<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ team_display_name }} Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        /* Board card styles */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Custom scrollbar for board */
        #boardColumns::-webkit-scrollbar {
            height: 8px;
        }
        #boardColumns::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        #boardColumns::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        #boardColumns::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Column cards container scroll */
        [data-cards]::-webkit-scrollbar {
            width: 6px;
        }
        [data-cards]::-webkit-scrollbar-track {
            background: #f8fafc;
        }
        [data-cards]::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 3px;
        }
        
        /* Card hover animation */
        [data-board-column] > div:last-child > div {
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        [data-board-column] > div:last-child > div:hover {
            transform: translateY(-2px);
        }
        
        /* Custom checkbox styling */
        .task-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            transition: all 0.15s ease;
        }
        .task-checkbox:hover {
            border-color: #3b82f6;
        }
        .task-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .task-checkbox:checked::after {
            content: '';
            position: absolute;
            left: 4px;
            top: 1px;
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        .task-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        
        /* Avatar stack overlap */
        .avatar-stack > span:not(:first-child) {
            margin-left: -8px;
        }

        .rfp-details summary {
            list-style: none;
        }

        .rfp-details summary::-webkit-details-marker {
            display: none;
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='light_theme_overrides.css') }}">
</head>
<body class="{% if embed_mode %}bg-transparent text-gray-800{% else %}bg-gray-50 text-gray-800{% endif %}"
      data-tasks-scope-all="{{ 1 if (embed_mode and (((user_role or '')|lower|replace('_',' ')) == 'business manager' or (((user_role or '')|lower|replace('_',' ')) == 'manager' and active_department_key == 'business') or is_admin)) else 0 }}">
    <div class="{% if embed_mode %}block{% else %}flex h-screen{% endif %}">
        {% if not embed_mode %}
        {% set sidebar_mode = 'team_lead' %}
        {% include 'sidebar.html' %}
        {% endif %}

        <main class="{% if embed_mode %}w-full p-0{% else %}flex-1 p-8 overflow-y-auto{% endif %}">
            {% if not embed_mode %}
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">{{ team_display_name }} Dashboard</h2>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">Current Stage: <span class="font-semibold">{{ current_stage|replace('_',' ')|capitalize }}</span></div>
                    {% if check_module_access('team_management') or is_admin %}
                    <a href="/team/{{ team }}/employees" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-users mr-2"></i>Manage Employees
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Team Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-clipboard-list text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Bids</p>
                            <p class="text-2xl font-bold text-gray-900">{{ total_bids }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-check-circle text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Completed</p>
                            <p class="text-2xl font-bold text-gray-900">{{ completed_bids }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i class="fas fa-clock text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">In Progress</p>
                            <p class="text-2xl font-bold text-gray-900">{{ total_bids - completed_bids }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% if approval_items and approval_items|length > 0 %}
            <div class="bg-white rounded-lg shadow-md mb-8">
                <div class="p-5 border-b border-gray-200 flex items-center justify-between">
                    <div class="font-semibold text-gray-900">Pending Approvals</div>
                    <div class="text-xs text-gray-500">Total: {{ approval_items|length }}</div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                            <tr>
                                <th class="text-left p-3">Source</th>
                                <th class="text-left p-3">Department</th>
                                <th class="text-left p-3">Task</th>
                                <th class="text-left p-3">Priority</th>
                                <th class="text-left p-3">Uploaded By</th>
                                <th class="text-left p-3">Approval For</th>
                                <th class="text-left p-3">File / Comment</th>
                                <th class="text-left p-3">Uploaded</th>
                                <th class="text-left p-3">Status</th>
                                <th class="text-left p-3">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for it in approval_items %}
                            <tr class="hover:bg-gray-50">
                                <td class="p-3">
                                    <span class="px-2 py-1 text-xs rounded-full font-semibold {{ 'bg-blue-100 text-blue-800' if it.source=='employee' else 'bg-gray-100 text-gray-700' }}">
                                        {{ it.source|title }}
                                    </span>
                                </td>
                                <td class="p-3 text-gray-600">{{ (it.department or 'â€”')|replace('_',' ')|title }}</td>
                                <td class="p-3">
                                    <div class="font-semibold">{{ it.task_name or ('Task ' ~ it.task_id) }}</div>
                                    <div class="text-xs text-gray-500">{{ it.bid_name or 'â€”' }}</div>
                                </td>
                                <td class="p-3 whitespace-nowrap">
                                    {% set _prio = (it.priority or 'normal')|lower %}
                                    {% set _prio_label = _prio if _prio in ['low','medium','high','urgent','normal'] else 'normal' %}
                                    <span class="px-2 py-1 text-xs rounded-full font-semibold
                                        {{ 'bg-red-100 text-red-800' if _prio_label=='urgent' else ('bg-orange-100 text-orange-800' if _prio_label=='high' else ('bg-yellow-100 text-yellow-800' if _prio_label=='medium' else 'bg-gray-100 text-gray-700')) }}">
                                        {{ _prio_label|title }}
                                    </span>
                                </td>
                                <td class="p-3 text-gray-600">{{ it.uploader or 'â€”' }}</td>
                                <td class="p-3 text-gray-600">{{ (it.approval_target or 'admin')|replace('_',' ')|title }}</td>
                                <td class="p-3">
                                    {% if it.source_table == 'task_comments' %}
                                        <div class="text-gray-900 font-semibold">Approval Request (Comment)</div>
                                        <div class="text-xs text-gray-600 mt-0.5 whitespace-pre-line">{{ it.comment or 'â€”' }}</div>
                                        {% if it.task_details_url %}
                                            <a class="inline-block mt-1 text-xs text-gray-900 underline" href="{{ it.task_details_url }}" target="_blank">View task details</a>
                                        {% endif %}
                                    {% else %}
                                        <a class="text-gray-900 font-semibold underline" href="{{ it.download_url }}" target="_blank">{{ it.original_filename or it.filename }}</a>
                                        {% if it.description %}
                                            <div class="text-xs text-gray-500 mt-0.5">{{ it.description }}</div>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="p-3 text-gray-600 whitespace-nowrap">{{ it.uploaded_at }}</td>
                                <td class="p-3 whitespace-nowrap">
                                    {% set st = (it.status or 'pending')|lower %}
                                    <span class="px-2 py-1 text-xs rounded-full font-semibold
                                        {{ 'bg-amber-100 text-amber-800' if st=='pending' else ('bg-emerald-100 text-emerald-800' if st=='approved' else 'bg-rose-100 text-rose-800') }}">
                                        {{ st|title }}
                                    </span>
                                    {% if it.decided_at and st != 'pending' %}
                                        <div class="text-xs text-gray-500 mt-0.5">Decided: {{ it.decided_at }}</div>
                                    {% endif %}
                                </td>
                                <td class="p-3">
                                    <div class="flex items-center gap-2">
                                        {% if st == 'pending' %}
                                        <button type="button"
                                                class="px-3 py-2 text-xs bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg"
                                                data-approve
                                                data-source-table="{{ it.source_table }}"
                                                data-source-id="{{ it.source_id }}">
                                            Approve
                                        </button>
                                        <button type="button"
                                                class="px-3 py-2 text-xs bg-rose-600 hover:bg-rose-700 text-white rounded-lg"
                                                data-reject
                                                data-source-table="{{ it.source_table }}"
                                                data-source-id="{{ it.source_id }}">
                                            Reject
                                        </button>
                                        {% else %}
                                            <span class="text-xs text-gray-500 italic">No action</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            {% endif %}

            {% if not embed_mode %}
            <!-- Team Lead Bid Overview (Compact Table) -->
            <div class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200 mb-8 overflow-hidden">
                <!-- <div class="p-5 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white"> -->
                    <!-- <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                        <div class="flex items-start gap-3">
                            <div class="mt-0.5 w-9 h-9 rounded-lg bg-blue-600 text-white flex items-center justify-center shadow-sm">
                                <i class="fas fa-table text-sm"></i>
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <h3 class="text-base md:text-lg font-semibold text-gray-900">Team Lead Assigned Bids</h3>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                        {{ teamlead_assign_bids|length if teamlead_assign_bids else 0 }} records
                                    </span>
                                </div>
                                <p class="text-xs text-gray-500">Search, scroll, and scan statuses quickly.</p>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
                            Grid/Board Toggle (Planner-like) -->
                            <!-- <div class="flex items-center bg-gray-100 rounded-lg overflow-hidden border border-gray-200">
                                <button id="tlabTabGrid" type="button" class="px-3 py-2 text-xs font-medium bg-white text-gray-900 hover:bg-gray-50">
                                    <i class="fas fa-table mr-1"></i>Grid
                                </button>
                                <button id="tlabTabBoard" type="button" class="px-3 py-2 text-xs font-medium text-gray-600 hover:bg-gray-50">
                                    <i class="fas fa-columns mr-1"></i>Board
                                </button>
                            </div>
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                                <input id="tlabSearch" type="text"
                                       class="w-full sm:w-72 pl-8 pr-8 py-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Search bids (name, state, company...)">
                                <button id="tlabClear" type="button"
                                        class="hidden absolute right-2 top-2 text-gray-400 hover:text-gray-600"
                                        title="Clear">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div> -->
                <!-- </div> -->

                <!-- Grid view -->
                <!-- <div id="tlabGridWrap" class="max-h-[520px] overflow-auto">
                    {% if teamlead_assign_bids and teamlead_assign_bids|length > 0 %}
                    {% set _cols_all = teamlead_assign_bids[0].keys()|list %}
                    {% set _cols = (_cols_all[2:] if is_team_lead_dashboard else _cols_all) %}
                    <table class="w-full min-w-[1400px]">
                        <thead class="sticky top-0 z-10 bg-white shadow-sm">
                            <tr class="text-[11px] uppercase tracking-wider text-gray-600">
                                {% for c in _cols %}
                                {% set _h = (c|replace('_',' ')) %}
                                <th class="px-3 py-3 text-left whitespace-nowrap border-b border-gray-200">
                                    <span class="inline-flex items-center gap-1.5">
                                        <span class="font-semibold">{{ _h }}</span>
                                    </span>
                                </th>
                                {% endfor %}
                                <th class="px-3 py-3 text-left whitespace-nowrap border-b border-gray-200">
                                    <span class="font-semibold">Employee Assign</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tlabTbody" class="text-sm">
                            {% for r in teamlead_assign_bids %}
                            <tr class="border-b last:border-b-0 hover:bg-blue-50/40 odd:bg-gray-50/30"
                                data-tlab-row
                                data-gid="{{ r.get('g_id') }}"
                                data-bname="{{ (r.get('b_name') or '')|e }}"
                                data-duedate="{{ (r.get('due_date') or '') }}"
                                data-state="{{ (r.get('state') or '')|e }}"
                                data-company="{{ (r.get('company') or r.get('comp_name') or '')|e }}"
                                data-summary="{{ (r.get('summary') or '')|e }}"
                                data-status="{{ (r.get('submission_status') or r.get('status') or 'Work Progress')|e }}">
                                {% for c in _cols %}
                                {% set v = r[c] %}
                                {% set s = '' if v is none else (v|string) %}

                                {% set _base_td = "px-3 py-2.5 align-top text-gray-800" %}
                                {% if c in ['summary', 'scope'] %}
                                    {% set _base_td = _base_td + " max-w-[420px]" %}
                                {% elif c in ['b_name', 'comp_name', 'company'] %}
                                    {% set _base_td = _base_td + " max-w-[260px]" %}
                                {% endif %}

                                <td class="{{ _base_td }}">
                                    {% if v is none %}
                                        <span class="text-gray-400 italic">N/A</span>
                                    {% else %}
                                        {% set c_low = (c|string)|lower %}
                                        {% set s_low = s|lower %}

                                        {# Badge styles for certain fields #}
                                        {% if c_low in ['submission_status', 'status'] %}
                                            {% set badge = "bg-gray-100 text-gray-700" %}
                                            {% if 'submitted' in s_low %}
                                                {% set badge = "bg-green-100 text-green-800" %}
                                            {% elif 'not submitted' in s_low %}
                                                {% set badge = "bg-red-100 text-red-800" %}
                                            {% elif 'on hold' in s_low %}
                                                {% set badge = "bg-amber-100 text-amber-800" %}
                                            {% elif 'work progress' in s_low or 'in progress' in s_low %}
                                                {% set badge = "bg-blue-100 text-blue-800" %}
                                            {% endif %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {{ badge }}">
                                                {{ s }}
                                            </span>

                                        {% elif c_low == 'state' %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
                                                {{ s }}
                                            </span>

                                        {% elif c_low == 'scoring' %}
                                            {% set _pct = (v|int) %}
                                            {% if _pct < 0 %}{% set _pct = 0 %}{% endif %}
                                            {% if _pct > 100 %}{% set _pct = 100 %}{% endif %}
                                            <div class="flex items-center gap-2 min-w-[120px]">
                                                <span class="text-xs font-semibold text-gray-700 w-7">{{ v }}</span>
                                                <div class="flex-1 h-2 rounded-full bg-gray-200 overflow-hidden">
                                                    <div class="h-2 bg-blue-600 rounded-full" style="width: {{ _pct }}%"></div>
                                                </div>
                                            </div>

                                        {% elif (c_low.endswith('date') or c_low.endswith('at')) %}
                                            <span class="text-xs font-medium text-gray-700" title="{{ s|e }}">
                                                {{ s|replace('T',' ') }}
                                            </span>

                                        {% else %}
                                            {% if s|length > 80 %}
                                                <div class="truncate" title="{{ s|e }}">{{ s }}</div>
                                            {% else %}
                                                <span title="{{ s|e }}">{{ s }}</span>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                </td>
                                {% endfor %}
                                <td class="px-3 py-2.5 align-top text-gray-800">
                                    <div class="flex items-center gap-2 min-w-[220px]">
                                        <select class="tlab-assign-select w-full px-2 py-1.5 rounded border border-gray-300 text-xs focus:ring-2 focus:ring-blue-500"
                                                data-tlab-assign-select
                                                data-gid="{{ r.get('g_id') }}">
                                            <option value="">Select employeeâ€¦</option>
                                            {% for emp in employees %}
                                            <option value="{{ emp.id }}">{{ emp.name }} ({{ emp.email }})</option>
                                            {% endfor %}
                                        </select>
                                        <button type="button"
                                                class="px-2.5 py-1.5 rounded bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium"
                                                data-tlab-assign-btn
                                                data-gid="{{ r.get('g_id') }}">
                                            Assign
                                        </button>
                                    </div>
                                    <div class="mt-1 text-[11px] text-gray-500 tlab-assign-msg hidden" data-tlab-assign-msg="{{ r.get('g_id') }}"></div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="p-10 text-center">
                        <div class="mx-auto w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-400">
                            <i class="fas fa-inbox text-xl"></i>
                        </div>
                        <p class="mt-3 text-sm text-gray-600">No records found in <span class="font-mono">teamlead_assign_bids</span>.</p>
                    </div>
                    {% endif %}
                </div> -->

                <!-- Board view (Planner-like) -->
                <div id="tlabBoardWrap" class="hidden p-5 bg-gray-50">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-lg border border-gray-200">
                            <div class="p-3 border-b flex items-center justify-between">
                                <div class="text-sm font-semibold text-gray-900">Work Progress</div>
                                <span class="text-xs text-gray-500" id="tlabCountWork">0</span>
                            </div>
                            <div class="p-3 space-y-3" id="tlabColWork"></div>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200">
                            <div class="p-3 border-b flex items-center justify-between">
                                <div class="text-sm font-semibold text-gray-900">Submitted</div>
                                <span class="text-xs text-gray-500" id="tlabCountSubmitted">0</span>
                            </div>
                            <div class="p-3 space-y-3" id="tlabColSubmitted"></div>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200">
                            <div class="p-3 border-b flex items-center justify-between">
                                <div class="text-sm font-semibold text-gray-900">Not Submitted</div>
                                <span class="text-xs text-gray-500" id="tlabCountNot">0</span>
                            </div>
                            <div class="p-3 space-y-3" id="tlabColNot"></div>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200">
                            <div class="p-3 border-b flex items-center justify-between">
                                <div class="text-sm font-semibold text-gray-900">On Hold</div>
                                <span class="text-xs text-gray-500" id="tlabCountHold">0</span>
                            </div>
                            <div class="p-3 space-y-3" id="tlabColHold"></div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
              (function () {
                const input = document.getElementById('tlabSearch');
                const clearBtn = document.getElementById('tlabClear');
                const tbody = document.getElementById('tlabTbody');
                const tabGrid = document.getElementById('tlabTabGrid');
                const tabBoard = document.getElementById('tlabTabBoard');
                const gridWrap = document.getElementById('tlabGridWrap');
                const boardWrap = document.getElementById('tlabBoardWrap');

                if (!input || !tbody) return;
                const rows = Array.from(tbody.querySelectorAll('tr[data-tlab-row]'));

                const colWork = document.getElementById('tlabColWork');
                const colSubmitted = document.getElementById('tlabColSubmitted');
                const colNot = document.getElementById('tlabColNot');
                const colHold = document.getElementById('tlabColHold');

                const countWork = document.getElementById('tlabCountWork');
                const countSubmitted = document.getElementById('tlabCountSubmitted');
                const countNot = document.getElementById('tlabCountNot');
                const countHold = document.getElementById('tlabCountHold');

                function norm(s) {
                  return (s || '').toString().trim().toLowerCase();
                }

                function setView(view) {
                  const isGrid = view === 'grid';
                  if (gridWrap) gridWrap.classList.toggle('hidden', !isGrid);
                  if (boardWrap) boardWrap.classList.toggle('hidden', isGrid);
                  if (tabGrid) {
                    tabGrid.classList.toggle('bg-white', isGrid);
                    tabGrid.classList.toggle('text-gray-900', isGrid);
                    tabGrid.classList.toggle('text-gray-600', !isGrid);
                  }
                  if (tabBoard) {
                    tabBoard.classList.toggle('bg-white', !isGrid);
                    tabBoard.classList.toggle('text-gray-900', !isGrid);
                    tabBoard.classList.toggle('text-gray-600', isGrid);
                  }
                  try { localStorage.setItem('tlab_view', view); } catch (e) {}
                  if (!isGrid) buildBoard(); // rebuild when switching to board
                }

                function bucketForStatus(statusRaw) {
                  const s = norm(statusRaw);
                  if (s.includes('on hold')) return 'hold';
                  if (s.includes('not submitted')) return 'not';
                  if (s.includes('submitted')) return 'submitted';
                  return 'work'; // default: Work Progress / In progress
                }

                function makeCard(row) {
                  const gid = row.getAttribute('data-gid') || '';
                  const bname = row.getAttribute('data-bname') || '';
                  const due = row.getAttribute('data-duedate') || '';
                  const state = row.getAttribute('data-state') || '';
                  const company = row.getAttribute('data-company') || '';
                  const summary = row.getAttribute('data-summary') || '';
                  const status = row.getAttribute('data-status') || 'Work Progress';
                  const searchText = (bname + ' ' + company + ' ' + state + ' ' + summary + ' ' + status + ' ' + due).toLowerCase();

                  const card = document.createElement('div');
                  card.className = 'p-3 rounded-lg border border-gray-200 bg-white hover:shadow-sm transition-shadow';
                  card.setAttribute('data-tlab-card', '1');
                  card.setAttribute('data-search', searchText);
                  card.setAttribute('data-bucket', bucketForStatus(status));

                  const badgeClass =
                    norm(status).includes('submitted') ? 'bg-green-100 text-green-800' :
                    norm(status).includes('not submitted') ? 'bg-red-100 text-red-800' :
                    norm(status).includes('on hold') ? 'bg-amber-100 text-amber-800' :
                    'bg-blue-100 text-blue-800';

                  card.innerHTML = `
                    <div class="flex items-start justify-between gap-2">
                      <div>
                        <div class="font-semibold text-sm text-gray-900">${escapeHtml(bname || 'â€”')}</div>
                        <div class="text-xs text-gray-500 mt-0.5">${escapeHtml(company || '')}</div>
                      </div>
                      <span class="px-2 py-0.5 text-xs rounded-full ${badgeClass}">${escapeHtml(status)}</span>
                    </div>
                    <div class="mt-2 flex items-center justify-between text-xs text-gray-600">
                      <span>${escapeHtml(state || 'â€”')}</span>
                      <span>Due: ${escapeHtml(due || 'â€”')}</span>
                    </div>
                    <div class="mt-3">
                      <div class="flex items-center gap-2">
                        <select class="w-full px-2 py-1.5 rounded border border-gray-300 text-xs focus:ring-2 focus:ring-blue-500"
                                data-tlab-card-assign-select="${gid}">
                          <option value="">Select employeeâ€¦</option>
                        </select>
                        <button type="button"
                                class="px-2.5 py-1.5 rounded bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium"
                                data-tlab-card-assign-btn="${gid}">
                          Assign
                        </button>
                      </div>
                      <div class="mt-1 text-[11px] text-gray-500 hidden" data-tlab-card-assign-msg="${gid}"></div>
                    </div>
                  `;
                  return card;
                }

                function escapeHtml(str) {
                  return (str || '').toString()
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                }

                // Populate employee options from the grid table selects (single source of truth)
                function getEmployeeOptionsHtml() {
                  const anySelect = document.querySelector('[data-tlab-assign-select]');
                  if (!anySelect) return '';
                  return Array.from(anySelect.querySelectorAll('option'))
                    .map(o => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.textContent || '')}</option>`)
                    .join('');
                }

                function buildBoard() {
                  if (!colWork || !colSubmitted || !colNot || !colHold) return;
                  colWork.innerHTML = '';
                  colSubmitted.innerHTML = '';
                  colNot.innerHTML = '';
                  colHold.innerHTML = '';

                  const optsHtml = getEmployeeOptionsHtml();
                  let cWork = 0, cSub = 0, cNot = 0, cHold = 0;

                  rows.forEach((tr) => {
                    // Only include rows currently visible by search filter
                    if (tr.style.display === 'none') return;
                    const card = makeCard(tr);
                    const bucket = card.getAttribute('data-bucket');
                    // inject options into card select
                    const sel = card.querySelector('select[data-tlab-card-assign-select]');
                    if (sel) sel.innerHTML = optsHtml;

                    if (bucket === 'submitted') { colSubmitted.appendChild(card); cSub++; }
                    else if (bucket === 'not') { colNot.appendChild(card); cNot++; }
                    else if (bucket === 'hold') { colHold.appendChild(card); cHold++; }
                    else { colWork.appendChild(card); cWork++; }
                  });

                  if (countWork) countWork.textContent = String(cWork);
                  if (countSubmitted) countSubmitted.textContent = String(cSub);
                  if (countNot) countNot.textContent = String(cNot);
                  if (countHold) countHold.textContent = String(cHold);

                  wireAssignHandlers(); // re-wire after rebuild
                }

                function apply() {
                  const q = (input.value || '').trim().toLowerCase();
                  const showClear = q.length > 0;
                  if (clearBtn) clearBtn.classList.toggle('hidden', !showClear);

                  let visible = 0;
                  rows.forEach((tr) => {
                    const txt = (tr.innerText || '').toLowerCase();
                    const ok = !q || txt.includes(q);
                    tr.style.display = ok ? '' : 'none';
                    if (ok) visible += 1;
                  });

                  // When board is active, rebuild it with only visible rows
                  if (boardWrap && !boardWrap.classList.contains('hidden')) {
                    buildBoard();
                  }
                }

                input.addEventListener('input', apply);
                if (clearBtn) {
                  clearBtn.addEventListener('click', () => { input.value = ''; apply(); input.focus(); });
                }

                if (tabGrid) tabGrid.addEventListener('click', () => setView('grid'));
                if (tabBoard) tabBoard.addEventListener('click', () => setView('board'));

                async function assignToEmployee(gid, employeeId, msgEl) {
                  if (!gid) return;
                  if (!employeeId) {
                    alert('Please select an employee.');
                    return;
                  }
                  try {
                    if (msgEl) {
                      msgEl.classList.remove('hidden');
                      msgEl.textContent = 'Assigning...';
                    }
                    const res = await fetch('/api/team/{{ team }}/assign', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ g_id: parseInt(gid, 10), employee_id: parseInt(employeeId, 10) })
                    });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok || !data.ok) {
                      throw new Error(data.error || 'Failed to assign');
                    }
                    if (msgEl) {
                      msgEl.classList.remove('hidden');
                      msgEl.textContent = 'Assigned âœ“';
                    }
                  } catch (e) {
                    console.error(e);
                    alert('Error assigning employee: ' + (e && e.message ? e.message : 'Unknown error'));
                    if (msgEl) {
                      msgEl.classList.remove('hidden');
                      msgEl.textContent = 'Assign failed';
                    }
                  }
                }

                function wireAssignHandlers() {
                  // Grid assigns
                  document.querySelectorAll('[data-tlab-assign-btn]').forEach(btn => {
                    if (btn.__wired) return;
                    btn.__wired = true;
                    btn.addEventListener('click', () => {
                      const gid = btn.getAttribute('data-gid');
                      const sel = document.querySelector(`[data-tlab-assign-select][data-gid="${gid}"]`);
                      const msg = document.querySelector(`[data-tlab-assign-msg="${gid}"]`);
                      const employeeId = sel ? sel.value : '';
                      assignToEmployee(gid, employeeId, msg);
                    });
                  });

                  // Board assigns
                  document.querySelectorAll('button[data-tlab-card-assign-btn]').forEach(btn => {
                    if (btn.__wired) return;
                    btn.__wired = true;
                    btn.addEventListener('click', () => {
                      const gid = btn.getAttribute('data-tlab-card-assign-btn');
                      const sel = document.querySelector(`select[data-tlab-card-assign-select="${gid}"]`);
                      const msg = document.querySelector(`div[data-tlab-card-assign-msg="${gid}"]`);
                      const employeeId = sel ? sel.value : '';
                      assignToEmployee(gid, employeeId, msg);
                    });
                  });
                }

                // Initial wiring + view restore
                wireAssignHandlers();
                try {
                  const saved = localStorage.getItem('tlab_view');
                  setView(saved === 'board' ? 'board' : 'grid');
                } catch (e) {
                  setView('grid');
                }
              })();
            </script>
            {% endif %}

            <!-- Assigned Bids - Grid View -->
            <div class="{% if embed_mode %}w-full{% else %}bg-white text-gray-900 rounded-lg shadow-md border border-gray-200{% endif %}">
                <div class="flex items-center justify-between gap-3 {% if embed_mode %}p-2{% else %}p-4{% endif %} border-b border-gray-200 {% if embed_mode %}bg-white{% else %}bg-gray-50 rounded-t-lg{% endif %}">
                    {% if not embed_mode %}
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Assigned Bids</h3>
                        <p class="text-xs text-gray-600">Readable grid/board view with quick actions</p>
                    </div>
                    {% endif %}
                    <div class="flex items-center gap-3 text-xs flex-wrap justify-end">
                        <!-- Grid/Board Toggle -->
                        <div class="flex items-center bg-white rounded-md overflow-hidden border border-gray-300 shadow-sm">
                            <button id="tabGrid" type="button" class="px-3 py-1.5 bg-gray-100 text-gray-700 font-medium border border-gray-300 hover:bg-gray-200 transition-colors">
                                Grid
                            </button>
                            <button id="tabBoard" type="button" class="px-3 py-1.5 text-gray-700 font-medium hover:bg-gray-100 transition-colors">
                                Board
                            </button>
                        </div>
                        <!-- Bucket Filter -->
                        <div class="flex items-center gap-2">
                            <span class="text-gray-700 font-medium">Bucket</span>
                            <select id="boardBucketFilter" class="px-2 py-1.5 rounded bg-white border border-gray-300 text-gray-900 text-xs min-w-[120px] shadow-sm">
                                <option value="__all__">All buckets</option>
                                <option value="ready">Ready To Start</option>
                                <option value="inprogress">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <!-- Group By -->
                        <div class="flex items-center gap-2">
                            <select id="groupBySelect" class="px-2 py-1.5 rounded bg-white border border-gray-300 text-gray-900 text-xs min-w-[150px] shadow-sm">
                                <option value="bucket">ðŸª£ Group by Bucket</option>
                                <option value="assigned">ðŸ‘¤ Group by Assigned</option>
                                <option value="priority">âš¡ Group by Priority</option>
                                <option value="due">ðŸ“… Group by Due Date</option>
                            </select>
                        </div>
                    </div>
                </div>
                {% set grid_max_h = 'max-h-[92vh]' if embed_mode else 'max-h-[75vh]' %}
                <div class="text-gray-900 overflow-x-auto {{ grid_max_h }} overflow-y-auto {% if embed_mode %}rounded-none{% endif %}">
                    <table id="gridContainer" class="min-w-[1400px] w-full table-auto">
                        <thead class="sticky top-0 z-10 bg-gray-100 text-xs uppercase tracking-wider text-gray-700 border-b border-gray-200">
                            <tr>
                                <th class="px-3 py-3 text-left min-w-[260px]">Task Name
                                    <i class="fa-solid fa-sort ml-1 opacity-50"></i>
                                </th>
                                <th class="px-3 py-3 text-left min-w-[120px]">
                                    {% if is_team_lead_dashboard %}
                                        Employee Assigned
                                    {% else %}
                                        Team Lead
                                    {% endif %}
                                </th>
                                {% if show_team_column %}
                                <th class="px-3 py-3 text-left min-w-[110px]">Team</th>
                                {% endif %}
                                <th class="px-3 py-3 text-left min-w-[110px]">Due
                                    <i class="fa-solid fa-sort ml-1 opacity-50"></i>
                                </th>
                                <th class="px-3 py-3 text-left min-w-[110px]">Created</th>
                                <th class="px-3 py-3 text-left min-w-[120px]">Bucket
                                    <i class="fa-solid fa-sort ml-1 opacity-50"></i>
                                </th>
                                <th class="px-3 py-3 text-left min-w-[80px]">State</th>
                                <th class="px-3 py-3 text-left min-w-[150px]">Progress</th>
                                <th class="px-3 py-3 text-left min-w-[95px]">Priority</th>
                                <th class="px-3 py-3 text-left min-w-[140px]">Labels</th>
                                {% if team == 'business' %}
                                <th class="px-3 py-3 text-left min-w-[120px]">Proposal</th>
                                {% endif %}
                                <th class="px-3 py-3 text-left min-w-[170px]">Submission</th>
                                <th class="px-3 py-3 text-left min-w-[120px]">Result</th>
                                <th class="px-3 py-3 text-right min-w-[90px]">Actions</th>
                            </tr>
                        </thead>
                        {% set _colspan = 12 + (1 if show_team_column else 0) + (1 if team == 'business' else 0) %}
                        <tbody class="text-sm text-gray-900">
                            {% for bid in bids %}
                            <tr class="odd:bg-white even:bg-gray-50 hover:bg-blue-50 transition-colors border-b border-gray-200 text-gray-900"
                                data-bid-row="{{ bid.id }}"
                                data-current-stage="{{ bid.current_stage }}"
                                data-person-name="{{ bid.person_name or '' }}"
                                data-person-email="{{ bid.person_email or '' }}"
                                data-dyn-stages='{{ (bid.dyn_stages or []) | tojson | safe }}'>
                                <!-- Task Name - Full name with wrapping -->
                                <td class="px-3 py-3 align-top">
                                    <div class="flex items-start gap-2">
                                        <button type="button"
                                                class="mt-0.5 w-7 h-7 rounded-md border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 flex items-center justify-center"
                                                data-expand-bid="{{ bid.id }}"
                                                aria-expanded="false"
                                                title="Open details">
                                            <i class="fas fa-chevron-right text-xs transition-transform" data-expand-icon="{{ bid.id }}"></i>
                                        </button>
                                        <div class="min-w-0">
                                            <div class="font-semibold text-gray-900 leading-tight break-words">{{ bid.name }}</div>
                                            <div class="text-xs text-gray-600 mt-0.5">{{ bid.company or 'N/A' }}</div>
                                        </div>
                                    </div>
                                </td>
                                <!-- Assignment - Icons only (stacked avatars) -->
                                <td class="px-3 py-3 align-top">
                                    <div class="flex items-center -space-x-1" data-assignees data-bid-id="{{ bid.id }}"></div>
                                    <button type="button" class="mt-1 w-6 h-6 text-xs rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 flex items-center justify-center border border-gray-300" data-assignees-btn data-bid-id="{{ bid.id }}" title="Add assignee">+</button>
                                </td>
                                {% if show_team_column %}
                                <!-- Team (department) -->
                                <td class="px-3 py-3 align-top" data-teams data-bid-id="{{ bid.id }}">
                                    <span class="text-xs text-gray-600">â€”</span>
                                </td>
                                {% endif %}
                                <!-- Due date -->
                                <td class="px-3 py-3 align-top">
                                    {% if is_team_lead_dashboard %}
                                        <span class="text-xs text-gray-900" data-date="{{ bid.task_completion_date or '' }}">{{ bid.task_completion_date or 'N/A' }}</span>
                                    {% else %}
                                        <span class="text-xs text-gray-900" data-date="{{ bid.due_date or '' }}">{{ bid.due_date or 'N/A' }}</span>
                                    {% endif %}
                                </td>
                                <!-- Created At -->
                                <td class="px-3 py-3 align-top">
                                    <span class="text-xs text-gray-900">{{ bid.created_at or 'N/A' }}</span>
                                </td>
                                <!-- Bucket (Checklist status, independent of team stage) -->
                                <td class="px-3 py-3 align-top">
                                    <span id="bucketLabel_{{ bid.id }}" class="px-2 py-0.5 rounded-full text-xs bg-indigo-50 text-indigo-800 border border-indigo-200">Ready</span>
                                </td>
                                <!-- Current stage (read-only) -->
                                <td class="px-3 py-3 align-top">
                                    <span class="px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-700 border border-gray-300">
                                        {{ (bid.current_stage or 'analyzer')[:2]|title }}
                                    </span>
                                </td>
                                <!-- Progress -->
                                <td class="px-3 py-3 align-top">
                                    <div class="w-full">
                                        <div class="w-full h-2 rounded-full bg-gray-200">
                                            <div id="progressBarRow_{{ bid.id }}"
                                                class="h-2 rounded-full bg-emerald-600 transition-all duration-300"
                                                style="width: 0%"></div>
                                        </div>
                                        <div class="mt-1 text-xs text-gray-700">
                                            <i class="fa-regular fa-circle-check text-emerald-600"></i>
                                            <span id="progressPctRow_{{ bid.id }}">0%</span>
                                        </div>
                                    </div>
                                </td>
                                <!-- Priority (placeholder mapping) -->
                                <td class="px-3 py-3 align-top">
                                    {% set _prio = (bid.priority_label or 'Medium') %}
                                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs
                                                 {% if _prio == 'Important' %} bg-red-600/20 text-red-900 border border-red-600/40
                                                 {% elif _prio == 'Low' %} bg-gray-600/20 text-gray-900 border border-gray-500/40
                                                 {% else %} bg-yellow-500/20 text-yellow-900 border border-yellow-600/40 {% endif %}">
                                        {% if _prio == 'Important' %}
                                            <i class="fa-solid fa-circle-exclamation"></i>
                                        {% elif _prio == 'Low' %}
                                            <i class="fa-solid fa-arrow-down"></i>
                                        {% else %}
                                            <i class="fa-solid fa-arrow-right"></i>
                                                {% endif %}
                                        {{ _prio }}
                                    </span>
                                </td>
                                <!-- Labels -->
                                <td class="px-3 py-3 align-top">
                                    <div class="flex flex-wrap gap-1">
                                        {% if bid.company %}
                                        <span class="px-2 py-0.5 rounded-full text-xs bg-sky-900 text-white border border-sky-700">
                                            {{ bid.company[:12] }}
                                        </span>
                                        {% endif %}
                                        {% set _decision = (bid.wl_result or bid.decision or 'GO') %}
                                        <span class="px-2 py-0.5 rounded-full text-xs
                                                     {% if _decision == 'WON' %} bg-emerald-50 text-emerald-800 border border-emerald-200
                                                     {% elif _decision in ['NO-GO','LOST'] %} bg-rose-50 text-rose-800 border border-rose-200
                                                     {% else %} bg-indigo-50 text-indigo-800 border border-indigo-200 {% endif %}">
                                            {{ _decision }}
                                        </span>
                                    </div>
                                </td>
                                <!-- Proposal Making -->
                                {% if team == 'business' %}
                                <td class="px-3 py-3 align-top">
                                    <button type="button" 
                                            class="px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold shadow-sm generate-proposals-btn"
                                            data-bid-id="{{ bid.id }}"
                                            data-bid-name="{{ bid.name }}"
                                            data-bid-company="{{ bid.company or '' }}"
                                            title="Generate Proposals">
                                        <i class="fas fa-file-alt"></i> Generate
                                    </button>
                                </td>
                                {% endif %}
                                <!-- Submission Stage (Submitted / Not Submitted) -->
                                <td class="px-3 py-3 align-top">
                                    <div class="flex flex-col gap-0.5">
                                        <select class="px-2 py-1 rounded border border-gray-300 text-xs focus:ring-2 focus:ring-blue-500 w-full bg-white"
                                                onchange="handleSubmissionChange({{ bid.id }}, this.value, this)"
                                                data-bid-id="{{ bid.id }}"
                                                data-submission-select>
                                            <option value="Work Progress" {% if not bid.submission_status or bid.submission_status == 'Work Progress' %}selected{% endif %}>Work Progress</option>
                                            <option value="Submitted" {% if bid.submission_status == 'Submitted' %}selected{% endif %}>Submitted</option>
                                            <option value="Not Submitted" {% if bid.submission_status == 'Not Submitted' %}selected{% endif %}>Not Submitted</option>
                                            <option value="On Hold" {% if bid.submission_status == 'On Hold' %}selected{% endif %}>On Hold</option>
                                        </select>
                                        <div class="submission-reason-container {% if bid.submission_status not in ['Not Submitted', 'On Hold'] %}hidden{% endif %}" data-reason-container="{{ bid.id }}">
                                            <input type="text" 
                                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 bg-white"
                                                   placeholder="Reason..."
                                                   value="{{ bid.submission_reason or '' }}"
                                                   data-reason-input="{{ bid.id }}"
                                                   onblur="saveSubmissionReason({{ bid.id }})">
                                        </div>
                                    </div>
                                </td>
                                <!-- Submitted Result (Won / Lost) -->
                                <td class="px-3 py-3 align-top">
                                    <select class="px-2 py-1 rounded border border-gray-300 text-xs focus:ring-2 focus:ring-blue-500 w-full bg-white"
                                            onchange="updateResultStatus({{ bid.id }}, this.value)"
                                            data-bid-id="{{ bid.id }}">
                                        <option value="Awaited" {% if not bid.wl_result or bid.wl_result == 'Awaited' or bid.wl_result == 'Pending' %}selected{% endif %}>Awaited</option>
                                        <option value="WON" {% if bid.wl_result == 'WON' %}selected{% endif %}>Won</option>
                                        <option value="LOST" {% if bid.wl_result == 'LOST' %}selected{% endif %}>Lost</option>
                                    </select>
                                </td>
                                <!-- Actions -->
                                <td class="px-3 py-3 align-top">
                                    <div class="flex items-center justify-end gap-1">
                                        <button type="button"
                                                class="px-3 py-1.5 rounded-md border border-blue-200 bg-blue-50 text-blue-700 text-xs font-semibold hover:bg-blue-100"
                                                data-assign-bid="{{ bid.id }}"
                                                data-assign-name="{{ bid.name|e }}">
                                            Assign
                                        </button>
                                        <details class="rfp-details relative">
                                            <summary class="px-2 py-1.5 rounded-md border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 text-xs font-semibold cursor-pointer"
                                                     title="RFP attachments">
                                                <i class="fas fa-paperclip"></i>
                                            </summary>
                                            <div class="absolute right-0 mt-2 w-60 rounded-lg border border-gray-200 bg-white shadow-lg z-20">
                                                <div class="px-3 py-2 text-xs font-semibold text-gray-700 border-b border-gray-100">
                                                    RFP Attachments
                                                </div>
                                                <div class="max-h-56 overflow-y-auto">
                                                    {% if bid.rfp_files and bid.rfp_files|length > 0 %}
                                                        {% for rfp_file in bid.rfp_files %}
                                                        {% set display_name = (rfp_file.filename or rfp_file.original_filename or 'RFP') %}
                                                        <div class="px-3 py-2 text-xs text-gray-700 flex items-center justify-between gap-2 hover:bg-gray-50">
                                                            <span class="truncate" title="{{ display_name }}">{{ display_name }}</span>
                                                            <span class="flex items-center gap-1">
                                                                <a href="{{ url_for('view_rfp_file', file_id=rfp_file.id) }}"
                                                                   target="_blank"
                                                                   class="w-5 h-5 rounded bg-blue-500 hover:bg-blue-600 text-white text-[9px] flex items-center justify-center"
                                                                   title="View {{ display_name }}">
                                                                    <i class="fas fa-eye"></i>
                                                                </a>
                                                                <a href="{{ url_for('download_rfp_file', file_id=rfp_file.id) }}"
                                                                   class="w-5 h-5 rounded bg-emerald-500 hover:bg-emerald-600 text-white text-[9px] flex items-center justify-center"
                                                                   title="Download {{ display_name }}">
                                                                    <i class="fas fa-download"></i>
                                                                </a>
                                                            </span>
                                                        </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        <div class="px-3 py-2 text-xs text-gray-500">No attachments</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </details>
                                    </div>
                                </td>
                            </tr>
                            <!-- Inline expandable details row -->
                            <tr class="hidden bg-gray-50 border-b border-gray-200" data-bid-details-row="{{ bid.id }}">
                                <td colspan="{{ _colspan }}" class="px-3 py-3">
                                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                                        <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm font-semibold text-gray-900">Bid Details</span>
                                                <span class="text-xs text-gray-500">#{{ bid.id }}</span>
                                            </div>
                                            <button type="button"
                                                    class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-300"
                                                    data-collapse-bid="{{ bid.id }}">
                                                Close
                                            </button>
                                        </div>
                                        <div class="p-4" id="bidDetailsContent_{{ bid.id }}">
                                            <div class="text-sm text-gray-600">Loadingâ€¦</div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if bids|length == 0 %}
            <tr class="bg-gray-50">
                <td colspan="{{ _colspan }}" class="p-6 text-center text-gray-500">
                    <i class="fas fa-inbox text-4xl text-gray-400 mb-2"></i>
                    <p>No bids assigned to {{ team_display_name }}</p>
                </td>
            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <!-- Board view -->
                <div id="boardContainer" class="hidden mt-4">
                    <div id="boardColumns" class="flex gap-4 pb-4 w-full" style="min-height: 500px;"></div>
                </div>
                
            </div>

            {% if not embed_mode %}
            <!-- Add Task Section (Hidden by default) -->
            

            <!-- Task Checklist Table (Hidden by default) -->
            <div id="taskChecklistSection" class="bg-white rounded-lg shadow-md mb-8 mt-8 hidden">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold">Task Checklist for: <span id="checklistBidName" class="text-blue-600"></span></h3>
                        <button onclick="hideChecklistSection()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <!-- Progress Bar -->
                    <div class="mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">Progress</span>
                            <span id="progressPercentage" class="text-sm font-medium text-gray-700">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">According to Task Completed</p>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">Task Name</th>
                                <th class="p-3 text-left">Person Name</th>
                                <th class="p-3 text-left">Email</th>
                                <th class="p-3 text-left">Due Date</th>
                                <th class="p-3 text-left">Designation</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Action</th>
                            </tr>
                        </thead>
                        <tbody id="taskChecklistTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="addTaskSection" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Add Task for: <span id="selectedBidName" class="text-blue-600"></span></h3>
                    <button onclick="hideChecklistSection()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="addTaskForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <input type="hidden" id="selectedBidId" name="g_id">
                    <div>
                        <label for="task_name" class="block text-sm font-medium text-gray-700 mb-2">Task Name</label>
                        <input type="text" id="task_name" name="task_name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="assigned_to" class="block text-sm font-medium text-gray-700 mb-2">Assign To</label>
                        <select id="assigned_to" name="assigned_to" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Employee</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                        <select id="priority" name="priority" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div>
                        <label for="due_date" class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                        <input type="datetime-local" id="due_date" name="due_date" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2 lg:col-span-4">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="description" name="description" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                  placeholder="Task description..."></textarea>
                    </div>
                    <div class="md:col-span-2 lg:col-span-4">
                        <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Task
                        </button>
                    </div>
                </form>
            </div>
            <!-- Live Activity Log -->
            <!-- <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold mb-4">Live Activity Log</h3>
                <div id="activity-log" class="space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-gray-500 text-sm">Activity updates will appear here in real-time...</p>
                </div>
            </div> -->
            {% endif %}
        </main>
    </div>

    <!-- Board Bid Detail Modal (Planner-like) -->
    <div id="boardBidModal" class="fixed inset-0 bg-black/60 hidden z-50">
        <div class="relative top-10 mx-auto w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 bg-white rounded shadow-xl max-h-[85vh] overflow-hidden">
            <div class="p-5 border-b flex items-start justify-between">
                <div>
                    <div id="bbm_plan" class="text-xs text-blue-600"></div>
                    <div id="bbm_title" class="text-xl font-semibold text-gray-900"></div>
                    <div class="mt-2 flex items-center gap-3 text-sm text-gray-700">
                        <div id="bbm_labels" class="flex items-center gap-1"></div>
                    </div>
                </div>
                <button onclick="closeBoardBidModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-5 space-y-5 overflow-y-auto max-h-[75vh]">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Bucket</label>
                        <div id="bbm_bucket"></div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Progress</label>
                        <select id="bbm_progress" class="w-full border rounded px-3 py-2 text-sm">
                            <option>Not started</option>
                            <option>In progress</option>
                            <option>Completed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Priority</label>
                        <select id="bbm_priority" class="w-full border rounded px-3 py-2 text-sm">
                            <option>Low</option>
                            <option selected>Medium</option>
                            <option>High</option>
                            <option>Urgent</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Start date</label>
                        <input id="bbm_start" type="date" class="w-full border rounded px-3 py-2 text-sm" disabled>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Due date</label>
                        <input id="bbm_due" type="date" class="w-full border rounded px-3 py-2 text-sm" disabled>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Repeat</label>
                        <select id="bbm_repeat" class="w-full border rounded px-3 py-2 text-sm" disabled>
                            <option>Does not repeat</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Assign to Team</label>
                    <div class="flex flex-wrap gap-2 mb-2" id="bbm_team_assignees"></div>
                    <button type="button" id="bbm_assign_team_btn" class="px-3 py-1.5 text-xs rounded bg-gray-800 text-white hover:bg-gray-900">+ Assign Team Members</button>
                </div>

                <div>
                    <label class="block text-xs text-gray-500 mb-1">Notes</label>
                    <textarea id="bbm_notes" rows="4" class="w-full border rounded px-3 py-2 text-sm" placeholder="Write a note..."></textarea>
                    <div class="text-right mt-2">
                        <button id="bbm_save_notes" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">Save</button>
                    </div>
                </div>

                <div>
                    <div class="flex items-center justify-between">
                        <label class="block text-sm font-medium text-gray-700">Checklist</label>
                        <span id="bbm_check_counts" class="text-xs text-gray-500"></span>
                    </div>
                    <div id="bbm_checklist" class="mt-2 divide-y border rounded"></div>
                    <form id="bbm_add_task" class="mt-3 grid grid-cols-1 md:grid-cols-5 gap-2">
                        <input type="text" id="bbm_new_task" class="border rounded px-3 py-2 text-sm md:col-span-2" placeholder="Add an item">
                        <input type="date" id="bbm_new_due" class="border rounded px-3 py-2 text-sm">
                        <select id="bbm_assign_to" class="border rounded px-3 py-2 text-sm">
                            <option value="">Assign toâ€¦</option>
                        </select>
                        <button class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-sm">Add</button>
                    </form>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Attachments</label>
                    <div class="mt-2">
                        <input id="bbm_attach_file" type="file" class="hidden">
                        <button id="bbm_attach_btn" class="px-3 py-1.5 bg-gray-800 text-white rounded text-sm">Add attachment</button>
                        <div class="text-xs text-gray-500 mt-1">Attachment is saved as a checklist item linked to this bid.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Bid Summary Modal -->
<div id="bidSummaryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 id="modalTitle" class="text-lg font-semibold text-gray-900"></h3>
                    <button onclick="closeBidSummary()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
</div>

<!-- Assign Modal -->
<div id="assignModal" class="fixed inset-0 bg-gray-700 bg-opacity-50 hidden z-40">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <div>
                    <h3 class="text-xl font-semibold text-gray-900">Assign Task</h3>
                    <p class="text-sm text-gray-600">Assign this bid to one or more departments.</p>
                </div>
                <button type="button" class="text-gray-400 hover:text-gray-700" onclick="closeAssignModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="px-6 py-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bid</label>
                    <input id="assignBidName" type="text" readonly
                           class="w-full border border-gray-200 rounded-md px-3 py-2 bg-gray-50 text-gray-800">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Departments</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <label class="flex items-center gap-2 text-sm text-gray-700">
                            <input type="checkbox" value="business" class="assign-dept-checkbox">
                            Business (Business Manager)
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-700">
                            <input type="checkbox" value="design" class="assign-dept-checkbox">
                            Design (Design Manager)
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-700">
                            <input type="checkbox" value="operations" class="assign-dept-checkbox">
                            Operations (Operations Manager)
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-700">
                            <input type="checkbox" value="engineer" class="assign-dept-checkbox">
                            Engineer (Site Manager)
                        </label>
                    </div>
                    <div id="assignDeptChips" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start date</label>
                        <div class="relative">
                            <input type="date" id="assignStart" class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-400 hover:text-gray-600" onclick="focusDateInput(this)">
                                <i class="fas fa-calendar-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due date</label>
                        <div class="relative">
                            <input type="date" id="assignDue" class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-400 hover:text-gray-600" onclick="focusDateInput(this)">
                                <i class="fas fa-calendar-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="assignNotes" rows="3"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Add assignment notes (optional)"></textarea>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex -space-x-1" id="assignSelectedStages">
                        <div class="w-8 h-8 rounded-full bg-blue-50 border border-blue-200 flex items-center justify-center text-blue-600" title="Bid Analyzer">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-blue-50 border border-blue-200 flex items-center justify-center text-blue-600" title="Allocate">
                            <i class="fas fa-briefcase"></i>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-blue-50 border border-blue-200 flex items-center justify-center text-blue-600" title="Tasks">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-blue-50 border border-blue-200 flex items-center justify-center text-blue-600" title="Configure">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-blue-50 border border-blue-200 flex items-center justify-center text-blue-600" title="Closeout">
                            <i class="fas fa-handshake"></i>
                        </div>
                    </div>
                    <span class="text-xs text-gray-500">Current Stage: Bid Analyzer</span>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
                <button type="button" class="px-4 py-2 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200" onclick="closeAssignModal()">Cancel</button>
                <button type="button" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700" onclick="submitAssign()">Save</button>
            </div>
        </div>
    </div>
</div>
                <!-- Modal Content -->
                <div class="grid grid-cols-1 gap-6">
                    <!-- Key Points -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Key Points</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between gap-4">
                                <span class="font-medium text-gray-600">Company:</span>
                                <span id="modalCompany" class="text-gray-900 text-right"></span>
                            </div>
                            <div class="flex justify-between gap-4">
                                <span class="font-medium text-gray-600">Due Date:</span>
                                <span id="modalDueDate" class="text-gray-900 text-right"></span>
                            </div>
                            <div class="flex justify-between gap-4">
                                <span class="font-medium text-gray-600">Decision:</span>
                                <span id="modalDecision" class="text-gray-900 text-right"></span>
                            </div>
                            <div class="flex justify-between gap-4">
                                <span class="font-medium text-gray-600">Project Status:</span>
                                <span id="modalProjectStatus" class="text-gray-900 text-right"></span>
                            </div>
                            <div class="flex justify-between gap-4">
                                <span class="font-medium text-gray-600">Work Status:</span>
                                <span id="modalWorkStatus" class="text-gray-900 text-right"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Description (monospace + preserves alignment for tables/pipes) -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Description</h4>
                        <pre id="modalDescription" class="text-xs font-mono leading-relaxed whitespace-pre overflow-x-auto rounded border border-gray-200 bg-gray-50 p-4 max-h-[60vh]"></pre>
                    </div>
                    
                    
                </div>
                
                <!-- Modal Footer -->
                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                    <button onclick="closeBidSummary()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Parsed PDF Modal -->
    <div id="parsedPdfModal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden z-50">
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="bg-white w-full max-w-4xl rounded-lg shadow-xl">
                <div class="flex items-center justify-between border-b px-5 py-4">
                    <h3 id="parsedPdfModalTitle" class="text-lg font-semibold text-gray-900">Parsed PDF</h3>
                    <button type="button" class="text-gray-500 hover:text-gray-700" onclick="closeParsedPdfModal()">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                <div class="px-5 py-4 space-y-4">
                    <div id="parsedPdfStatus" class="text-sm text-gray-500">Select an RFP to parse.</div>
                    <div id="parsedPdfPageContainer" class="hidden max-h-[55vh] overflow-y-auto space-y-4 text-sm text-gray-800"></div>
                </div>
                <div class="flex items-center justify-between border-t px-5 py-4">
                    <div id="parsedPdfMeta" class="text-xs text-gray-500"></div>
                    <div class="flex items-center gap-2">
                        <button id="parsedPdfLoadMore" type="button" class="hidden px-3 py-1.5 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm" onclick="loadMoreParsedPdfPages()">Load more pages</button>
                        <button type="button" class="px-3 py-1.5 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm" onclick="closeParsedPdfModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection for real-time updates
        const socket = io();
        
        // Listen for permission changes from admin
        socket.on('permission_changed', function(data) {
            const userRole = '{{ user_role | default("") }}'.toLowerCase().replace(' ', '_');
            const affectedRoles = data.roles.map(r => r.toLowerCase().replace(' ', '_'));
            
            // Check if current user is affected
            if (affectedRoles.includes(userRole) || affectedRoles.includes(userRole.replace(' ', '_'))) {
                // Show notification
                showPermissionNotification(data.module, data.enabled);
                
                // If module was disabled, show warning
                if (!data.enabled) {
                    setTimeout(() => {
                        if (confirm('Your access permissions have changed. The page will refresh to apply the changes.')) {
                            location.reload();
                        }
                    }, 2000);
                }
            }
        });
        
        function showPermissionNotification(module, enabled) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-xl z-50 transition-all transform translate-x-full ${
                enabled ? 'bg-green-500' : 'bg-yellow-500'
            } text-white max-w-sm`;
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <i class="fas fa-${enabled ? 'check-circle' : 'exclamation-triangle'} text-xl"></i>
                    <div>
                        <p class="font-semibold">Permission ${enabled ? 'Enabled' : 'Changed'}</p>
                        <p class="text-sm opacity-90">${module.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} access has been ${enabled ? 'enabled' : 'updated'}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        // Bid IDs present in the table for computing per-bid progress
        const bidIds = [{% for bid in bids %}{{ bid.id }}{% if not loop.last %}, {% endif %}{% endfor %}];
        // Raw bids data for client-side board rendering
        const bidsData = {{ bids | tojson | safe }};
        const SHOW_TEAM_COLUMN = {{ 'true' if show_team_column else 'false' }};
        const IS_TEAM_LEAD_DASHBOARD = {{ 'true' if ((is_team_lead_dashboard is defined and is_team_lead_dashboard) or (request is defined and request.path and request.path.startswith('/team-lead'))) else 'false' }};
        const TEAM_KEY = '{{ team|default("") }}';
        const teamLeadCache = {};
        const parsedPdfState = {
            gId: null,
            nextStart: null,
            totalPages: 0,
            firstLoaded: null,
            lastLoaded: null,
        };

        function openParsedPdfModalFromEl(btn) {
            if (!btn) return;
            const gId = parseInt(btn.getAttribute('data-g-id'));
            const bidName = btn.getAttribute('data-bid-name') || 'RFP';
            if (!gId) {
                alert('Unable to determine the associated project.');
                return;
            }
            openParsedPdfModal(gId, bidName);
        }

        async function openParsedPdfModal(gId, bidName) {
            parsedPdfState.gId = gId;
            parsedPdfState.nextStart = null;
            parsedPdfState.totalPages = 0;
            parsedPdfState.firstLoaded = null;
            parsedPdfState.lastLoaded = null;

            const modal = document.getElementById('parsedPdfModal');
            const titleEl = document.getElementById('parsedPdfModalTitle');
            const statusEl = document.getElementById('parsedPdfStatus');
            const pageContainer = document.getElementById('parsedPdfPageContainer');
            const loadMoreBtn = document.getElementById('parsedPdfLoadMore');
            const metaEl = document.getElementById('parsedPdfMeta');

            if (titleEl) titleEl.textContent = `Parsed PDF â€“ ${bidName}`;
            if (pageContainer) {
                pageContainer.innerHTML = '';
                pageContainer.classList.add('hidden');
            }
            if (metaEl) metaEl.textContent = '';
            if (loadMoreBtn) loadMoreBtn.classList.add('hidden');
            if (statusEl) {
                statusEl.textContent = 'Loading pages...';
                statusEl.classList.remove('text-red-500', 'text-yellow-600');
                statusEl.classList.add('text-gray-500');
            }
            if (modal) modal.classList.remove('hidden');

            await fetchParsedPdfPages(gId, 1, false);
        }

        async function fetchParsedPdfPages(gId, startPage, append) {
            const statusEl = document.getElementById('parsedPdfStatus');
            const pageContainer = document.getElementById('parsedPdfPageContainer');
            const loadMoreBtn = document.getElementById('parsedPdfLoadMore');
            const metaEl = document.getElementById('parsedPdfMeta');

            if (!pageContainer) return;

            try {
                const response = await fetch(`/api/rfp-file/${gId}/parsed?start=${startPage}&limit=3`);
                if (!response.ok) {
                    let message = 'Failed to parse PDF.';
                    try {
                        const errJson = await response.json();
                        message = errJson.message || message;
                    } catch (_) {}
                    throw new Error(message);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.message || 'Failed to parse PDF.');
                }

                const pages = data.pages || [];
                parsedPdfState.nextStart = data.next_start || null;
                parsedPdfState.totalPages = data.total_pages || 0;

                if (!append) {
                    pageContainer.innerHTML = '';
                }

                if (!pages.length && !append) {
                    if (statusEl) {
                        statusEl.textContent = 'No text could be extracted from this PDF.';
                        statusEl.classList.remove('text-gray-500', 'text-red-500');
                        statusEl.classList.add('text-yellow-600');
                    }
                    pageContainer.classList.add('hidden');
                    if (loadMoreBtn) loadMoreBtn.classList.add('hidden');
                    if (metaEl) metaEl.textContent = '';
                    return;
                }

                if (statusEl) {
                    statusEl.textContent = '';
                    statusEl.classList.remove('text-yellow-600', 'text-red-500');
                    statusEl.classList.add('text-gray-500');
                }
                pageContainer.classList.remove('hidden');

                pages.forEach(page => {
                    const card = document.createElement('article');
                    card.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';

                    const header = document.createElement('header');
                    header.className = 'flex items-center justify-between mb-3';

                    const label = document.createElement('span');
                    label.className = 'text-sm font-semibold text-gray-700';
                    label.textContent = `Page ${page.number ?? '?'}`;

                    const chars = document.createElement('span');
                    chars.className = 'text-xs text-gray-400';
                    chars.textContent = `${page.characters || 0} characters`;

                    header.appendChild(label);
                    header.appendChild(chars);

                    const body = document.createElement('pre');
                    body.className = 'whitespace-pre-wrap text-sm leading-relaxed text-gray-800';
                    const textContent = (page.text || '').trim();
                    body.textContent = textContent || '[No text detected on this page]';

                    card.appendChild(header);
                    card.appendChild(body);
                    pageContainer.appendChild(card);

                    if (typeof page.number === 'number') {
                        if (parsedPdfState.firstLoaded === null || page.number < parsedPdfState.firstLoaded) {
                            parsedPdfState.firstLoaded = page.number;
                        }
                        if (parsedPdfState.lastLoaded === null || page.number > parsedPdfState.lastLoaded) {
                            parsedPdfState.lastLoaded = page.number;
                        }
                    }
                });

                if (loadMoreBtn) {
                    loadMoreBtn.classList.toggle('hidden', !parsedPdfState.nextStart);
                }

                if (metaEl) {
                    if (parsedPdfState.firstLoaded !== null && parsedPdfState.lastLoaded !== null) {
                        const totalTxt = parsedPdfState.totalPages ? parsedPdfState.totalPages : 'unknown';
                        metaEl.textContent = `Showing pages ${parsedPdfState.firstLoaded}-${parsedPdfState.lastLoaded} of ${totalTxt}`;
                    } else {
                        metaEl.textContent = '';
                    }
                }
            } catch (error) {
                if (statusEl) {
                    statusEl.textContent = error.message || 'Failed to parse PDF.';
                    statusEl.classList.remove('text-gray-500', 'text-yellow-600');
                    statusEl.classList.add('text-red-500');
                }
                if (loadMoreBtn) loadMoreBtn.classList.add('hidden');
            }
        }

        function loadMoreParsedPdfPages() {
            if (!parsedPdfState.gId || !parsedPdfState.nextStart) {
                return;
            }
            fetchParsedPdfPages(parsedPdfState.gId, parsedPdfState.nextStart, true);
        }

        function closeParsedPdfModal() {
            const modal = document.getElementById('parsedPdfModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Listen for master dashboard updates
        socket.on('master_update', function(data) {
            console.log('Received update:', data);
            
            // Add to activity log
            addToActivityLog(data.log);
            
            // Refresh page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        });

        function addToActivityLog(logData) {
            const logContainer = document.getElementById('activity-log');
            const logEntry = document.createElement('div');
            logEntry.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg';
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `
                <div class="flex-shrink-0">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                </div>
                <div class="flex-1">
                    <p class="text-sm text-gray-900">${logData.action}</p>
                    <p class="text-xs text-gray-500">${logData.user_email} â€¢ ${timestamp}</p>
                </div>
            `;
            
            // Add to top of log
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Keep only last 10 entries
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function advance(bidId, toStage) {
            if (!toStage) {
                return;
            }
            
            fetch(`/api/update_stage/${bidId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stage: toStage })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message briefly then reload
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    notification.textContent = data.success;
                    document.body.appendChild(notification);
                    
                    // Reload page to move bid to next team's dashboard
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating stage');
            });
        }

        function showBidSummary(bidId, bidName, company, dueDate, decision, projectStatus, workStatus, description) {
            // Populate modal with bid data
            document.getElementById('modalTitle').textContent = `${bidName} - Summary`;
            document.getElementById('modalCompany').textContent = company;
            document.getElementById('modalDueDate').textContent = dueDate;
            document.getElementById('modalDecision').textContent = decision;
            document.getElementById('modalProjectStatus').textContent = projectStatus;
            document.getElementById('modalWorkStatus').textContent = workStatus;
            document.getElementById('modalDescription').textContent = description;
            
            // Show modal
            document.getElementById('bidSummaryModal').classList.remove('hidden');
        }

        // Read values from data-* attributes to avoid inline argument quoting issues
        function showBidSummaryFromEl(btn) {
            const bidId = parseInt(btn.getAttribute('data-bid-id'));
            const bidName = btn.getAttribute('data-bid-name') || '';
            const company = btn.getAttribute('data-company') || 'N/A';
            const dueDate = btn.getAttribute('data-due-date') || 'N/A';
            const decision = btn.getAttribute('data-decision') || 'GO';
            const projectStatus = btn.getAttribute('data-project-status') || 'ongoing';
            const workStatus = btn.getAttribute('data-work-status') || '';
            const description = btn.getAttribute('data-description') || '';
            showBidSummary(bidId, bidName, company, dueDate, decision, projectStatus, workStatus, description);
        }

        function closeBidSummary() {
            document.getElementById('bidSummaryModal').classList.add('hidden');
        }

        // Assign modal logic
        let assignContext = { bidId: null, bidName: '' };
        function openAssignModalFromBtn(btn) {
            const bidId = parseInt(btn.getAttribute('data-assign-bid') || '0', 10);
            const name = btn.getAttribute('data-assign-name') || '';
            if (!bidId) return;
            assignContext = { bidId, bidName: name };
            document.getElementById('assignBidName').value = name;
            document.querySelectorAll('.assign-dept-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('assignDeptChips').innerHTML = '';
            document.getElementById('assignNotes').value = '';
            document.getElementById('assignStart').value = '';
            document.getElementById('assignDue').value = '';
            document.getElementById('assignModal').classList.remove('hidden');
        }
        function closeAssignModal() {
            document.getElementById('assignModal').classList.add('hidden');
        }
        document.querySelectorAll('[data-assign-bid]').forEach(btn => {
            btn.addEventListener('click', function() { openAssignModalFromBtn(this); });
        });
        document.querySelectorAll('.assign-dept-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                const chips = document.getElementById('assignDeptChips');
                const selected = Array.from(document.querySelectorAll('.assign-dept-checkbox')).filter(c => c.checked).map(c => c.value);
                chips.innerHTML = selected.map(s => `<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-200 text-xs">${s.replace('_',' ')}<button type="button" class="text-blue-500 hover:text-blue-700" onclick="toggleDept('${s}')"><i class="fas fa-times"></i></button></span>`).join('');
            });
        });
        function toggleDept(val) {
            document.querySelectorAll('.assign-dept-checkbox').forEach(cb => {
                if (cb.value === val) cb.checked = false;
            });
            const evt = new Event('change');
            document.querySelector('.assign-dept-checkbox')?.dispatchEvent(evt);
        }
        function showToast(message, tone) {
            const t = document.createElement('div');
            const colors = tone === 'error'
                ? 'bg-red-600 text-white'
                : tone === 'success'
                    ? 'bg-emerald-600 text-white'
                    : 'bg-slate-900 text-white';
            t.className = `fixed top-5 right-5 px-4 py-2 rounded shadow-lg z-50 text-sm ${colors}`;
            t.textContent = message;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        function submitAssign() {
            const selected = Array.from(document.querySelectorAll('.assign-dept-checkbox')).filter(c => c.checked).map(c => c.value);
            if (!assignContext.bidId || selected.length === 0) {
                showToast('Select at least one department to assign.', 'error');
                return;
            }
            // TODO: Hook up backend assignment + notifications per manager dashboard endpoints.
            closeAssignModal();
            showToast(`Assigned "${assignContext.bidName}" to: ${selected.join(', ')}`, 'info');
        }

        function viewDetails(bidId) {
            // For now, just show an alert. You can implement a modal or redirect to a details page
            showToast(`View details for bid ${bidId}`, 'info');
        }

        // Helper function to get next stage
        function getNextStage(currentStage) {
            const stageFlow = {
                'analyzer': 'business',
                'business': 'design',
                'design': 'operations',
                'operations': 'engineer',
                'engineer': 'handover'
            };
            return stageFlow[currentStage] || null;
        }

        // Manage Timeline modal (supervisor-like), but only allow next stages
        function showManageTimeline(bidId, currentStage) {
            const order = ['analyzer','business','design','operations','engineer','handover'];
            const idx = order.indexOf((currentStage || 'analyzer').toLowerCase());
            // Prefer dynamic stages from dataset if available
            let dynStages = [];
            const row = document.querySelector(`[data-bid-row="${bidId}"]`);
            if (row) {
                try { dynStages = JSON.parse(row.getAttribute('data-dyn-stages') || '[]'); } catch(e) { dynStages = []; }
            }
            let allowed;
            if (dynStages && dynStages.length) {
                const pos = dynStages.indexOf((currentStage || 'analyzer').toLowerCase());
                allowed = dynStages.slice(Math.max(pos + 1, 0));
            } else {
                allowed = order.slice(Math.max(idx + 1, 0));
            }
            const modalId = `manageTimelineModal_${bidId}`;
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white w-96 rounded-lg shadow-xl">
                        <div class="px-5 py-4 border-b flex items-center justify-between">
                            <h3 class="text-lg font-semibold">Manage Timeline</h3>
                            <button class="text-gray-500 hover:text-gray-700" onclick="document.getElementById('${modalId}').remove()">âœ•</button>
                        </div>
                        <div class="p-5 space-y-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Add Stage</label>
                                <div class="flex space-x-2">
                                    <input id="addStage_${bidId}" type="text" placeholder="Enter new stage (e.g., procurement)" class="flex-1 border rounded px-3 py-2" />
                                    <button class="px-3 py-2 bg-blue-600 text-white rounded" onclick="applyAddStage(${bidId})">Add</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Move to next stage</label>
                                <select id="nextStage_${bidId}" class="w-full border rounded px-3 py-2">
                                    ${allowed.map(s => `<option value="${s}">${s.replace('_',' ').replace(/\b\w/g, c=>c.toUpperCase())}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Delete Stage (after current only)</label>
                                <div class="flex space-x-2">
                                    <select id="delStage_${bidId}" class="flex-1 border rounded px-3 py-2">
                                        ${allowed.map(s => `<option value="${s}">${s.replace('_',' ').replace(/\b\w/g, c=>c.toUpperCase())}</option>`).join('')}
                                    </select>
                                    <button class="px-3 py-2 bg-red-600 text-white rounded" onclick="applyDeleteStage(${bidId})">Delete</button>
                                </div>
                            </div>
                        </div>
                        <div class="px-5 py-4 border-t flex justify-end space-x-2">
                            <button class="px-4 py-2 bg-gray-200 rounded" onclick="document.getElementById('${modalId}').remove()">Cancel</button>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="applyManageTimeline(${bidId})">Update Stage</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
        }

        function applyManageTimeline(bidId) {
            const select = document.getElementById(`nextStage_${bidId}`);
            if (!select) return;
            const selected = (select.value || '').toLowerCase();
            fetch(`/api/update_stage/${bidId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ stage: selected })
            })
            .then(async r => { try { return { ok: r.ok, data: await r.json() }; } catch { return { ok: r.ok, data: {} }; } })
            .then(({ ok, data }) => {
                if (ok && (data.success || Object.keys(data).length === 0)) {
                    const modal = document.getElementById(`manageTimelineModal_${bidId}`);
                    if (modal) modal.remove();
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(() => alert('Error updating stage'));
        }

        function applyAddStage(bidId) {
            const inp = document.getElementById(`addStage_${bidId}`);
            const val = (inp && inp.value || '').trim();
            if (!val) { alert('Please enter a stage name'); return; }
            const payload = new URLSearchParams({ g_id: bidId, new_stage: val });
            // Try team endpoint first
            fetch('/team/stage/add', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, credentials: 'include', body: payload })
            .then(async r => { if (r.ok) return { ok: true }; if (r.status === 404 || r.status === 403) return Promise.reject(r); return r.json(); })
            .then(() => location.reload())
            .catch(() => {
                // Fallback to supervisor endpoint (may redirect HTML)
                fetch('/supervisor/add-stage', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, credentials: 'include', body: payload })
                .then(r => { if (r.ok) location.reload(); else alert('Error adding stage'); })
                .catch(() => alert('Error adding stage'));
            });
        }

        function applyDeleteStage(bidId) {
            const sel = document.getElementById(`delStage_${bidId}`);
            const val = (sel && sel.value) || '';
            if (!val) { alert('Select a stage to delete'); return; }
            if (!confirm(`Delete stage "${val}"? This cannot be undone.`)) return;
            const payload = new URLSearchParams({ g_id: bidId, stage: val });
            fetch('/team/stage/delete', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, credentials: 'include', body: payload })
            .then(async r => { if (r.ok) return r.json(); if (r.status === 404 || r.status === 403) return Promise.reject(r); return r.json(); })
            .then(data => { if (data.ok) location.reload(); else alert('Error: ' + (data.error || 'Unable to delete stage')); })
            .catch(() => {
                fetch('/supervisor/delete-stage', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, credentials: 'include', body: payload })
                .then(r => { if (r.ok) location.reload(); else alert('Error deleting stage'); })
                .catch(() => alert('Error deleting stage'));
            });
        }


        function generateProposals(bidId, bidName, company) {
            // Navigate to proposals-making page with bid information
            const params = new URLSearchParams({
                bid_id: bidId,
                bid_name: bidName,
                company: company || ''
            });
            window.location.href = `/proposals-making?${params.toString()}`;
        }

        // Add event listeners for generate proposals buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.generate-proposals-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bidId = this.getAttribute('data-bid-id');
                    const bidName = this.getAttribute('data-bid-name');
                    const company = this.getAttribute('data-bid-company');
                    generateProposals(bidId, bidName, company);
                });
            });
        });


        let currentBidId = null;
        let teamEmployees = [];
        let teamLeads = [];

        // Format dates to MM-DD-YYYY format
        function formatDatesOnPage() {
            document.querySelectorAll('[data-date]').forEach(el => {
                const dateStr = el.getAttribute('data-date');
                if (dateStr && dateStr !== 'None' && dateStr !== '') {
                    try {
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const year = date.getFullYear();
                            el.textContent = `${month}-${day}-${year}`;
                        }
                    } catch (e) {
                        console.log('Date parse error:', e);
                    }
                }
            });
        }

        // Load team employees on page load and compute progress bars
        document.addEventListener('DOMContentLoaded', function() {
            formatDatesOnPage();
            // Always load employees (used by task assignment + Team Lead -> Employee assignment UI)
            loadTeamEmployees();
            // Manager view additionally needs Team Leads list (Manager -> Team Lead assignment UI)
            if (!IS_TEAM_LEAD_DASHBOARD) loadTeamLeads();
            loadAllBidProgress();
            wireBidInlineDetails();
            // After employees load, render planner-like assignee controls
            setTimeout(renderAssigneeControls, 300);
            // Grid/Board toggle
            const tabGrid = document.getElementById('tabGrid');
            const tabBoard = document.getElementById('tabBoard');
            const grid = document.getElementById('gridContainer');
            const board = document.getElementById('boardContainer');
            
            function setActiveTab(isGrid) {
                if (isGrid) {
                    tabGrid.classList.add('bg-gray-800', 'text-gray-100');
                    tabGrid.classList.remove('text-gray-300');
                    tabBoard.classList.remove('bg-gray-800', 'text-gray-100');
                    tabBoard.classList.add('text-gray-300');
                    grid.classList.remove('hidden');
                    board.classList.add('hidden');
                } else {
                    tabBoard.classList.add('bg-gray-800', 'text-gray-100');
                    tabBoard.classList.remove('text-gray-300');
                    tabGrid.classList.remove('bg-gray-800', 'text-gray-100');
                    tabGrid.classList.add('text-gray-300');
                    board.classList.remove('hidden');
                    grid.classList.add('hidden');
                }
            }
            
            if (tabGrid && tabBoard && grid && board) {
                tabGrid.addEventListener('click', () => setActiveTab(true));
                tabBoard.addEventListener('click', () => setActiveTab(false));
            }
            // Bucket filter for board
            const bucketFilter = document.getElementById('boardBucketFilter');
            if (bucketFilter) {
                bucketFilter.addEventListener('change', function() {
                    const val = this.value || '__all__';
                    document.querySelectorAll('[data-board-column]').forEach(col => {
                        const k = col.getAttribute('data-board-column');
                        if (val === '__all__' || val === k) col.classList.remove('hidden'); else col.classList.add('hidden');
                    });
                    renderBoard(currentGroupBy, val);
                });
            }
            // Group by select dropdown
            const groupBySelect = document.getElementById('groupBySelect');
            if (groupBySelect) {
                groupBySelect.addEventListener('change', function() {
                    currentGroupBy = this.value;
                    const currentFilter = (document.getElementById('boardBucketFilter')?.value) || '__all__';
                    renderBoard(currentGroupBy, currentFilter);
                });
            }
            // Initial board render
            renderBoard(currentGroupBy, '__all__');
        });

        // ============================================================================
        // Inline expandable Bid Details (inside grid row)
        // ============================================================================
        const bidInlineDetailsCache = {}; // bidId -> { loaded: boolean, html: string }

        function escHtml(s) {
            const str = (s === null || s === undefined) ? '' : String(s);
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function setExpandIcon(bidId, expanded) {
            const icon = document.querySelector(`[data-expand-icon="${bidId}"]`);
            const btn = document.querySelector(`[data-expand-bid="${bidId}"]`);
            if (btn) btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            if (icon) {
                if (expanded) icon.classList.add('rotate-90');
                else icon.classList.remove('rotate-90');
            }
        }

        function closeAllBidDetails(exceptBidId) {
            document.querySelectorAll('[data-bid-details-row]').forEach(row => {
                const bidId = parseInt(row.getAttribute('data-bid-details-row'));
                if (exceptBidId && bidId === exceptBidId) return;
                row.classList.add('hidden');
                setExpandIcon(bidId, false);
            });
        }

        function wireBidInlineDetails() {
            // Expand buttons
            document.querySelectorAll('[data-expand-bid]').forEach(btn => {
                if (btn.__wired) return;
                btn.__wired = true;
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const bidId = parseInt(btn.getAttribute('data-expand-bid'));
                    if (!bidId) return;
                    await toggleBidInlineDetails(bidId);
                });
            });

            // Close buttons inside details row
            document.querySelectorAll('[data-collapse-bid]').forEach(btn => {
                if (btn.__wired) return;
                btn.__wired = true;
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const bidId = parseInt(btn.getAttribute('data-collapse-bid'));
                    const row = document.querySelector(`[data-bid-details-row="${bidId}"]`);
                    if (row) row.classList.add('hidden');
                    setExpandIcon(bidId, false);
                });
            });
        }

        async function toggleBidInlineDetails(bidId) {
            const row = document.querySelector(`[data-bid-details-row="${bidId}"]`);
            const content = document.getElementById(`bidDetailsContent_${bidId}`);
            if (!row || !content) return;

            const isHidden = row.classList.contains('hidden');
            if (!isHidden) {
                row.classList.add('hidden');
                setExpandIcon(bidId, false);
                return;
            }

            // Open (accordion style: one at a time)
            closeAllBidDetails(bidId);
            row.classList.remove('hidden');
            setExpandIcon(bidId, true);

            // Render cached content if already loaded
            if (bidInlineDetailsCache[bidId] && bidInlineDetailsCache[bidId].loaded) {
                content.innerHTML = bidInlineDetailsCache[bidId].html;
                return;
            }

            // Skeleton
            content.innerHTML = `
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="p-4 rounded border border-gray-200 bg-gray-50">
                  <div class="h-4 w-40 bg-gray-200 rounded mb-3"></div>
                  <div class="h-3 w-full bg-gray-200 rounded mb-2"></div>
                  <div class="h-3 w-5/6 bg-gray-200 rounded"></div>
                </div>
                <div class="p-4 rounded border border-gray-200 bg-gray-50">
                  <div class="h-4 w-40 bg-gray-200 rounded mb-3"></div>
                  <div class="h-3 w-full bg-gray-200 rounded mb-2"></div>
                  <div class="h-3 w-3/4 bg-gray-200 rounded"></div>
                </div>
              </div>
            `;

            try {
                const TASKS_QUERY = (document.body && document.body.dataset && document.body.dataset.tasksScopeAll === '1') ? '?scope=all' : '';
                const tasksApiUrl = (id) => `/api/team/{{ team }}/bids/${id}/tasks${TASKS_QUERY}`;
                const [tasksRes, assigneesRes] = await Promise.all([
                    fetch(tasksApiUrl(bidId), { credentials: 'include' }),
                    fetch(`/api/bid/${bidId}/assignees`, { credentials: 'include' }),
                ]);

                const tasksJson = tasksRes.ok ? await tasksRes.json() : { tasks: [] };
                const assigneesJson = assigneesRes.ok ? await assigneesRes.json() : { ok: true, members: [] };

                const tasks = tasksJson.tasks || [];
                const members = assigneesJson.members || assigneesJson.assignees || [];

                const statsByEmp = {};
                const unassigned = { pending: 0, in_progress: 0, completed: 0, total: 0 };
                for (const t of tasks) {
                    const empId = t.assigned_to ? Number(t.assigned_to) : null;
                    const st = (t.status || 'pending').toLowerCase();
                    const key = (st === 'in_progress' || st === 'inprogress') ? 'in_progress' : (st === 'completed' ? 'completed' : 'pending');
                    if (!empId) {
                        unassigned.total += 1;
                        unassigned[key] += 1;
                    } else {
                        if (!statsByEmp[empId]) statsByEmp[empId] = { pending: 0, in_progress: 0, completed: 0, total: 0 };
                        statsByEmp[empId].total += 1;
                        statsByEmp[empId][key] += 1;
                    }
                }

                const bidObj = (Array.isArray(bidsData) ? bidsData.find(b => Number(b.id) === Number(bidId)) : null) || {};
                const bidName = bidObj.name || '';
                const company = bidObj.company || 'N/A';
                const due = bidObj.due_date || bidObj.task_completion_date || 'N/A';
                const created = bidObj.created_at || 'N/A';
                const stage = (bidObj.current_stage || '').replace(/_/g, ' ') || 'N/A';
                const summary = bidObj.summary || 'â€”';

                // ---- Team Lead view: show members working on the bid (not departments) ----
                // Managers/Supervisors: keep the department summary cards.
                let deptCards = '';
                let membersListHtml = '';

                if (IS_TEAM_LEAD_DASHBOARD) {
                    const items = (members || []).map(m => {
                        const empId = Number(m.id || m.employee_id);
                        const s = (empId && statsByEmp[empId]) ? statsByEmp[empId] : { pending: 0, in_progress: 0, completed: 0, total: 0 };
                        const name = m.name || m.email || ('Employee ' + (empId || ''));
                        const email = m.email || '';
                        return `
                          <div class="p-3 rounded border border-gray-200 bg-white flex items-start justify-between gap-3">
                            <div class="min-w-0">
                              <div class="text-sm font-semibold text-gray-900 truncate">${escHtml(name)}</div>
                              ${email ? `<div class="text-xs text-gray-500 truncate">${escHtml(email)}</div>` : ''}
                            </div>
                            <div class="shrink-0 text-right">
                              <div class="text-xs text-gray-600">${Number(s.total || 0)} tasks</div>
                              <div class="mt-1 flex items-center justify-end gap-1.5 text-[11px]">
                                <span class="px-2 py-0.5 rounded bg-yellow-100 text-yellow-800">${Number(s.pending || 0)} P</span>
                                <span class="px-2 py-0.5 rounded bg-blue-100 text-blue-800">${Number(s.in_progress || 0)} IP</span>
                                <span class="px-2 py-0.5 rounded bg-green-100 text-green-800">${Number(s.completed || 0)} C</span>
                              </div>
                            </div>
                          </div>
                        `;
                    }).join('');

                    membersListHtml = items || `<div class="text-sm text-gray-500">No team members assigned.</div>`;
                } else {
                    function normalizeDeptKey(raw) {
                        const s = (raw || '').toString().trim().toLowerCase().replace(/_/g, ' ');
                        if (!s) return 'unknown';
                        if (s.includes('business')) return 'business';
                        if (s.includes('design') || s.includes('marketing')) return 'design';
                        if (s.includes('operation')) return 'operations';
                        if (s.includes('engineer') || s.includes('site')) return 'engineer';
                        return 'other';
                    }
                    function deptLabel(key) {
                        const m = {
                            business: 'Business Development',
                            design: 'Design & Marketing',
                            operations: 'Operation Team',
                            engineer: 'Engineering Team',
                            other: 'Other',
                            unknown: 'Unknown',
                        };
                        return m[key] || (key || '').toString();
                    }

                    const empToDept = {};
                    const deptMembersCount = {};
                    const deptStats = {};

                    (members || []).forEach(m => {
                        const empId = Number(m.id || m.employee_id);
                        if (!empId) return;
                        const key = normalizeDeptKey(m.team_key || m.department);
                        empToDept[empId] = key;
                        deptMembersCount[key] = (deptMembersCount[key] || 0) + 1;
                        if (!deptStats[key]) deptStats[key] = { pending: 0, in_progress: 0, completed: 0, total: 0 };
                    });

                    Object.keys(statsByEmp).forEach(empIdStr => {
                        const empId = Number(empIdStr);
                        const key = empToDept[empId] || 'unknown';
                        if (!deptStats[key]) deptStats[key] = { pending: 0, in_progress: 0, completed: 0, total: 0 };
                        const s = statsByEmp[empId] || { pending: 0, in_progress: 0, completed: 0, total: 0 };
                        deptStats[key].pending += (s.pending || 0);
                        deptStats[key].in_progress += (s.in_progress || 0);
                        deptStats[key].completed += (s.completed || 0);
                        deptStats[key].total += (s.total || 0);
                    });

                    // IMPORTANT: Only show departments that are enabled in the bid's Timeline (Team Allocation & Decision Making).
                    // team_dashboard backend attaches bidObj.dyn_stages (dynamic timeline stages), so use that to filter depts here.
                    const deptOrder = ['business', 'design', 'operations', 'engineer'];
                    const timelineStagesRaw = Array.isArray(bidObj.dyn_stages) ? bidObj.dyn_stages : [];
                    const timelineDeptKeys = (timelineStagesRaw || [])
                        .map(s => (s || '').toString().trim().toLowerCase().replace(/_/g, ' '))
                        .filter(s => s && s !== 'analyzer')
                        .map(s => {
                            if (s.includes('business')) return 'business';
                            if (s.includes('design') || s.includes('marketing')) return 'design';
                            if (s.includes('operation')) return 'operations';
                            if (s.includes('engineer') || s.includes('site')) return 'engineer';
                            return null; // custom stages are not departments
                        })
                        .filter(Boolean);
                    const allowedDeptSet = new Set(timelineDeptKeys);
                    const deptKeys = deptOrder.filter(k => allowedDeptSet.has(k));

                    deptCards = (deptKeys || []).map(k => {
                        const s = deptStats[k] || { pending: 0, in_progress: 0, completed: 0, total: 0 };
                        const pct = s.total ? Math.round((s.completed / s.total) * 100) : 0;
                        const memberCount = deptMembersCount[k] || 0;
                        return `
                          <div class="p-3 rounded border border-gray-200 bg-white">
                            <div class="flex items-start justify-between gap-3">
                              <div class="min-w-0">
                                <div class="text-sm font-semibold text-gray-900 truncate">${escHtml(deptLabel(k))}</div>
                                <div class="text-xs text-gray-500">${memberCount ? `${memberCount} member${memberCount === 1 ? '' : 's'}` : 'No members'}</div>
                              </div>
                              <div class="text-xs text-gray-700 font-semibold">${pct}%</div>
                            </div>
                            <div class="mt-2 w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                              <div class="h-2 bg-emerald-600" style="width:${pct}%"></div>
                            </div>
                          </div>
                        `;
                    }).join('');
                }

                // In this table, "Due" should reflect the BID due date (not per-task due date).
                let bidDueForTasks = '';
                try {
                    bidDueForTasks = (bidObj && (bidObj.due_date || bidObj.task_completion_date)) ? String(bidObj.due_date || bidObj.task_completion_date) : '';
                } catch (e) { bidDueForTasks = ''; }

                const tasksRows = (tasks || []).slice(0, 25).map(t => {
                    const st = (t.status || 'pending').toLowerCase();
                    const badge = st === 'completed'
                        ? 'bg-green-100 text-green-800'
                        : (st === 'in_progress' || st === 'inprogress')
                            ? 'bg-blue-100 text-blue-800'
                            : 'bg-yellow-100 text-yellow-800';
                    const due = (bidDueForTasks || '').toString();
                    let pct = 0;
                    try { pct = Number(t.progress_pct ?? t.progressPct ?? 0) || 0; } catch (e) { pct = 0; }
                    if (st === 'completed' && pct < 100) pct = 100;
                    if (pct < 0) pct = 0;
                    if (pct > 100) pct = 100;
                    const stageKey = (t.stage || '').toString().trim().toLowerCase();
                    const bidIdNum = Number(bidId);
                    return `
                      <tr class="border-b">
                        <td class="py-2 pr-3">
                          <div class="text-sm font-medium text-gray-900">${escHtml(t.task_name || '')}</div>
                          <div class="text-xs text-gray-500">${escHtml(t.description || '')}</div>
                        </td>
                        <td class="py-2 pr-3 text-xs text-gray-700">${escHtml(t.assigned_employee_name || 'Unassigned')}</td>
                        <td class="py-2 pr-3"><span class="px-2 py-0.5 rounded text-xs ${badge}">${escHtml(t.status || 'pending')}</span></td>
                        <td class="py-2 pr-3 text-xs text-gray-700">${escHtml(t.priority || '')}</td>
                        <td class="py-2 pr-3 text-xs text-gray-700">${escHtml(due ? due.substring(0, 10) : 'N/A')}</td>
                        <td class="py-2 pr-3">
                          <div class="flex items-center gap-2">
                            <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                              <div class="h-2 bg-emerald-600" style="width:${pct}%"></div>
                            </div>
                            <div class="text-[11px] text-gray-600 w-10 text-right">${pct}%</div>
                          </div>
                        </td>
                        <td class="py-2 pr-3 text-xs text-gray-500">${escHtml(stageKey || '')}</td>
                        <td class="py-2 text-xs">
                          <div class="flex flex-wrap gap-1.5 justify-end">
                            <button type="button"
                              class="px-2 py-1 rounded bg-slate-900 hover:bg-slate-800 text-white text-[11px] font-semibold"
                              onclick="bmAssignTaskEmployee(${bidIdNum}, ${Number(t.id)}, '${escHtml(stageKey)}')">Assign</button>
                            <button type="button"
                              class="px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-700 text-white text-[11px] font-semibold"
                              onclick="bmAssignTaskTeamLead(${bidIdNum}, '${escHtml(stageKey)}')">Team Lead</button>
                            <button type="button"
                              class="px-2 py-1 rounded bg-amber-500 hover:bg-amber-600 text-white text-[11px] font-semibold"
                              onclick="bmAddTaskComment(${bidIdNum}, ${Number(t.id)})">Comment</button>
                            <input type="file" class="hidden" id="bm_task_file_${bidIdNum}_${Number(t.id)}"
                                   onchange="bmUploadTaskAttachment(${bidIdNum}, ${Number(t.id)}, this.files && this.files[0])" />
                            <button type="button"
                              class="px-2 py-1 rounded bg-teal-600 hover:bg-teal-700 text-white text-[11px] font-semibold"
                              onclick="(function(){ const el=document.getElementById('bm_task_file_${bidIdNum}_${Number(t.id)}'); if(el) el.click(); })()">Attach</button>
                            <button type="button"
                              class="px-2 py-1 rounded bg-purple-600 hover:bg-purple-700 text-white text-[11px] font-semibold"
                              onclick="viewTaskSubmissions(${Number(t.id)}, ${JSON.stringify(t.task_name || '')})">View</button>
                          </div>
                        </td>
                      </tr>
                    `;
                }).join('');

                // Unassigned tasks panel removed per UI requirement
                const unassignedBlock = '';

                const html = `
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="p-4 rounded border border-gray-200 bg-white">
                      <div class="text-sm font-semibold text-gray-900 mb-2">Bid info</div>
                      <div class="grid grid-cols-1 gap-1 text-sm">
                        <div class="flex justify-between gap-3"><span class="text-gray-500">Name</span><span class="text-gray-900 font-medium text-right">${escHtml(bidName)}</span></div>
                        <div class="flex justify-between gap-3"><span class="text-gray-500">Company</span><span class="text-gray-900 text-right">${escHtml(company)}</span></div>
                        <div class="flex justify-between gap-3"><span class="text-gray-500">Due</span><span class="text-gray-900 text-right">${escHtml(due)}</span></div>
                        <div class="flex justify-between gap-3"><span class="text-gray-500">Created</span><span class="text-gray-900 text-right">${escHtml(created)}</span></div>
                        <div class="flex justify-between gap-3"><span class="text-gray-500">Stage</span><span class="text-gray-900 text-right">${escHtml(stage)}</span></div>
                      </div>
                    </div>

                    <div class="p-4 rounded border border-gray-200 bg-white">
                      <div class="text-sm font-semibold text-gray-900 mb-2">${IS_TEAM_LEAD_DASHBOARD ? 'Members working on this' : 'Departments working on this'}</div>
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${IS_TEAM_LEAD_DASHBOARD ? membersListHtml : (deptCards || `<div class="text-sm text-gray-500">No departments assigned.</div>`)}
                      </div>
                    </div>
                  </div>

                  <div class="mt-4 p-4 rounded border border-gray-200 bg-white">
                    <div class="flex items-center justify-between mb-2">
                      <div class="text-sm font-semibold text-gray-900">Tasks (status / type / progress)</div>
                      <div class="text-xs text-gray-500"><span id="bidTasksCount_${bidId}">${tasks.length}</span> total</div>
                    </div>
                    <div class="overflow-x-auto">
                      <table class="w-full">
                        <thead class="text-xs text-gray-600 border-b">
                          <tr>
                            <th class="py-2 pr-3 text-left">Task</th>
                            <th class="py-2 pr-3 text-left">Assignee</th>
                            <th class="py-2 pr-3 text-left">Status</th>
                            <th class="py-2 pr-3 text-left">Priority</th>
                            <th class="py-2 pr-3 text-left">Due</th>
                            <th class="py-2 pr-3 text-left">Progress</th>
                            <th class="py-2 pr-3 text-left">Type</th>
                            <th class="py-2 text-right">Actions</th>
                          </tr>
                        </thead>
                        <tbody id="bidTasksTbody_${bidId}">
                          ${tasksRows || `<tr><td class="py-3 text-sm text-gray-500" colspan="9">No tasks found for this bid.</td></tr>`}
                        </tbody>
                      </table>
                      ${tasks.length > 25 ? `<div class="mt-2 text-xs text-gray-500">Showing first 25 tasks.</div>` : ''}
                    </div>
                  </div>
                `;

                bidInlineDetailsCache[bidId] = { loaded: true, html };
                content.innerHTML = html;
            } catch (e) {
                content.innerHTML = `<div class="text-sm text-red-600">Failed to load details. ${escHtml(e.message || e)}</div>`;
            }
        }

        function loadAllBidProgress() {
            bidIds.forEach(id => loadBidProgress(id));
        }

        function loadBidProgress(bidId) {
            const TASKS_QUERY = (document.body && document.body.dataset && document.body.dataset.tasksScopeAll === '1') ? '?scope=all' : '';
            fetch(`/api/team/{{ team }}/bids/${bidId}/tasks${TASKS_QUERY}`)
                .then(response => response.json())
                .then(data => {
                    const tasks = data.tasks || [];
                    let pct = 0;
                    if (tasks.length > 0) {
                        const completed = tasks.filter(t => t.status === 'completed').length;
                        pct = Math.round((completed / tasks.length) * 100);
                    }
                    // Keep actual pct based on tasks for this team only
                    const bar = document.getElementById(`progressBarRow_${bidId}`);
                    const txt = document.getElementById(`progressPctRow_${bidId}`);
                    if (bar) bar.style.width = `${pct}%`;
                    if (txt) txt.textContent = `${pct}%`;
                    const boardTxt = document.getElementById(`boardPct_${bidId}`);
                    if (boardTxt) boardTxt.textContent = `${pct}%`;
                    // Update overview table progress if present
                    const oBar = document.getElementById(`overviewProgressBar_${bidId}`);
                    const oTxt = document.getElementById(`overviewProgressPct_${bidId}`);
                    if (oBar) oBar.style.width = `${pct}%`;
                    if (oTxt) oTxt.textContent = `${pct}%`;
                    // Set bucket label independently based on pct
                    const lbl = document.getElementById(`bucketLabel_${bidId}`);
                    const oLbl = document.getElementById(`overviewStatus_${bidId}`);
                    if (lbl) {
                        let text, cls;
                        if (pct >= 100) { text = 'Completed'; cls = 'bg-emerald-100 text-emerald-700 border border-emerald-200'; }
                        else if (pct > 0) { text = 'In Progress'; cls = 'bg-amber-100 text-amber-700 border border-amber-200'; }
                        else { text = 'Ready To Start'; cls = 'bg-indigo-100 text-indigo-700 border border-indigo-200'; }
                        lbl.textContent = text;
                        lbl.className = `px-2 py-1 rounded-full text-xs ${cls}`;
                    }
                    if (oLbl) {
                        let text, cls;
                        if (pct >= 100) { text = 'Completed'; cls = 'bg-emerald-100 text-emerald-700 border border-emerald-200'; }
                        else if (pct > 0) { text = 'In Progress'; cls = 'bg-amber-100 text-amber-700 border border-amber-200'; }
                        else { text = 'Ready To Start'; cls = 'bg-indigo-100 text-indigo-700 border border-indigo-200'; }
                        oLbl.textContent = text;
                        oLbl.className = `px-2 py-1 rounded-full text-xs ${cls}`;
                    }
                })
                .catch(err => {
                    console.error('Error loading bid progress', bidId, err);
                });
        }

        // --- Board rendering ---
        let currentGroupBy = 'bucket';
        const stageDisplay = {
            analyzer: 'Planned / Ready to Start',
            business: 'Idea / Backlog',
            design: 'In Progress',
            operations: 'Under Review / QA',
            engineer: 'On Hold / Blocked',
            handover: 'Submitted'
        };
        const stageIcon = {
            analyzer: 'fa-clipboard-list text-amber-400',
            business: 'fa-lightbulb text-pink-400',
            design: 'fa-hourglass-half text-yellow-400',
            operations: 'fa-vial text-blue-400',
            engineer: 'fa-circle-pause text-rose-400',
            handover: 'fa-check-double text-emerald-400'
        };

        async function getBidPct(bidId) {
            try {
                const TASKS_QUERY = (document.body && document.body.dataset && document.body.dataset.tasksScopeAll === '1') ? '?scope=all' : '';
                const r = await fetch(`/api/team/{{ team }}/bids/${bidId}/tasks${TASKS_QUERY}`);
                const d = await r.json();
                const tasks = d.tasks || [];
                if (!tasks.length) return 0;
                const completed = tasks.filter(t => (t.status||'').toLowerCase()==='completed').length;
                return Math.round((completed / tasks.length) * 100);
            } catch { return 0; }
        }

        async function renderBoard(groupBy, bucketFilterVal) {
            const container = document.getElementById('boardColumns');
            if (!container) return;
            container.innerHTML = '';
            let columns = [];
            if (groupBy === 'assignee') {
                const names = Array.from(new Set((bidsData || []).map(b => (b.person_name || 'Unassigned')))).sort((a,b)=>a.localeCompare(b));
                columns = names.map(n => ({ key: n, label: n, icon: 'fa-user text-blue-300' }));
            } else {
                // Bucket-based columns (Ready, In Progress, Completed)
                columns = [
                    { key: 'ready', label: 'Planned / Ready to Start', icon: 'fa-lock text-amber-300' },
                    { key: 'inprogress', label: 'In Progress', icon: 'fa-hourglass-half text-yellow-300' },
                    { key: 'completed', label: 'Completed (This Month)', icon: 'fa-check-double text-emerald-300' },
                ];
            }

            columns.forEach(col => {
                const colDiv = document.createElement('div');
                colDiv.className = 'bg-white rounded-lg border border-gray-200 shadow-sm flex-1 min-w-0';
                colDiv.setAttribute('data-board-column', col.key);
                colDiv.innerHTML = `
                    <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 text-gray-700 flex items-center gap-2 text-sm rounded-t-lg">
                        <i class="fa-solid ${col.icon}"></i>
                        <span class="font-semibold">${col.label}</span>
                        <span class="ml-auto text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full" data-card-count>0</span>
                    </div>
                    <div class="p-3 space-y-3 max-h-[calc(100vh-280px)] overflow-y-auto" data-cards></div>
                `;
                container.appendChild(colDiv);
            });

            const thisTeam = '{{ team }}'.toLowerCase();
            const cardCounts = {};
            
            for (const bid of (bidsData || [])) {
                let colKey;
                if (groupBy === 'assignee') {
                    colKey = (bid.person_name || 'Unassigned');
                } else {
                    const pct = await getBidPct(bid.id);
                    if (pct >= 100) colKey = 'completed';
                    else if (pct > 0) colKey = 'inprogress';
                    else colKey = 'ready';
                    if (bucketFilterVal && bucketFilterVal !== '__all__' && colKey !== bucketFilterVal) continue;
                }
                
                cardCounts[colKey] = (cardCounts[colKey] || 0) + 1;
                
                const targetCol = Array.from(document.querySelectorAll('[data-board-column]')).find(c => c.getAttribute('data-board-column') === colKey);
                if (!targetCol) continue;
                const cards = targetCol.querySelector('[data-cards]');
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-md p-3 cursor-pointer transition-all';
                const due = bid.due_date || '';
                const company = bid.company || '';
                const summary = bid.summary || '';
                const members = bid.assigned_members || [];
                const type = bid.type || '';
                const state = bid.state || '';
                
                // Fetch checklist for this bid
                const taskData = await getBidTasksPreview(bid.id);
                const totalTasks = taskData.total || 0;
                const completedTasks = taskData.completed || 0;
                const previewTasks = taskData.preview || [];
                
                // Build tags HTML
                let tagsHtml = '<div class="flex flex-wrap gap-1.5 mb-3">';
                if (type) {
                    tagsHtml += `<span class="px-2 py-0.5 rounded text-[10px] font-medium bg-indigo-100 text-indigo-700 border border-indigo-200">${type}</span>`;
                }
                if (company) {
                    const companyColor = company.toLowerCase().includes('ikio') ? 'emerald' : 
                                        company.toLowerCase().includes('metco') ? 'violet' : 
                                        company.toLowerCase().includes('sunsprint') ? 'amber' : 'sky';
                    tagsHtml += `<span class="px-2 py-0.5 rounded text-[10px] font-medium bg-${companyColor}-100 text-${companyColor}-700 border border-${companyColor}-200">${company}</span>`;
                }
                if (state) {
                    const stateColor = state.toLowerCase() === 'design' ? 'pink' : 
                                      state.toLowerCase() === 'operations' ? 'orange' : 
                                      state.toLowerCase() === 'business' ? 'cyan' : 'gray';
                    tagsHtml += `<span class="px-2 py-0.5 rounded text-[10px] font-medium bg-${stateColor}-100 text-${stateColor}-700 border border-${stateColor}-200">${state}</span>`;
                }
                tagsHtml += '</div>';
                
                // Build checklist preview HTML (show up to 4 items)
                let checklistHtml = '';
                if (previewTasks.length > 0) {
                    checklistHtml = '<div class="space-y-2 mb-3 border-t border-gray-100 pt-3">';
                    previewTasks.slice(0, 4).forEach(task => {
                        const isCompleted = task.status === 'completed';
                        checklistHtml += `
                            <label class="flex items-start gap-2.5 text-xs cursor-pointer group ${isCompleted ? 'text-gray-400' : 'text-gray-700'}" onclick="event.stopPropagation();">
                                <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                       class="task-checkbox mt-0.5" 
                                       onchange="event.stopPropagation(); toggleTaskFromCard(${task.id}, this.checked)">
                                <span class="${isCompleted ? 'line-through' : ''} leading-tight group-hover:text-blue-600 transition-colors">${escapeHtml(task.task_name)}</span>
                            </label>
                        `;
                    });
                    if (totalTasks > 4) {
                        checklistHtml += `<div class="text-[10px] text-gray-400 pl-6 mt-1">+${totalTasks - 4} more items</div>`;
                    }
                    checklistHtml += '</div>';
                }
                
                // Build assigned members HTML
                let membersHtml = '';
                if (IS_TEAM_LEAD_DASHBOARD) {
                    if (members.length > 0) {
                        const displayMembers = members.slice(0, 3);
                        const extraCount = members.length - 3;
                        membersHtml = '<div class="flex items-center gap-2" data-board-assignees>';
                        membersHtml += '<div class="flex items-center avatar-stack">';
                        displayMembers.forEach((m, idx) => {
                            const colors = ['bg-blue-600', 'bg-emerald-600', 'bg-violet-600', 'bg-amber-600', 'bg-rose-600', 'bg-cyan-600'];
                            membersHtml += `<span class="inline-flex items-center justify-center w-7 h-7 rounded-full ${colors[idx % colors.length]} text-white text-[10px] font-medium border-2 border-white shadow-sm" title="${m.name}">${getInitials(m.name)}</span>`;
                        });
                        if (extraCount > 0) {
                            membersHtml += `<span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-gray-400 text-white text-[10px] font-medium border-2 border-white shadow-sm">+${extraCount}</span>`;
                        }
                        membersHtml += '</div>';
                        membersHtml += `<button type="button" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-200 flex items-center justify-center" title="Assign employees" data-board-assign-btn data-bid-id="${bid.id}">
                            <i class="fa-solid fa-plus text-[10px]"></i>
                        </button>`;
                        membersHtml += '</div>';
                    } else {
                        membersHtml = `<div class="flex items-center gap-2" data-board-assignees>
                            <div class="text-[10px] text-gray-400">Unassigned</div>
                            <button type="button" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-200 flex items-center justify-center" title="Assign employees" data-board-assign-btn data-bid-id="${bid.id}">
                                <i class="fa-solid fa-plus text-[10px]"></i>
                            </button>
                        </div>`;
                    }
                } else {
                    const teamLeads = await fetchTeamLeadForBid(bid.id);
                    const tlHtml = (teamLeads && teamLeads.length)
                        ? teamLeads.map(tl => teamLeadBadgeHtml(bid.id, tl)).join('')
                        : '<span class="text-[10px] text-gray-400">Unassigned</span>';
                    const displayMembers = members.slice(0, 3);
                    const extraCount = members.length - 3;
                    let memberRow = '<div class="flex items-center gap-1 flex-wrap">';
                    memberRow += '<span class="text-[10px] text-gray-500">Members</span>';
                    if (members.length > 0) {
                        memberRow += '<div class="flex items-center avatar-stack">';
                        displayMembers.forEach((m, idx) => {
                            const colors = ['bg-blue-600', 'bg-emerald-600', 'bg-violet-600', 'bg-amber-600', 'bg-rose-600', 'bg-cyan-600'];
                            memberRow += `<span class="inline-flex items-center justify-center w-7 h-7 rounded-full ${colors[idx % colors.length]} text-white text-[10px] font-medium border-2 border-white shadow-sm" title="${m.name}">${getInitials(m.name)}</span>`;
                        });
                        if (extraCount > 0) {
                            memberRow += `<span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-gray-400 text-white text-[10px] font-medium border-2 border-white shadow-sm">+${extraCount}</span>`;
                        }
                        memberRow += '</div>';
                    } else {
                        memberRow += '<span class="text-[10px] text-gray-400">-</span>';
                    }
                    memberRow += '</div>';
                    membersHtml = `<div class="flex flex-col gap-1" data-board-assignees>
                        <div class="flex items-center gap-1 flex-wrap">
                            <span class="text-[10px] text-gray-500">Team Lead</span>
                            ${tlHtml}
                            <button type="button" class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-200 flex items-center justify-center" title="Assign team lead" data-board-assign-btn data-bid-id="${bid.id}">
                                <i class="fa-solid fa-plus text-[10px]"></i>
                            </button>
                        </div>
                        ${memberRow}
                    </div>`;
                }
                
                // Progress indicator
                const progressHtml = totalTasks > 0 ? 
                    `<div class="flex items-center gap-1.5 text-xs ${completedTasks === totalTasks ? 'text-emerald-600' : 'text-gray-500'}">
                        <i class="fa-regular fa-circle-check"></i>
                        <span class="font-medium">${completedTasks} / ${totalTasks}</span>
                    </div>` : '';
                
                // Due date formatting
                let dueDateHtml = '';
                if (due) {
                    const dueDate = new Date(due);
                    const today = new Date();
                    const isOverdue = dueDate < today;
                    const isToday = dueDate.toDateString() === today.toDateString();
                    const dateStr = dueDate.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
                    const dateColor = isOverdue ? 'text-red-600 bg-red-50' : isToday ? 'text-amber-600 bg-amber-50' : 'text-gray-500 bg-gray-50';
                    dueDateHtml = `<div class="flex items-center gap-1 px-2 py-1 rounded ${dateColor} text-[10px]">
                        <i class="fa-regular fa-calendar"></i>
                        <span>${dateStr}</span>
                    </div>`;
                }
                
                card.innerHTML = `
                    ${tagsHtml}
                    <div class="font-semibold text-sm text-gray-900 mb-2 leading-tight">${bid.name || ''}</div>
                    ${summary ? `<div class="text-xs text-gray-600 mb-3 line-clamp-2">${summary}</div>` : ''}
                    ${checklistHtml}
                    <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                        <div class="flex items-center gap-2">
                            ${membersHtml}
                        </div>
                        <div class="flex items-center gap-2">
                            ${progressHtml}
                        </div>
                    </div>
                    ${dueDateHtml ? `<div class="mt-2">${dueDateHtml}</div>` : ''}
                `;
                // Allow assignment directly from board cards (works in manager iframe too)
                const assignBtn = card.querySelector('[data-board-assign-btn]');
                if (assignBtn) {
                    assignBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openAssigneeMenu(parseInt(assignBtn.getAttribute('data-bid-id')), assignBtn);
                    });
                }
                const assigneesArea = card.querySelector('[data-board-assignees]');
                if (assigneesArea && !assignBtn) {
                    assigneesArea.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openAssigneeMenu(bid.id, assigneesArea);
                    });
                }
                card.addEventListener('click', () => openBoardBidModal(bid));
                cards.appendChild(card);
            }
            
            // Update card counts
            Object.keys(cardCounts).forEach(key => {
                const col = document.querySelector(`[data-board-column="${key}"]`);
                if (col) {
                    const countEl = col.querySelector('[data-card-count]');
                    if (countEl) countEl.textContent = cardCounts[key];
                }
            });
        }
        
        // Helper function to get tasks preview for a bid
        async function getBidTasksPreview(bidId) {
            try {
                const r = await fetch(`/api/team/{{ team }}/bids/${bidId}/tasks`);
                const d = await r.json();
                const tasks = d.tasks || [];
                const completed = tasks.filter(t => (t.status||'').toLowerCase()==='completed').length;
                return {
                    total: tasks.length,
                    completed: completed,
                    preview: tasks.slice(0, 5)
                };
            } catch { return { total: 0, completed: 0, preview: [] }; }
        }
        
        // Helper to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Toggle task status from card checkbox
        function toggleTaskFromCard(taskId, isCompleted) {
            const newStatus = isCompleted ? 'completed' : 'pending';
            fetch(`/task/${taskId}/update_status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `status=${newStatus}`
            }).then(r => r.json()).then(d => {
                if (d.success) {
                    // Refresh board after short delay
                    setTimeout(() => renderBoard(currentGroupBy, '__all__'), 500);
                }
            }).catch(err => console.error('Error updating task:', err));
        }

        function loadTeamEmployees() {
            fetch(`/api/team/{{ team }}/employees`)
            .then(response => response.json())
            .then(data => {
                teamEmployees = data.employees || [];
                populateEmployeeSelect();
            })
            .catch(error => {
                console.error('Error loading employees:', error);
            });
        }

        function loadTeamLeads() {
            fetch(`/api/team/{{ team }}/team-leads`)
            .then(response => response.json())
            .then(data => {
                teamLeads = (data.team_leads || []).map(t => ({
                    id: t.id,
                    email: t.email,
                    role: t.role
                }));
                // Trigger render once loaded
                renderAssigneeControls();
            })
            .catch(error => {
                console.error('Error loading team leads:', error);
            });
        }

        function populateEmployeeSelect() {
            const select = document.getElementById('assigned_to');
            select.innerHTML = '<option value="">Select Employee</option>';
            teamEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                select.appendChild(option);
            });
        }

        // --- Planner-style assignees UI ---
        function getInitials(name){
            if(!name) return 'U';
            const parts = name.trim().split(/\s+/);
            return (parts[0]?.[0]||'U') + (parts[1]?.[0]||'');
        }
        function formatTeamLeadDate(dateVal){
            if (!dateVal) return '';
            if (typeof dateVal === 'string') {
                const isoMatch = dateVal.match(/\d{4}-\d{2}-\d{2}/);
                if (isoMatch) return isoMatch[0];
            }
            try {
                const dt = new Date(dateVal);
                if (!isNaN(dt)) {
                    const y = dt.getFullYear();
                    const m = String(dt.getMonth() + 1).padStart(2, '0');
                    const d = String(dt.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                }
            } catch (e) {}
            return '';
        }
        function renderTeamChips(){
            if (!SHOW_TEAM_COLUMN) return;
            document.querySelectorAll('[data-teams]').forEach(cell => {
                const bidId = parseInt(cell.getAttribute('data-bid-id'));
                const bid = (bidsData||[]).find(b => b.id === bidId) || {};
                const members = bid.assigned_members || [];
                const teams = [];
                members.forEach(m => {
                    const t = (m.team_key || m.department || '').toString().trim().toLowerCase();
                    if (t && !teams.includes(t)) teams.push(t);
                });
                cell.innerHTML = '';
                if (!teams.length) {
                    const empty = document.createElement('span');
                    empty.className = 'text-[10px] text-gray-500';
                    empty.textContent = 'â€”';
                    cell.appendChild(empty);
                    return;
                }
                const wrap = document.createElement('div');
                wrap.className = 'flex flex-wrap gap-1';
                teams.forEach(t => {
                    const chip = document.createElement('span');
                    chip.className = 'px-1.5 py-0.5 rounded-full text-[10px] bg-slate-100 text-slate-700 border border-slate-200';
                    chip.textContent = (t === 'engineer') ? 'Engineer' : (t.charAt(0).toUpperCase() + t.slice(1));
                    wrap.appendChild(chip);
                });
                cell.appendChild(wrap);
            });
        }
        function fetchTeamLeadForBid(bidId){
            if (Object.prototype.hasOwnProperty.call(teamLeadCache, bidId)) {
                return Promise.resolve(teamLeadCache[bidId]);
            }
            return fetch(`/api/bid/${bidId}/team-lead`)
                .then(r => r.json())
                .then(d => {
                    const tls = (d && d.ok) ? (d.team_leads || (d.team_lead ? [d.team_lead] : [])) : [];
                    teamLeadCache[bidId] = tls;
                    return tls;
                })
                .catch(() => {
                    teamLeadCache[bidId] = [];
                    return [];
                });
        }
        function renderAssigneeControls(){
            if (IS_TEAM_LEAD_DASHBOARD) {
                // Team Lead view: show employee assignees (bid_assignment_members)
                document.querySelectorAll('[data-assignees]').forEach(host => {
                    const bidId = parseInt(host.getAttribute('data-bid-id'));
                    const bid = (bidsData||[]).find(b => b.id === bidId) || {};
                    const members = bid.assigned_members || [];
                    host.innerHTML = '';
                    if (!members.length){
                        const empty = document.createElement('div');
                        empty.className = 'text-[11px] text-gray-500';
                        empty.textContent = 'Unassigned';
                        host.appendChild(empty);
                    } else {
                        members.forEach(m => host.appendChild(buildAssigneeChip(bidId, m)));
                    }
                });
                document.querySelectorAll('[data-assignees-btn]').forEach(btn => {
                    btn.onclick = () => openAssigneeMenu(parseInt(btn.getAttribute('data-bid-id')), btn);
                });
                renderTeamChips();
            } else {
                // Manager view: show Team Lead and any assigned members
                document.querySelectorAll('[data-assignees]').forEach(host => {
                    const bidId = parseInt(host.getAttribute('data-bid-id'));
                    const bid = (bidsData||[]).find(b => b.id === bidId) || {};
                    renderManagerAssignees(host, bid, []);
                    fetchTeamLeadForBid(bidId).then(tls => {
                        if (!tls || !tls.length) return;
                        renderManagerAssignees(host, bid, tls);
                    });
                });
                document.querySelectorAll('[data-assignees-btn]').forEach(btn => {
                    btn.onclick = () => openAssigneeMenu(parseInt(btn.getAttribute('data-bid-id')), btn);
                });
            }
        }
        function buildTeamLeadChip(bidId, tl){
            const chip = document.createElement('span');
            chip.className = 'relative group inline-flex items-center';
            const initials = getInitials(tl.name || tl.email || 'TL');
            const assignedBy = tl.assigned_by_email ? ` | Assigned by: ${escapeHtml(tl.assigned_by_email)}` : '';
            const dateText = tl.task_completion_date ? ` â€¢ ${escapeHtml(formatTeamLeadDate(tl.task_completion_date))}` : '';
            const tooltip = `${escapeHtml(tl.name || tl.email || 'Team Lead')}${dateText}${assignedBy ? ` â€¢${assignedBy}` : ''}`;
            chip.title = tooltip;
            let inner = `<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-700 text-white text-[10px] font-medium border border-white shadow-sm">${initials}</span>`;
            if (!IS_TEAM_LEAD_DASHBOARD && tl.email) {
                inner += `<button type="button" class="teamlead-remove-btn absolute -top-1 -right-1 w-4 h-4 rounded-full bg-white text-red-500 text-[10px] border border-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-sm" aria-label="Remove team lead" data-team-lead-email="${escapeHtml(tl.email)}" data-bid-id="${bidId}">Ã—</button>`;
            }
            chip.innerHTML = inner;
            return chip;
        }
        function buildMemberMiniChip(member){
            const chip = document.createElement('span');
            const colors = ['bg-blue-600', 'bg-green-600', 'bg-purple-600', 'bg-pink-600', 'bg-indigo-600', 'bg-teal-600', 'bg-orange-600'];
            const seed = (member.name || member.email || '').split('').reduce((a, c) => a + c.charCodeAt(0), 0);
            const colorIdx = seed % colors.length;
            chip.className = `inline-flex items-center justify-center w-5 h-5 rounded-full ${colors[colorIdx]} text-white text-[9px] font-medium`;
            chip.title = member.name || member.email || '';
            chip.textContent = getInitials(member.name || member.email || 'U');
            return chip;
        }
        function renderManagerAssignees(host, bid, teamLeadData){
            const members = bid.assigned_members || [];
            host.innerHTML = '';
            const wrap = document.createElement('div');
            wrap.className = 'flex flex-col gap-1';

            const tlRow = document.createElement('div');
            tlRow.className = 'flex items-center gap-1 flex-wrap';
            if (Array.isArray(teamLeadData) && teamLeadData.length) {
                teamLeadData.forEach(tl => tlRow.appendChild(buildTeamLeadChip(bid.id, tl)));
            } else {
                const emptyTl = document.createElement('span');
                emptyTl.className = 'inline-flex items-center';
                emptyTl.title = 'Unassigned';
                emptyTl.innerHTML = '<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-200 text-slate-500 text-[10px] font-medium border border-white shadow-sm"><i class="fa-solid fa-user"></i></span>';
                tlRow.appendChild(emptyTl);
            }
            wrap.appendChild(tlRow);

            const memRow = document.createElement('div');
            memRow.className = 'flex items-center gap-1 flex-wrap';
            if (members.length) {
                members.forEach(m => memRow.appendChild(buildMemberMiniChip(m)));
            } else {
                const emptyMem = document.createElement('span');
                emptyMem.className = 'inline-flex items-center';
                emptyMem.title = 'No members';
                emptyMem.innerHTML = '<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-200 text-slate-500 text-[10px] font-medium border border-white shadow-sm"><i class="fa-solid fa-user"></i></span>';
                memRow.appendChild(emptyMem);
            }
            wrap.appendChild(memRow);

            host.appendChild(wrap);
        }
        function teamLeadBadgeHtml(bidId, tl){
            if (!tl) return '';
            const name = escapeHtml(tl.name || tl.email || 'Team Lead');
            const initials = getInitials(tl.name || tl.email || 'TL');
            const assignedBy = tl.assigned_by_email ? ` | Assigned by: ${escapeHtml(tl.assigned_by_email)}` : '';
            const dateText = tl.task_completion_date ? ` â€¢ ${formatTeamLeadDate(tl.task_completion_date)}` : '';
            const tooltip = `${name}${dateText}${assignedBy ? ` â€¢${assignedBy}` : ''}`;
            let inner = `<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-700 text-white text-[10px] font-medium border border-white shadow-sm">${initials}</span>`;
            if (!IS_TEAM_LEAD_DASHBOARD && tl.email) {
                inner += `<button type="button" class="teamlead-remove-btn absolute -top-1 -right-1 w-4 h-4 rounded-full bg-white text-red-500 text-[10px] border border-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-sm" aria-label="Remove team lead" data-team-lead-email="${escapeHtml(tl.email)}" data-bid-id="${bidId}">Ã—</button>`;
            }
            return `<span class="relative group inline-flex items-center" title="${tooltip}">${inner}</span>`;
        }
        function buildAssigneeChip(bidId, member){
            const chip = document.createElement('span');
            chip.className = 'relative group inline-flex items-center';
            chip.title = member.name;
            // Generate a consistent color based on name
            const colors = ['bg-blue-600', 'bg-green-600', 'bg-purple-600', 'bg-pink-600', 'bg-indigo-600', 'bg-teal-600', 'bg-orange-600'];
            const colorIdx = (member.name || '').split('').reduce((a, c) => a + c.charCodeAt(0), 0) % colors.length;
            chip.innerHTML = `
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full ${colors[colorIdx]} text-white text-[10px] font-medium cursor-pointer border-2 border-white shadow-sm hover:scale-110 transition-transform">${getInitials(member.name)}</span>
                <button type="button" class="absolute -top-1 -right-1 w-4 h-4 rounded-full bg-white text-red-500 text-[10px] border border-red-500 flex items-center justify-center opacity-90 hover:opacity-100 transition-opacity shadow" aria-label="Remove">Ã—</button>
            `;
            chip.querySelector('button').onclick = (e) => {
                e.stopPropagation();
                const current = getMemberIds(bidId).filter(id => id !== member.id);
                saveAssignees(bidId, current);
            };
            return chip;
        }
        function getMemberIds(bidId){
            const bid = (bidsData||[]).find(b => b.id === bidId) || {};
            return (bid.assigned_members||[]).map(m => m.id);
        }
        async function openAssigneeMenu(bidId, anchor){
            closeAssigneeMenu();
            const menu = document.createElement('div');
            menu.id = 'assigneeMenu';
            // Use fixed positioning so it works reliably inside embedded iframes / scroll containers
            menu.className = 'bg-white border rounded shadow-lg p-2 text-sm';
            const rect = anchor.getBoundingClientRect();
            menu.style.position = 'fixed';
            menu.style.zIndex = '99999';
            menu.style.top = (rect.bottom + 6) + 'px';
            menu.style.left = (rect.left) + 'px';
            const list = document.createElement('div');
            list.className = 'max-h-56 overflow-auto min-w-[260px] space-y-0.5';

            // Optional completion date for Team Lead -> Employee assignment
            let dueInput = null;
            if (IS_TEAM_LEAD_DASHBOARD) {
                const wrap = document.createElement('div');
                wrap.className = 'mb-2 pb-2 border-b';
                const label = document.createElement('div');
                label.className = 'text-[11px] font-semibold text-gray-700 mb-1';
                label.textContent = 'Task Completion Date (for Employee)';
                dueInput = document.createElement('input');
                dueInput.type = 'date';
                dueInput.className = 'w-full px-2 py-1.5 border rounded text-xs';
                try {
                    const bid = (bidsData||[]).find(b => b.id === bidId) || {};
                    if (bid.task_completion_date && typeof bid.task_completion_date === 'string' && bid.task_completion_date.length >= 10) {
                        dueInput.value = bid.task_completion_date.slice(0, 10);
                    }
                } catch (e) {}
                wrap.appendChild(label);
                wrap.appendChild(dueInput);
                menu.appendChild(wrap);
            }

            if (IS_TEAM_LEAD_DASHBOARD) {
                const selected = new Set(getMemberIds(bidId));
                // Show only employees not already assigned (assigned are shown as chips in the row)
                (teamEmployees||[]).filter(emp => !selected.has(emp.id)).forEach(emp => {
                    const row = document.createElement('label');
                    row.className = 'flex items-center gap-2.5 px-2 py-1.5 hover:bg-blue-50 cursor-pointer rounded group transition-colors';
                    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='task-checkbox'; cb.value = emp.id; cb.checked = false;
                    row.appendChild(cb);
                    const av = document.createElement('span'); av.className='inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 text-white text-[10px] font-medium'; av.textContent=getInitials(emp.name);
                    row.appendChild(av);
                    const txt = document.createElement('span'); txt.className='group-hover:text-blue-600 transition-colors'; txt.textContent = `${emp.name} (${emp.email})`; row.appendChild(txt);
                    list.appendChild(row);
                });
            } else {
                // Manager -> Team Lead multi selection
                let currentTeamLeads = [];
                try {
                    const r = await fetch(`/api/bid/${bidId}/team-lead`);
                    const d = await r.json().catch(() => ({}));
                    currentTeamLeads = (d && d.ok) ? (d.team_leads || (d.team_lead ? [d.team_lead] : [])) : [];
                } catch (e) {
                    currentTeamLeads = [];
                }

                if (currentTeamLeads.length) {
                    const curWrap = document.createElement('div');
                    curWrap.className = 'mb-2 pb-2 border-b';
                    const label = document.createElement('div');
                    label.className = 'text-[11px] font-semibold text-gray-700 mb-1';
                    label.textContent = 'Currently Assigned';
                    curWrap.appendChild(label);
                    currentTeamLeads.forEach(tl => curWrap.appendChild(buildTeamLeadChip(tl)));
                    menu.appendChild(curWrap);
                }

                const currentEmailSet = new Set(currentTeamLeads.map(tl => (tl.email || '').toLowerCase().trim()));
                const leads = (teamLeads||[])
                    .filter(tl => (tl.email || '').toLowerCase().trim());

                leads.forEach(tl => {
                    const row = document.createElement('label');
                    row.className = 'flex items-center gap-2.5 px-2 py-1.5 hover:bg-blue-50 cursor-pointer rounded group transition-colors';
                    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='task-checkbox'; cb.value = tl.email;
                    cb.checked = currentEmailSet.has((tl.email || '').toLowerCase().trim());
                    row.appendChild(cb);
                    const av = document.createElement('span'); av.className='inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-700 text-white text-[10px] font-medium'; av.textContent=getInitials((tl.email||'TL').split('@')[0]);
                    row.appendChild(av);
                    const txt = document.createElement('span'); txt.className='group-hover:text-blue-600 transition-colors'; txt.textContent = `${tl.email} (${tl.role || 'team lead'})`; row.appendChild(txt);
                    list.appendChild(row);
                });

                // Manager must provide completion date for Team Lead(s)
                const wrap = document.createElement('div');
                wrap.className = 'mb-2 pb-2 border-b';
                const label = document.createElement('div');
                label.className = 'text-[11px] font-semibold text-gray-700 mb-1';
                label.textContent = 'Task Completion Date (for Team Lead)';
                dueInput = document.createElement('input');
                dueInput.type = 'date';
                dueInput.className = 'w-full px-2 py-1.5 border rounded text-xs';
                if (currentTeamLeads.length && currentTeamLeads[0].task_completion_date) {
                    dueInput.value = String(currentTeamLeads[0].task_completion_date).slice(0, 10);
                }
                wrap.appendChild(label);
                wrap.appendChild(dueInput);
                menu.appendChild(wrap);
            }
            const actions = document.createElement('div');
            actions.className = 'flex justify-end gap-2 mt-3 pt-2 border-t';
            const btnCancel = document.createElement('button'); btnCancel.className='px-3 py-1.5 text-xs rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors'; btnCancel.textContent='Cancel';
            const btnSave = document.createElement('button'); btnSave.className='px-3 py-1.5 text-xs rounded-md bg-blue-600 hover:bg-blue-700 text-white transition-colors'; btnSave.textContent='Save';
            btnCancel.onclick = closeAssigneeMenu;
            btnSave.onclick = () => {
                if (IS_TEAM_LEAD_DASHBOARD) {
                    // Keep existing assignees and add the newly checked employees
                    const existing = new Set(getMemberIds(bidId));
                    const addIds = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(i=>parseInt(i.value));
                    addIds.forEach(id => existing.add(id));
                    const ids = Array.from(existing);
                    const dueVal = dueInput ? (dueInput.value || '') : '';
                    saveAssignees(bidId, ids, dueVal);
                    closeAssigneeMenu();
                } else {
                    const picked = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value).filter(Boolean);
                    const dueVal = dueInput ? (dueInput.value || '') : '';
                    if (!picked.length) { alert('Please select at least one Team Lead.'); return; }
                    if (!dueVal) { alert('Please select Task Completion Date.'); return; }
                    saveTeamLeadAssignment(bidId, picked, dueVal);
                    closeAssigneeMenu();
                }
            };
            menu.appendChild(list); menu.appendChild(actions); actions.appendChild(btnCancel); actions.appendChild(btnSave);
            document.body.appendChild(menu);
            setTimeout(()=> document.addEventListener('click', outsideCloseOnce), 0);
            function outsideCloseOnce(e){ if (!menu.contains(e.target) && e.target !== anchor){ closeAssigneeMenu(); document.removeEventListener('click', outsideCloseOnce);} }
        }
        function closeAssigneeMenu(){ const m = document.getElementById('assigneeMenu'); if (m) m.remove(); }
        function saveAssignees(bidId, ids, taskCompletionDate){
            const payload = { g_id: bidId, employee_ids: ids };
            if (taskCompletionDate) payload.task_completion_date = taskCompletionDate;
            fetch(`/api/team/{{ team }}/assign`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
                .then(r=>r.json())
                .then(d=>{
                    if (!d.ok) { alert(d.error || 'Assignment failed'); return; }
                    // Update local data model
                    const bidIdx = (bidsData||[]).findIndex(b => b.id === bidId);
                    if (bidIdx >= 0){
                        const map = new Map((teamEmployees||[]).map(e => [e.id, e]));
                        bidsData[bidIdx].assigned_members = (ids||[]).map(id => ({
                            id,
                            name: map.get(id)?.name || 'User',
                            email: map.get(id)?.email || '',
                            department: map.get(id)?.department || '',
                            team_key: map.get(id)?.department || ''
                        }));
                    }
                    // Re-render chips
                    const host = document.querySelector(`[data-assignees][data-bid-id="${bidId}"]`);
                    if (host) {
                        host.innerHTML = '';
                        const bid = (bidsData||[]).find(b => b.id === bidId) || {};
                        (bid.assigned_members||[]).forEach(m => host.appendChild(buildAssigneeChip(bidId, m)));
                        if (!(bid.assigned_members||[]).length){ const empty=document.createElement('div'); empty.className='text-[11px] text-gray-500'; empty.textContent='Unassigned'; host.appendChild(empty); }
                    }
                    renderTeamChips();
                    // Re-render board so card assignees update too
                    const board = document.getElementById('boardContainer');
                    if (board && !board.classList.contains('hidden')) {
                        const currentFilter = (document.getElementById('boardBucketFilter')?.value) || '__all__';
                        renderBoard(currentGroupBy, currentFilter);
                    }
                })
                .catch(()=> alert('Assignment failed'));
        }

        function saveTeamLeadAssignment(bidId, teamLeadEmails, taskCompletionDate) {
            const payload = { g_id: bidId, team_lead_emails: teamLeadEmails, task_completion_date: taskCompletionDate };
            fetch(`/api/team/{{ team }}/assign-team-lead`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
                .then(r => r.json())
                .then(d => {
                    if (!d || !d.ok) { alert((d && d.error) || 'Assignment failed'); return; }
                    // Refresh the display chip
                    const host = document.querySelector(`[data-assignees][data-bid-id="${bidId}"]`);
                    if (host) {
                        const leads = (teamLeadEmails || []).map(email => {
                            const raw = (email || '').split('@')[0].replace(/\./g, ' ').trim();
                            const name = raw ? raw.replace(/\b\w/g, c => c.toUpperCase()) : email;
                            return { email, name, task_completion_date: taskCompletionDate };
                        });
                        teamLeadCache[bidId] = leads;
                        const bid = (bidsData||[]).find(b => b.id === bidId) || {};
                        renderManagerAssignees(host, bid, leads);
                    }
                    // Refresh due date cell (team lead assigned due date is not shown on manager view)
                    const board = document.getElementById('boardContainer');
                    if (board && !board.classList.contains('hidden')) {
                        const currentFilter = (document.getElementById('boardBucketFilter')?.value) || '__all__';
                        renderBoard(currentGroupBy, currentFilter);
                    }
                })
                .catch(() => alert('Assignment failed'));
        }

        

        function showChecklistSection(bidId, bidName) {
            currentBidId = bidId;
            document.getElementById('selectedBidId').value = bidId;
            document.getElementById('selectedBidName').textContent = bidName;
            document.getElementById('checklistBidName').textContent = bidName;
            
            // Show both sections
            document.getElementById('addTaskSection').classList.remove('hidden');
            document.getElementById('taskChecklistSection').classList.remove('hidden');
            
            // Load existing tasks for this bid
            loadBidTasks(bidId);
        }

        function hideChecklistSection() {
            document.getElementById('addTaskSection').classList.add('hidden');
            document.getElementById('taskChecklistSection').classList.add('hidden');
            currentBidId = null;
        }

        // Inline bucket change (Planner style)
        function changeBucket(bidId, toStage) {
            if (!toStage) return;
            advance(bidId, toStage);
        }

        function toggleBucketMenu(bidId) {
            const m = document.getElementById(`bucketMenu_${bidId}`);
            if (!m) return;
            // Close others
            document.querySelectorAll('.bucket-menu').forEach(el => { if (el !== m) el.classList.add('hidden'); });
            m.classList.toggle('hidden');
        }

        function selectBucket(bidId, stage, label, iconClass) {
            changeBucket(bidId, stage);
            const btn = document.getElementById(`bucketBtn_${bidId}`);
            if (btn) {
                const lab = btn.querySelector('[data-label]');
                const ic = btn.querySelector('i[data-icon]');
                if (lab) lab.textContent = label;
                if (ic) ic.className = `fa-solid ${iconClass}`;
            }
            const m = document.getElementById(`bucketMenu_${bidId}`);
            if (m) m.classList.add('hidden');
        }

        // Close bucket menus when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('[data-bucket]')) {
                document.querySelectorAll('.bucket-menu').forEach(el => el.classList.add('hidden'));
            }
        });

        function loadBidTasks(bidId) {
            fetch(`/api/team/{{ team }}/bids/${bidId}/tasks`)
            .then(response => response.json())
            .then(data => {
                populateTaskTable(data.tasks || []);
                updateProgressBar(data.tasks || []);
            })
            .catch(error => {
                console.error('Error loading tasks:', error);
            });
        }

        function populateTaskTable(tasks) {
            const tbody = document.getElementById('taskChecklistTableBody');
            tbody.innerHTML = '';
            
            if (tasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="p-6 text-center text-gray-500">
                            <i class="fas fa-tasks text-4xl text-gray-300 mb-2"></i>
                            <p>No tasks created yet for this bid</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tasks.forEach(task => {
                const commentsCount = (task.employee_comments || []).length;
                const filesCount = (task.employee_files || []).length;
                const hasSubmissions = commentsCount > 0 || filesCount > 0;
                
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3">
                        <div>
                            <div class="font-medium">${task.task_name}</div>
                            ${task.description ? `<div class="text-sm text-gray-600">${task.description}</div>` : ''}
                            ${hasSubmissions ? `<div class="mt-1"><span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-[10px]"><i class="fas fa-paperclip"></i> ${filesCount} files <i class="fas fa-comment ml-1"></i> ${commentsCount} comments</span></div>` : ''}
                        </div>
                    </td>
                    <td class="p-3">${task.assigned_employee_name || 'Unassigned'}</td>
                    <td class="p-3">${task.employee_email || 'N/A'}</td>
                    <td class="p-3">${task.due_date ? new Date(task.due_date).toLocaleDateString() : 'N/A'}</td>
                    <td class="p-3">${task.department || 'N/A'}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(task.status)}">
                            ${task.status.charAt(0).toUpperCase() + task.status.slice(1)}
                        </span>
                    </td>
                    <td class="p-3">
                        <div class="flex flex-wrap gap-1">
                            <button class="px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded"
                                    onclick="openTaskEdit(${task.id}, '${task.task_name}', '${(task.description||'').replace(/'/g, "\'")}', '${task.status}', '${task.due_date || ''}', '${task.priority || 'medium'}')">
                                Update
                            </button>
                            ${hasSubmissions ? `<button class="px-2 py-1 text-xs bg-purple-600 hover:bg-purple-700 text-white rounded" onclick="viewTaskSubmissions(${task.id}, '${task.task_name}')">View Work</button>` : ''}
                            <button class="px-2 py-1 text-xs bg-red-600 hover:bg-red-700 text-white rounded"
                                    onclick="deleteTask(${task.id})">
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Store task data for viewing submissions
                row.dataset.taskData = JSON.stringify(task);
            });
        }
        
        // View task submissions modal
        function viewTaskSubmissions(taskId, taskName) {
            fetch(`/task/${taskId}/details`, { credentials: 'include' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showTaskSubmissionsModal(taskName, data.files || [], data.comments || []);
                    } else {
                        alert('Error loading task submissions: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Error loading task submissions');
                });
        }
        
        function showTaskSubmissionsModal(taskName, files, comments) {
            // Create modal if doesn't exist
            let modal = document.getElementById('taskSubmissionsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'taskSubmissionsModal';
                modal.className = 'fixed inset-0 bg-black/60 hidden z-[99999] overflow-y-auto';
                modal.innerHTML = `
                    <div class="relative top-10 mx-auto w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-lg shadow-xl mb-10">
                        <div class="p-5 border-b flex justify-between items-center">
                            <h3 id="submissionsModalTitle" class="text-lg font-semibold text-gray-900"></h3>
                            <button onclick="closeTaskSubmissionsModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-5">
                            <div id="submissionsFilesSection" class="mb-6"></div>
                            <div id="submissionsCommentsSection"></div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('submissionsModalTitle').textContent = 'Employee Submissions - ' + taskName;
            
            // Render files
            const filesSection = document.getElementById('submissionsFilesSection');
            if (files.length > 0) {
                filesSection.innerHTML = `
                    <h4 class="font-semibold text-gray-700 mb-3"><i class="fas fa-file-upload mr-2"></i>Uploaded Work Files (${files.length})</h4>
                    <div class="space-y-2">
                        ${files.map(f => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                                <div>
                                    <span class="text-blue-600 font-medium"><i class="fas fa-file mr-2"></i>${f.filename || f.original_filename}</span>
                                    <p class="text-xs text-gray-500 mt-1">Uploaded by ${f.employee_name || 'Employee'} â€¢ ${f.uploaded_at}</p>
                                    ${f.description ? `<p class="text-sm text-gray-600 mt-1">${f.description}</p>` : ''}
                                </div>
                                <a href="${f.download_url}" class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                    <i class="fas fa-download mr-1"></i>Download
                                </a>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                filesSection.innerHTML = '<p class="text-gray-500 text-sm italic mb-4">No files uploaded by employee yet.</p>';
            }
            
            // Render comments
            const commentsSection = document.getElementById('submissionsCommentsSection');
            if (comments.length > 0) {
                commentsSection.innerHTML = `
                    <h4 class="font-semibold text-gray-700 mb-3"><i class="fas fa-comments mr-2"></i>Employee Comments (${comments.length})</h4>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        ${comments.map(c => `
                            <div class="p-3 bg-gray-50 rounded-lg border">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-medium text-gray-800">${c.employee_name || 'Employee'}</span>
                                    <span class="text-xs text-gray-500">${c.created_at}</span>
                                </div>
                                <p class="text-gray-700">${c.comment}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                commentsSection.innerHTML = '<p class="text-gray-500 text-sm italic">No comments from employee yet.</p>';
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeTaskSubmissionsModal() {
            const modal = document.getElementById('taskSubmissionsModal');
            if (modal) modal.classList.add('hidden');
        }

        // ===== Business Manager: Task Actions (Assign / Comment / Attachment) =====
        async function bmRefreshInlineTasks(bidId){
            try {
                const tbody = document.getElementById(`bidTasksTbody_${bidId}`);
                const cnt = document.getElementById(`bidTasksCount_${bidId}`);
                if (!tbody) return;
                const TASKS_QUERY = (document.body && document.body.dataset && document.body.dataset.tasksScopeAll === '1') ? '?scope=all' : '';
                const r = await fetch(`/api/team/{{ team }}/bids/${bidId}/tasks${TASKS_QUERY}`, { credentials: 'include' });
                const d = await r.json().catch(()=>({}));
                const tasks = (d && d.tasks) ? d.tasks : [];
                if (cnt) cnt.textContent = String(tasks.length || 0);
                let bidDueForTasks = '';
                try {
                    const bid = (bidsData||[]).find(b => Number(b.id) === Number(bidId)) || {};
                    bidDueForTasks = (bid && (bid.due_date || bid.task_completion_date)) ? String(bid.due_date || bid.task_completion_date) : '';
                } catch (e) { bidDueForTasks = ''; }
                // Reuse the same row renderer logic (duplicated here to keep it simple/stable)
                const rows = (tasks || []).slice(0, 25).map(t => {
                    const st = (t.status || 'pending').toLowerCase();
                    const badge = st === 'completed'
                        ? 'bg-green-100 text-green-800'
                        : (st === 'in_progress' || st === 'inprogress')
                            ? 'bg-blue-100 text-blue-800'
                            : 'bg-yellow-100 text-yellow-800';
                    const due = (bidDueForTasks || '').toString();
                    let pct = 0;
                    try { pct = Number(t.progress_pct ?? t.progressPct ?? 0) || 0; } catch (e) { pct = 0; }
                    if (st === 'completed' && pct < 100) pct = 100;
                    if (pct < 0) pct = 0;
                    if (pct > 100) pct = 100;
                    const stageKey = (t.stage || '').toString().trim().toLowerCase();
                    return `
                      <tr class="border-b">
                        <td class="py-2 pr-3">
                          <div class="text-sm font-medium text-gray-900">${escHtml(t.task_name || '')}</div>
                          <div class="text-xs text-gray-500">${escHtml(t.description || '')}</div>
                        </td>
                        <td class="py-2 pr-3 text-xs text-gray-700">${escHtml(t.assigned_employee_name || 'Unassigned')}</td>
                        <td class="py-2 pr-3"><span class="px-2 py-0.5 rounded text-xs ${badge}">${escHtml(t.status || 'pending')}</span></td>
                        <td class="py-2 pr-3 text-xs text-gray-700">${escHtml(t.priority || '')}</td>
                        <td class="py-2 pr-3 text-xs text-gray-700">${escHtml(due ? due.substring(0, 10) : 'N/A')}</td>
                        <td class="py-2 pr-3">
                          <div class="flex items-center gap-2">
                            <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                              <div class="h-2 bg-emerald-600" style="width:${pct}%"></div>
                            </div>
                            <div class="text-[11px] text-gray-600 w-10 text-right">${pct}%</div>
                          </div>
                        </td>
                        <td class="py-2 pr-3 text-xs text-gray-500">${escHtml(stageKey || '')}</td>
                        <td class="py-2 text-xs">
                          <div class="flex flex-wrap gap-1.5 justify-end">
                            <button type="button"
                              class="px-2 py-1 rounded bg-slate-900 hover:bg-slate-800 text-white text-[11px] font-semibold"
                              onclick="bmAssignTaskEmployee(${Number(bidId)}, ${Number(t.id)}, '${escHtml(stageKey)}')">Assign</button>
                            <button type="button"
                              class="px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-700 text-white text-[11px] font-semibold"
                              onclick="bmAssignTaskTeamLead(${Number(bidId)}, '${escHtml(stageKey)}')">Team Lead</button>
                            <button type="button"
                              class="px-2 py-1 rounded bg-amber-500 hover:bg-amber-600 text-white text-[11px] font-semibold"
                              onclick="bmAddTaskComment(${Number(bidId)}, ${Number(t.id)})">Comment</button>
                            <input type="file" class="hidden" id="bm_task_file_${Number(bidId)}_${Number(t.id)}"
                                   onchange="bmUploadTaskAttachment(${Number(bidId)}, ${Number(t.id)}, this.files && this.files[0])" />
                            <button type="button"
                              class="px-2 py-1 rounded bg-teal-600 hover:bg-teal-700 text-white text-[11px] font-semibold"
                              onclick="(function(){ const el=document.getElementById('bm_task_file_${Number(bidId)}_${Number(t.id)}'); if(el) el.click(); })()">Attach</button>
                            <button type="button"
                              class="px-2 py-1 rounded bg-purple-600 hover:bg-purple-700 text-white text-[11px] font-semibold"
                              onclick="viewTaskSubmissions(${Number(t.id)}, ${JSON.stringify(t.task_name || '')})">View</button>
                          </div>
                        </td>
                      </tr>
                    `;
                }).join('');
                tbody.innerHTML = rows || `<tr><td class="py-3 text-sm text-gray-500" colspan="9">No tasks found for this bid.</td></tr>`;
            } catch (e) {
                console.error('Failed to refresh tasks', e);
            }
        }

        function bmShowModal(innerHtml){
            let modal = document.getElementById('bmQuickModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'bmQuickModal';
                modal.className = 'fixed inset-0 bg-black/60 z-[99999] flex items-center justify-center p-4';
                modal.innerHTML = `<div class="bg-white rounded-xl shadow-xl w-full max-w-lg"></div>`;
                modal.addEventListener('click', (e) => { if (e.target === modal) bmCloseModal(); });
                document.body.appendChild(modal);
            }
            modal.querySelector('div').innerHTML = innerHtml;
            modal.classList.remove('hidden');
        }
        function bmCloseModal(){
            const modal = document.getElementById('bmQuickModal');
            if (modal) modal.classList.add('hidden');
        }

        async function bmAssignTaskEmployee(bidId, taskId, stageKey){
            stageKey = (stageKey || '{{ team }}').toString().trim().toLowerCase() || '{{ team }}';
            try {
                const r = await fetch(`/api/team/${encodeURIComponent(stageKey)}/employees`, { credentials: 'include' });
                const d = await r.json().catch(()=>({}));
                const employees = d.employees || [];
                bmShowModal(`
                  <div class="p-5 border-b flex items-center justify-between">
                    <div class="font-semibold text-gray-900">Assign Task (Employee)</div>
                    <button class="text-gray-500 hover:text-gray-700" onclick="bmCloseModal()"><i class="fas fa-times"></i></button>
                  </div>
                  <div class="p-5 space-y-3">
                    <div class="text-sm text-gray-600">Department: <span class="font-semibold">${escHtml(stageKey)}</span></div>
                    <select id="bmAssignEmpSelect" class="w-full border rounded px-3 py-2 text-sm">
                      <option value="">Unassigned</option>
                      ${(employees||[]).map(e => `<option value="${e.id}">${escHtml(e.name || e.email)} (${escHtml(e.email || '')})</option>`).join('')}
                    </select>
                    <div class="flex justify-end gap-2 pt-2">
                      <button class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm" onclick="bmCloseModal()">Cancel</button>
                      <button class="px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm" onclick="(async function(){
                        const sel = document.getElementById('bmAssignEmpSelect');
                        const val = sel ? sel.value : '';
                        const fd = new FormData();
                        fd.append('assigned_to', val);
                        fd.append('_csrf_token', '{{ csrf_token() }}');
                        const rr = await fetch('/task/' + taskId + '/update', { method:'POST', body: fd, credentials:'include' });
                        const dd = await rr.json().catch(()=>({}));
                        if (!rr.ok || !dd.success) { alert((dd && (dd.error || dd.message)) || 'Failed'); return; }
                        bmCloseModal();
                        bmRefreshInlineTasks(bidId);
                      })()">Save</button>
                    </div>
                  </div>
                `);
            } catch (e) {
                alert('Failed to load employees for assignment.');
            }
        }

        async function bmAssignTaskTeamLead(bidId, stageKey){
            stageKey = (stageKey || '{{ team }}').toString().trim().toLowerCase() || '{{ team }}';
            try {
                const r = await fetch(`/api/team/${encodeURIComponent(stageKey)}/team-leads`, { credentials: 'include' });
                const d = await r.json().catch(()=>({}));
                const leads = d.team_leads || [];
                bmShowModal(`
                  <div class="p-5 border-b flex items-center justify-between">
                    <div class="font-semibold text-gray-900">Assign Bid (Team Lead)</div>
                    <button class="text-gray-500 hover:text-gray-700" onclick="bmCloseModal()"><i class="fas fa-times"></i></button>
                  </div>
                  <div class="p-5 space-y-3">
                    <div class="text-sm text-gray-600">Team: <span class="font-semibold">${escHtml(stageKey)}</span></div>
                    <select id="bmAssignTlSelect" class="w-full border rounded px-3 py-2 text-sm">
                      <option value="">Select team lead</option>
                      ${(leads||[]).map(tl => `<option value="${escHtml(tl.email || '')}">${escHtml(tl.email || '')}</option>`).join('')}
                    </select>
                    <div>
                      <label class="block text-sm text-gray-700 mb-1">Task completion date</label>
                      <input id="bmAssignTlDate" type="date" class="w-full border rounded px-3 py-2 text-sm" />
                    </div>
                    <div class="flex justify-end gap-2 pt-2">
                      <button class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm" onclick="bmCloseModal()">Cancel</button>
                      <button class="px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm" onclick="(async function(){
                        const sel = document.getElementById('bmAssignTlSelect');
                        const dt = document.getElementById('bmAssignTlDate');
                        const email = sel ? sel.value : '';
                        const dateVal = dt ? dt.value : '';
                        if(!email){ alert('Select team lead'); return; }
                        if(!dateVal){ alert('Select completion date'); return; }
                        const payload = { g_id: bidId, team_lead_email: email, task_completion_date: dateVal };
                        const rr = await fetch('/api/team/' + encodeURIComponent(stageKey) + '/assign-team-lead', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), credentials:'include' });
                        const dd = await rr.json().catch(()=>({}));
                        if(!rr.ok || !dd.ok){ alert((dd && (dd.error || dd.message)) || 'Failed'); return; }
                        bmCloseModal();
                      })()">Save</button>
                    </div>
                  </div>
                `);
            } catch (e) {
                alert('Failed to load team leads.');
            }
        }

        async function removeTeamLeadAssignment(bidId, email){
            if (!bidId || !email) return;
            if (!confirm('Remove this team lead from the bid?')) return;
            try {
                const payload = { g_id: bidId, team_lead_email: email };
                const response = await fetch(`/api/team/${encodeURIComponent(TEAM_KEY)}/unassign-team-lead`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include',
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || !data.ok) {
                    throw new Error((data && (data.error || data.message)) || 'Failed to remove team lead');
                }
                delete teamLeadCache[bidId];
                const bid = (bidsData||[]).find(b => b.id === bidId) || {};
                const host = document.querySelector(`[data-assignees][data-bid-id="${bidId}"]`);
                if (host && !IS_TEAM_LEAD_DASHBOARD) {
                    fetchTeamLeadForBid(bidId).then(tls => renderManagerAssignees(host, bid, tls));
                }
                renderBoard(currentGroupBy, '__all__');
            } catch (err) {
                alert(err.message || 'Failed to remove team lead.');
            }
        }

        function getApprovalRequestForRole(actionLabel){
            const role = (userRole || '').toLowerCase().replace(/\s+/g, '_');
            const label = actionLabel || 'item';
            if (role === 'teamlead' || role === 'team_lead') {
                const wants = confirm(`Request approval for this ${label}?`);
                if (!wants) {
                    return { needs_approval: false, approval_target: 'admin' };
                }
                const choice = prompt('Approval target: manager or admin', 'manager');
                if (choice === null) return null;
                const val = (choice || '').trim().toLowerCase();
                if (val === 'manager' || val === 'admin') {
                    return { needs_approval: true, approval_target: val };
                }
                alert('Please type "manager" or "admin".');
                return null;
            }
            if (role === 'manager' || role === 'business_manager') {
                const wants = confirm(`Request approval for this ${label} from Top Admin?`);
                return { needs_approval: wants, approval_target: 'admin' };
            }
            return { needs_approval: false, approval_target: 'admin' };
        }

        function getApprovalTargetForAttachment(){
            const role = (userRole || '').toLowerCase().replace(/\s+/g, '_');
            if (role === 'teamlead' || role === 'team_lead') {
                const choice = prompt('Approval target for attachment: manager or admin', 'manager');
                if (choice === null) return null;
                const val = (choice || '').trim().toLowerCase();
                if (val === 'manager' || val === 'admin') {
                    return val;
                }
                alert('Please type "manager" or "admin".');
                return null;
            }
            if (role === 'manager' || role === 'business_manager') {
                return 'admin';
            }
            return 'admin';
        }

        async function bmAddTaskComment(bidId, taskId){
            let taskName = 'Task';
            try {
                const rr = await fetch(`/task/${taskId}/details`, { credentials: 'include' });
                const dd = await rr.json().catch(()=>({}));
                if (rr.ok && dd && dd.success && dd.task && dd.task.task_name) {
                    taskName = dd.task.task_name;
                }
            } catch (e) {}
            const comment = prompt(`Add comment for "${taskName}":`);
            if (comment === null) return;
            const trimmed = (comment || '').trim();
            if (!trimmed) return;
            const approvalReq = getApprovalRequestForRole('comment');
            if (approvalReq === null) return;
            try {
                const r = await fetch(`/task/${taskId}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        comment: trimmed,
                        needs_approval: approvalReq.needs_approval,
                        approval_target: approvalReq.approval_target
                    }),
                    credentials: 'include'
                });
                const d = await r.json().catch(()=>({}));
                if (!r.ok || !d.success) {
                    alert((d && (d.error || d.message)) || 'Failed to add comment');
                    return;
                }
                try { viewTaskSubmissions(taskId, taskName); } catch(e) {}
            } catch (e) {
                alert('Failed to add comment');
            }
        }

        async function bmUploadTaskAttachment(bidId, taskId, file){
            if (!file) return;
            try {
                const fd = new FormData();
                fd.append('attachment', file);
                const approvalTarget = getApprovalTargetForAttachment();
                if (approvalTarget === null) return;
                fd.append('approval_target', approvalTarget);
                const r = await fetch(`/task/${taskId}/attach`, { method:'POST', body: fd, credentials:'include' });
                const d = await r.json().catch(()=>({}));
                if (!r.ok || !d.success) {
                    alert((d && (d.error || d.message)) || 'Failed to upload attachment');
                    return;
                }
                bmRefreshInlineTasks(bidId);
                try { viewTaskSubmissions(taskId, 'Task'); } catch(e) {}
            } catch (e) {
                alert('Failed to upload attachment');
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'completed': return 'bg-green-100 text-green-800';
                case 'in_progress': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function updateProgressBar(tasks) {
            if (tasks.length === 0) {
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressPercentage').textContent = '0%';
                return;
            }

            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const progressPercentage = Math.round((completedTasks / tasks.length) * 100);
            
            document.getElementById('progressBar').style.width = `${progressPercentage}%`;
            document.getElementById('progressPercentage').textContent = `${progressPercentage}%`;
        }

        function updateTaskStatus(taskId, newStatus) {
            const formData = new FormData();
            formData.append('status', newStatus);
            
            fetch(`/task/${taskId}/update_status`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload tasks for current bid
                    if (currentBidId) {
                        loadBidTasks(currentBidId);
                    }
                } else {
                    alert('Error updating task status: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating task status');
            });
        }

        function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;
            fetch(`/task/${taskId}/delete`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        if (currentBidId) loadBidTasks(currentBidId);
                    } else {
                        alert('Error deleting task: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Error deleting task');
                });
        }

        function openTaskEdit(taskId, taskName, description, status, dueDate, priority) {
            const newName = prompt('Task name:', taskName);
            if (newName === null) return;
            const newDesc = prompt('Description:', description || '');
            if (newDesc === null) return;
            const newStatus = prompt("Status (pending|in_progress|completed):", status);
            if (newStatus === null) return;
            const newDue = prompt('Due date (YYYY-MM-DD HH:MM) or empty:', dueDate || '');
            if (newDue === null) return;
            const newPriority = prompt('Priority (low|medium|high|urgent):', priority || 'medium');
            if (newPriority === null) return;

            const form = new FormData();
            form.append('task_name', newName);
            form.append('description', newDesc);
            form.append('status', newStatus);
            if (newDue) form.append('due_date', newDue);
            form.append('priority', newPriority);

            fetch(`/task/${taskId}/update`, { method: 'POST', body: form })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        if (currentBidId) loadBidTasks(currentBidId);
                    } else {
                        alert('Error updating task: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Error updating task');
                });
        }

        function showTaskDetails(taskId, taskName, description, status) {
            alert(`Task: ${taskName}\nDescription: ${description}\nStatus: ${status}`);
        }

        // Handle add task form submission
        // In embed mode the Add Task section is not rendered, so guard against null.
        const addTaskFormEl = document.getElementById('addTaskForm');
        if (addTaskFormEl) {
            addTaskFormEl.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                fetch(`/team/{{ team }}/bids/${currentBidId}/checklist/create`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // Clear form
                        this.reset();
                        // Reload tasks
                        loadBidTasks(currentBidId);
                    } else {
                        alert('Error creating task');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error creating task');
                });
            });
        }

        // --- Planner-like Bid modal helpers ---
        let bbmCurrentBidId = null;
        function openBoardBidModal(bid) {
            bbmCurrentBidId = bid.id;
            // Get the latest bid data from bidsData to ensure we have assigned_members
            const latestBid = (bidsData||[]).find(b => b.id === bid.id) || bid;
            const modalEl = document.getElementById('boardBidModal');
            if (modalEl) {
                modalEl.classList.remove('hidden');
                // Extra safety for embedded dashboards: ensure it's on top and visible
                modalEl.style.zIndex = '99999';
                modalEl.style.display = 'block';
            }
            document.getElementById('bbm_plan').textContent = `Team â€“ ${'{{ team_display_name }}'}`;
            document.getElementById('bbm_title').textContent = latestBid.name || '';
            const labDiv = document.getElementById('bbm_labels');
            labDiv.innerHTML = '';
            if (latestBid.company) {
                const span = document.createElement('span');
                span.className = 'px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 text-xs border border-purple-200';
                span.textContent = latestBid.company;
                labDiv.appendChild(span);
            }
            // Load and display assigned team members
            loadModalTeamAssignees(latestBid);
            // Bucket selector
            const bucketHost = document.getElementById('bbm_bucket');
            bucketHost.innerHTML = '';
            const stages = (latestBid.dyn_stages || ['analyzer','business','design','operations','engineer','handover']);
            const sel = document.createElement('select');
            sel.className = 'w-full border rounded px-3 py-2 text-sm';
            stages.forEach(s=>{
                const opt = document.createElement('option');
                opt.value = s; opt.textContent = s.replace('_',' ').replace(/\b\w/g,c=>c.toUpperCase());
                if ((latestBid.current_stage||'analyzer')===s) opt.selected = true;
                sel.appendChild(opt);
            });
            sel.addEventListener('change', ()=> changeBucket(latestBid.id, sel.value));
            bucketHost.appendChild(sel);
            // Dates and notes
            try{ document.getElementById('bbm_start').value = (latestBid.in_date || '').substring(0,10);}catch{}
            try{ document.getElementById('bbm_due').value = (latestBid.due_date || '').substring(0,10);}catch{}
            // enable date editing
            const startEl = document.getElementById('bbm_start');
            const dueEl = document.getElementById('bbm_due');
            startEl.disabled = false; dueEl.disabled = false;
            const saveDates = ()=>{
                const fd = new FormData();
                if (startEl.value) fd.append('in_date', startEl.value);
                if (dueEl.value) fd.append('due_date', dueEl.value);
                fetch(`/api/bids/${latestBid.id}/dates`, { method:'POST', body: fd}).then(()=>{});
            };
            startEl.onchange = saveDates; dueEl.onchange = saveDates;
            document.getElementById('bbm_notes').value = latestBid.summary || '';
            document.getElementById('bbm_save_notes').onclick = function(){
                const fd = new FormData();
                fd.append('summary', document.getElementById('bbm_notes').value || '');
                fetch(`/api/bids/${latestBid.id}/summary`, { method: 'POST', body: fd })
                    .then(r=>r.json()).then(()=>{ /* ok */ })
                    .catch(()=>alert('Could not save notes'));
            };
            // Checklist
            loadBoardChecklist(latestBid.id);
            const addForm = document.getElementById('bbm_add_task');
            // Populate assignment select
            const assignSel = document.getElementById('bbm_assign_to');
            if (assignSel) {
                assignSel.innerHTML = '<option value="">Assign toâ€¦</option>';
                (teamEmployees||[]).forEach(emp => {
                    const opt = document.createElement('option');
                    opt.value = emp.id;
                    opt.textContent = `${emp.name} (${emp.email})`;
                    if ((latestBid.person_email||'').toLowerCase() === (emp.email||'').toLowerCase()) opt.selected = true;
                    assignSel.appendChild(opt);
                });
            }
            addForm.onsubmit = function(e){
                e.preventDefault();
                const name = (document.getElementById('bbm_new_task').value||'').trim();
                const due = document.getElementById('bbm_new_due').value || '';
                const assigneeId = (document.getElementById('bbm_assign_to')?.value)||'';
                if (!name) return;
                const fd = new FormData();
                fd.append('g_id', latestBid.id);
                fd.append('task_name', name);
                if (due) fd.append('due_date', due);
                if (assigneeId) fd.append('assigned_to', assigneeId);
                fetch(`/team/{{ team }}/bids/${latestBid.id}/checklist/create`, { method: 'POST', body: fd })
                    .then(r=>{ if(r.ok){ document.getElementById('bbm_new_task').value=''; document.getElementById('bbm_new_due').value=''; loadBoardChecklist(latestBid.id);} else alert('Error adding task');});
            };
            document.getElementById('bbm_attach_btn').onclick = ()=> document.getElementById('bbm_attach_file').click();
            document.getElementById('bbm_attach_file').onchange = function(){
                const file = this.files && this.files[0];
                if (!file) return;
                const fd = new FormData();
                fd.append('g_id', latestBid.id);
                fd.append('task_name', file.name);
                fd.append('attachment', file);
                fetch(`/team/{{ team }}/bids/${latestBid.id}/checklist/create`, { method: 'POST', body: fd })
                    .then(r=>{ if(r.ok){ this.value=''; loadBoardChecklist(latestBid.id);} else alert('Upload failed'); });
            };
            // Setup team assignment button
            document.getElementById('bbm_assign_team_btn').onclick = () => openModalAssigneeMenu(latestBid.id, document.getElementById('bbm_assign_team_btn'));
        }
        
        function loadModalTeamAssignees(bid) {
            const host = document.getElementById('bbm_team_assignees');
            host.innerHTML = '';
            const members = bid.assigned_members || [];
            if (!members.length) {
                const empty = document.createElement('div');
                empty.className = 'text-xs text-gray-500';
                empty.textContent = 'No team members assigned';
                host.appendChild(empty);
            } else {
                members.forEach(m => {
                    const chip = buildModalAssigneeChip(bid.id, m);
                    host.appendChild(chip);
                });
            }
        }
        
        function buildModalAssigneeChip(bidId, member) {
            const chip = document.createElement('span');
            chip.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-xs border';
            chip.innerHTML = `<span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-600 text-white text-[10px]">${getInitials(member.name)}</span><span>${member.name}</span><button type="button" class="ml-1 text-gray-500 hover:text-gray-700" aria-label="Remove">Ã—</button>`;
            chip.querySelector('button').onclick = () => {
                const current = getModalMemberIds(bidId).filter(id => id !== member.id);
                saveModalAssignees(bidId, current);
            };
            return chip;
        }
        
        function getModalMemberIds(bidId) {
            const bid = (bidsData||[]).find(b => b.id === bidId) || {};
            return (bid.assigned_members||[]).map(m => m.id);
        }
        
        function openModalAssigneeMenu(bidId, anchor) {
            closeAssigneeMenu();
            const menu = document.createElement('div');
            menu.id = 'assigneeMenu';
            // Use fixed positioning so it works reliably inside embedded iframes / scroll containers
            menu.className = 'bg-white border rounded shadow-lg p-2 text-sm';
            const rect = anchor.getBoundingClientRect();
            menu.style.position = 'fixed';
            menu.style.zIndex = '99999';
            menu.style.top = (rect.bottom + 6) + 'px';
            menu.style.left = (rect.left) + 'px';
            const selected = new Set(getModalMemberIds(bidId));
            const list = document.createElement('div');
            list.className = 'max-h-56 overflow-auto min-w-[240px] space-y-0.5';
            (teamEmployees||[]).forEach(emp => {
                const row = document.createElement('label');
                row.className = 'flex items-center gap-2.5 px-2 py-1.5 hover:bg-blue-50 cursor-pointer rounded group transition-colors';
                const cb = document.createElement('input'); cb.type='checkbox'; cb.className='task-checkbox'; cb.value = emp.id; cb.checked = selected.has(emp.id);
                row.appendChild(cb);
                const av = document.createElement('span'); av.className='inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 text-white text-[10px] font-medium'; av.textContent=getInitials(emp.name);
                row.appendChild(av);
                const txt = document.createElement('span'); txt.className='group-hover:text-blue-600 transition-colors'; txt.textContent = `${emp.name} (${emp.email})`; row.appendChild(txt);
                list.appendChild(row);
            });
            const actions = document.createElement('div');
            actions.className = 'flex justify-end gap-2 mt-3 pt-2 border-t';
            const btnCancel = document.createElement('button'); btnCancel.className='px-3 py-1.5 text-xs rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors'; btnCancel.textContent='Cancel';
            const btnSave = document.createElement('button'); btnSave.className='px-3 py-1.5 text-xs rounded-md bg-blue-600 hover:bg-blue-700 text-white transition-colors'; btnSave.textContent='Save';
            btnCancel.onclick = closeAssigneeMenu;
            btnSave.onclick = () => {
                const ids = Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(i=>parseInt(i.value));
                saveModalAssignees(bidId, ids);
                closeAssigneeMenu();
            };
            menu.appendChild(list); menu.appendChild(actions); actions.appendChild(btnCancel); actions.appendChild(btnSave);
            document.body.appendChild(menu);
            setTimeout(()=> document.addEventListener('click', outsideCloseOnce), 0);
            function outsideCloseOnce(e){ if (!menu.contains(e.target) && e.target !== anchor){ closeAssigneeMenu(); document.removeEventListener('click', outsideCloseOnce);} }
        }
        
        function saveModalAssignees(bidId, ids) {
            fetch(`/api/team/{{ team }}/assign`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ g_id: bidId, employee_ids: ids }) })
                .then(r=>r.json())
                .then(d=>{
                    if (!d.ok) { alert(d.error || 'Assignment failed'); return; }
                    // Update local data model
                    const bidIdx = (bidsData||[]).findIndex(b => b.id === bidId);
                    if (bidIdx >= 0){
                        const map = new Map((teamEmployees||[]).map(e => [e.id, e]));
                        bidsData[bidIdx].assigned_members = (ids||[]).map(id => ({ id, name: map.get(id)?.name || 'User', email: map.get(id)?.email || '' }));
                    }
                    // Re-render modal chips
                    const bid = (bidsData||[]).find(b => b.id === bidId) || {};
                    loadModalTeamAssignees(bid);
                    // Also update the table view if visible
                    const host = document.querySelector(`[data-assignees][data-bid-id="${bidId}"]`);
                    if (host) {
                        host.innerHTML = '';
                        (bid.assigned_members||[]).forEach(m => host.appendChild(buildAssigneeChip(bidId, m)));
                        if (!(bid.assigned_members||[]).length){ const empty=document.createElement('div'); empty.className='text-[11px] text-gray-500'; empty.textContent='Unassigned'; host.appendChild(empty); }
                    }
                })
                .catch(()=> alert('Assignment failed'));
        }
        function closeBoardBidModal(){
            const m = document.getElementById('boardBidModal');
            if (!m) return;
            m.classList.add('hidden');
            // Clear any inline forcing from embedded dashboards
            m.style.display = '';
            m.style.zIndex = '';
        }
        function loadBoardChecklist(bidId){
            fetch(`/api/team/{{ team }}/bids/${bidId}/tasks`).then(r=>r.json()).then(data=>{
                const list = document.getElementById('bbm_checklist');
                list.innerHTML='';
                const tasks = data.tasks||[];
                const done = tasks.filter(t=> (t.status||'').toLowerCase()==='completed').length;
                document.getElementById('bbm_check_counts').textContent = `${done} / ${tasks.length}`;
                tasks.forEach(t=>{
                    const row = document.createElement('div');
                    row.className = 'px-3 py-2 border-b last:border-b-0';
                    
                    // Count employee submissions and manager files
                    const commentsCount = (t.employee_comments || []).length;
                    const filesCount = (t.employee_files || []).length;
                    const managerFilesCount = (t.manager_files || []).length;
                    const hasSubmissions = commentsCount > 0 || filesCount > 0;
                    const hasManagerFiles = managerFilesCount > 0;
                    
                    row.innerHTML = `
                        <div class="flex items-center justify-between">
                            <label class="inline-flex items-center gap-2.5 text-sm cursor-pointer group">
                                <input type="checkbox" class="task-checkbox" ${((t.status||'').toLowerCase()==='completed')?'checked':''}>
                                <span class="group-hover:text-blue-600 transition-colors ${((t.status||'').toLowerCase()==='completed') ? 'line-through text-gray-400' : ''}">${escapeHtml(t.task_name||'')}</span>
                                ${t.assigned_employee_name ? `<span class=\"px-2 py-0.5 rounded-full bg-sky-100 text-sky-700 text-[11px]\">${t.assigned_employee_name}</span>` : ''}
                                ${hasSubmissions ? `<span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-[10px]"><i class="fas fa-paperclip"></i> ${filesCount} <i class="fas fa-comment ml-1"></i> ${commentsCount}</span>` : ''}
                                ${hasManagerFiles ? `<span class="px-2 py-0.5 rounded-full bg-gray-800 text-white text-[10px]"><i class="fas fa-file-alt"></i> ${managerFilesCount} attached</span>` : ''}
                            </label>
                            <div class="flex items-center gap-2 text-xs">
                                ${t.due_date ? `<span class=\"text-gray-500\">${new Date(t.due_date).toLocaleDateString()}</span>` : ''}
                            <button class="px-2 py-1 rounded bg-blue-600 text-white" data-act="update">Update</button>
                            <button class="px-2 py-1 rounded bg-gray-900 text-white" data-act="attach">Attach</button>
                            ${(hasSubmissions || hasManagerFiles) ? `<button class="px-2 py-1 rounded bg-purple-600 text-white" data-act="view-submissions">View Work</button>` : ''}
                                <button class="px-2 py-1 rounded bg-red-600 text-white" data-act="delete">Delete</button>
                            </div>
                        </div>
                        ${(hasSubmissions || hasManagerFiles) ? `
                        <div class="task-submissions hidden mt-2 ml-6 p-3 bg-gray-50 rounded-lg text-sm" data-submissions-panel>
                            ${managerFilesCount > 0 ? `
                            <div class="mb-3">
                                <h5 class="font-medium text-gray-700 mb-2"><i class="fas fa-user-tie mr-1"></i>Manager Attachments (${managerFilesCount})</h5>
                                <div class="space-y-1">
                                    ${(t.manager_files || []).map(f => `
                                        <div class="flex items-center justify-between bg-gray-100 p-2 rounded border border-gray-300">
                                            <div>
                                                <span class="text-gray-800"><i class="fas fa-file-alt mr-1"></i>${f.filename}</span>
                                                <span class="text-xs text-gray-500 ml-2">â€¢ ${f.uploaded_at}</span>
                                            </div>
                                            <a href="${f.download_url}" class="px-2 py-1 bg-gray-800 text-white rounded text-xs hover:bg-gray-900">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                            ${filesCount > 0 ? `
                            <div class="mb-3">
                                <h5 class="font-medium text-gray-700 mb-2"><i class="fas fa-file-upload mr-1"></i>Employee Uploaded Files (${filesCount})</h5>
                                <div class="space-y-1">
                                    ${(t.employee_files || []).map(f => `
                                        <div class="flex items-center justify-between bg-white p-2 rounded border">
                                            <div>
                                                <span class="text-blue-600"><i class="fas fa-file mr-1"></i>${f.filename}</span>
                                                <span class="text-xs text-gray-500 ml-2">by ${f.employee_name} â€¢ ${f.uploaded_at}</span>
                                                ${f.description ? `<p class="text-xs text-gray-600 mt-1">${f.description}</p>` : ''}
                                            </div>
                                            <a href="${f.download_url}" class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                            ${commentsCount > 0 ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2"><i class="fas fa-comments mr-1"></i>Employee Comments (${commentsCount})</h5>
                                <div class="space-y-2">
                                    ${(t.employee_comments || []).map(c => `
                                        <div class="bg-white p-2 rounded border">
                                            <div class="flex justify-between items-start">
                                                <span class="font-medium text-gray-800">${c.employee_name}</span>
                                                <span class="text-xs text-gray-500">${c.created_at}</span>
                                            </div>
                                            <p class="text-gray-700 mt-1">${c.comment}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                        </div>` : ''}`;
                    
                    const cb = row.querySelector('input[type="checkbox"]');
                    cb.addEventListener('change', ()=>{
                        const st = cb.checked ? 'completed' : 'pending';
                        const fd = new FormData(); fd.append('status', st);
                        fetch(`/task/${t.id}/update_status`, { method:'POST', body: fd }).then(()=> loadBoardChecklist(bidId));
                    });
                    row.querySelector('[data-act="delete"]').addEventListener('click', ()=>{
                        if(!confirm('Delete task?')) return;
                        fetch(`/task/${t.id}/delete`, { method:'POST' }).then(()=> loadBoardChecklist(bidId));
                    });
                    row.querySelector('[data-act="update"]').addEventListener('click', ()=>{
                        openTaskEdit(t.id, t.task_name || '', t.description || '', (t.status||''), t.due_date || '', t.priority || 'medium');
                    });
                    row.querySelector('[data-act="attach"]').addEventListener('click', ()=>{
                        const input = document.createElement('input'); input.type='file'; input.className='hidden';
                        input.onchange = function(){ const f=this.files&&this.files[0]; if(!f) return; const fd=new FormData(); fd.append('attachment',f); fetch(`/task/${t.id}/attach`,{method:'POST',body:fd}).then(()=> loadBoardChecklist(bidId)); };
                        document.body.appendChild(input); input.click(); setTimeout(()=>input.remove(),1000);
                    });
                    
                    // View submissions toggle
                    const viewBtn = row.querySelector('[data-act="view-submissions"]');
                    if (viewBtn) {
                        viewBtn.addEventListener('click', () => {
                            const panel = row.querySelector('[data-submissions-panel]');
                            if (panel) {
                                panel.classList.toggle('hidden');
                                viewBtn.textContent = panel.classList.contains('hidden') ? 'View Work' : 'Hide Work';
                            }
                        });
                    }
                    
                    list.appendChild(row);
                });
            });
            // Comments
            loadBoardComments(bidId);
        }

        function loadBoardComments(bidId){
            const wrapId = 'bbm_comments_wrap';
            let wrap = document.getElementById(wrapId);
            if (!wrap) {
                // create container below attachments
                const modal = document.getElementById('boardBidModal').querySelector('.p-5.space-y-5');
                wrap = document.createElement('div'); wrap.id = wrapId;
                wrap.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">Comments</label>
                    <div id="bbm_comments" class="mt-2 space-y-2 max-h-48 overflow-y-auto border rounded p-2 bg-gray-50"></div>
                    <form id="bbm_comment_form" class="mt-2 flex gap-2">
                        <input id="bbm_comment_input" type="text" class="flex-1 border rounded px-3 py-2 text-sm" placeholder="Type your message here">
                        <button class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">Send</button>
                    </form>`;
                modal.appendChild(wrap);
            }
            fetch(`/api/bids/${bidId}/comments`).then(r=>r.json()).then(data=>{
                const list = document.getElementById('bbm_comments');
                list.innerHTML = '';
                (data.comments||[]).forEach(c=>{
                    const row = document.createElement('div');
                    row.className = 'text-xs text-gray-700 bg-white border rounded px-2 py-1';
                    row.innerHTML = `<span class="font-medium">${c.user_email||'User'}</span> Â· <span class="text-gray-500">${(c.created_at||'').toString().replace('T',' ').substring(0,19)}</span><div>${c.comment_text||''}</div>`;
                    list.appendChild(row);
                });
                const form = document.getElementById('bbm_comment_form');
                form.onsubmit = function(e){
                    e.preventDefault();
                    const val = (document.getElementById('bbm_comment_input').value||'').trim();
                    if (!val) return;
                    const fd = new FormData(); fd.append('comment', val);
                    fetch(`/api/bids/${bidId}/comments`, { method:'POST', body: fd}).then(()=>{ document.getElementById('bbm_comment_input').value=''; loadBoardComments(bidId);});
                };
            });
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-0`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function handleSubmissionChange(bidId, status, selectEl) {
            const reasonContainer = document.querySelector(`[data-reason-container="${bidId}"]`);
            const reasonInput = document.querySelector(`[data-reason-input="${bidId}"]`);
            
            // Show/hide reason input based on status
            if (status === 'Not Submitted' || status === 'On Hold') {
                reasonContainer.classList.remove('hidden');
                reasonInput.focus();
            } else {
                reasonContainer.classList.add('hidden');
                // Clear reason when not needed
                if (reasonInput) reasonInput.value = '';
                // Save immediately for non-reason statuses
                updateSubmissionStatus(bidId, status, '');
            }
        }
        
        function saveSubmissionReason(bidId) {
            const selectEl = document.querySelector(`[data-submission-select][data-bid-id="${bidId}"]`);
            const reasonInput = document.querySelector(`[data-reason-input="${bidId}"]`);
            const status = selectEl ? selectEl.value : '';
            const reason = reasonInput ? reasonInput.value : '';
            
            if (status === 'Not Submitted' || status === 'On Hold') {
                updateSubmissionStatus(bidId, status, reason);
            }
        }

        function updateSubmissionStatus(bidId, status, reason = '') {
            const fd = new FormData();
            fd.append('submission_status', status);
            fd.append('submission_reason', reason);
            fetch(`/api/bids/${bidId}/update_submission`, { method: 'POST', body: fd })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        console.log('Submission status updated');
                        const reasonMsg = reason ? ` (Reason: ${reason})` : '';
                        showToast('Submission status updated to ' + status + reasonMsg, 'success');
                    } else {
                        alert('Failed to update submission status: ' + (d.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Error updating submission status:', err);
                    alert('Failed to update submission status');
                });
        }

        function updateResultStatus(bidId, result) {
            // If Won or Lost, show feedback modal
            if (result === 'WON' || result === 'LOST') {
                showResultFeedbackModal(bidId, result);
            } else {
                // For Awaited/Pending, just update without feedback
                const fd = new FormData();
                fd.append('result', result);
                fd.append('feedback', '');
                fetch(`/api/bids/${bidId}/update_result`, { method: 'POST', body: fd })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            console.log('Result updated');
                            showToast('Result updated to ' + result, 'success');
                        } else {
                            alert('Failed to update result: ' + (d.error || 'Unknown error'));
                        }
                    })
                    .catch(err => {
                        console.error('Error updating result:', err);
                        alert('Failed to update result');
                    });
            }
        }

        function showResultFeedbackModal(bidId, result) {
            document.getElementById('resultFeedbackBidId').value = bidId;
            document.getElementById('resultFeedbackResult').value = result;
            document.getElementById('resultFeedbackTitle').textContent = result === 'WON' ? 'Won - Feedback' : 'Lost - Feedback';
            document.getElementById('resultFeedbackModal').classList.remove('hidden');
        }

        function closeResultFeedbackModal() {
            document.getElementById('resultFeedbackModal').classList.add('hidden');
            document.getElementById('resultFeedbackForm').reset();
            // Reset dropdown to previous value if cancelled
            const bidId = document.getElementById('resultFeedbackBidId').value;
            const dropdown = document.querySelector(`select[data-bid-id="${bidId}"][onchange*="updateResultStatus"]`);
            if (dropdown) {
                dropdown.value = 'Awaited'; // Reset to Awaited
            }
        }

        function submitResultFeedback() {
            const bidId = document.getElementById('resultFeedbackBidId').value;
            const result = document.getElementById('resultFeedbackResult').value;
            const feedback = document.getElementById('resultFeedbackText').value;

            const fd = new FormData();
            fd.append('result', result);
            fd.append('feedback', feedback);

            fetch(`/api/bids/${bidId}/update_result`, { method: 'POST', body: fd })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        console.log('Result updated with feedback');
                        showToast('Result updated to ' + result + ' with feedback', 'success');
                        closeResultFeedbackModal();
                    } else {
                        alert('Failed to update result: ' + (d.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Error updating result:', err);
                    alert('Failed to update result');
                });
        }

        async function postApprovalAction(action, table, id) {
            const res = await fetch('/approvals/action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, source_table: table, source_id: id, _csrf_token: '{{ csrf_token() }}' })
            });
            const data = await res.json();
            if (!data || !data.success) throw new Error((data && (data.error || data.message)) || 'Failed');
        }

        document.addEventListener('click', function(e) {
            const removeBtn = e.target.closest ? e.target.closest('.teamlead-remove-btn') : null;
            if (!removeBtn) return;
            e.preventDefault();
            e.stopPropagation();
            const bidId = parseInt(removeBtn.getAttribute('data-bid-id') || '0', 10);
            const email = removeBtn.getAttribute('data-team-lead-email') || '';
            if (!bidId || !email) return;
            removeTeamLeadAssignment(bidId, email);
        });

        document.addEventListener('click', async (e) => {
            const btnApprove = e.target.closest ? e.target.closest('[data-approve]') : null;
            const btnReject = e.target.closest ? e.target.closest('[data-reject]') : null;
            const btn = btnApprove || btnReject;
            if (!btn) return;
            const action = btnApprove ? 'approve' : 'reject';
            const table = btn.getAttribute('data-source-table');
            const id = parseInt(btn.getAttribute('data-source-id') || '0', 10);
            if (!table || !id) return;
            try {
                btn.disabled = true;
                await postApprovalAction(action, table, id);
                location.reload();
            } catch (err) {
                btn.disabled = false;
                alert('Approval action failed: ' + (err && err.message ? err.message : 'Unknown error'));
            }
        });
    </script>

    <!-- Result Feedback Modal -->
    <div id="resultFeedbackModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 id="resultFeedbackTitle" class="text-lg font-medium text-gray-900 mb-4">Result Feedback</h3>
                
                <form id="resultFeedbackForm" onsubmit="event.preventDefault(); submitResultFeedback();">
                    <input type="hidden" id="resultFeedbackBidId" name="bid_id">
                    <input type="hidden" id="resultFeedbackResult" name="result">
                    
                    <div class="mb-4">
                        <label for="resultFeedbackText" class="block text-sm font-medium text-gray-700 mb-2">Feedback:</label>
                        <textarea name="feedback" id="resultFeedbackText" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter feedback or reason..." required></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeResultFeedbackModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</body>
</html>
