<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposals Making</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- PDF.js for viewing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- PDF-lib for editing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        /* Custom scrollbar for sidebars - thin and subtle */
        aside ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        aside ::-webkit-scrollbar-track {
            background: transparent;
        }

        aside ::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.3);
            border-radius: 3px;
            transition: background 0.2s;
        }

        aside ::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.5);
        }

        .proposal-attachment {
            display: block;
            margin: 12px 0;
            text-align: center;
        }

        .proposal-attachment img {
            display: block;
            max-width: 100%;
            height: auto;
            margin: 0 auto;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
        }

        .section-attachment-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #ffffff;
        }

        .section-attachment-thumb {
            width: 44px;
            height: 44px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        /* Firefox scrollbar for sidebars */
        aside {
            scrollbar-width: thin;
            scrollbar-color: rgba(156, 163, 175, 0.3) transparent;
        }

        /* Invisible scrollbar for main content area only */
        main {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        main::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
            background: transparent;
        }

        main::-webkit-scrollbar-track {
            display: none;
        }

        main::-webkit-scrollbar-thumb {
            display: none;
        }

        .dropdown-item:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .dropdown-item:disabled:hover {
            background-color: transparent;
        }

        /* Smooth transitions */
        * {
            transition-property: color, background-color, border-color, opacity, transform;
            transition-duration: 0.2s;
            transition-timing-function: ease-in-out;
        }

        /* Card hover effects */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* Button animations */
        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.2), 0 2px 4px -1px rgba(5, 150, 105, 0.1);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            box-shadow: 0 6px 8px -1px rgba(5, 150, 105, 0.3), 0 4px 6px -1px rgba(5, 150, 105, 0.2);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            box-shadow: 0 4px 6px -1px rgba(124, 58, 237, 0.2), 0 2px 4px -1px rgba(124, 58, 237, 0.1);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #5b21b6 100%);
            box-shadow: 0 6px 8px -1px rgba(124, 58, 237, 0.3), 0 4px 6px -1px rgba(124, 58, 237, 0.2);
            transform: translateY(-1px);
        }

        .btn-accent {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            box-shadow: 0 4px 6px -1px rgba(8, 145, 178, 0.2), 0 2px 4px -1px rgba(8, 145, 178, 0.1);
        }

        .btn-accent:hover {
            background: linear-gradient(135deg, #0e7490 0%, #155e75 100%);
            box-shadow: 0 6px 8px -1px rgba(8, 145, 178, 0.3), 0 4px 6px -1px rgba(8, 145, 178, 0.2);
            transform: translateY(-1px);
        }

        /* Section active state */
        .section-active {
            background: linear-gradient(90deg, rgba(5, 150, 105, 0.08) 0%, rgba(5, 150, 105, 0.03) 100%);
            border-left: 4px solid #059669;
        }

        /* Glass morphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Table styling for Corporate Qualifications section */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.875rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .prose table thead {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }

        .prose table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #d1d5db;
            font-size: 0.875rem;
        }

        .prose table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
        }

        .prose table tbody tr:hover {
            background-color: #f9fafb;
        }

        .prose table tbody tr:last-child td {
            border-bottom: none;
        }

        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .prose h3:first-child {
            margin-top: 0;
        }

        .prose p {
            margin-bottom: 1rem;
            line-height: 1.75;
        }

        #finalProposalContent img,
        .proposal-page img {
            max-width: 100%;
            height: auto;
        }

        .proposal-editor-toolbar button {
            border: 1px solid #e5e7eb;
            background: #ffffff;
            color: #374151;
            padding: 0.4rem 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
        }

        .proposal-editor-toolbar button:hover {
            border-color: #d1d5db;
            color: #111827;
        }

        .proposal-editor-toolbar button.is-active {
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
            color: #111827;
        }

        #finalProposalFrame {
            background: #f3f4f6;
        }

        #finalProposalContent {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
            margin: 24px auto;
            max-width: 816px;
            min-height: 1056px;
            transform-origin: top center;
        }

        .proposal-page {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
            margin: 0 auto 24px;
            max-width: 816px;
            min-height: 1056px;
            padding: 3rem;
        }

        @media (max-width: 900px) {
            #finalProposalContent,
            .proposal-page {
                max-width: 100%;
            }
        }

        .section-action-bar {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.75rem;
        }

        #sectionList li {
            padding: 0.15rem 0.5rem;
        }

        .proposal-fullscreen {
            position: fixed;
            inset: 16px;
            z-index: 60;
            max-width: none !important;
            margin: 0 !important;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.2);
        }

        .proposal-fullscreen #finalProposalFrame {
            height: calc(100vh - 220px) !important;
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='light_theme_overrides.css') }}">
</head>

<body class="bg-gradient-to-br from-gray-50 via-gray-100 to-gray-50 text-gray-800 h-screen overflow-hidden">
    <div class="flex h-full overflow-hidden">
        <!-- Section navigator - Fixed Left Sidebar -->
        <aside class="hidden lg:flex lg:w-80.2 bg-white border-r border-gray-200 flex-col shadow-sm h-full">
            <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h1 class="text-lg font-semibold text-gray-900">Add new section</h1>
                    <div class="flex items-center gap-2">
                        <button id="generateAllBtn"
                            class="inline-flex items-center justify-center h-9 w-9 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 transition-all hover:scale-110 shadow-sm"
                            title="Generate content for all sections automatically">
                            <i class="fas fa-magic"></i>
                        </button>
                        <button id="evaluateHeadersBtn"
                            class="inline-flex items-center justify-center h-9 w-9 rounded-full bg-purple-50 text-purple-600 hover:bg-purple-100 transition-all hover:scale-110 shadow-sm"
                            title="Evaluate RFP and list recommended headers (TOC)">
                            <i class="fas fa-list-check"></i>
                        </button>
                        <button id="addSectionBtn"
                            class="inline-flex items-center justify-center h-9 w-9 rounded-full bg-emerald-50 text-emerald-600 hover:bg-emerald-100 transition-all hover:scale-110 shadow-sm"
                            title="Add new custom section">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Compliance Blueprint & Draft Builder Section -->
            <!-- <section id="rfpDeepAnalysisSection"
                class="mx-4 mt-4 mb-4 bg-white rounded-sm border border-gray-200 shadow-md card-hover overflow-hidden flex-shrink-0">
                <div class="px-4 py-4 border-b border-gray-100 bg-gradient-to-r from-white to-gray-50">
                    <div class="mb-3">
                        <h3 class="text-base font-semibold text-gray-900 mb-1">Compliance Blueprint & Draft Builder</h3>
                        <p class="text-xs text-gray-500">Run a full compliance analysis and receive a proposal-ready outline, boilerplate drafts, templates, and submission checklist tailored to this RFP.</p>
                    </div>
                    <button id="runDeepAnalysisBtn"
                        class="w-full btn-secondary inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-white disabled:opacity-60 disabled:cursor-not-allowed">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        <span>Analyze RFP</span>
                    </button>
                </div>
                <div class="px-4 py-4 space-y-3">
                    <div id="deepAnalysisStatus"
                        class="hidden rounded-lg border border-cyan-200 bg-cyan-50 px-3 py-2 text-xs text-cyan-700 flex items-center gap-2">
                        <div class="h-3 w-3 border-2 border-cyan-200 border-t-cyan-600 rounded-full animate-spin"></div>
                        <span>Analyzing RFP documents. This may take a moment…</span>
                    </div>
                    <div id="deepAnalysisError" class="hidden rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-600"></div>
                    <div id="deepAnalysisOutput"
                        class="prose prose-emerald max-w-none text-gray-800 leading-relaxed space-y-3 text-xs"></div>
                </div>
            </section> -->
            
            <div class="flex-1 overflow-y-auto">
                <ul id="sectionList" class="divide-y divide-gray-100">
                    <!-- populated via JS -->
                </ul>
            </div>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden">
            <div class="flex flex-1 overflow-hidden h-full">
                {% set viewer_bid_id = bid_context.g_id if bid_context and bid_context.g_id else None %}
                {% if not viewer_bid_id %}
                {% set viewer_bid_id = bid_context.bid_id if bid_context and bid_context.bid_id else (bid_id if
                bid_id
                else None) %}
                {% endif %}
                <main class="flex-1 overflow-y-auto px-5 lg:px-8 py-6 space-y-6 h-full max-w-[1200px] mx-auto">
                    <!-- RFP Name Header -->
                    {% if bid_context and bid_context.rfp_label %}
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                                    <i class="fas fa-file-pdf text-emerald-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-0.5">RFP Document</p>
                                <h2 class="text-lg font-semibold text-gray-900 truncate">{{ bid_context.rfp_label }}</h2>
                            </div>
                        </div>
                    </div>
                    {% elif bid_context and bid_context.project_name %}
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                                    <i class="fas fa-file-pdf text-emerald-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-0.5">RFP Document</p>
                                <h2 class="text-lg font-semibold text-gray-900 truncate">{{ bid_context.project_name }}</h2>
                            </div>
                        </div>
                    </div>
                    {% elif bid_name %}
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                                    <i class="fas fa-file-pdf text-emerald-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-0.5">RFP Document</p>
                                <h2 class="text-lg font-semibold text-gray-900 truncate">{{ bid_name }}</h2>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Requirements and Attachments Section (Hidden by default, shown when selected) -->
                    <section id="requirementsAttachmentsSection"
                        class="hidden bg-white rounded-2xl border border-gray-200 shadow-lg card-hover">
                        <div class="px-6 py-5 border-b border-gray-100">
                            <h3 class="text-2xl font-semibold text-gray-900 leading-tight mb-2">Requirements and
                                Attachments</h3>
                            <p class="text-sm text-gray-600 leading-relaxed">Review the requirements and required
                                attachments extracted from the RFP document. Upload your documents to fulfill the
                                attachment requirements.</p>
                        </div>
                        <div class="px-6 py-6 space-y-6">
                            <!-- Analyze Requirements Button -->
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-sm font-semibold uppercase tracking-wide text-gray-500 mb-1">
                                        RFP REQUIREMENTS & ATTACHMENTS</h4>
                                    <p class="text-xs text-gray-500">Click to analyze the RFP and extract all
                                        requirements and required attachments.</p>
                                </div>
                                <button id="analyzeRequirementsBtn"
                                    class="btn-accent inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none">
                                    <i class="fas fa-search"></i>
                                    Analyze RFP
                                </button>
                            </div>

                            <!-- Loading State -->
                            <div id="requirementsAnalyzing"
                                class="hidden flex items-center gap-2 text-sm text-cyan-600">
                                <div
                                    class="h-4 w-4 border-2 border-cyan-200 border-t-cyan-600 rounded-full animate-spin">
                                </div>
                                <span>Analyzing RFP document for requirements and attachments...</span>
                            </div>

                            <!-- Requirements Display -->
                            <div id="requirementsDisplay"
                                class="hidden rounded-xl border border-cyan-100 bg-cyan-50/60 px-4 py-4 text-sm text-gray-700 space-y-4">
                                <div class="flex items-center justify-between gap-3">
                                    <h5 class="text-sm font-semibold text-gray-900 uppercase tracking-wide">
                                        EXTRACTED REQUIREMENTS & ATTACHMENTS</h5>
                                    <span class="text-xs text-gray-400">From RFP analysis</span>
                                </div>
                                <div id="requirementsItemsList" class="space-y-3 mt-4">
                                    <!-- Individual requirement items will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Section metadata -->
                    <section id="regularSectionDisplay"
                        class="bg-white rounded-2xl border border-gray-200 shadow-lg card-hover overflow-hidden">
                        <div
                            class="border-b border-gray-100 px-6 py-5 flex items-start justify-between bg-gradient-to-r from-white to-gray-50">
                            <div>
                                <div
                                    class="mb-1 inline-flex items-center gap-1 rounded-full bg-emerald-50 px-3 py-1 text-sm font-medium text-emerald-700">
                                    <span id="sectionStatus">Saved</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <h3 id="sectionTitleDisplay"
                                        class="text-2xl font-semibold text-gray-900 leading-tight"></h3>
                                    <button id="renameSectionBtn"
                                        class="text-sm text-emerald-600 hover:text-emerald-700 font-medium transition-colors">Rename</button>
                                </div>
                            </div>
                            <button
                                class="hidden md:inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-500 hover:border-gray-300">
                                <i class="fas fa-chart-line"></i>
                                <span>Evaluate</span>
                            </button>
                        </div>

                        <div class="px-6 py-6 space-y-8">
                            <div>
                                <h4 class="text-sm font-semibold uppercase tracking-wide text-gray-500 mb-3">
                                    Guidelines</h4>
                                <div class="rounded-xl border border-dashed border-cyan-200 bg-cyan-50/60 px-4 py-4 text-sm text-cyan-800 leading-relaxed"
                                    id="sectionGuidanceDisplay"></div>
                            </div>

                            <div class="space-y-4">
                                <div class="section-action-bar flex flex-wrap items-center gap-3">
                                    <button id="quickSaveBtn"
                                        class="btn-primary inline-flex items-center gap-2 rounded-lg px-4 py-2.5 text-sm font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-save"></i>
                                        Save Section
                                    </button>
                                    <button id="reviewGenerateBtn"
                                        class="btn-secondary inline-flex items-center gap-2 rounded-lg px-4 py-2.5 text-sm font-semibold text-white">
                                        <i class="fas fa-bolt"></i>
                                        Generate Draft
                                    </button>
                                    <!-- <button id="refineContentBtn"
                                        class="inline-flex items-center gap-2 rounded-lg border border-emerald-300 bg-emerald-50 px-4 py-2.5 text-sm font-semibold text-emerald-800 hover:bg-emerald-100"
                                        title="Regenerate this section to strictly align with the RFP and remove unsupported suggestions">
                                        <i class="fas fa-magic"></i>
                                        Improve
                                    </button>
                                    <button id="setOpenAIKeyBtn"
                                        class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                                        title="Use your own OpenAI API key for higher-quality drafting">
                                        <i class="fas fa-key"></i>
                                        Apply OpenAI Key
                                    </button>
                                    <span id="customKeyBadge" class="hidden text-xs rounded-md bg-purple-100 text-purple-800 px-2 py-1">Custom key active</span> -->
                                    
                                    <button id="attachPricingFileBtn"
                                        class="hidden inline-flex items-center gap-2 rounded-lg border border-gray-300 px-4 py-2.5 text-sm font-semibold text-gray-700 hover:bg-gray-50"
                                        title="Attach pricing-related PDF or images for Payment Schedule">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                        Attach File
                                    </button>
                                    
                                    <button id="attachSectionAnyFileBtn"
                                        class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2.5 text-sm font-semibold text-gray-700 hover:bg-gray-50"
                                        title="Attach files to the current section (inserted into final proposal)">
                                        <i class="fas fa-image"></i>
                                        Add Files
                                    </button>
                                    <input type="file" id="ptsImageInput" class="hidden" accept="image/png,image/jpeg,image/jpg,image/webp,application/pdf,.pdf" multiple>
                                    <input type="file" id="pricingFileInput" class="hidden" accept="image/png,image/jpeg,image/jpg,image/webp,application/pdf,.pdf" multiple>
                                    
                                    <input type="file" id="sectionImageInput" class="hidden" accept="image/png,image/jpeg,image/jpg,image/webp" multiple>
                                    <input type="file" id="sectionAnyFileInput" class="hidden" accept="image/png,image/jpeg,image/jpg,image/webp,application/pdf,.pdf" multiple>
                                    <button id="writeManuallyBtn"
                                        class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-4 py-2.5 text-sm font-semibold text-gray-700 hover:bg-gray-50">
                                        <i class="fas fa-pen"></i>
                                        Edit Manually
                                    </button>
                                    <!-- <p class="text-xs text-gray-500">The AI builder stitches the narrative based on your RFP and company profile.</p> -->
                                </div>
                                <div id="sectionAttachmentsPanel" class="hidden rounded-xl border border-gray-200 bg-gray-50 px-4 py-3">
                                    <div class="flex items-center justify-between">
                                        <h5 class="text-sm font-semibold text-gray-700">Section attachments</h5>
                                        <span id="sectionAttachmentsCount" class="text-xs text-gray-500"></span>
                                    </div>
                                    <div id="sectionAttachmentsList" class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
                                </div>
                                <!-- <div class="rounded-2xl border border-cyan-100 bg-white px-4 py-4 shadow-sm space-y-3">
                                    <div class="flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
                                        <div>
                                            <p class="text-sm font-semibold uppercase tracking-wide text-gray-600">
                                                AI REQUIREMENTS OUTLINE</p>
                                            <p class="text-xs text-gray-500">Extracts mandatory requirements for this
                                                section by reading the linked RFP document.</p>
                                        </div>
                                        <button id="outlineAnalyzeBtn"
                                            class="btn-accent inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none">
                                            <i class="fas fa-robot"></i>
                                            Analyze with AI
                                        </button>
                                    </div>
                                    <div id="outlineAnalyzing"
                                        class="hidden flex items-center gap-2 text-sm text-cyan-600">
                                        <div
                                            class="h-4 w-4 border-2 border-cyan-200 border-t-cyan-600 rounded-full animate-spin">
                                        </div>
                                        <span>Reviewing RFP content for section requirements…</span>
                                    </div>
                                    <div id="outlineResultContainer"
                                        class="hidden rounded-xl border border-cyan-100 bg-cyan-50/60 px-4 py-3 text-sm text-gray-700 space-y-3">
                                        <div class="flex items-center justify-between gap-3">
                                            <h5 class="text-sm font-semibold text-gray-900 uppercase tracking-wide">
                                                AI
                                                Output</h5>
                                            <span class="text-xs text-gray-400">Formatted for direct proposal
                                                use</span>
                                        </div>
                                        <div id="outlineContent"
                                            class="whitespace-pre-wrap text-sm leading-relaxed text-gray-700"></div>
                                    </div>
                                </div> -->
                                <div id="subCategoryContentDisplay"
                                    class="hidden mb-4 prose prose-cyan max-w-none text-gray-700 leading-relaxed space-y-3 p-4 bg-cyan-50 rounded-lg border border-cyan-200">
                                    <h5 class="text-lg font-semibold text-gray-900 mb-2" id="subCategoryTitleDisplay">
                                    </h5>
                                    <div id="subCategoryContentText" class="text-gray-700"></div>
                                </div>
                                <div id="sectionContentDisplay"
                                    class="prose prose-blue max-w-none text-gray-700 leading-relaxed space-y-3">
                                </div>
                                <div id="sectionFlagsDisplay" class="hidden mt-2"></div>
                                <textarea id="sectionContentEditor"
                                    class="hidden w-full rounded-xl border border-gray-300 px-4 py-3 text-sm leading-relaxed focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                    rows="12"></textarea>
                                <div id="editorActions" class="hidden flex justify-end gap-3 mt-3">
                                    <button id="cancelEditBtn"
                                        class="px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">Cancel</button>
                                    <button id="saveSectionBtn"
                                        class="btn-primary px-4 py-2 rounded-lg text-sm font-semibold text-white">Save
                                        section</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="rfpPreviewSection"
                        class="bg-white rounded-2xl border border-gray-200 shadow-lg card-hover overflow-hidden"
                        data-bid-id="{{ viewer_bid_id or '' }}"
                        data-api="{{ url_for('api_rfp_file_parsed', g_id=viewer_bid_id) if viewer_bid_id else '' }}"
                        data-view-url="{{ url_for('view_rfp_file_by_g', g_id=viewer_bid_id) if viewer_bid_id else '' }}">
                        <div
                            class="px-6 py-5 border-b border-gray-100 flex items-center justify-between bg-gradient-to-r from-white to-gray-50">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">RFP Source Document</h3>
                                <!-- <p class="text-sm text-gray-500 mt-1">RFP files are automatically loaded from the
                                    database. Preview the latest RFP attachment and review extracted text snippets.
                                </p> -->
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="file" id="rfpUploadInput" class="hidden" accept=".pdf" multiple>
                                <button id="rfpUploadBtn"
                                    class="btn-secondary inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium text-white {{ '' if viewer_bid_id else 'hidden' }}"
                                    title="Upload additional RFP PDF (files from database are already loaded)">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    Upload PDFs
                                </button>
                                <button id="rfpReloadBtn"
                                    class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-600 hover:border-gray-300 {{ '' if viewer_bid_id else 'hidden' }}">
                                    <i class="fas fa-rotate-right"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="px-6 py-6 grid gap-6 lg:grid-cols-1">
                            <div class="flex flex-col gap-3">
                                {% if viewer_bid_id %}
                                <!-- PDF Editor Controls -->
                                <div id="pdfEditorControls" class="flex items-center justify-between gap-2 mb-2 hidden">
                                    <div class="flex items-center gap-2">
                                        <button id="pdfPrevPage" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                            <i class="fas fa-chevron-left"></i> Previous
                                        </button>
                                        <span id="pdfPageInfo" class="px-3 py-1.5 text-sm text-gray-700">Page 1 of 1</span>
                                        <button id="pdfNextPage" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                            Next <i class="fas fa-chevron-right"></i>
                                        </button>
                                        <input type="number" id="pdfPageInput" min="1" value="1" 
                                            class="w-16 px-2 py-1.5 text-sm border border-gray-300 rounded-lg text-center">
                                        <button id="pdfGoToPage" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                            Go
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="pdfZoomOut" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                            <i class="fas fa-search-minus"></i>
                                        </button>
                                        <span id="pdfZoomLevel" class="px-2 text-sm text-gray-700">100%</span>
                                        <button id="pdfZoomIn" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        <button id="pdfAddText" class="px-3 py-1.5 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700">
                                            <i class="fas fa-font"></i> Add Text
                                        </button>
                                        <button id="pdfExport" class="px-3 py-1.5 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700">
                                            <i class="fas fa-download"></i> Export PDF
                                        </button>
                                    </div>
                                </div>
                                <!-- PDF Canvas Viewer -->
                                <div id="pdfViewerContainer" class="w-full rounded-xl border border-gray-200 bg-gray-50 shadow-inner overflow-auto" style="height: 520px;">
                                    <div id="pdfWrapper" class="relative mx-auto">
                                        <canvas id="pdfCanvas" class="block"></canvas>
                                        <div id="textOverlayLayer" class="absolute inset-0 pointer-events-none"></div>
                                    </div>
                                    <div id="pdfLoadingIndicator" class="flex items-center justify-center h-full absolute inset-0 pointer-events-none">
                                        <div class="text-center">
                                            <div class="h-8 w-8 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mx-auto mb-2"></div>
                                            <p class="text-sm text-gray-500">Loading PDF...</p>
                                        </div>
                                    </div>
                                    <div id="pdfErrorIndicator" class="hidden flex items-center justify-center h-full">
                                        <div class="text-center">
                                            <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mb-2"></i>
                                            <p class="text-sm text-gray-500">PDF preview unavailable. Attempting to decrypt...</p>
                                        </div>
                                    </div>
                                </div>
                                <p id="rfpPreviewFallback" class="hidden text-sm text-gray-500">The RFP preview is
                                    currently unavailable.</p>
                                {% else %}
                                <div class="flex flex-col items-center justify-center w-full h-[220px] rounded-xl border border-dashed border-gray-200 bg-gray-50 text-sm text-gray-500 gap-3">
                                    <p>Select or attach a bid to preview its RFP.</p>
                                    <button id="rfpUploadEmptyStateBtn" class="btn-secondary inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium text-white shadow-sm hover:shadow-md transition-all">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        Upload RFP PDF
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            <div id="rfpParseStatus" class="px-6 pb-4 text-xs text-gray-500 hidden"></div>
                            <!-- <div class="flex flex-col gap-3">
                                <div id="rfpParseStatus" class="text-xs text-gray-500 hidden"></div>
                                <div id="rfpTextContainer" class="min-h-[200px] max-h-[520px] overflow-y-auto rounded-xl border border-gray-200 bg-white p-4 shadow-inner text-sm leading-relaxed space-y-4">
                                    {% if not viewer_bid_id %}
                                    <p class="text-sm text-gray-500">Attach an RFP PDF to view its extracted content.</p>
                                    {% endif %}
                                </div>
                                <button id="rfpLoadMoreBtn"
                                        class="hidden self-start inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-600 hover:border-gray-300">
                                    <i class="fas fa-layer-group"></i>
                                    Load more pages
                                </button>
                            </div>
                        </div> -->
                    </section>

                    <!-- Processing status -->
                    <section id="processingStatus"
                        class="hidden bg-white rounded-2xl border border-cyan-100 px-6 py-6 shadow-sm">
                        <div class="flex items-start gap-4">
                            <div class="mt-1">
                                <div
                                    class="h-6 w-6 border-2 border-cyan-200 border-t-cyan-600 rounded-full animate-spin">
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-cyan-800">Generating proposal package</h4>
                                <!-- <p class="text-sm text-cyan-700 mt-1">We are assembling all required sections and attachments. This typically takes less than a minute for standard RFPs.</p> -->
                                <div id="statusContent" class="mt-4 grid gap-3 text-sm text-cyan-800"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Generated proposals moved into Proposal settings section -->

                    <!-- Final proposal preview -->
                    <section id="finalProposalPreviewSection"
                        class="hidden bg-white rounded-2xl border border-gray-200 shadow-lg card-hover overflow-hidden">
                        <div
                            class="px-6 py-5 flex flex-col gap-3 md:flex-row md:items-center md:justify-between border-b border-gray-100 bg-gradient-to-r from-white to-gray-50">
                            <div>
                                <h3 id="finalProposalTitle" class="text-xl font-semibold text-gray-900">Final Proposal Draft</h3>
                                <p class="text-sm text-gray-500" id="finalProposalStatus">Review the compiled proposal
                                    before downloading.</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="finalProposalEditBtn"
                                    class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-white-600 hover:border-gray-300">
                                    <i class="fas fa-edit"></i>
                                    <!-- <span>Edit Preview</span> -->
                                </button>
                                <button id="finalProposalSaveBtn"
                                    class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-600 hover:border-gray-300"
                                    title="Save preview changes">
                                    <i class="fas fa-floppy-disk"></i>
                                </button>
                                <button id="finalProposalDownloadBtn"
                                    class="btn-primary inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-download"></i>
                                    <!-- <span>Download DOCX</span> -->
                                </button>
                            </div>
                        </div>
                        <div class="px-6 py-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <button id="finalProposalPrevBtn"
                                        class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-600 hover:border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-arrow-left"></i>
                                        <span>Previous</span>
                                    </button>
                                    <button id="finalProposalNextBtn"
                                        class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-600 hover:border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <span>Next</span>
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-3">
                                    <label class="sr-only" for="finalProposalTocSelect">Jump to section</label>
                                    <select id="finalProposalTocSelect"
                                        class="min-w-[220px] max-w-xs rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                        <option value="" selected disabled>Jump to section…</option>
                                    </select>
                                    <div class="text-sm text-gray-500">
                                        Page <span id="finalProposalPageCurrent">1</span> of <span id="finalProposalPageTotal">1</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mx-auto" style="max-width: 850px;">
                                <div id="finalProposalEditorShell" class="proposal-editor-toolbar mb-4 flex flex-wrap items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2">
                                    <select id="finalProposalFormat"
                                        class="rounded-lg border border-gray-300 px-2 py-1 text-xs text-gray-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                        <option value="p" selected>Normal</option>
                                        <option value="h1">Heading 1</option>
                                        <option value="h2">Heading 2</option>
                                        <option value="h3">Heading 3</option>
                                        <option value="blockquote">Quote</option>
                                        <option value="pre">Code</option>
                                    </select>
                                    <select id="finalProposalFont"
                                        class="rounded-lg border border-gray-300 px-2 py-1 text-xs text-gray-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                        <option value="Aptos">Aptos</option>
                                        <option value="Calibri">Calibri</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Georgia">Georgia</option>
                                        <option value="Garamond">Garamond</option>
                                        <option value="Arial">Arial</option>
                                    </select>
                                    <select id="finalProposalFontSize"
                                        class="rounded-lg border border-gray-300 px-2 py-1 text-xs text-gray-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                        <option value="2">10</option>
                                        <option value="3" selected>12</option>
                                        <option value="4">14</option>
                                        <option value="5">16</option>
                                        <option value="6">18</option>
                                        <option value="7">24</option>
                                    </select>
                                    <button type="button" data-editor-cmd="bold" title="Bold">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="italic" title="Italic">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="underline" title="Underline">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="strikeThrough" title="Strikethrough">
                                        <i class="fas fa-strikethrough"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="insertUnorderedList" title="Bulleted list">
                                        <i class="fas fa-list-ul"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="insertOrderedList" title="Numbered list">
                                        <i class="fas fa-list-ol"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="justifyLeft" title="Align left">
                                        <i class="fas fa-align-left"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="justifyCenter" title="Align center">
                                        <i class="fas fa-align-center"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="justifyRight" title="Align right">
                                        <i class="fas fa-align-right"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="justifyFull" title="Justify">
                                        <i class="fas fa-align-justify"></i>
                                    </button>
                                    <button type="button" id="finalProposalInsertLink" title="Insert link">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button type="button" id="finalProposalInsertTable" title="Insert table">
                                        <i class="fas fa-table"></i>
                                    </button>
                                    <button type="button" id="finalProposalInsertImage" title="Insert image">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="removeFormat" title="Clear formatting">
                                        <i class="fas fa-eraser"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="undo" title="Undo">
                                        <i class="fas fa-rotate-left"></i>
                                    </button>
                                    <button type="button" data-editor-cmd="redo" title="Redo">
                                        <i class="fas fa-rotate-right"></i>
                                    </button>
                                    <button type="button" id="finalProposalFullscreenBtn" title="Full screen">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                    <button type="button" id="finalProposalClearBtn" title="Clear document">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <div class="ml-auto flex items-center gap-2 text-xs text-gray-500">
                                        <span>Zoom</span>
                                        <select id="finalProposalZoom"
                                            class="rounded-lg border border-gray-300 px-2 py-1 text-xs text-gray-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                            <option value="0.85">85%</option>
                                            <option value="1" selected>100%</option>
                                            <option value="1.15">115%</option>
                                            <option value="1.3">130%</option>
                                            <option value="1.5">150%</option>
                                        </select>
                                    </div>
                                </div>
                                <input type="file" id="finalProposalImageInput" accept="image/*" class="hidden">
                                <div id="finalProposalFrame"
                                    class="bg-white border border-gray-200 rounded-xl shadow overflow-auto"
                                    style="height: 1122px;">
                                    <div
                                        class="prose prose-blue max-w-none text-gray-800 leading-relaxed space-y-4 p-8"
                                        id="finalProposalContent">
                                        <p class="text-gray-500 text-sm">Your compiled proposal will appear here once generated.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Proposal settings -->
                    <section class="bg-white rounded-2xl border border-gray-200 shadow-lg card-hover overflow-hidden">
                        <div class="px-6 py-5 flex items-center justify-between border-b border-gray-100 bg-gradient-to-r from-white to-gray-50">
                            <h3 class="text-xl font-semibold text-gray-900">Proposal settings</h3>
                            <div class="flex items-center gap-2">
                                <button id="generateProposalBtn"
                                    class="btn-primary inline-flex items-center gap-1 rounded px-3 py-2 text-sm text-white font-medium transition-all">
                                    <i class="fas fa-wand-magic-sparkles text-[9px]"></i>
                                    <span>Generate Proposal</span>
                                </button>
                            </div>
                        </div>
                        <div class="px-6 py-6">
                            <form id="uploadForm" action="{{ url_for('proposals_making') }}" method="POST"
                                enctype="multipart/form-data" class="space-y-4">
                                {% set linked_bid_id = viewer_bid_id if viewer_bid_id else (bid_id if bid_id else None)
                                %}
                                {% if linked_bid_id %}
                                <input type="hidden" name="bid_id" value="{{ linked_bid_id }}">
                                <input type="hidden" name="g_id" value="{{ linked_bid_id }}">
                                {% endif %}
                                {% if bid_name %}
                                <input type="hidden" name="bid_name" value="{{ bid_name }}">
                                {% endif %}
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="company" class="text-sm font-medium text-gray-700 mb-2 block">Select Company</label>
                                        <select name="company" id="company" required
                                            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all">
                                            <option value="">-- Select Company --</option>
                                            <option value="IKIO" {% if company=='IKIO' %}selected{% endif %}>IKIO</option>
                                            <option value="METCO" {% if company=='METCO' %}selected{% endif %}>METCO</option>
                                            <option value="SUNSPRINT" {% if company=='SUNSPRINT' %}selected{% endif %}>SUNSPRINT</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label for="proposalTemplate" class="text-sm font-medium text-gray-700 mb-2 block">Proposal Template</label>
                                        <select name="template" id="proposalTemplate" required
                                            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all">
                                            <option value="standard">Standard Proposal Template</option>
                                            <option value="technical">Technical Proposal Template</option>
                                            <option value="commercial">Commercial Proposal Template</option>
                                        </select>
                                    </div>
                                </div>

                                <button type="submit" class="hidden" id="generateSubmitHelper"></button>
                            </form>
                            <!-- Generated proposals (merged here) -->
                            <div class="mt-8 pt-6 border-t border-gray-100">
                                <div class="flex items-center justify-between">
                                    <h4 class="text-lg font-semibold text-gray-900">Generated Proposals</h4>
                                    <button onclick="refreshProposals()"
                                        class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-600 hover:border-gray-300">
                                        <i class="fas fa-sync-alt"></i>
                                        Refresh
                                    </button>
                                </div>
                                <div id="proposalsList" class="mt-4 space-y-4">
                                    {% if proposals %}
                                    {% for proposal in proposals %}
                                    <article
                                        class="rounded-xl border border-gray-200 px-4 py-4 hover:border-emerald-200 hover:shadow-sm transition card-hover">
                                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                            <div>
                                                <h4 class="text-lg font-semibold text-gray-900">{{ proposal.name }}</h4>
                                                <dl class="mt-2 flex flex-wrap gap-x-6 gap-y-1 text-sm text-gray-600">
                                                    <div class="flex items-center gap-2">
                                                        <i class="fas fa-file-pdf text-red-500"></i>
                                                        <dt class="font-medium text-gray-700">RFP:</dt>
                                                        <dd>{{ proposal.rfp_name }}</dd>
                                                    </div>
                                                    {% if proposal.company %}
                                                    <div class="flex items-center gap-2">
                                                        <i class="fas fa-building text-gray-400"></i>
                                                        <dt class="font-medium text-gray-700">Company:</dt>
                                                        <dd>{{ proposal.company }}</dd>
                                                    </div>
                                                    {% endif %}
                                                    {% if proposal.bid_name %}
                                                    <div class="flex items-center gap-2">
                                                        <i class="fas fa-tag text-gray-400"></i>
                                                        <dt class="font-medium text-gray-700">Bid:</dt>
                                                        <dd>{{ proposal.bid_name }}{% if proposal.bid_id %} · ID {{
                                                            proposal.bid_id }}{% endif %}</dd>
                                                    </div>
                                                    {% endif %}
                                                    <div class="flex items-center gap-2">
                                                        <i class="fas fa-clock text-gray-400"></i>
                                                        <dt class="font-medium text-gray-700">Generated:</dt>
                                                        <dd>{{ proposal.created_at }}</dd>
                                                    </div>
                                                </dl>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <a href="{{ proposal.download_url }}"
                                                    class="btn-primary inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-white">
                                                    <i class="fas fa-download"></i>
                                                    Download
                                                </a>
                                            </div>
                                        </div>
                                    </article>
                                    {% endfor %}
                                    {% else %}
                                    <p class="text-center text-gray-500">No proposals generated yet. Attach your RFP and
                                        click Generate Proposal to get started.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </section>
                </main>

            <!-- AI helper / settings - Fixed Right Sidebar -->
            <aside
                class="hidden xl:block w-96 border-l border-gray-200 bg-white shadow-sm h-full flex flex-col overflow-hidden scrollbar">
                <div class="px-6 py-6 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white flex-shrink-0">
                    <h3 class="text-xl font-semibold text-gray-900">AI Agent</h3>
                    <!-- <p class="text-sm text-gray-500 mt-1"></p> -->
                </div>
                <div class="flex-1 overflow-y-auto">
                    <div class="px-6 py-6 space-y-5">


                        <div
                            class="rounded-2xl border border-gray-200 bg-white shadow-sm card-hover flex flex-col h-[800px]">
                            <div class="flex items-center gap-3 px-5 py-4 border-b border-gray-200 flex-shrink-0">
                                <span
                                    class="h-10 w-10 inline-flex items-center justify-center rounded-xl bg-slate-100 text-slate-500 text-lg">
                                    <i class="fas fa-pencil-alt"></i>
                                </span>
                                <div>
                                    <p class="font-semibold text-gray-900">Ask Questions related to the RFP</p>
                                    <!-- <p class="text-sm text-gray-500">Type your query below and get a quick AI
                                        response.
                                    </p> -->
                                </div>
                            </div>

                            <!-- Chat Messages Container -->
                            <div id="generalQueryResponse" class="flex-1 overflow-y-auto px-4 py-4 space-y-4 bg-gray-50"
                                style="scrollbar-width: none; -ms-overflow-style: none;">
                                <!-- Messages will be rendered here -->
                            </div>
                            <style>
                                #generalQueryResponse::-webkit-scrollbar {
                                    display: none;
                                }
                            </style>

                            <!-- Input Area at Bottom -->
                            <div class="border-t border-gray-200 bg-white px-4 py-4 flex-shrink-0">
                                <form id="generalQueryForm" class="flex items-end gap-2">
                                    <div class="flex w-full">
                                        <textarea id="generalQueryInput" name="general_query" rows="1"
                                            placeholder="Enter your question..."
                                            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 resize-none transition-all max-h-32 overflow-y-auto"
                                            style="min-height: 40px;"></textarea>
                                    </div>
                                    <button type="submit"
                                        class="btn-accent inline-flex items-center justify-center gap-2 rounded-lg px-3 py-2 text-sm font-semibold text-white h-10 flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-paper-plane"></i>
                                        <span class="hidden sm:inline">Send</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    </div>
    </div>

    <script id="proposal-context-data" type="application/json">
        {{ {
            'sections': sections_outline,
            'bid': bid_context,
            'company': company or '',
            'contactEmail': contact_email or ''
        } | tojson | safe }}
    </script>

    <script>
        const proposalContextElement = document.getElementById('proposal-context-data');
        const proposalContext = proposalContextElement ? JSON.parse(proposalContextElement.textContent || '{}') : {};
        window.__proposalContext = proposalContext;

        const fallbackSections = [
            {
                id: 'section-1',
                title: 'Letter of Transmittal ',
                status: 'Saved',
                guidance: 'Summarize the company name, point of contact, DUNS, CAGE, and address exactly as stated in SAM.gov. Include the solicitation number and clearly mark the proposal volume.',
                content: [
                    'Apex Federal Solutions is pleased to submit this proposal for the Q-1075 SOF Operations Building Addition and Renovation at NAS Oceana Dam Neck Annex. We provide turnkey design-build services with proven performance on complex Department of Defense facility upgrades.',
                    'Primary Point of Contact: Jordan Blake, Program Director · (757) 555-1390 · proposals@apexfederal.com · 614 Patriot Way, Suite 200, Virginia Beach, VA 23451.',
                    'Secondary Contracting Contact: Lydia Chen, Director of Capture · (757) 555-2244 · contracts@apexfederal.com.',
                    'SAM UEI: X1Y2Z3A4B5C6 · CAGE Code: 4YV27. All representations and certifications are current in SAM as of November 2025.'
                ]
            },
            {
                id: 'section-2',
                title: '',
                status: 'In Progress',
                guidance: 'Add guidance for this new section.',
                content: [
                    'Use this placeholder section to capture unique narrative requirements called out in the solicitation. Drag and drop to reposition it where it makes the most sense in your proposal flow.'
                ]
            },
            {
                id: 'section-3',
                title: 'Acknowledgment of Amendments',
                status: 'Pending',
                guidance: 'List and acknowledge all solicitation amendments issued prior to proposal submission. Include amendment numbers and dates. If no amendments were issued, state “No amendments issued.”',
                content: [
                    'The offer or acknowledges receipt of Amendment 0001 dated 15 October 2025 and Amendment 0002 dated 22 October 2025. Each amendment has been incorporated into the technical approach, updated drawings, and pricing schedules.',
                    'No additional amendments were released. The offer or understands that failure to acknowledge future amendments may render the proposal non-responsive.'
                ]
            },
            {
                id: 'section-4',
                title: 'New Section',
                status: 'Draft',
                guidance: 'Add guidance for this new section.',
                content: []
            },
            {
                id: 'section-5',
                title: 'New Section',
                status: 'Draft',
                guidance: 'Add guidance for this new section.',
                content: []
            },
            {
                id: 'section-6',
                title: 'Price Proposal Form (Attachment A)',
                status: 'Saved',
                guidance: 'Ensure the pricing form mirrors the Government-provided Attachment A spreadsheet. Cross-check CLIN numbers, extended amounts, and totals.',
                content: [
                    'Attachment A – Price Proposal Form has been completed using the Government-furnished Excel workbook. The pricing reflects firm-fixed-price CLINs 0001 through 0004 and optional CLIN 0005.',
                    'Labor categories follow the Davis-Bacon wage determinations included in the RFP. Equipment and material estimates rely on current vendor quotes validated within the last 30 days.',
                    'A fully burdened cost summary and narrative assumptions are provided within Volume II for Contracting Officer review.'
                ]
            },
            {
                id: 'section-7',
                title: 'Bid Guarantee',
                status: 'Pending',
                guidance: 'Attach the bid bond or proof of surety. Confirm the surety is listed in Treasury Circular 570 and the amount meets the solicitation requirement.',
                content: [
                    'A bid bond in the amount of 20% of the total evaluated price is included. The bond is executed by Atlantic Surety Company (NAIC #12345), an approved corporate surety per Treasury Circular 570.',
                    'The original hard-copy bond with raised seal will be delivered to the Contracting Officer within one business day of electronic submission if requested.'
                ]
            },
            {
                id: 'section-8',
                title: 'Representations and Certifications',
                status: 'Saved',
                guidance: 'Confirm FAR 52.212-3 or 52.219-1 reps and certs are current. Include any additional provisions the contracting officer requested to be returned with the offer.',
                content: [
                    'Updated FAR and DFARS representations and certifications are incorporated by reference through the offer or’s active SAM registration.',
                    'Supplemental representations required under FAR 52.204-24, FAR 52.209-11, and FAR 52.223-18 are signed and attached in Appendix B.'
                ]
            },
            {
                id: 'section-9',
                title: 'Proposal Validity Statement',
                status: 'Saved',
                guidance: 'Reaffirm the validity period requested in the solicitation (commonly 120 or 180 days). Mention ability to extend upon Government request.',
                content: [
                    'This proposal, inclusive of price and technical commitments, remains valid for 120 calendar days from the date of submission. Apex Federal Solutions agrees to hold pricing steady during the Government evaluation period.',
                    'The offer or may extend the validity at no additional cost upon written request from the Contracting Officer.'
                ]
            }
        ];

        function isTableOfContentsSection(section) {
            if (!section) {
                return false;
            }
            const title = (section.title || '').toString().trim().toLowerCase();
            const sectionId = (section.id || '').toString().trim().toLowerCase();
            return title === 'table of contents' || sectionId === 'section-toc';
        }
        function isAppendixSection(section) {
            if (!section) return false;
            const title = (section.title || '').toString().trim().toLowerCase();
            const sectionId = (section.id || '').toString().trim().toLowerCase();
            return title === 'appendix' || sectionId === 'section-appendix';
        }

        const defaultSections = (() => {
            if (Array.isArray(proposalContext.sections) && proposalContext.sections.length > 0) {
                return proposalContext.sections
                    .filter(section => !isTableOfContentsSection(section) && !isAppendixSection(section))
                    .map((section, index) => ({
                    id: section.id || `section-${index + 1}`,
                    title: section.title || `Section ${index + 1}`,
                    status: section.status || 'Draft',
                    guidance: section.guidance || '',
                    content: Array.isArray(section.content)
                        ? section.content.slice()
                        : section.content
                            ? [String(section.content)]
                            : [],
                    rawContent: section.raw_content || '',
                    sub_categories: Array.isArray(section.sub_categories) ? section.sub_categories.slice() : []
                    }));
            }
            return fallbackSections
                .filter(section => !isTableOfContentsSection(section) && !isAppendixSection(section))
                .map((section, index) => ({
                id: section.id || `fallback-${index + 1}`,
                title: section.title,
                status: section.status,
                guidance: section.guidance,
                content: Array.isArray(section.content) ? section.content.slice() : [],
                rawContent: section.raw_content || '',
                sub_categories: Array.isArray(section.sub_categories) ? section.sub_categories.slice() : []
                }));
        })();

        const sectionListEl = document.getElementById('sectionList');
        const sectionTitleDisplay = document.getElementById('sectionTitleDisplay');
        const sectionGuidanceDisplay = document.getElementById('sectionGuidanceDisplay');

        // Ensure "Safety" and "Interconnection" appear after "Appendix" even if backend omitted them
        (function ensurePostAppendixSections() {
            try {
                const hasSafety = defaultSections.some(s => (s.id || '').toLowerCase() === 'section-safety' || (s.title || '').toLowerCase() === 'safety');
                const hasInterconnection = defaultSections.some(s => (s.id || '').toLowerCase() === 'section-interconnection' || (s.title || '').toLowerCase() === 'interconnection');
                if (hasSafety && hasInterconnection) return;
                const appendixIndex = defaultSections.findIndex(s => (s.id || '').toLowerCase() === 'section-appendix' || (s.title || '').toLowerCase() === 'appendix');
                const insertPos = appendixIndex >= 0 ? appendixIndex + 1 : defaultSections.length;
                const inserts = [];
                if (!hasSafety) {
                    inserts.push({
                        id: 'section-safety',
                        title: 'Safety',
                        status: 'Draft',
                        guidance: 'Describe safety systems, OSHA compliance, hazard mitigation, training, PPE, and incident reporting.',
                        content: [],
                        rawContent: '',
                        sub_categories: [
                            { id: 'safety-plan', title: 'Safety Plan' },
                            { id: 'safety-compliance', title: 'Regulatory Compliance' },
                            { id: 'safety-training', title: 'Training & Certifications' },
                            { id: 'safety-incident', title: 'Incident Response & Reporting' }
                        ]
                    });
                }
                if (!hasInterconnection) {
                    inserts.push({
                        id: 'section-interconnection',
                        title: 'Interconnection',
                        status: 'Draft',
                        guidance: 'Detail utility interconnection strategy: applications, studies, protection, metering, and commissioning.',
                        content: [],
                        rawContent: '',
                        sub_categories: [
                            { id: 'ic-applications', title: 'Applications & Permits' },
                            { id: 'ic-studies', title: 'Engineering Studies' },
                            { id: 'ic-protection', title: 'Protection & Controls' },
                            { id: 'ic-commissioning', title: 'Commissioning & Testing' }
                        ]
                    });
                }
                if (inserts.length) {
                    defaultSections.splice(insertPos, 0, ...inserts);
                }
            } catch (_) { /* no-op */ }
        })();
        const sectionContentDisplay = document.getElementById('sectionContentDisplay');
        const sectionContentEditor = document.getElementById('sectionContentEditor');
        const sectionStatus = document.getElementById('sectionStatus');
        const editorActions = document.getElementById('editorActions');
        const renameSectionBtn = document.getElementById('renameSectionBtn');
        const reviewGenerateBtn = document.getElementById('reviewGenerateBtn');
        const sectionFlagsDisplay = document.getElementById('sectionFlagsDisplay');
        const attachFileNearGenerateBtn = document.getElementById('attachFileNearGenerateBtn');
        const attachPricingFileBtn = document.getElementById('attachPricingFileBtn');
        const ptsImageInput = document.getElementById('ptsImageInput');
        const pricingFileInput = document.getElementById('pricingFileInput');
        const attachSectionAnyFileBtn = document.getElementById('attachSectionAnyFileBtn');
        const attachSectionImageBtn = document.getElementById('attachSectionImageBtn');
        const sectionAnyFileInput = document.getElementById('sectionAnyFileInput');
        const sectionImageInput = document.getElementById('sectionImageInput');
        const quickSaveBtn = document.getElementById('quickSaveBtn');
        const writeManuallyBtn = document.getElementById('writeManuallyBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveSectionBtn = document.getElementById('saveSectionBtn');
        const addSectionBtn = document.getElementById('addSectionBtn');
        const outlineAnalyzeBtn = document.getElementById('outlineAnalyzeBtn');
        const outlineAnalyzing = document.getElementById('outlineAnalyzing');
        const outlineResultContainer = document.getElementById('outlineResultContainer');
        const outlineContent = document.getElementById('outlineContent');
        const finalProposalPreviewSection = document.getElementById('finalProposalPreviewSection');
        const finalProposalContent = document.getElementById('finalProposalContent');
        const finalProposalStatus = document.getElementById('finalProposalStatus');
        const finalProposalDownloadBtn = document.getElementById('finalProposalDownloadBtn');
        const finalProposalEditBtn = document.getElementById('finalProposalEditBtn');
        const finalProposalSaveBtn = document.getElementById('finalProposalSaveBtn');
        const finalProposalFrame = document.getElementById('finalProposalFrame');
        const finalProposalPrevBtn = document.getElementById('finalProposalPrevBtn');
        const finalProposalZoom = document.getElementById('finalProposalZoom');
        const finalProposalImageInput = document.getElementById('finalProposalImageInput');
        const finalProposalInsertTable = document.getElementById('finalProposalInsertTable');
        const finalProposalInsertImage = document.getElementById('finalProposalInsertImage');
        const finalProposalFormat = document.getElementById('finalProposalFormat');
        const finalProposalFont = document.getElementById('finalProposalFont');
        const finalProposalFontSize = document.getElementById('finalProposalFontSize');
        const finalProposalInsertLink = document.getElementById('finalProposalInsertLink');
        const finalProposalFullscreenBtn = document.getElementById('finalProposalFullscreenBtn');
        const finalProposalClearBtn = document.getElementById('finalProposalClearBtn');
        const finalProposalEditorShell = document.getElementById('finalProposalEditorShell');
        const refineContentBtn = document.getElementById('refineContentBtn');
        const setOpenAIKeyBtn = document.getElementById('setOpenAIKeyBtn');
        const customKeyBadge = document.getElementById('customKeyBadge');
        // Track number of uploaded attachments per section so Save can be enabled post-attachment
        const sectionAttachmentCounts = {};
        // Track files chosen by the user but not yet uploaded (saved with section)
        const pendingSectionImageFiles = {};
        function getPendingAttachmentCount(sectionId) {
            const arr = pendingSectionImageFiles[sectionId];
            return Array.isArray(arr) ? arr.length : 0;
        }
        function sectionHasAttachments(sectionId) {
            if (!sectionId) return false;
            // Consider both persisted and pending attachments
            return (sectionAttachmentCounts[sectionId] || 0) > 0 || getPendingAttachmentCount(sectionId) > 0;
        }
        async function uploadPendingAttachmentsForSection(sectionId) {
            const gId = getActiveBidId();
            const pending = pendingSectionImageFiles[sectionId] || [];
            if (!gId || !sectionId || pending.length === 0) return 0;
            let uploadedCount = 0;
            for (const file of pending) {
                const fd = new FormData();
                fd.append('file', file);
                fd.append('section_id', sectionId);
                const res = await fetch(`/api/section-attachment/${gId}/upload?section_id=${encodeURIComponent(sectionId)}`, {
                    method: 'POST',
                    body: fd
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error((data && data.message) || 'Upload failed');
                }
                uploadedCount += 1;
            }
            // Update persisted counter and clear pending
            sectionAttachmentCounts[sectionId] = (sectionAttachmentCounts[sectionId] || 0) + uploadedCount;
            delete pendingSectionImageFiles[sectionId];
            return uploadedCount;
        }
        // Evaluate headers (TOC) modal elements
        const evaluateHeadersBtn = document.getElementById('evaluateHeadersBtn');
        const headersModal = document.getElementById('headersModal');
        const headersModalList = document.getElementById('headersModalList');
        const headersModalClose = document.getElementById('headersModalClose');
        function setHeadersModalOpen(open) {
            if (!headersModal) return;
            if (open) headersModal.classList.remove('hidden');
            else headersModal.classList.add('hidden');
        }
        function buildHeadersListHtml(items) {
            if (!Array.isArray(items) || items.length === 0) {
                return '<p class="text-gray-500">No headers found.</p>';
            }
            const safe = items.map(t => escapeHtml(String(t || '').trim())).filter(Boolean);
            if (!safe.length) return '<p class="text-gray-500">No headers found.</p>';
            return `<ol class="list-decimal pl-6 space-y-1">${safe.map(t => `<li>${t}</li>`).join('')}</ol>`;
        }
        async function fetchRfpFullText(gId) {
            // Try to pull a large slice of parsed PDF text for scoring
            try {
                const res = await fetch(`/api/rfp-file/${gId}/parsed?start=1&limit=120`);
                const data = await res.json();
                if (!res.ok) return '';
                const pages = Array.isArray(data.pages) ? data.pages : [];
                return pages.map(p => String(p.text || '')).join('\n');
            } catch (_) {
                return '';
            }
        }
        // Compute list of missing required sections
        function getMissingRequiredSections() {
            return (defaultSections || []).filter(s => {
                if (!s || s.id === 'requirements-attachments') return false;
                if (s.excluded) return false;
                if (!s.recommended) return false;
                return s.verifiedRequired !== true;
            });
        }
        // Update the Download button enabled/disabled state based on required sections
        function updateFinalProposalDownloadState() {
            if (!finalProposalDownloadBtn) return;
            const href = finalProposalDownloadBtn.dataset.downloadHref || '';
            const missing = getMissingRequiredSections();
            const blocked = missing.length > 0;
            finalProposalDownloadBtn.disabled = !href || blocked;
            if (blocked) {
                const names = missing.map(s => s.title).filter(Boolean).slice(0, 6).join(', ');
                finalProposalDownloadBtn.title = names
                    ? `Complete and save required sections before downloading: ${names}${missing.length > 6 ? '…' : ''}`
                    : 'Complete and save all required sections before downloading.';
            } else {
                finalProposalDownloadBtn.title = '';
            }
        }
        function computeSectionRequirementScores(rfpText) {
            const text = (rfpText || '').toLowerCase();
            if (!text) return new Map();
            // Simple keyword map to improve matching beyond bare titles
            const keywordOverrides = {
                'section-pricing': ['pricing','price','cost','fee','bid form','schedule of values'],
                'section-technical': ['technical','scope','specification','approach','solution','work plan'],
                'section-project-management-plan': ['project management','management plan','controls','qa/qc','communication plan'],
                'section-project-schedule': ['schedule','milestone','timeline','completion','substantial completion'],
                'section-project-team': ['key personnel','team','staff','resume','qualification'],
                'section-corporate-qualifications': ['qualifications','experience','past performance','references'],
                'section-requirements-compliance': ['compliance','requirements','mandatory','must','shall'],
                'section-safety': ['safety','osha','incident','accident','hazard','emergency'],
                'section-interconnection': ['interconnection','utility','metering','commissioning','protection'],
                'section-representations-certifications': ['certification','representation','debarment','non-collusion'],
                'section-addenda': ['addenda','addendum'],
                'section-contractual-terms': ['contract','terms','conditions','warranty','indemnification','insurance'],
                
            };
            const stop = new Set(['and','of','the','for','to','in','plan','section','proposal','project']);
            const scores = new Map();
            (defaultSections || []).forEach((s) => {
                if (!s || s.id === 'requirements-attachments') return;
                const title = String(s.title || '').toLowerCase();
                const baseTokens = title.split(/\s+/).filter(t => t && !stop.has(t));
                const extra = keywordOverrides[s.id] || [];
                const tokens = [...baseTokens, ...extra];
                let score = 0;
                tokens.forEach(tok => {
                    const t = tok.trim();
                    if (!t) return;
                    // Phrase score: presence adds more
                    if (text.includes(t)) score += t.split(' ').length >= 2 ? 3 : 1;
                    // Frequency score for single words
                    if (t.split(' ').length === 1) {
                        const re = new RegExp(`\\b${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\b`, 'g');
                        const matches = text.match(re);
                        if (matches) score += Math.min(matches.length, 5) * 0.5;
                    }
                });
                scores.set(s.id, score);
            });
            return scores;
        }
        function extractHeadersFromAnalysisHtml(html) {
            const out = [];
            if (!html) return out;
            const container = document.createElement('div');
            container.innerHTML = html;
            const norm = (s) => (s || '').replace(/\s+/g, ' ').trim().toLowerCase();
            const h2s = Array.from(container.querySelectorAll('h2'));
            // Strategy 1: Look for explicit "Proposal Table of Contents"
            let targetH2 = h2s.find(h => /proposal\s+table\s+of\s+contents/i.test(h.textContent || ''));
            if (targetH2) {
                let el = targetH2.nextElementSibling;
                while (el && el.tagName !== 'H2') {
                    const lis = Array.from(el.querySelectorAll('li'));
                    if (lis.length) {
                        lis.forEach(li => {
                            const t = norm(li.textContent || '');
                            if (t) out.push(li.textContent.trim());
                        });
                    }
                    el = el.nextElementSibling;
                }
            }
            // Strategy 2: Use "Section-by-Section Guidance and Drafts" and collect H3s under it
            if (out.length === 0) {
                targetH2 = h2s.find(h => /section[\s-]*by[\s-]*section.*guidance/i.test(norm(h.textContent || '')));
                if (targetH2) {
                    let el = targetH2.nextElementSibling;
                    while (el && el.tagName !== 'H2') {
                        if (el.tagName === 'H3') {
                            const t = (el.textContent || '').trim();
                            if (t) out.push(t);
                        }
                        el = el.nextElementSibling;
                    }
                }
            }
            // Deduplicate while preserving order
            const seen = new Set();
            const dedup = out.filter(t => {
                const key = norm(t);
                if (!key || seen.has(key)) return false;
                seen.add(key);
                return true;
            });
            return dedup;
        }
        function buildSectionSelectionUI(recommendedHeaders) {
            const recNorm = (recommendedHeaders || []).map(h => normalizeTitle(h));
            const items = (defaultSections || []).filter(s => s && s.id !== 'requirements-attachments');
            const lines = items.map((s, idx) => {
                const title = s.title || `Section ${idx + 1}`;
                const nTitle = normalizeTitle(title);
                // Preselect when recommendation matches or section is not excluded
                const matched = recNorm.some(h => h && (h.includes(nTitle) || nTitle.includes(h)));
                const isChecked = matched || !s.excluded;
                return `
                    <label class="flex items-center gap-3 py-1">
                        <input type="checkbox" class="header-section-checkbox h-4 w-4 text-emerald-600" data-section-id="${s.id}" ${isChecked ? 'checked' : ''}>
                        <span class="text-sm">${escapeHtml(title)}</span>
                    </label>
                `;
            });
            const controls = `
                <div class="flex items-center justify-between mb-2">
                    <div class="text-xs text-gray-500">Select the sections to keep for this RFP</div>
                    <div class="flex items-center gap-2">
                        <button id="headersModalSelectAll" class="px-2 py-1 text-xs rounded border border-gray-200 hover:bg-gray-50">Select all</button>
                        <button id="headersModalClearAll" class="px-2 py-1 text-xs rounded border border-gray-200 hover:bg-gray-50">Clear</button>
                    </div>
                </div>
            `;
            const actions = `
                <div class="mt-3 flex items-center justify-end gap-2 border-t pt-3">
                    <button id="headersModalApply" class="btn-primary px-3 py-1.5 text-sm text-white rounded">Apply</button>
                </div>
            `;
            return controls + `<div class="max-h-80 overflow-y-auto space-y-1">${lines.join('')}</div>` + actions;
        }
        // Wire evaluate button
        evaluateHeadersBtn?.addEventListener('click', async () => {
            const bidId = getActiveBidId();
            if (!bidId) {
                alert('Select or open a bid/project before evaluating headers.');
                return;
            }
            if (headersModalList) {
                headersModalList.innerHTML = '<p class="text-gray-500">Analyzing RFP and building recommended headers…</p>';
            }
            setHeadersModalOpen(true);
            if (evaluateHeadersBtn) evaluateHeadersBtn.disabled = true;
            try {
                const res = await fetch('/api/analyze-rfp-master', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bid_id: bidId })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    throw new Error(data.message || 'Failed to analyze RFP.');
                }
                const headers = extractHeadersFromAnalysisHtml(data.analysis_html || '');
                if (headersModalList) {
                    headersModalList.innerHTML = buildSectionSelectionUI(headers);
                }
                // Mark recommended sections and highlight in the list
                try {
                    const normalized = (headers || []).map(h => normalizeTitle(h));
                    (defaultSections || []).forEach((s) => {
                        if (!s || s.id === 'requirements-attachments') return;
                        const nTitle = normalizeTitle(s.title || '');
                        s.recommended = normalized.some(h => h && (h.includes(nTitle) || nTitle.includes(h)));
                    });
                    // Additionally score against full RFP text to capture more required sections
                    const gId = getActiveBidId();
                    const fullText = await fetchRfpFullText(gId);
                    const scores = computeSectionRequirementScores(fullText);
                    const threshold = 2.0; // tweakable
                    (defaultSections || []).forEach((s) => {
                        if (!s || s.id === 'requirements-attachments') return;
                        const sc = Number(scores.get(s.id) || 0);
                        s.requirementScore = sc;
                        if (sc >= threshold) {
                            s.recommended = true;
                        }
                    });
                    renderSectionList();
                } catch (_) {}
            } catch (err) {
                console.error('Header evaluation failed:', err);
                const fallback = (defaultSections || []).map(s => s.title).filter(Boolean);
                if (headersModalList) {
                    headersModalList.innerHTML = `
                        <p class="text-red-600 text-sm mb-2">${escapeHtml(err.message || 'Unable to analyze RFP right now.')}</p>
                        ${buildSectionSelectionUI(fallback)}
                    `;
                }
            } finally {
                if (evaluateHeadersBtn) evaluateHeadersBtn.disabled = false;
            }
        });
        headersModalClose?.addEventListener('click', () => setHeadersModalOpen(false));
        headersModal?.addEventListener('click', (e) => {
            if (e.target === headersModal) setHeadersModalOpen(false);
        });
        // Modal control actions (delegated after content render)
        document.addEventListener('click', (e) => {
            const target = e.target;
            if (!(target instanceof HTMLElement)) return;
            if (target.id === 'headersModalSelectAll') {
                e.preventDefault();
                headersModal?.querySelectorAll('input.header-section-checkbox').forEach((cb) => { cb.checked = true; });
            } else if (target.id === 'headersModalClearAll') {
                e.preventDefault();
                headersModal?.querySelectorAll('input.header-section-checkbox').forEach((cb) => { cb.checked = false; });
            } else if (target.id === 'headersModalApply') {
                e.preventDefault();
                const checkboxes = Array.from(headersModal?.querySelectorAll('input.header-section-checkbox') || []);
                const selectedIds = new Set(checkboxes.filter(cb => cb.checked).map(cb => cb.getAttribute('data-section-id')));
                // Apply selection by setting excluded flag
                (defaultSections || []).forEach((s) => {
                    if (!s || s.id === 'requirements-attachments') return;
                    s.excluded = !selectedIds.has(s.id);
                });
                // Ensure active section points to a visible one
                const firstVisible = (defaultSections || []).find(s => s && !s.excluded && s.id !== 'requirements-attachments');
                if (firstVisible) {
                    activeSectionId = firstVisible.id;
                }
                renderSectionList();
                renderActiveSection();
                persistSectionsToStorage();
                setHeadersModalOpen(false);
            }
        });
        const finalProposalNextBtn = document.getElementById('finalProposalNextBtn');
        const finalProposalPageCurrent = document.getElementById('finalProposalPageCurrent');
        const finalProposalPageTotal = document.getElementById('finalProposalPageTotal');
        let sortableInstance = null;
        const rfpFolderInput = document.getElementById('rfpFolder');
        const selectedRfpLabel = document.getElementById('selectedRfpLabelBottom');
        const rfpUploadLabel = document.getElementById('rfpUploadLabel');
        const generateProposalBtn = document.getElementById('generateProposalBtn');
        const companySelect = document.getElementById('company');
        const uploadForm = document.getElementById('uploadForm');
        const hiddenSubmit = document.getElementById('generateSubmitHelper');
        const processingStatus = document.getElementById('processingStatus');
        const statusContent = document.getElementById('statusContent');
        const rfpSectionEl = document.getElementById('rfpPreviewSection');
        // PDF viewer is now handled by PDF.js (no iframe needed)
        const rfpPreviewFallback = document.getElementById('rfpPreviewFallback');
        const rfpParseStatus = document.getElementById('rfpParseStatus');
        const rfpTextContainer = document.getElementById('rfpTextContainer');
        const rfpLoadMoreBtn = document.getElementById('rfpLoadMoreBtn');
        const rfpReloadBtn = document.getElementById('rfpReloadBtn');
        const rfpUploadBtn = document.getElementById('rfpUploadBtn');
        const rfpUploadInput = document.getElementById('rfpUploadInput');
        const generalQueryForm = document.getElementById('generalQueryForm');
        const generalQueryInput = document.getElementById('generalQueryInput');
        const generalQueryResponse = document.getElementById('generalQueryResponse');
        const deepAnalysisBtn = document.getElementById('runDeepAnalysisBtn');
        const deepAnalysisStatus = document.getElementById('deepAnalysisStatus');
        const deepAnalysisOutput = document.getElementById('deepAnalysisOutput');
        const deepAnalysisError = document.getElementById('deepAnalysisError');
        let generalQueryHistory = [];
        let activeSectionId = defaultSections[0]?.id || null;
        let isEditing = false;
        let rfpPagesNextStart = null;
        const RFP_PAGE_BATCH = 3;
        const GENERAL_AGENT_STATUS_TEXT = 'Agent is drafting a response…';
        const SECTIONS_STORAGE_PREFIX = 'proposalSections';
        const isLocalStorageAvailable = (() => {
            try {
                const testKey = '__proposal_sections_test__';
                localStorage.setItem(testKey, '1');
                localStorage.removeItem(testKey);
                return true;
            } catch (error) {
                return false;
            }
        })();
        let finalProposalEditable = false;
        // Undo support for preview replacements
        const PREVIEW_UNDO_LIMIT = 10;
        let previewUndoStack = [];
        const finalProposalUndoBtnId = 'finalProposalUndoBtn';

        function ensureFinalProposalUndoBtn() {
            if (!finalProposalEditBtn) return null;
            const container = finalProposalEditBtn.parentElement;
            if (!container) return null;
            let undoBtn = document.getElementById(finalProposalUndoBtnId);
            if (undoBtn) return undoBtn;
            undoBtn = document.createElement('button');
            undoBtn.id = finalProposalUndoBtnId;
            undoBtn.className = 'inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-600 hover:border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed';
            undoBtn.innerHTML = '<i class="fas fa-undo"></i>';
            undoBtn.disabled = true;
            undoBtn.addEventListener('click', () => {
                undoLastPreviewChange();
            });
            // Insert just after Edit button
            container.insertBefore(undoBtn, finalProposalEditBtn.nextSibling);
            return undoBtn;
        }

        function updateUndoBtnState() {
            const btn = ensureFinalProposalUndoBtn();
            if (!btn) return;
            btn.disabled = previewUndoStack.length === 0;
        }

        function pushPreviewUndoSnapshot() {
            if (!finalProposalContent) return;
            try {
                previewUndoStack.push({
                    html: finalProposalContent.innerHTML,
                    page: finalProposalCurrentPage
                });
                if (previewUndoStack.length > PREVIEW_UNDO_LIMIT) {
                    previewUndoStack = previewUndoStack.slice(-PREVIEW_UNDO_LIMIT);
                }
                updateUndoBtnState();
            } catch (_) { /* no-op */ }
        }

        function recalcPagesFromDom() {
            // Rebuild page references from DOM
            finalProposalPages = Array.from(finalProposalContent.querySelectorAll('.proposal-page'));
            if (finalProposalPages.length === 0) {
                // Fallback: treat entire content as a single page if wrappers are missing
                finalProposalPages = [finalProposalContent.firstElementChild || finalProposalContent];
            }
            finalProposalTotalPages = Math.max(1, finalProposalPages.length);
        }

        function showOnlyPage(idx) {
            if (finalProposalPages.length === 0) return;
            finalProposalPages.forEach((page, i) => {
                if (!page) return;
                page.classList.toggle('hidden', i !== idx);
            });
            finalProposalCurrentPage = Math.min(Math.max(0, idx), finalProposalTotalPages - 1);
            updateFinalProposalPaginatorUI();
        }

        function undoLastPreviewChange() {
            if (!finalProposalContent || previewUndoStack.length === 0) return;
            const snapshot = previewUndoStack.pop();
            try {
                finalProposalContent.innerHTML = snapshot.html || '';
                recalcPagesFromDom();
                showOnlyPage(snapshot.page || 0);
                updateUndoBtnState();
            } catch (err) {
                console.error('Undo failed:', err);
                alert('Undo failed. Please try again.');
            }
        }

        // Pagination state for Final Proposal preview
        let finalProposalPageHeight = 0;
        let finalProposalTotalPages = 1;
        let finalProposalCurrentPage = 0;
        /** Array of DOM elements representing each logical page (section) */
        let finalProposalPages = [];
        // Force Times New Roman in preview content
        (function enforcePreviewFont() {
            const styleEl = document.createElement('style');
            styleEl.innerHTML = `
                #finalProposalContent, #finalProposalContent * {
                    font-family: "Aptos (Body)", "Aptos", "Segoe UI", "Calibri", Arial, sans-serif !important;
                    font-size: 11pt !important;
                    line-height: 1.4;
                }
                #finalProposalTitle {
                    font-family: "Aptos (Body)", "Aptos", "Segoe UI", "Calibri", Arial, sans-serif !important;
                    font-weight: 700 !important;
                    font-size: 16pt !important;
                }
            `;
            document.head.appendChild(styleEl);
        })();

        function normalizeTitle(str) {
            return (str || '')
                .toString()
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function getSectionTitlesForPaging() {
            // Use the same list used to compile, so paging mirrors the Table of Contents
            const titles = sectionsEligibleForCompilation().map(s => s.title).filter(Boolean);
            // Ensure Table of Contents is included if present in preview
            if (!titles.some(t => /table of contents/i.test(t))) {
                titles.unshift('Table of Contents');
            }
            return titles;
        }

        function isHeadingElement(el) {
            if (!el || el.nodeType !== 1) return false;
            const tag = el.tagName.toLowerCase();
            return tag === 'h1' || tag === 'h2' || tag === 'h3' || tag === 'h4' || tag === 'h5' || tag === 'h6';
        }

        function elementMatchesAnyTitle(el, normalizedTitles) {
            if (!el || el.nodeType !== 1) return false;
            let text = '';
            if (isHeadingElement(el)) {
                text = el.textContent || '';
            } else if (el.matches('p,strong,em,div,span')) {
                // Fallback for generators that style headings as paragraphs
                text = (el.textContent || '');
            } else {
                return false;
            }
            const norm = normalizeTitle(text);
            return normalizedTitles.some(t => norm.includes(t));
        }

        // Map of normalized section title -> page index
        let finalProposalPageIndexByTitle = {};

        function renderFinalProposalPages(htmlString) {
            if (!finalProposalContent) return;
            finalProposalPages = [];
            finalProposalContent.innerHTML = '';
            finalProposalPageIndexByTitle = {};

            const temp = document.createElement('div');
            temp.innerHTML = htmlString || '';

            // Normalize minimal Markdown in the preview DOM:
            // - **bold** -> <strong>
            // - ### Heading -> <h3>
            (function normalizeMarkdownInDom(root) {
                if (!root) return;
                const walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
                const toProcess = [];
                while (walker.nextNode()) {
                    toProcess.push(walker.currentNode);
                }
                const boldRegex = /\*\*(.+?)\*\*/g;
                // Helper: replace **bold** inside text nodes by splitting and inserting <strong>
                function convertTextNodeBold(textNode) {
                    if (!textNode || textNode.nodeType !== Node.TEXT_NODE) return;
                    const text = textNode.nodeValue || '';
                    if (!boldRegex.test(text)) return;
                    const parent = textNode.parentNode;
                    if (!parent) return;
                    const parts = text.split(/\*\*(.+?)\*\*/g); // keep capture groups
                    const frag = document.createDocumentFragment();
                    for (let i = 0; i < parts.length; i++) {
                        const part = parts[i];
                        if (part === undefined || part === null) continue;
                        // Even indices: plain text; odd indices: captured bold text
                        if (i % 2 === 1) {
                            const strong = document.createElement('strong');
                            strong.textContent = part;
                            frag.appendChild(strong);
                        } else if (part) {
                            frag.appendChild(document.createTextNode(part));
                        }
                    }
                    parent.replaceChild(frag, textNode);
                }
                toProcess.forEach((el) => {
                    if (!(el instanceof HTMLElement)) return;
                    // For <pre>, strip any ** markers (can't reliably render inline HTML inside pre we created as text)
                    if (el.tagName === 'PRE' && el.textContent && el.textContent.includes('**')) {
                        el.textContent = el.textContent.replace(/\*\*/g, '');
                    }
                    // Transform <pre> blocks that contain ### headings into mixed content:
                    // keep non-heading lines in <pre>, move heading lines into <p><strong>..</strong></p>
                    if (el.tagName === 'PRE' && el.textContent && el.textContent.includes('###')) {
                        const lines = el.textContent.split('\n');
                        const frag = document.createDocumentFragment();
                        let preBuffer = [];
                        const flushPre = () => {
                            if (preBuffer.length === 0) return;
                            const pre = document.createElement('pre');
                            pre.textContent = preBuffer.join('\n');
                            frag.appendChild(pre);
                            preBuffer = [];
                        };
                        for (const line of lines) {
                            const m = line.match(/^\s*#{3,}\s*(.+?)\s*$/);
                            if (m) {
                                flushPre();
                                const p = document.createElement('p');
                                const strong = document.createElement('strong');
                                strong.textContent = m[1];
                                p.appendChild(strong);
                                frag.appendChild(p);
                            } else {
                                preBuffer.push(line);
                            }
                        }
                        flushPre();
                        el.replaceWith(frag);
                        return;
                    }
                    // Convert heading markers on block elements
                    if (['P', 'DIV', 'SPAN'].includes(el.tagName)) {
                        const text = el.textContent || '';
                        const headingMatch = text.match(/^\s*#{3,}\s*(.+?)\s*$/);
                        if (headingMatch) {
                            const h3 = document.createElement('h3');
                            h3.textContent = headingMatch[1];
                            el.replaceWith(h3);
                            return;
                        }
                    }
                    // Replace **bold** inside element HTML
                if (el.tagName !== 'PRE') {
                    // Walk child text nodes and convert **...** to <strong>
                    const textWalker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null);
                    const textNodes = [];
                    while (textWalker.nextNode()) textNodes.push(textWalker.currentNode);
                    textNodes.forEach(convertTextNodeBold);
                }
                });
                // Remove stray markers that remain
                root.querySelectorAll('*').forEach((el) => {
                    if (el.childElementCount === 0 && el.textContent) {
                        el.textContent = el.textContent.replace(/[#$*]+/g, (m) => {
                            // keep currency uses like $; we're only removing # and *
                            return m.replace(/[#*]/g, '');
                        });
                    }
                });
            })(temp);

            const titles = getSectionTitlesForPaging();
            const normalizedTitles = titles.map(normalizeTitle);

            // Strategy: walk top-level children and split when we hit a new section heading
            let currentPageEl = document.createElement('div');
            currentPageEl.className = 'h-[1122px] overflow-auto px-8 py-8';

            const pushPage = () => {
                const wrapper = document.createElement('div');
                wrapper.className = 'proposal-page';
                wrapper.appendChild(currentPageEl);
                finalProposalPages.push(wrapper);
                currentPageEl = document.createElement('div');
                currentPageEl.className = 'h-[1122px] overflow-auto px-8 py-8';
            };

            const children = Array.from(temp.childNodes);
            let started = false;
            for (const node of children) {
                if (node.nodeType === 1 && elementMatchesAnyTitle(node, normalizedTitles)) {
                    // If this matches a TOC/section heading, start a new page
                    if (started) {
                        pushPage();
                    } else {
                        started = true;
                    }
                    // Record mapping for this section heading -> page index
                    try {
                        const nodeTextNorm = normalizeTitle(node.textContent || '');
                        const matchedIndex = normalizedTitles.findIndex(t => nodeTextNorm.includes(t) && finalProposalPageIndexByTitle[t] === undefined);
                        const pageIndex = started ? (finalProposalPages.length) : 0;
                        if (matchedIndex >= 0) {
                            finalProposalPageIndexByTitle[normalizedTitles[matchedIndex]] = pageIndex;
                        }
                    } catch (_) { /* no-op */ }
                }
                // Append the node to the current page (clone to avoid removing from temp if needed)
                currentPageEl.appendChild(node);
            }
            // Push the remaining content as a page
            pushPage();

            // Mount only the first page initially; others hidden
            finalProposalPages.forEach((page, idx) => {
                if (idx !== 0) page.classList.add('hidden');
                finalProposalContent.appendChild(page);
            });

            finalProposalTotalPages = Math.max(1, finalProposalPages.length);
            finalProposalCurrentPage = 0;
            updateFinalProposalPaginatorUI();
            populateFinalProposalTocDropdown(titles);
        }

        function updateFinalProposalPaginatorUI() {
            if (finalProposalPageCurrent) {
                finalProposalPageCurrent.textContent = String(finalProposalCurrentPage + 1);
            }
            if (finalProposalPageTotal) {
                finalProposalPageTotal.textContent = String(finalProposalTotalPages);
            }
            if (finalProposalPrevBtn) {
                finalProposalPrevBtn.disabled = finalProposalCurrentPage <= 0;
            }
            if (finalProposalNextBtn) {
                finalProposalNextBtn.disabled = finalProposalCurrentPage >= (finalProposalTotalPages - 1);
            }
        }

        function initFinalProposalPagination() {
            if (!finalProposalFrame) return;
            // Two modes: logical pages (by sections) or fallback to height-based
            if (finalProposalPages.length > 0) {
                finalProposalTotalPages = finalProposalPages.length;
                finalProposalCurrentPage = 0;
                updateFinalProposalPaginatorUI();
                return;
            }
            // Height-based fallback
            requestAnimationFrame(() => {
                finalProposalPageHeight = finalProposalFrame.clientHeight || 1;
                const totalScrollableHeight = finalProposalFrame.scrollHeight || finalProposalPageHeight;
                finalProposalTotalPages = Math.max(1, Math.ceil(totalScrollableHeight / finalProposalPageHeight));
                finalProposalCurrentPage = 0;
                finalProposalFrame.scrollTop = 0;
                updateFinalProposalPaginatorUI();
            });
        }

        // TOC dropdown population and navigation
        const finalProposalTocSelect = document.getElementById('finalProposalTocSelect');

        function populateFinalProposalTocDropdown(titles) {
            if (!finalProposalTocSelect) return;
            const currentValue = finalProposalTocSelect.value;
            finalProposalTocSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.disabled = true;
            placeholder.selected = true;
            placeholder.textContent = 'Jump to section…';
            finalProposalTocSelect.appendChild(placeholder);
            const normalizedTitles = titles.map(normalizeTitle);
            titles.forEach((title, idx) => {
                const opt = document.createElement('option');
                const norm = normalizedTitles[idx];
                const pageIndex = (finalProposalPageIndexByTitle && finalProposalPageIndexByTitle[norm] !== undefined)
                    ? finalProposalPageIndexByTitle[norm]
                    : '';
                opt.value = pageIndex === '' ? '' : String(pageIndex);
                opt.textContent = title;
                if (pageIndex === '') {
                    opt.disabled = true;
                }
                finalProposalTocSelect.appendChild(opt);
            });
            if (currentValue && Array.from(finalProposalTocSelect.options).some(o => o.value === currentValue)) {
                finalProposalTocSelect.value = currentValue;
            }
        }

        // Verify that all required (recommended) sections appear in the compiled preview HTML
        function verifyRequiredSectionsInHtml(html) {
            try {
                if (!html) return;
                const container = document.createElement('div');
                container.innerHTML = html;
                const fullText = (container.textContent || '').toLowerCase();
                (defaultSections || []).forEach((s) => {
                    if (!s || s.id === 'requirements-attachments' || s.excluded) return;
                    if (!s.recommended) {
                        s.verifiedRequired = undefined;
                        return;
                    }
                    const title = String(s.title || '').trim();
                    const nTitle = normalizeTitle(title);
                    let present = false;
                    // Quick text inclusion check
                    if (nTitle && fullText.includes(nTitle)) {
                        present = true;
                    } else {
                        // Scan headings for fuzzy match
                        const headings = Array.from(container.querySelectorAll('h1,h2,h3,strong'));
                        present = headings.some(h => {
                            const t = normalizeTitle(h.textContent || '');
                            return t && (t.includes(nTitle) || nTitle.includes(t));
                        });
                    }
                    // Only mark as verified if the section is present AND saved
                    const isSaved = String(s.status || '').toLowerCase() === 'saved';
                    s.verifiedRequired = !!(present && isSaved);
                });
                persistSectionsToStorage();
                renderSectionList();
            updateFinalProposalDownloadState();
            } catch (e) {
                console.error('Verification failed:', e);
            }
        }

        finalProposalTocSelect?.addEventListener('change', (e) => {
            const value = (e.target && e.target.value) ? parseInt(e.target.value, 10) : NaN;
            if (Number.isNaN(value)) return;
            // Navigate to selected page
            if (finalProposalPages.length > 0) {
                if (value < 0 || value >= finalProposalPages.length) return;
                if (finalProposalCurrentPage !== value) {
                    finalProposalPages[finalProposalCurrentPage]?.classList.add('hidden');
                    finalProposalCurrentPage = value;
                    finalProposalPages[finalProposalCurrentPage]?.classList.remove('hidden');
                    updateFinalProposalPaginatorUI();
                }
            } else if (finalProposalFrame && finalProposalPageHeight > 0) {
                finalProposalCurrentPage = Math.min(Math.max(0, value), finalProposalTotalPages - 1);
                finalProposalFrame.scrollTo({ top: finalProposalPageHeight * finalProposalCurrentPage, behavior: 'smooth' });
                updateFinalProposalPaginatorUI();
            }
        });

        window.addEventListener('resize', () => {
            // Recalculate pages on resize when preview is visible
            if (finalProposalPreviewSection && !finalProposalPreviewSection.classList.contains('hidden')) {
                initFinalProposalPagination();
            }
        });

        function hasSectionContentForSave(section) {
            if (!section) return false;
            if (isEditing && sectionContentEditor) {
                return !!sectionContentEditor.value.trim();
            }
            if (section.rawContent && section.rawContent.trim()) {
                return true;
            }
            if (Array.isArray(section.content)) {
                return section.content.some(paragraph => paragraph && paragraph.trim());
            }
            // Allow saving when the section only contains attachments (no textual content)
            if (sectionHasAttachments(section.id)) {
                return true;
            }
            return false;
        }

        function refreshSectionActionStates() {
            if (!quickSaveBtn) return;
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            const disabled = isEditing || !hasSectionContentForSave(section);
            quickSaveBtn.disabled = !!disabled;
        }

        function markSectionDraft(section) {
            if (!section) return;
            const wasStatus = section.status;
            section.status = 'Draft';
            if (sectionStatus) {
                sectionStatus.textContent = section.status;
            }
            if (wasStatus !== section.status) {
                renderSectionList();
            }
            refreshSectionActionStates();
        }
        
        async function refreshSectionAttachments() {
            const panel = document.getElementById('sectionAttachmentsPanel');
            const list = document.getElementById('sectionAttachmentsList');
            const countEl = document.getElementById('sectionAttachmentsCount');
            if (!panel || !list) return;
            const gId = getActiveBidId();
            if (!gId || !activeSectionId) {
                panel.classList.add('hidden');
                list.innerHTML = '';
                if (countEl) countEl.textContent = '';
                return;
            }
            try {
                const res = await fetch(`/api/section-attachments/${gId}?section_id=${encodeURIComponent(activeSectionId)}`);
                const data = await res.json();
                if (!res.ok || !data || data.success === false) {
                    throw new Error((data && data.message) || 'Failed to load attachments');
                }
                const files = Array.isArray(data.files) ? data.files : [];
                if (files.length === 0) {
                    panel.classList.add('hidden');
                    list.innerHTML = '';
                    if (countEl) countEl.textContent = '';
                    return;
                }
                const itemsHtml = files.map(f => {
                    const safeName = escapeHtml(f.filename || '');
                    const isPdf = !!f.is_pdf;
                    const icon = isPdf ? '<i class="fas fa-file-pdf text-red-500"></i>' : '<i class="fas fa-image text-emerald-600"></i>';
                    const thumb = isPdf
                        ? icon
                        : `<img src="${f.view_url}" alt="${safeName}" class="section-attachment-thumb" />`;
                    return `
                        <a href="${f.view_url}" target="_blank" class="section-attachment-item hover:border-emerald-300">
                            ${thumb}
                            <span class="truncate text-sm text-gray-700">${safeName}</span>
                        </a>
                    `;
                }).join('');
                list.innerHTML = itemsHtml;
                if (countEl) countEl.textContent = `${files.length} file${files.length === 1 ? '' : 's'}`;
                panel.classList.remove('hidden');
            } catch (err) {
                console.error('Failed to refresh section attachments:', err);
                panel.classList.add('hidden');
                list.innerHTML = '';
                if (countEl) countEl.textContent = '';
            }
        }

        if (proposalContext.bid && proposalContext.bid.rfp_label && selectedRfpLabel) {
            selectedRfpLabel.textContent = proposalContext.bid.rfp_label;
        }

        function getActiveBidId() {
            if (proposalContext && proposalContext.bid) {
                if (proposalContext.bid.g_id) {
                    return proposalContext.bid.g_id;
                }
                if (proposalContext.bid.bid_id) {
                    return proposalContext.bid.bid_id;
                }
            }
            if (proposalContext && proposalContext.bid_id) {
                return proposalContext.bid_id;
            }
            return null;
        }
        function updateEvaluateBtnState() {
            const hasBid = !!getActiveBidId();
            if (evaluateHeadersBtn) {
                evaluateHeadersBtn.disabled = !hasBid;
                evaluateHeadersBtn.title = hasBid
                    ? 'Evaluate RFP and list recommended headers (TOC)'
                    : 'Open this page from a specific bid (with an attached RFP) to enable header extraction';
            }
        }

        function getProjectTitle() {
            if (proposalContext && proposalContext.bid) {
                return proposalContext.bid.project_name || proposalContext.bid.b_name || proposalContext.bid.rfp_label || '';
            }
            return proposalContext?.project_name || proposalContext?.bid_name || '';
        }

        function sectionsEligibleForCompilation() {
            return defaultSections.filter(sec => sec.id !== 'requirements-attachments' && !sec.excluded);
        }

         function allSectionsReadyForCompilation() {
             const eligible = sectionsEligibleForCompilation();
             if (!eligible.length) return false;
             return eligible.every((section) => {
                const hasContent = (Array.isArray(section.content) && section.content.length > 0) || !!section.rawContent || sectionHasAttachments(section.id);
                return hasContent && String(section.status || '').toLowerCase() === 'saved';
             });
         }

         function collectSectionsPayload() {
             return sectionsEligibleForCompilation()
                 // Include only sections explicitly saved
                 .filter((section) => String(section.status || '').toLowerCase() === 'saved')
                 .map((section) => ({
                     id: section.id,
                     title: section.title,
                     status: section.status,
                     content: Array.isArray(section.content) ? section.content : [],
                     raw_content: section.rawContent || ''
                 }))
                 // Require actual content
                .filter((section) => section.content.length > 0 || section.raw_content || sectionHasAttachments(section.id));
         }

        function setFinalProposalStatus(message, options = {}) {
            if (!finalProposalStatus) return;
            finalProposalStatus.textContent = message || '';
            if (options.muted) {
                finalProposalStatus.classList.add('text-gray-400');
            } else {
                finalProposalStatus.classList.remove('text-gray-400');
            }
        }

        // Analyze a section's current content and compute recommendation/suggestion flags automatically,
        // without changing the user's content. Uses the same backend guardrail as refinement.
        async function auditSectionSuggestions(section) {
            try {
                if (!section) return;
                const paragraphs = Array.isArray(section.content) && section.content.length
                    ? section.content
                    : (section.rawContent ? [section.rawContent] : []);
                if (!paragraphs.length) return;
                const body = {
                    paragraphs,
                    section_id: section.id,
                    section_title: section.title,
                    bid_id: getActiveBidId()
                };
                const res = await fetch('/api/refine-section-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (!res.ok) {
                    // Non-blocking: simply skip flags if the service is unavailable
                    return;
                }
                const flags = (data.flags && data.flags.outside_rfp_recommendations) ? data.flags.outside_rfp_recommendations : [];
                section.flags = { outside_rfp_recommendations: flags };
                // If auditing the currently active section, update UI highlights and panel
                if (section.id === activeSectionId) {
                    const paragraphsToRender = Array.isArray(section.content) && section.content.length
                        ? section.content
                        : (section.rawContent ? [section.rawContent] : []);
                    if (sectionContentDisplay && paragraphsToRender.length) {
                        const highlighted = paragraphsToRender.map((paragraph, idx) => {
                            let html = escapeHtml(paragraph);
                            const pFlags = flags.filter(f => f.paragraph_index === idx && f.sentence);
                            pFlags.forEach(f => {
                                const escapedSentence = escapeHtml(f.sentence);
                                const re = new RegExp(escapeRegExp(escapedSentence), 'gi');
                                html = html.replace(re, '<mark class="bg-yellow-200">$&</mark>');
                            });
                            return `<p class="text-gray-700 leading-relaxed">${html}</p>`;
                        });
                        sectionContentDisplay.innerHTML = highlighted.join('');
                    }
                    if (sectionFlagsDisplay) {
                        if (flags && flags.length > 0) {
                            const list = flags.slice(0, 6).map(f => `<li class="ml-4 list-disc">${escapeHtml(f.sentence)}</li>`).join('');
                            sectionFlagsDisplay.classList.remove('hidden');
                            sectionFlagsDisplay.innerHTML = `
                                <div class="rounded-md border border-yellow-300 bg-yellow-50 p-3 text-yellow-900 text-sm">
                                    <div class="flex items-center gap-2 mb-1">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>${flags.length} potential recommendation/suggestion sentence${flags.length===1?'':'s'} outside the RFP detected</strong>
                                    </div>
                                    <p class="mb-1">Highlighted in yellow above. Please review and edit or remove before compiling.</p>
                                </div>
                            `;
                        } else {
                            sectionFlagsDisplay.classList.add('hidden');
                            sectionFlagsDisplay.innerHTML = '';
                        }
                    }
                }
                persistSectionsToStorage();
            } catch (_) {
                // ignore audit failures
            }
        }

        async function compileProposalFromSections() {
            const sectionsPayload = collectSectionsPayload();
            if (!sectionsPayload.length) {
                alert('No section content is available to compile. Generate or write content for at least one section first.');
                return;
            }

            const bidId = getActiveBidId();
            const payload = {
                bid_id: bidId,
                project_title: getProjectTitle(),
                sections: sectionsPayload,
                company: (companySelect && companySelect.value) ? companySelect.value : ((proposalContext && proposalContext.company) ? proposalContext.company : '')
            };

            if (processingStatus) {
                processingStatus.classList.remove('hidden');
            }
            if (statusContent) {
                const sectionCount = sectionsPayload.length;
                statusContent.innerHTML = `
                    <div class="rounded-lg bg-cyan-50 px-4 py-2 text-sm text-cyan-800 flex items-center gap-3">
                        <i class="fas fa-diagram-project text-cyan-600"></i>
                        <span>Compiling ${sectionCount} section${sectionCount !== 1 ? 's' : ''} with generated content into a Word document...</span>
                    </div>
                `;
            }

            try {
                const response = await fetch('/api/compile-proposal-sections', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(payload),
                });

                const contentType = response.headers.get('content-type') || '';
                let data;
                if (contentType.includes('application/json')) {
                    data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.message || 'Unable to compile sections. Please try again.');
                    }
                } else {
                    const text = await response.text();
                    console.error('Unexpected non-JSON response:', text);
                    throw new Error('Unexpected response from server. Please ensure you are logged in and try again.');
                }

                if (finalProposalPreviewSection) {
                    finalProposalPreviewSection.classList.remove('hidden');
                }
                if (finalProposalContent) {
                    const html = data.html_preview || '<p class="text-sm text-gray-500">Preview unavailable. Download the DOCX to review the compiled proposal.</p>';
                    // Build pages by Table of Contents topics (section titles)
                    renderFinalProposalPages(html);
                    // Re-verify required sections presence
                    verifyRequiredSectionsInHtml(html);
                    lastSavedProposalHtml = finalProposalContent.innerHTML || '';
                }
                // Initialize pagination after content renders (no-op if pages are built)
                initFinalProposalPagination();
                if (finalProposalDownloadBtn) {
                    const downloadUrl = data.download_url || '';
                    finalProposalDownloadBtn.dataset.downloadHref = downloadUrl;
                    finalProposalDownloadBtn.disabled = !downloadUrl;
                    finalProposalDownloadBtn.dataset.filename = downloadUrl
                        ? downloadUrl.split('/').pop().split('?')[0]
                        : '';
                    updateFinalProposalDownloadState();
                }
                setFinalProposalStatus(data.message || 'Proposal compiled successfully. Review the preview below.');
            } catch (error) {
                console.error('Compilation error:', error);
                alert(error.message || 'Unable to compile proposal right now.');
            } finally {
                if (processingStatus) {
                    processingStatus.classList.add('hidden');
                }
            }
        }

        function getSectionsStorageKey() {
            const bidId = getActiveBidId();
            return `${SECTIONS_STORAGE_PREFIX}:${bidId || 'general'}`;
        }

        function persistSectionsToStorage() {
            if (!isLocalStorageAvailable) return;
            try {
                const payload = defaultSections.map((section) => ({
                    id: section.id,
                    title: section.title,
                    status: section.status,
                    guidance: section.guidance,
                    content: Array.isArray(section.content) ? section.content : [],
                    rawContent: section.rawContent || '',
                    excluded: !!section.excluded,
                    recommended: !!section.recommended,
                    requirementScore: typeof section.requirementScore === 'number' ? section.requirementScore : undefined
                }));
                localStorage.setItem(getSectionsStorageKey(), JSON.stringify(payload));
            } catch (error) {
                console.error('Unable to persist sections locally:', error);
            }
        }

        function hydrateSectionsFromStorage() {
            if (!isLocalStorageAvailable) return;
            try {
                const stored = localStorage.getItem(getSectionsStorageKey());
                if (!stored) return;
                const parsed = JSON.parse(stored);
                if (!Array.isArray(parsed) || parsed.length === 0) return;
                // Merge saved sections with defaults:
                // 1) Update existing sections
                // 2) Add any saved sections that don't exist in defaults (e.g., newly added ones)
                // 3) Reorder to match saved order while keeping any unmatched defaults at the end
                const existingIds = new Set(defaultSections.map(s => s.id));
                parsed.forEach((savedSection) => {
                    const target = defaultSections.find(sec => sec.id === savedSection.id);
                    if (!target) {
                        // New section created by the user previously; add it
                        defaultSections.push({
                            id: savedSection.id,
                            title: savedSection.title || 'New Section',
                            status: savedSection.status || 'Draft',
                            guidance: savedSection.guidance || '',
                            content: Array.isArray(savedSection.content) ? savedSection.content : [],
                            rawContent: typeof savedSection.rawContent === 'string' ? savedSection.rawContent : '',
                            excluded: !!savedSection.excluded,
                            recommended: !!savedSection.recommended,
                            requirementScore: typeof savedSection.requirementScore === 'number' ? savedSection.requirementScore : undefined,
                            sub_categories: Array.isArray(savedSection.sub_categories) ? savedSection.sub_categories : []
                        });
                        return;
                    }
                    if (Array.isArray(savedSection.content)) {
                        target.content = savedSection.content;
                    }
                    if (savedSection.status) {
                        target.status = savedSection.status;
                    }
                    if (typeof savedSection.rawContent === 'string') {
                        target.rawContent = savedSection.rawContent;
                    }
                    if (typeof savedSection.excluded !== 'undefined') {
                        target.excluded = !!savedSection.excluded;
                    }
                    if (typeof savedSection.recommended !== 'undefined') {
                        target.recommended = !!savedSection.recommended;
                    }
                    if (typeof savedSection.requirementScore === 'number') {
                        target.requirementScore = savedSection.requirementScore;
                    }
                    if (typeof savedSection.verifiedRequired !== 'undefined') {
                        target.verifiedRequired = !!savedSection.verifiedRequired;
                    }
                });
                // Reorder to match saved order
                const byId = new Map(defaultSections.map(s => [s.id, s]));
                const reordered = [];
                parsed.forEach(sv => {
                    const node = byId.get(sv.id);
                    if (node) {
                        reordered.push(node);
                        byId.delete(sv.id);
                    }
                });
                // Append any sections that weren't in saved payload (e.g., new defaults)
                for (const [, node] of byId) {
                    reordered.push(node);
                }
                // Replace contents to preserve reference
                defaultSections.splice(0, defaultSections.length, ...reordered);
            } catch (error) {
                console.error('Unable to hydrate sections from local storage:', error);
            }
        }

        async function runDeepAnalysis() {
            const bidId = getActiveBidId();
            if (!bidId) {
                alert('Select or open a bid before running the compliance analysis.');
                return;
            }

            if (deepAnalysisBtn) {
                deepAnalysisBtn.disabled = true;
                deepAnalysisBtn.classList.add('opacity-60', 'cursor-not-allowed');
            }
            if (deepAnalysisStatus) {
                deepAnalysisStatus.classList.remove('hidden');
            }
            if (deepAnalysisError) {
                deepAnalysisError.classList.add('hidden');
                deepAnalysisError.textContent = '';
            }
            if (deepAnalysisOutput) {
                deepAnalysisOutput.innerHTML = '';
            }

            try {
                const response = await fetch('/api/analyze-rfp-master', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ bid_id: bidId })
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    throw new Error(data.message || 'Unable to analyze the RFP. Please try again.');
                }

                const data = await response.json();
                if (deepAnalysisOutput) {
                    deepAnalysisOutput.innerHTML = data.analysis_html || '<p class="text-sm text-gray-500">No analysis returned.</p>';
                }
            } catch (error) {
                console.error('Deep analysis error:', error);
                if (deepAnalysisError) {
                    deepAnalysisError.textContent = error.message || 'An unexpected error occurred while analyzing the RFP.';
                    deepAnalysisError.classList.remove('hidden');
                }
            } finally {
                if (deepAnalysisStatus) {
                    deepAnalysisStatus.classList.add('hidden');
                }
                if (deepAnalysisBtn) {
                    deepAnalysisBtn.disabled = false;
                    deepAnalysisBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                }
            }
        }

        function renderGeneralQueryChat(statusMessage = '') {
            if (!generalQueryResponse) {
                return;
            }

            let bubbles = [];

            // Show empty state if no messages
            if (!generalQueryHistory.length && !statusMessage) {
                generalQueryResponse.innerHTML = `
                    <div class="flex items-center justify-center h-full text-center px-4">
                        <div class="text-gray-400">
                            <i class="fas fa-comments text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm">Start a conversation with the AI agent</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Render chat messages
            bubbles = generalQueryHistory.map((entry, index) => {
                const isUser = entry.role === 'user';
                const isAssistant = entry.role === 'assistant';
                const content = entry.content ? escapeHtml(entry.content) : '';

                // User message (right aligned, green)
                if (isUser) {
                    return `
                        <div class="flex justify-end group">
                            <div class="max-w-[85%] flex items-start gap-2">
                                <div class="flex-1"></div>
                                <div class="bg-emerald-600 text-white rounded-2xl rounded-tr-sm px-4 py-2.5 shadow-sm">
                                    <p class="text-sm whitespace-pre-wrap leading-relaxed">${content}</p>
                                </div>
                                <button onclick="editUserMessage(${index})" 
                                    class="mt-1 inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-600 hover:text-gray-800 transition-all opacity-0 group-hover:opacity-100" 
                                    title="Edit this message">
                                    <i class="fas fa-edit text-[10px]"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }

                // Assistant message (left aligned, white)
                if (isAssistant) {
                    return `
                        <div class="flex justify-start">
                            <div class="max-w-[85%] flex items-start gap-2">
                                <div class="w-6 h-6 rounded-full bg-emerald-100 flex items-center justify-center flex-shrink-0 mt-1">
                                    <i class="fas fa-robot text-emerald-600 text-xs"></i>
                                </div>
                                <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-sm px-4 py-2.5 shadow-sm">
                                    <p class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">${content}</p>
                                    <div class="mt-2 flex items-center gap-2">
                                        <button onclick="replacePreviewWithAssistant(${index})" class="text-[11px] px-2 py-1 rounded bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200" title="Replace selected text in the Final Proposal preview with this response">
                                            Replace selection in Preview
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                return '';
            });

            // Add status message if present
            if (statusMessage) {
                bubbles.push(`
                    <div class="flex justify-start">
                        <div class="max-w-[85%] flex items-start gap-2">
                            <div class="w-6 h-6 rounded-full bg-cyan-100 flex items-center justify-center flex-shrink-0 mt-1">
                                <div class="w-3 h-3 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
                            </div>
                            <div class="bg-white border border-cyan-200 rounded-2xl rounded-tl-sm px-4 py-2.5 shadow-sm">
                                <p class="text-sm text-cyan-700">${escapeHtml(statusMessage)}</p>
                            </div>
                        </div>
                    </div>
                `);
            }

            generalQueryResponse.innerHTML = bubbles.join('');

            // Auto-scroll to bottom
            setTimeout(() => {
                generalQueryResponse.scrollTop = generalQueryResponse.scrollHeight;
            }, 100);
        }

        // Replace selected text inside the Final Proposal preview with the assistant's response
        function replacePreviewWithAssistant(index) {
            if (!finalProposalContent) return;
            if (index < 0 || index >= generalQueryHistory.length) return;
            const entry = generalQueryHistory[index];
            if (!entry || entry.role !== 'assistant') return;

            // Ensure preview is editable
            if (!finalProposalEditable && finalProposalEditBtn) {
                try { finalProposalEditBtn.click(); } catch (_) {}
            }

            const sel = window.getSelection();
            if (!sel || sel.rangeCount === 0) {
                alert('Select the text inside the Final Proposal preview that you want to replace, then click this button again.');
                return;
            }
            const range = sel.getRangeAt(0);
            if (!finalProposalContent.contains(range.commonAncestorContainer)) {
                alert('Please select text within the Final Proposal preview area to replace.');
                return;
            }

            // Snapshot for undo
            pushPreviewUndoSnapshot();

            // Build a fragment from the assistant response (split by blank lines into paragraphs)
            const buildFragmentFromText = (text) => {
                const frag = document.createDocumentFragment();
                const blocks = String(text || '').trim().split(/\n\s*\n/);
                blocks.forEach((block) => {
                    const trimmed = block.trim();
                    if (!trimmed) return;
                    // If the block looks like a heading marker (### Heading), convert to <h3>
                    const m = trimmed.match(/^\s*#{3,}\s*(.+?)\s*$/);
                    if (m) {
                        const h3 = document.createElement('h3');
                        h3.textContent = m[1];
                        frag.appendChild(h3);
                        return;
                    }
                    const p = document.createElement('p');
                    p.textContent = trimmed;
                    frag.appendChild(p);
                });
                return frag;
            };

            try {
                const fragment = buildFragmentFromText(entry.content || '');
                if (!fragment || fragment.childNodes.length === 0) return;
                range.deleteContents();
                range.insertNode(fragment);
                // Move caret to end of inserted content
                sel.removeAllRanges();
                const newRange = document.createRange();
                const lastChild = finalProposalContent.lastChild;
                if (lastChild) {
                    newRange.selectNodeContents(lastChild);
                    newRange.collapse(false);
                    sel.addRange(newRange);
                }
                updateUndoBtnState();
            } catch (err) {
                console.error('Replace in preview failed:', err);
                alert('Sorry, replacing the selection failed. Please try again.');
            }
        }

        function editUserMessage(index) {
            if (index < 0 || index >= generalQueryHistory.length) return;
            const entry = generalQueryHistory[index];
            if (entry.role !== 'user') return;

            // Set the input value to the message content
            if (generalQueryInput) {
                generalQueryInput.value = entry.content;
                generalQueryInput.focus();

                // Remove the message and all subsequent messages (assistant response)
                generalQueryHistory = generalQueryHistory.slice(0, index);

                // Re-render the chat
                renderGeneralQueryChat();
            }
        }

        function setRfpStatus(message, options = {}) {
            if (!rfpParseStatus) return;
            const { error = false, loading = false } = options;
            if (!message) {
                rfpParseStatus.textContent = '';
                rfpParseStatus.classList.add('hidden');
                rfpParseStatus.classList.remove('animate-pulse', 'text-rose-500');
                rfpParseStatus.classList.add('text-gray-500');
                return;
            }
            rfpParseStatus.textContent = message;
            rfpParseStatus.classList.remove('hidden');
            rfpParseStatus.classList.toggle('animate-pulse', !!loading);
            rfpParseStatus.classList.toggle('text-rose-500', !!error);
            rfpParseStatus.classList.toggle('text-gray-500', !error);
        }

        function renderRfpPages(pages, append = false) {
            if (!rfpTextContainer) return;
            if (!append) {
                rfpTextContainer.innerHTML = '';
            }
            if (!Array.isArray(pages) || pages.length === 0) {
                if (!append) {
                    rfpTextContainer.innerHTML = '<p class="text-sm text-gray-500">No extractable text found for the requested pages.</p>';
                }
                return;
            }

            pages.forEach((page) => {
                const wrapper = document.createElement('article');
                wrapper.className = 'rounded-lg border border-gray-200 bg-gray-50 p-3 shadow-sm';

                const header = document.createElement('header');
                header.className = 'flex items-center justify-between mb-2';

                const pageLabel = document.createElement('span');
                pageLabel.className = 'text-xs font-semibold uppercase tracking-wider text-gray-500';
                pageLabel.textContent = `Page ${page.number}`;

                const charLabel = document.createElement('span');
                charLabel.className = 'text-[10px] text-gray-400';
                charLabel.textContent = `${page.characters || 0} chars`;

                header.appendChild(pageLabel);
                header.appendChild(charLabel);

                const pre = document.createElement('pre');
                pre.className = 'whitespace-pre-wrap text-sm leading-relaxed text-gray-700';
                const pageText = typeof page.text === 'string' ? page.text : '';
                pre.textContent = pageText;
                if (!pageText.trim()) {
                    pre.textContent = 'No selectable text detected on this page.';
                    pre.classList.add('text-gray-400', 'italic');
                }

                wrapper.appendChild(header);
                wrapper.appendChild(pre);
                rfpTextContainer.appendChild(wrapper);
            });
        }

        function fetchRfpPages(start = 1, limit = RFP_PAGE_BATCH, append = false) {
            if (!rfpSectionEl) return;
            const apiEndpoint = rfpSectionEl.dataset.api;
            if (!apiEndpoint) {
                setRfpStatus('No RFP file is linked to this workspace yet.');
                if (rfpLoadMoreBtn) {
                    rfpLoadMoreBtn.classList.add('hidden');
                }
                return;
            }

            const url = new URL(apiEndpoint, window.location.origin);
            if (start) url.searchParams.set('start', start);
            if (limit) url.searchParams.set('limit', limit);

            setRfpStatus('Loading RFP pages…', { loading: true });

            fetch(url.toString(), { headers: { 'Accept': 'application/json' } })
                .then(async (response) => {
                    const contentType = response.headers.get('content-type') || '';
                    let payload = null;
                    if (contentType.includes('application/json')) {
                        payload = await response.json();
                    } else {
                        const text = await response.text();
                        payload = { error: text };
                    }
                    if (!response.ok) {
                        const errorMessage = payload && payload.message ? payload.message : 'Failed to load RFP content.';
                        throw new Error(errorMessage);
                    }
                    return payload;
                })
                .then((data) => {
                    const pages = Array.isArray(data.pages) ? data.pages : [];
                    if (pages.length > 0) {
                        const first = pages[0].number;
                        const last = pages[pages.length - 1].number;
                        const total = data.total_pages || last;
                        setRfpStatus(`Showing pages ${first}–${last} of ${total}`);
                        renderRfpPages(pages, append);
                    } else {
                        if ((data.total_pages || 0) === 0) {
                            setRfpStatus('No pages available in this PDF.');
                        } else {
                            setRfpStatus('No extractable text found in the requested pages.');
                        }
                        if (!append) {
                            rfpTextContainer.innerHTML = '<p class="text-sm text-gray-500">No extractable text found for the requested pages.</p>';
                        }
                    }

                    rfpPagesNextStart = data.next_start || null;
                    if (rfpLoadMoreBtn) {
                        if (rfpPagesNextStart) {
                            rfpLoadMoreBtn.classList.remove('hidden');
                            rfpLoadMoreBtn.disabled = false;
                        } else {
                            rfpLoadMoreBtn.classList.add('hidden');
                        }
                    }

                    // Load PDF using PDF.js instead of iframe
                    if (rfpSectionEl.dataset.viewUrl && !rfpSectionEl.dataset.pdfLoaded) {
                        loadPdfWithJs(rfpSectionEl.dataset.viewUrl);
                        rfpSectionEl.dataset.pdfLoaded = '1';
                    }
                    if (rfpPreviewFallback) {
                        rfpPreviewFallback.classList.add('hidden');
                    }
                })
                .catch((error) => {
                    console.error('Error loading RFP preview:', error);
                    setRfpStatus('', { error: true });
                    if (!append && rfpTextContainer) {
                        rfpTextContainer.innerHTML = '';
                    }
                    if (rfpLoadMoreBtn) {
                        rfpLoadMoreBtn.classList.add('hidden');
                    }
                    if (rfpPreviewFallback) {
                        rfpPreviewFallback.classList.remove('hidden');
                        rfpPreviewFallback.textContent = 'PDF preview unavailable. Download the file from the bid dashboard.';
                    }
                })
                .finally(() => {
                    if (rfpParseStatus) {
                        rfpParseStatus.classList.remove('animate-pulse');
                    }
                });
        }

        rfpLoadMoreBtn?.addEventListener('click', () => {
            if (!rfpPagesNextStart) return;
            fetchRfpPages(rfpPagesNextStart, RFP_PAGE_BATCH, true);
        });

        rfpReloadBtn?.addEventListener('click', () => {
            rfpPagesNextStart = null;
            fetchRfpPages(1, RFP_PAGE_BATCH, false);
        });

        rfpUploadBtn?.addEventListener('click', () => {
            rfpUploadInput?.click();
        });

        document.getElementById('rfpUploadEmptyStateBtn')?.addEventListener('click', () => {
            if (!document.querySelector('#rfpPreviewSection').dataset.bidId) {
                 alert('Please select a project from the "Add new section" sidebar or create a new project first.');
            }
            rfpUploadInput?.click();
        });

        // Attach button near Generate uses the same upload flow
        attachFileNearGenerateBtn?.addEventListener('click', () => {
            const bidId = getActiveBidId();
            if (!bidId) {
                alert('Select or open a bid/project before attaching files.');
                return;
            }
            ptsImageInput?.click();
        });
        attachPricingFileBtn?.addEventListener('click', () => {
            const bidId = getActiveBidId();
            if (!bidId) {
                alert('Select or open a bid/project before attaching files.');
                return;
            }
            pricingFileInput?.click();
        });

        // Handle image-only uploads for Proposed Technical Solution section
        ptsImageInput?.addEventListener('change', async () => {
            const gId = getActiveBidId();
            if (!gId) {
                alert('Select a bid/project first.');
                ptsImageInput.value = '';
                return;
            }
            const files = Array.from(ptsImageInput.files || []);
            if (!files.length) return;
            for (const file of files) {
                const name = (file.name || '').toLowerCase();
                if (!name.endsWith('.png') && !name.endsWith('.jpg') && !name.endsWith('.jpeg') && !name.endsWith('.webp')) {
                    alert('Only image files (.png, .jpg, .jpeg, .webp) are allowed for this section.');
                    continue;
                }
                const formData = new FormData();
                formData.append('file', file);
                formData.append('section_id', 'section-technical');
                try {
                    const res = await fetch(`/api/section-attachment/${gId}/upload?section_id=section-technical`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (!res.ok || !data.success) {
                        console.error('Image upload failed', data);
                        alert(data?.message || 'Image upload failed.');
                        continue;
                    }
                } catch (e) {
                    console.error(e);
                    alert('Network error while uploading image.');
                }
            }
            ptsImageInput.value = '';
            // Optional: provide quick feedback
            try {
                const el = document.createElement('div');
                el.className = 'text-xs text-gray-500';
                el.textContent = 'Images attached for this section. Click Generate to use them.';
                attachFileNearGenerateBtn?.parentElement?.appendChild(el);
                setTimeout(() => el.remove(), 4000);
            } catch {}
            // Track attachments for Proposed Technical Solution and enable Save if active
            try {
                sectionAttachmentCounts['section-technical'] = (sectionAttachmentCounts['section-technical'] || 0) + files.length;
                if (activeSectionId === 'section-technical') {
                    try { await refreshSectionAttachments(); } catch (_) {}
                    const sec = defaultSections.find(s => s.id === activeSectionId);
                    if (sec) {
                        sec.status = 'Draft';
                        if (sectionStatus) {
                            sectionStatus.textContent = 'Draft';
                        }
                        renderSectionList();
                    }
                    refreshSectionActionStates();
                }
            } catch (_) {}
        });

        // Handle pricing attachments (PDFs or images)
        pricingFileInput?.addEventListener('change', async () => {
            const gId = getActiveBidId();
            if (!gId) {
                alert('Select a bid/project first.');
                pricingFileInput.value = '';
                return;
            }
            const files = Array.from(pricingFileInput.files || []);
            if (!files.length) return;
            for (const file of files) {
                const name = (file.name || '').toLowerCase();
                const isImg = name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.jpeg') || name.endsWith('.webp');
                if (!isImg) {
                    alert('Only image files (.png, .jpg, .jpeg, .webp) are allowed for this section.');
                    continue;
                }
                const formData = new FormData();
                formData.append('file', file);
                formData.append('section_id', 'section-pricing');
                try {
                    const res = await fetch(`/api/section-attachment/${gId}/upload?section_id=section-pricing`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (!res.ok || !data.success) {
                        console.error('Pricing file upload failed', data);
                        alert(data?.message || 'File upload failed.');
                        continue;
                    }
                } catch (e) {
                    console.error(e);
                    alert('Network error while uploading file.');
                }
            }
            pricingFileInput.value = '';
            try {
                const el = document.createElement('div');
                el.className = 'text-xs text-gray-500';
                el.textContent = 'Pricing files attached. Click Generate to use them.';
                attachPricingFileBtn?.parentElement?.appendChild(el);
                setTimeout(() => el.remove(), 4000);
            } catch {}
            // Track attachments for Pricing section and enable Save if active
            try {
                sectionAttachmentCounts['section-pricing'] = (sectionAttachmentCounts['section-pricing'] || 0) + files.length;
                if (activeSectionId === 'section-pricing') {
                    try { await refreshSectionAttachments(); } catch (_) {}
                    const sec = defaultSections.find(s => s.id === activeSectionId);
                    if (sec) {
                        sec.status = 'Draft';
                        if (sectionStatus) {
                            sectionStatus.textContent = 'Draft';
                        }
                        renderSectionList();
                    }
                    refreshSectionActionStates();
                }
            } catch (_) {}
        });

        // Generic per-section attachments (PDFs or images)
        attachSectionAnyFileBtn?.addEventListener('click', () => {
            const gId = getActiveBidId();
            if (!gId) {
                alert('Select or open a bid/project before attaching files.');
                return;
            }
            if (!activeSectionId) {
                alert('Select a section first.');
                return;
            }
            sectionAnyFileInput?.click();
        });

        // Image-only attachments for any section
        attachSectionImageBtn?.addEventListener('click', () => {
            const gId = getActiveBidId();
            if (!gId) {
                alert('Select or open a bid/project before attaching images.');
                return;
            }
            if (!activeSectionId) {
                alert('Select a section first.');
                return;
            }
            sectionImageInput?.click();
        });

        sectionImageInput?.addEventListener('change', async () => {
            try {
                const gId = getActiveBidId();
                if (!gId || !activeSectionId) {
                    sectionImageInput.value = '';
                    return;
                }
                const files = Array.from(sectionImageInput.files || []);
                if (!files.length) return;
                const validImages = [];
                for (const file of files) {
                    const name = (file.name || '').toLowerCase();
                    const isImg = name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.jpeg') || name.endsWith('.webp');
                    if (!isImg) {
                        alert('Only image files (.png, .jpg, .jpeg, .webp) are allowed.');
                        continue;
                    }
                    validImages.push(file);
                }
                if (validImages.length === 0) {
                    sectionImageInput.value = '';
                    return;
                }
                // Queue images to be uploaded when the section is saved
                pendingSectionImageFiles[activeSectionId] = (pendingSectionImageFiles[activeSectionId] || []).concat(validImages);
                sectionImageInput.value = '';
                const el = document.createElement('div');
                el.className = 'text-xs text-emerald-600';
                el.textContent = 'Image(s) ready to save for this section. Click Save to attach.';
                attachSectionImageBtn?.parentElement?.appendChild(el);
                setTimeout(() => el.remove(), 4000);
                // Mark draft and enable Save
                try {
                    const sec = defaultSections.find(s => s.id === activeSectionId);
                    if (sec) {
                        sec.status = 'Draft';
                        if (sectionStatus) sectionStatus.textContent = 'Draft';
                        renderSectionList();
                    }
                    refreshSectionActionStates();
                } catch (_) {}
            } catch (error) {
                console.error('Preparing image(s) for save failed:', error);
                alert('Unable to queue image(s). Please try again.');
            }
        });

        sectionAnyFileInput?.addEventListener('change', async () => {
            try {
                const gId = getActiveBidId();
                if (!gId || !activeSectionId) {
                    sectionAnyFileInput.value = '';
                    return;
                }
                const files = Array.from(sectionAnyFileInput.files || []);
                if (files.length === 0) return;
                for (const file of files) {
                    const fd = new FormData();
                    fd.append('file', file);
                    fd.append('section_id', activeSectionId);
                    const res = await fetch(`/api/section-attachment/${gId}/upload?section_id=${encodeURIComponent(activeSectionId)}`, {
                        method: 'POST',
                        body: fd
                    });
                    const data = await res.json();
                    if (!res.ok || !data.success) {
                        throw new Error((data && data.message) || 'Upload failed');
                    }
                }
                sectionAnyFileInput.value = '';
                const el = document.createElement('div');
                el.className = 'text-xs text-emerald-600';
                el.textContent = 'File(s) attached to this section. They will be inserted into the final proposal.';
                attachSectionAnyFileBtn?.parentElement?.appendChild(el);
                setTimeout(() => el.remove(), 4000);
                // Record attachments for this section and enable Save
                try {
                    try { await refreshSectionAttachments(); } catch (_) {}
                    sectionAttachmentCounts[activeSectionId] = (sectionAttachmentCounts[activeSectionId] || 0) + files.length;
                    const sec = defaultSections.find(s => s.id === activeSectionId);
                    if (sec) {
                        sec.status = 'Draft';
                        if (sectionStatus) {
                            sectionStatus.textContent = 'Draft';
                        }
                        renderSectionList();
                    }
                    refreshSectionActionStates();
                } catch (_) {}
            } catch (error) {
                console.error('Section attachment upload failed:', error);
                alert('Unable to upload file(s). Only PDF and image files are supported.');
            }
        });

        rfpUploadInput?.addEventListener('change', () => {
            if (!rfpSectionEl || !rfpSectionEl.dataset.bidId) {
                setRfpStatus('No project is selected for upload.', { error: true });
                rfpUploadInput.value = '';
                return;
            }
            const files = rfpUploadInput.files ? Array.from(rfpUploadInput.files) : [];
            if (!files.length) {
                return;
            }
            const nonPdf = files.filter(f => !f.name.toLowerCase().endsWith('.pdf'));
            if (nonPdf.length) {
                setRfpStatus('Please upload PDF files only.', { error: true });
                rfpUploadInput.value = '';
                return;
            }

            const gId = rfpSectionEl.dataset.bidId;
            const formData = new FormData();
            files.forEach(file => {
                formData.append('file', file);
            });

            setRfpStatus(`Uploading ${files.length} PDF${files.length > 1 ? 's' : ''}...`, { loading: true });

            fetch(`/api/rfp-file/${gId}/upload`, {
                method: 'POST',
                body: formData,
            })
                .then(async (response) => {
                    let payload = {};
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        payload = await response.json();
                    }
                    if (!response.ok || payload.error || payload.success === false) {
                        const message = payload.message || 'Upload failed. Please try again.';
                        throw new Error(message);
                    }
                    return payload;
                })
                .then((data) => {
                    const pages = Array.isArray(data.pages) ? data.pages : [];
                    rfpPagesNextStart = data.next_start || null;
                    if (pages.length > 0) {
                        renderRfpPages(pages, false);
                        const first = pages[0].number || 1;
                        const last = pages[pages.length - 1].number || first;
                        const total = data.total_pages || last;
                        setRfpStatus(`Showing pages ${first}–${last} of ${total}`);
                        if (rfpLoadMoreBtn) {
                            if (rfpPagesNextStart) {
                                rfpLoadMoreBtn.classList.remove('hidden');
                                rfpLoadMoreBtn.disabled = false;
                            } else {
                                rfpLoadMoreBtn.classList.add('hidden');
                            }
                        }
                    } else {
                        setRfpStatus('Upload complete. Parsing PDF...', { loading: true });
                        fetchRfpPages(1, RFP_PAGE_BATCH, false);
                    }

                    // Reload PDF after upload
                    if (rfpSectionEl.dataset.viewUrl) {
                        delete rfpSectionEl.dataset.pdfLoaded;
                        loadPdfWithJs(`${rfpSectionEl.dataset.viewUrl}?t=${Date.now()}`);
                    }
                })
                .catch((error) => {
                    console.error('RFP upload failed:', error);
                    setRfpStatus(error.message || 'Upload failed. Please try again.', { error: true });
                })
                .finally(() => {
                    rfpUploadInput.value = '';
                    if (rfpParseStatus) {
                        rfpParseStatus.classList.remove('animate-pulse');
                    }
                });
        });

        if (rfpSectionEl && rfpSectionEl.dataset.api) {
            fetchRfpPages(1, RFP_PAGE_BATCH, false);
        } else if (rfpSectionEl) {
            rfpReloadBtn?.setAttribute('disabled', 'disabled');
            rfpReloadBtn?.classList.add('opacity-50', 'cursor-not-allowed');
            setRfpStatus('No RFP file is linked to this workspace yet.');
        }

        function escapeHtml(text) {
            const p = document.createElement('p');
            p.textContent = text;
            return p.innerHTML;
        }
        function escapeRegExp(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        function getCustomOpenAIKey() {
            try { return localStorage.getItem('custom_openai_key') || ''; } catch (_) { return ''; }
        }
        function setCustomOpenAIKey(value) {
            try {
                if (value && value.trim()) {
                    localStorage.setItem('custom_openai_key', value.trim());
                } else {
                    localStorage.removeItem('custom_openai_key');
                }
            } catch (_) {}
            updateCustomKeyBadge();
        }
        function updateCustomKeyBadge() {
            const hasKey = !!getCustomOpenAIKey();
            if (customKeyBadge) {
                if (hasKey) {
                    customKeyBadge.classList.remove('hidden');
                } else {
                    customKeyBadge.classList.add('hidden');
                }
            }
        }
        updateCustomKeyBadge();

        async function refineActiveSectionContent() {
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) return;
            const bidId = getActiveBidId();
            const company = (companySelect && companySelect.value) ? companySelect.value : ((proposalContext && proposalContext.company) ? proposalContext.company : '');
            const contactEmail = (proposalContext && proposalContext.contactEmail) ? proposalContext.contactEmail : '';
            const customApiKey = getCustomOpenAIKey();
            const body = {
                paragraphs: Array.isArray(section.content) ? section.content : [],
                section_id: section.id,
                section_title: section.title,
                bid_id: bidId,
                company: company,
                contact_email: contactEmail,
                api_key: customApiKey || undefined
            };
            sectionContentDisplay.innerHTML = `<p class="text-gray-700 leading-relaxed">Improving and aligning content with the RFP...</p>`;
            const res = await fetch('/api/refine-section-content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            if (!res.ok) {
                sectionContentDisplay.innerHTML = `<p class="text-red-600 leading-relaxed">Error: ${escapeHtml(data.message || 'Failed to refine content')}</p>`;
                return;
            }
            const paragraphs = data.content || [];
            const flags = (data.flags && data.flags.outside_rfp_recommendations) ? data.flags.outside_rfp_recommendations : [];
            section.content = paragraphs;
            section.rawContent = '';
            section.flags = { outside_rfp_recommendations: flags };
            const highlighted = paragraphs.map((paragraph, idx) => {
                let html = escapeHtml(paragraph);
                const pFlags = flags.filter(f => f.paragraph_index === idx && f.sentence);
                pFlags.forEach(f => {
                    const escapedSentence = escapeHtml(f.sentence);
                    const re = new RegExp(escapeRegExp(escapedSentence), 'gi');
                    html = html.replace(re, '<mark class="bg-yellow-200">$&</mark>');
                });
                return `<p class="text-gray-700 leading-relaxed">${html}</p>`;
            });
            sectionContentDisplay.innerHTML = highlighted.join('');
            // Update flags panel
            if (sectionFlagsDisplay) {
                if (flags && flags.length > 0) {
                    const list = flags.slice(0, 6).map(f => `<li class="ml-4 list-disc">${escapeHtml(f.sentence)}</li>`).join('');
                    sectionFlagsDisplay.classList.remove('hidden');
                    sectionFlagsDisplay.innerHTML = `
                        <div class="rounded-md border border-yellow-300 bg-yellow-50 p-3 text-yellow-900 text-sm">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>${flags.length} potential recommendation/suggestion sentence${flags.length===1?'':'s'} outside the RFP detected</strong>
                            </div>
                            <p class="mb-1">Highlighted in yellow above. Please review and edit or remove before compiling.</p>
                            <div class="mt-2">
                                <button id="refineFromFlagsBtn" class="inline-flex items-center gap-2 rounded-lg border border-emerald-300 bg-emerald-50 px-3 py-1.5 text-xs font-semibold text-emerald-800 hover:bg-emerald-100">
                                    <i class="fas fa-magic"></i>
                                    Improve this section
                                </button>
                            </div>
                        </div>
                    `;
                    const refineFromFlagsBtn = document.getElementById('refineFromFlagsBtn');
                    if (refineFromFlagsBtn) refineFromFlagsBtn.addEventListener('click', refineActiveSectionContent);
                } else {
                    sectionFlagsDisplay.classList.add('hidden');
                    sectionFlagsDisplay.innerHTML = '';
                }
            }
            persistSectionsToStorage();
        }
        // Expose for inline handlers if needed
        window.refineActiveSectionContent = refineActiveSectionContent;

        setOpenAIKeyBtn?.addEventListener('click', () => {
            const existing = getCustomOpenAIKey();
            const val = prompt('Enter your OpenAI API key (leave blank to clear):', existing || '');
            if (val !== null) {
                setCustomOpenAIKey(val);
                alert(getCustomOpenAIKey() ? 'Custom OpenAI key saved for this browser.' : 'Custom key cleared.');
            }
        });
        refineContentBtn?.addEventListener('click', refineActiveSectionContent);
        function renderSectionList() {
            if (!sectionListEl) return;
            sectionListEl.innerHTML = '';
            defaultSections.filter(s => !s.excluded).forEach((section, idx) => {
                const li = document.createElement('li');
                const recommendedClass = section.recommended
                    ? (section.verifiedRequired === true
                        ? ' ring-2 ring-emerald-300 bg-emerald-50/60'
                        : section.verifiedRequired === false
                            ? ' ring-2 ring-red-300 bg-red-50/60'
                            : ' ring-2 ring-purple-300 bg-purple-50/60')
                    : '';
                li.className = `relative flex items-center gap-3 px-6 py-4 cursor-pointer transition ${section.id === activeSectionId ? 'section-active' : 'hover:bg-gray-50'}${recommendedClass}`;
                li.dataset.sectionId = section.id;
                const statusLabel = section.status || 'Draft';

                // Create drag handle
                const dragHandle = document.createElement('button');
                dragHandle.className = 'drag-handle text-gray-300 hover:text-gray-500';
                dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';

                // Create dropdown button
                const dropdownBtn = document.createElement('button');
                dropdownBtn.className = 'section-dropdown-btn text-gray-400 hover:text-gray-600 transition p-1.5 rounded hover:bg-gray-100';
                dropdownBtn.innerHTML = '<i class="fas fa-ellipsis-v text-sm"></i>';
                dropdownBtn.title = 'Section options';
                dropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleSectionDropdown(section.id);
                });

                // Create dropdown menu
                const dropdownMenu = document.createElement('div');
                dropdownMenu.id = `dropdown-${section.id}`;
                dropdownMenu.className = 'hidden absolute right-2 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50 py-1';
                const isFirst = idx === 0;
                const isLast = idx === defaultSections.length - 1;
                dropdownMenu.innerHTML = `
                    <button class="dropdown-item w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2" data-action="rename" data-section-id="${section.id}">
                        <i class="fas fa-edit text-xs"></i>
                        <span>Rename</span>
                    </button>
                    <button class="dropdown-item w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2" data-action="duplicate" data-section-id="${section.id}">
                        <i class="fas fa-copy text-xs"></i>
                        <span>Duplicate</span>
                    </button>
                    <button class="dropdown-item w-full text-left px-4 py-2 text-sm ${isFirst ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100'} flex items-center gap-2" data-action="move-up" data-section-id="${section.id}" ${isFirst ? 'disabled' : ''}>
                        <i class="fas fa-arrow-up text-xs"></i>
                        <span>Move Up</span>
                    </button>
                    <button class="dropdown-item w-full text-left px-4 py-2 text-sm ${isLast ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100'} flex items-center gap-2" data-action="move-down" data-section-id="${section.id}" ${isLast ? 'disabled' : ''}>
                        <i class="fas fa-arrow-down text-xs"></i>
                        <span>Move Down</span>
                    </button>
                    <div class="border-t border-gray-200 my-1"></div>
                    <button class="dropdown-item w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2" data-action="delete" data-section-id="${section.id}">
                        <i class="fas fa-trash-alt text-xs"></i>
                        <span>Delete</span>
                    </button>
                `;

                // Add event listeners to dropdown items
                dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (item.disabled) return;
                        const action = item.dataset.action;
                        const sectionId = item.dataset.sectionId;
                        handleSectionAction(action, sectionId);
                        closeAllDropdowns();
                    });
                });

                // Create button container
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex items-center gap-2 relative';
                buttonContainer.appendChild(dropdownBtn);
                buttonContainer.appendChild(dragHandle);
                buttonContainer.appendChild(dropdownMenu);

                li.innerHTML = `
                    <span class="text-sm font-semibold text-gray-400 w-6">${idx + 1}.</span>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900">
                            ${section.title}
                            ${section.recommended ? `
                                <span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-medium ${section.verifiedRequired === true ? 'bg-emerald-100 text-emerald-700' : section.verifiedRequired === false ? 'bg-red-100 text-red-700' : 'bg-purple-100 text-purple-700'} align-middle">
                                    Required
                                    ${section.verifiedRequired === true ? '<i class="fas fa-check-circle ml-1 text-emerald-600"></i>' : section.verifiedRequired === false ? '<i class="fas fa-exclamation-circle ml-1 text-red-500"></i>' : ''}
                                </span>
                            ` : ''}
                        </p>
                        <p class="text-xs text-gray-500 capitalize">${statusLabel}</p>
                    </div>
                `;
                li.appendChild(buttonContainer);

                li.addEventListener('click', (e) => {
                    // Don't activate section if clicking on dropdown or menu
                    if (e.target.closest('.section-dropdown-btn') ||
                        e.target.closest('.dropdown-menu')) {
                        return;
                    }
                    if (isEditing) return;
                    activeSectionId = section.id;
                    closeAllDropdowns();
                    renderSectionList();
                    renderActiveSection();
                });
                sectionListEl.appendChild(li);
            });

            // Add Requirements and Attachments section at the end
            const reqAttachId = 'requirements-attachments';
            const reqAttachLi = document.createElement('li');
            reqAttachLi.className = `relative flex items-center gap-3 px-6 py-4 cursor-pointer transition ${reqAttachId === activeSectionId ? 'section-active' : 'hover:bg-gray-50'}`;
            reqAttachLi.dataset.sectionId = reqAttachId;

            reqAttachLi.innerHTML = `
                <span class="text-sm font-semibold text-gray-400 w-6">${defaultSections.length + 1}.</span>
                <div class="flex-1">
                    <p class="font-medium text-gray-900">Requirements and Attachments</p>
                    <p class="text-xs text-gray-500">Special Section</p>
                </div>
            `;

            reqAttachLi.addEventListener('click', (e) => {
                if (isEditing) return;
                activeSectionId = reqAttachId;
                closeAllDropdowns();
                renderSectionList();
                renderActiveSection();
            });

            sectionListEl.appendChild(reqAttachLi);
        }

        function toggleSectionDropdown(sectionId) {
            const dropdown = document.getElementById(`dropdown-${sectionId}`);
            if (!dropdown) {
                return;
            }
            const shouldShow = dropdown.classList.contains('hidden');
            closeAllDropdowns();
            if (shouldShow) {
                dropdown.classList.remove('hidden');
            }
        }

        function closeAllDropdowns() {
            document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
                dropdown.classList.add('hidden');
            });
        }

        function handleSectionAction(action, sectionId) {
            const section = defaultSections.find(sec => sec.id === sectionId);
            if (!section) return;

            switch (action) {
                case 'rename':
                    const newTitle = prompt('Rename section', section.title);
                    if (newTitle && newTitle.trim()) {
                        section.title = newTitle.trim();
                        renderSectionList();
                        renderActiveSection();
                        persistSectionsToStorage();
                    }
                    break;
                case 'duplicate':
                    const newId = `section-${Date.now()}`;
                    const duplicatedSection = {
                        id: newId,
                        title: `${section.title} (Copy)`,
                        status: 'Draft',
                        guidance: section.guidance || '',
                        content: Array.isArray(section.content) ? [...section.content] : [],
                        rawContent: section.rawContent || '',
                        sub_categories: Array.isArray(section.sub_categories) ? [...section.sub_categories] : []
                    };
                    const currentIndex = defaultSections.findIndex(sec => sec.id === sectionId);
                    defaultSections.splice(currentIndex + 1, 0, duplicatedSection);
                    activeSectionId = newId;
                    renderSectionList();
                    renderActiveSection();
                    ensureSortable();
                    persistSectionsToStorage();
                    break;
                case 'move-up':
                    const upIndex = defaultSections.findIndex(sec => sec.id === sectionId);
                    if (upIndex > 0) {
                        [defaultSections[upIndex - 1], defaultSections[upIndex]] = [defaultSections[upIndex], defaultSections[upIndex - 1]];
                        renderSectionList();
                        renderActiveSection();
                        ensureSortable();
                        persistSectionsToStorage();
                    }
                    break;
                case 'move-down':
                    const downIndex = defaultSections.findIndex(sec => sec.id === sectionId);
                    if (downIndex < defaultSections.length - 1) {
                        [defaultSections[downIndex], defaultSections[downIndex + 1]] = [defaultSections[downIndex + 1], defaultSections[downIndex]];
                        renderSectionList();
                        renderActiveSection();
                        ensureSortable();
                        persistSectionsToStorage();
                    }
                    break;
                case 'delete':
                    deleteSection(sectionId);
                    break;
            }
        }

        function deleteSection(sectionId) {
            if (!sectionId) return;

            const section = defaultSections.find(sec => sec.id === sectionId);
            if (!section) return;

            // Confirm deletion
            if (!confirm(`Are you sure you want to delete "${section.title}"? This action cannot be undone.`)) {
                return;
            }

            // Find the index of the section to delete
            const sectionIndex = defaultSections.findIndex(sec => sec.id === sectionId);

            // If deleting the active section, switch to another one
            if (sectionId === activeSectionId) {
                if (defaultSections.length > 1) {
                    // Switch to the previous section if available, otherwise the next one
                    if (sectionIndex > 0) {
                        activeSectionId = defaultSections[sectionIndex - 1].id;
                    } else if (sectionIndex < defaultSections.length - 1) {
                        activeSectionId = defaultSections[sectionIndex + 1].id;
                    } else {
                        activeSectionId = null;
                    }
                } else {
                    activeSectionId = null;
                }
            }

            // Remove the section from the array
            defaultSections.splice(sectionIndex, 1);

            // Re-render the list and active section
            renderSectionList();
            if (activeSectionId) {
                renderActiveSection();
            } else {
                // If no sections left, clear the active section display
                sectionTitleDisplay.textContent = 'No sections';
                sectionGuidanceDisplay.innerHTML = '<span class="text-gray-400 italic">Add a new section to get started.</span>';
                sectionContentDisplay.innerHTML = '<p class="text-gray-400 italic">No sections available. Click the + button to add a new section.</p>';
                sectionStatus.textContent = '';
            }

            // Re-initialize sortable after deletion
            ensureSortable();
            persistSectionsToStorage();
        }

        function renderActiveSection() {
            const requirementsAttachmentsSection = document.getElementById('requirementsAttachmentsSection');
            const regularSectionDisplay = document.getElementById('regularSectionDisplay');

            // Handle Requirements and Attachments special section
            if (activeSectionId === 'requirements-attachments') {
                if (requirementsAttachmentsSection) {
                    requirementsAttachmentsSection.classList.remove('hidden');
                }
                if (regularSectionDisplay) {
                    regularSectionDisplay.classList.add('hidden');
                }
                return;
            }

            // Handle regular sections
            if (requirementsAttachmentsSection) {
                requirementsAttachmentsSection.classList.add('hidden');
            }
            if (regularSectionDisplay) {
                regularSectionDisplay.classList.remove('hidden');
            }

            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) return;
            sectionTitleDisplay.textContent = section.title;
            sectionGuidanceDisplay.innerHTML = section.guidance ? escapeHtml(section.guidance) : '<span class="text-gray-400 italic">No guidance provided yet.</span>';
            sectionStatus.textContent = section.status || 'Draft';
            refreshSectionActionStates();
            // Refresh attachments list for this section
            try { refreshSectionAttachments(); } catch (_) {}
            
            // Toggle Attach File button visibility only for Proposed Technical Solution
            const attachBtn = document.getElementById('attachFileNearGenerateBtn');
            const attachPricing = document.getElementById('attachPricingFileBtn');
            if (attachBtn) {
                const isProposedTechnical = (
                    section.id === 'section-technical' ||
                    (section.title && section.title.toLowerCase().includes('proposed technical solution'))
                );
                if (isProposedTechnical) {
                    attachBtn.classList.remove('hidden');
                } else {
                    attachBtn.classList.add('hidden');
                }
            }
            if (attachPricing) {
                const isPricing = (
                    section.id === 'section-pricing' ||
                    (section.title && section.title.toLowerCase().includes('pricing proposals'))
                );
                if (isPricing) {
                    attachPricing.classList.remove('hidden');
                } else {
                    attachPricing.classList.add('hidden');
                }
            }
            
            // Check if this is Corporate Qualifications section that needs HTML rendering
            const isCorporateQualifications = (
                section.id === 'section-corporate-qualifications' || 
                section.id === 'section-corporate' ||
                (section.title && section.title.toLowerCase().includes('corporate qualifications'))
            );
            
            if (section.content && section.content.length > 0) {
                // For Corporate Qualifications with raw HTML content, render HTML directly
                if (isCorporateQualifications && section.rawContent) {
                    sectionContentDisplay.innerHTML = `
                        <div class="prose max-w-none text-gray-700">
                            ${section.rawContent}
                        </div>
                    `;
                } else {
                    // Re-apply highlights if flags exist for this section
                    const flags = (section.flags && section.flags.outside_rfp_recommendations) ? section.flags.outside_rfp_recommendations : [];
                    const highlighted = section.content.map((paragraph, idx) => {
                        let html = escapeHtml(paragraph);
                        if (flags && flags.length) {
                            const pFlags = flags.filter(f => f.paragraph_index === idx && f.sentence);
                            pFlags.forEach(f => {
                                const escapedSentence = escapeHtml(f.sentence);
                                const re = new RegExp(escapeRegExp(escapedSentence), 'gi');
                                html = html.replace(re, '<mark class="bg-yellow-200">$&</mark>');
                            });
                        }
                        return `<p>${html}</p>`;
                    });
                    sectionContentDisplay.innerHTML = highlighted.join('');
                    // Render flags panel if applicable
                    if (sectionFlagsDisplay) {
                        if (flags && flags.length > 0) {
                            const list = flags.slice(0, 6).map(f => `<li class="ml-4 list-disc">${escapeHtml(f.sentence)}</li>`).join('');
                            sectionFlagsDisplay.classList.remove('hidden');
                            sectionFlagsDisplay.innerHTML = `
                                <div class="rounded-md border border-yellow-300 bg-yellow-50 p-3 text-yellow-900 text-sm">
                                    <div class="flex items-center gap-2 mb-1">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>${flags.length} potential recommendation/suggestion sentence${flags.length===1?'':'s'} outside the RFP detected</strong>
                                    </div>
                                    <p class="mb-1">Highlighted in yellow above. Please review and edit or remove before compiling.</p>
                                    <ul class="list-inside">${list}</ul>
                                </div>
                            `;
                        } else {
                            sectionFlagsDisplay.classList.add('hidden');
                            sectionFlagsDisplay.innerHTML = '';
                        }
                    }
                }
            } else {
                sectionContentDisplay.innerHTML = '<p class="text-gray-400 italic">Use the generator to draft content from the RFP or type manually.</p>';
            }
            sectionContentEditor.value = section.content ? section.content.join('\n\n') : '';

            // Populate sub-category dropdown
            const subCategorySelect = document.getElementById('subCategorySelect');
            const analyzeSubCategoryBtn = document.getElementById('analyzeSubCategoryBtn');
            const subCategoryContentDisplay = document.getElementById('subCategoryContentDisplay');

            if (subCategorySelect) {
                subCategorySelect.innerHTML = '<option value="">-- Select Sub-Category --</option>';
                if (section.sub_categories && Array.isArray(section.sub_categories) && section.sub_categories.length > 0) {
                    section.sub_categories.forEach(subCat => {
                        const option = document.createElement('option');
                        option.value = subCat.id;
                        option.textContent = subCat.title;
                        option.dataset.subcategoryId = subCat.id;
                        option.dataset.subcategoryTitle = subCat.title;
                        subCategorySelect.appendChild(option);
                    });
                }
            }

            // Reset sub-category UI
            if (analyzeSubCategoryBtn) {
                analyzeSubCategoryBtn.disabled = true;
            }
            if (subCategoryContentDisplay) {
                subCategoryContentDisplay.classList.add('hidden');
            }
            if (outlineResultContainer) {
                outlineResultContainer.classList.add('hidden');
            }
            if (outlineContent) {
                outlineContent.textContent = '';
            }
            if (outlineAnalyzing) {
                outlineAnalyzing.classList.add('hidden');
            }
            if (outlineAnalyzeBtn) {
                outlineAnalyzeBtn.disabled = false;
            }
        }

        function toggleEditor(editMode) {
            isEditing = editMode;
            if (editMode) {
                sectionContentDisplay.classList.add('hidden');
                sectionContentEditor.classList.remove('hidden');
                editorActions.classList.remove('hidden');
            } else {
                sectionContentDisplay.classList.remove('hidden');
                sectionContentEditor.classList.add('hidden');
                editorActions.classList.add('hidden');
            }
            refreshSectionActionStates();
        }

        function ensureSortable() {
            if (!sectionListEl) return;
            // Destroy existing instance if it exists
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }
            // Create new Sortable instance
            sortableInstance = new Sortable(sectionListEl, {
                animation: 160,
                handle: '.drag-handle',
                onEnd: (evt) => {
                    const [moved] = defaultSections.splice(evt.oldIndex, 1);
                    defaultSections.splice(evt.newIndex, 0, moved);
                    renderSectionList();
                    renderActiveSection();
                    persistSectionsToStorage();
                }
            });
        }

        renameSectionBtn?.addEventListener('click', () => {
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) return;
            const newTitle = prompt('Rename section', section.title);
            if (newTitle && newTitle.trim()) {
                section.title = newTitle.trim();
                renderSectionList();
                renderActiveSection();
            }
        });

        deepAnalysisBtn?.addEventListener('click', runDeepAnalysis);

        reviewGenerateBtn?.addEventListener('click', async () => {
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) return;
            
            // Disable button during generation
            if (reviewGenerateBtn) {
                reviewGenerateBtn.disabled = true;
            }
            
            // Show loading state
            sectionContentDisplay.innerHTML = `
                <p class="text-gray-700 leading-relaxed">Drafting narrative from the attached RFP &amp; company profile...</p>
            `;
            
            const bidId = getActiveBidId();
            const company = (companySelect && companySelect.value) ? companySelect.value : ((proposalContext && proposalContext.company) ? proposalContext.company : '');
            const contactEmail = (proposalContext && proposalContext.contactEmail) ? proposalContext.contactEmail : '';
            const customApiKey = getCustomOpenAIKey();
            
            try {
                const response = await fetch('/api/generate-section-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section_id: section.id,
                        section_title: section.title,
                        bid_id: bidId,
                        company: company,
                        contact_email: contactEmail,
                        api_key: customApiKey || undefined
                    }),
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to generate section content.');
                }
                
                // Update section content with generated paragraphs
                const paragraphs = data.content || [];
                const rawContent = data.raw || '';
                const flags = (data.flags && data.flags.outside_rfp_recommendations) ? data.flags.outside_rfp_recommendations : [];
                const flagsContainer = document.getElementById('sectionFlagsDisplay');
                
                // Check if this is Corporate Qualifications section that needs HTML rendering
                const isCorporateQualifications = (
                    section.id === 'section-corporate-qualifications' || 
                    section.id === 'section-corporate' ||
                    (section.title && section.title.toLowerCase().includes('corporate qualifications'))
                );
                
                if (paragraphs.length > 0) {
                    section.content = paragraphs;
                    
                    // For Corporate Qualifications, render HTML directly (tables, headings)
                    if (isCorporateQualifications && rawContent) {
                        // Style the HTML content appropriately
                        sectionContentDisplay.innerHTML = `
                            <div class="prose max-w-none text-gray-700">
                                ${rawContent}
                            </div>
                        `;
                        // Store raw HTML in section for later use
                        section.rawContent = rawContent;
                    } else {
                        section.rawContent = '';
                        // Highlight sentences flagged as outside the RFP
                        const highlighted = paragraphs.map((paragraph, idx) => {
                            let html = escapeHtml(paragraph);
                            const pFlags = flags.filter(f => f.paragraph_index === idx && f.sentence);
                            pFlags.forEach(f => {
                                const escapedSentence = escapeHtml(f.sentence);
                                const re = new RegExp(escapeRegExp(escapedSentence), 'gi');
                                html = html.replace(re, '<mark class="bg-yellow-200">$&</mark>');
                            });
                            return `<p class="text-gray-700 leading-relaxed">${html}</p>`;
                        });
                        sectionContentDisplay.innerHTML = highlighted.join('');
                        // Persist flags on the section so they re-render on navigation
                        section.flags = { outside_rfp_recommendations: flags };
                    }
                } else {
                    section.content = ['AI drafting completed. Customize this section to highlight your differentiators.'];
                    section.rawContent = '';
                    sectionContentDisplay.innerHTML = section.content.map(paragraph => `<p class="text-gray-700 leading-relaxed">${escapeHtml(paragraph)}</p>`).join('');
                }

                // Show or clear flags UI
                if (flags && flags.length > 0 && flagsContainer) {
                    const list = flags.slice(0, 6).map(f => `<li class="ml-4 list-disc">${escapeHtml(f.sentence)}</li>`).join('');
                    flagsContainer.classList.remove('hidden');
                    flagsContainer.innerHTML = `
                        <div class="rounded-md border border-yellow-300 bg-yellow-50 p-3 text-yellow-900 text-sm">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>${flags.length} potential recommendation/suggestion sentence${flags.length===1?'':'s'} outside the RFP detected</strong>
                            </div>
                            <p class="mb-1">Highlighted in yellow above. Please review and edit or remove before compiling.</p>
                            <ul class="list-inside">${list}</ul>
                            <div class="mt-2">
                                <button id="refineFromFlagsBtn" class="inline-flex items-center gap-2 rounded-lg border border-emerald-300 bg-emerald-50 px-3 py-1.5 text-xs font-semibold text-emerald-800 hover:bg-emerald-100">
                                    <i class="fas fa-magic"></i>
                                    Improve this section
                                </button>
                            </div>
                        </div>
                    `;
                } else if (flagsContainer) {
                    flagsContainer.classList.add('hidden');
                    flagsContainer.innerHTML = '';
                }

                markSectionDraft(section);
                
                persistSectionsToStorage();
            } catch (error) {
                console.error('Error generating section content:', error);
                sectionContentDisplay.innerHTML = `
                    <p class="text-red-600 leading-relaxed">Error: ${escapeHtml(error.message || 'Failed to generate content. Please try again.')}</p>
                `;
            } finally {
                // Re-enable button
                if (reviewGenerateBtn) {
                    reviewGenerateBtn.disabled = false;
                }
                // Wire refine button (rendered on demand)
                const refineFromFlagsBtn = document.getElementById('refineFromFlagsBtn');
                if (refineFromFlagsBtn) {
                    refineFromFlagsBtn.addEventListener('click', refineActiveSectionContent);
                }
            }
        });

        writeManuallyBtn?.addEventListener('click', () => {
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (section) {
                markSectionDraft(section);
            }
            toggleEditor(true);
            sectionContentEditor.focus();
        });

        outlineAnalyzeBtn?.addEventListener('click', async () => {
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) {
                alert('Select a section to analyze first.');
                return;
            }

            if (outlineResultContainer) {
                outlineResultContainer.classList.add('hidden');
            }
            if (outlineContent) {
                outlineContent.textContent = '';
            }

            if (outlineAnalyzeBtn) {
                outlineAnalyzeBtn.disabled = true;
            }
            if (outlineAnalyzing) {
                outlineAnalyzing.classList.remove('hidden');
            }

            const bidId = getActiveBidId();

            try {
                const response = await fetch('/api/analyze-section-outline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section_id: section.id,
                        section_title: section.title,
                        bid_id: bidId,
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to analyze section requirements.');
                }

                const outputText = (data.output || data.raw || '').trim();
                if (outlineContent) {
                    outlineContent.textContent = outputText || 'Analysis complete. No explicit requirements were returned.';
                }

                if (outlineResultContainer) {
                    outlineResultContainer.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error analyzing section outline:', error);
                alert(`Unable to analyze RFP requirements: ${error.message || error}`);
            } finally {
                if (outlineAnalyzing) {
                    outlineAnalyzing.classList.add('hidden');
                }
                if (outlineAnalyzeBtn) {
                    outlineAnalyzeBtn.disabled = false;
                }
            }
        });

        cancelEditBtn?.addEventListener('click', () => {
            toggleEditor(false);
        });

        sectionContentEditor?.addEventListener('input', () => {
            if (!isEditing) return;
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (section) {
                markSectionDraft(section);
            }
        });

        saveSectionBtn?.addEventListener('click', async () => {
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) return;
            const value = sectionContentEditor.value.trim();
            section.content = value ? value.split(/\n\s*\n/) : [];
            section.rawContent = '';
            // Upload any pending images for this section before marking as saved
            try {
                await uploadPendingAttachmentsForSection(activeSectionId);
                try { await refreshSectionAttachments(); } catch (_) {}
            } catch (e) {
                console.error('Pending image upload failed on save:', e);
                alert('Failed to upload images for this section. Please try again.');
                return;
            }
            section.status = 'Saved';
            persistSectionsToStorage();
            toggleEditor(false);
            renderSectionList();
            renderActiveSection();
            refreshSectionActionStates();
            // Automatically analyze for recommendations/suggestions outside the RFP
            try { await auditSectionSuggestions(section); } catch (_) {}
        });

        quickSaveBtn?.addEventListener('click', async () => {
            if (isEditing) {
                return;
            }
            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) return;
            if (!hasSectionContentForSave(section)) {
                alert('Generate or enter content before saving this section.');
                return;
            }
            // Upload pending images if any
            try {
                quickSaveBtn.disabled = true;
                await uploadPendingAttachmentsForSection(activeSectionId);
                try { await refreshSectionAttachments(); } catch (_) {}
            } catch (e) {
                console.error('Pending image upload failed on quick save:', e);
                alert('Failed to upload images for this section. Please try again.');
                quickSaveBtn.disabled = false;
                return;
            }
            section.status = 'Saved';
            if (sectionStatus) {
                sectionStatus.textContent = 'Saved';
            }
            persistSectionsToStorage();
            renderSectionList();
            refreshSectionActionStates();
            // Automatically analyze for recommendations/suggestions outside the RFP
            try { await auditSectionSuggestions(section); } catch (_) {}
        });

        addSectionBtn?.addEventListener('click', () => {
            const id = `section-${Date.now()}`;
            defaultSections.push({
                id,
                title: 'New Section',
                status: 'Draft',
                guidance: 'Add guidance for this new section.',
                content: [],
                rawContent: '',
                sub_categories: []
            });
            activeSectionId = id;
            renderSectionList();
            renderActiveSection();
            persistSectionsToStorage();
        });

        // Generate All Sections Functionality
        document.getElementById('generateAllBtn')?.addEventListener('click', async () => {
            if (confirm('This will generate content for all incomplete sections (Draft, In Progress, Pending). Existing content in these sections will be overwritten. Do you want to continue?')) {
                const generateAllBtn = document.getElementById('generateAllBtn');
                generateAllBtn.disabled = true;
                generateAllBtn.classList.add('opacity-50', 'cursor-not-allowed');
                
                const originalIcon = generateAllBtn.innerHTML;
                generateAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    // Filter for sections that are NOT 'Saved'. 
                    // This includes Draft, In Progress, Pending, etc.
                    // We process them regardless of whether they have content or not, per user request.
                    const sectionsToGenerate = defaultSections.filter(sec => 
                        sec.status !== 'Saved'
                    );

                    if (sectionsToGenerate.length === 0) {
                        alert('No incomplete sections found to generate.');
                        return;
                    }

                    let completed = 0;
                    
                    // Sequential generation to avoid overwhelming the API
                    for (const section of sectionsToGenerate) {
                        activeSectionId = section.id;
                        renderSectionList(); // update UI to show which one is active
                        renderActiveSection();
                        
                        // Scroll to the active section in the sidebar
                        const activeLi = document.querySelector(`li[data-id="${section.id}"]`);
                        if (activeLi) {
                            activeLi.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }

                        // Trigger generation logic
                        await generateSectionContent(section);
                        
                        // Auto-save after generation
                        if (hasSectionContentForSave(section)) {
                            section.status = 'Saved';
                            // Update the status in the UI list immediately
                            const statusEl = document.querySelector(`li[data-id="${section.id}"] .text-gray-500`);
                            if (statusEl) statusEl.textContent = 'Saved';
                            
                            persistSectionsToStorage();
                            
                            // Helper function to trigger save logic similar to quickSaveBtn
                            await performQuickSave(section.id);
                        }

                        completed++;
                    }
                    
                    alert(`Successfully generated content for ${completed} sections.`);
                    renderSectionList();
                    renderActiveSection();

                } catch (error) {
                    console.error('Error during Batch Generation:', error);
                    alert('An error occurred during batch generation. See console for details.');
                } finally {
                    generateAllBtn.disabled = false;
                    generateAllBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    generateAllBtn.innerHTML = originalIcon;
                }
            }
        });

        async function generateSectionContent(section) {
             return new Promise(async (resolve, reject) => {
                // Find elements for the CURRENT active section
                // Since we called renderActiveSection(), these elements should be in the DOM for the current section
                const currentReviewGenerateBtn = document.getElementById('reviewGenerateBtn');
                
                if (!currentReviewGenerateBtn) {
                    console.warn(`Generate button not found for section ${section.title}`);
                    resolve(); // Skip if UI not ready
                    return;
                }

                // Simulate click or call the logic directly? 
                // Better to encapsulate the generate logic. 
                // But existing logic is tied to event listeners and UI state.
                // We will invoke the click handler logic manually or call a shared function.
                
                // Refactored: Call the generation logic directly
                try {
                    const bidId = getActiveBidId();
                    if (!bidId) throw new Error("No bid selected");

                    // Set UI to loading state (optional, as we are automating)
                    const sectionContentDisplay = document.getElementById('sectionContentDisplay');
                    const sectionFlagsDisplay = document.getElementById('sectionFlagsDisplay');
                    
                    if (sectionContentDisplay) {
                         sectionContentDisplay.innerHTML = `
                            <div class="flex items-center gap-2 text-emerald-600 p-4 bg-emerald-50 rounded-lg">
                                <div class="h-4 w-4 border-2 border-emerald-600 border-t-transparent rounded-full animate-spin"></div>
                                <span class="text-sm font-medium">Generating content for "${section.title}"...</span>
                            </div>
                        `;
                    }

                    const attachments = sectionAttachments.get(section.id) || [];
                    const formData = new FormData();
                    formData.append('section_title', section.title);
                    formData.append('guidance', section.guidance || '');
                    // Simplified: not handling custom files per batch run in this loop easily without complex logic
                    // Assuming basic generation based on RFP and Section Title/Guidance

                    // Add section-specific attachments
                    attachments.forEach(file => {
                        formData.append('files', file);
                    });
                    
                    // Call the API
                    const response = await fetch(`/api/proposal-section/${bidId}/generate`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (!response.ok || !data.success) {
                        throw new Error(data.message || 'Generation failed');
                    }

                    // Update section model
                    section.content = Array.isArray(data.content) ? data.content : [data.content];
                    section.rawContent = data.raw || data.content.join('\n\n');
                    section.status = 'Draft'; // Will be set to Saved by the caller

                    // Update UI if it's still the active section
                    if (activeSectionId === section.id) {
                        // Update display
                        if (sectionContentDisplay) {
                            sectionContentDisplay.innerHTML = '';
                            section.content.forEach((paragraph, idx) => {
                                const p = document.createElement('p');
                                p.textContent = paragraph;
                                p.dataset.index = idx;
                                sectionContentDisplay.appendChild(p);
                            });
                        }
                        if (sectionFlagsDisplay) {
                             // Render flags if any (omitted for brevity in batch mode, can be added if needed)
                             sectionFlagsDisplay.classList.add('hidden'); 
                        }
                    }
                    resolve();

                } catch (e) {
                    console.error(`Failed to generate section ${section.title}`, e);
                    // We resolve anyway to continue to next section, but log error
                    if (document.getElementById('sectionContentDisplay')) {
                        document.getElementById('sectionContentDisplay').innerHTML = `
                            <div class="p-4 bg-red-50 text-red-600 rounded-lg text-sm">
                                <p><strong>Generation Failed:</strong> ${e.message}</p>
                            </div>
                        `;
                    }
                    resolve(); 
                }
             });
        }

        async function performQuickSave(sectionId) {
             // Logic extracted from quickSaveBtn event listener
            const section = defaultSections.find(sec => sec.id === sectionId);
            if (!section) return;

            // Upload pending images if any (skipping for batch usually, but good to have)
            try {
                await uploadPendingAttachmentsForSection(sectionId);
                // try { await refreshSectionAttachments(); } catch (_) {}
            } catch (e) {
                console.error('Pending image upload failed on auto-save:', e);
            }
            
            section.status = 'Saved';
            persistSectionsToStorage();
            // UI updates are done by the loop calling renderSectionList()
        }

        // Sub-category dropdown change handler
        const subCategorySelect = document.getElementById('subCategorySelect');
        const analyzeSubCategoryBtn = document.getElementById('analyzeSubCategoryBtn');
        const subCategoryAnalyzing = document.getElementById('subCategoryAnalyzing');
        const subCategoryContentDisplay = document.getElementById('subCategoryContentDisplay');
        const subCategoryTitleDisplay = document.getElementById('subCategoryTitleDisplay');
        const subCategoryContentText = document.getElementById('subCategoryContentText');

        subCategorySelect?.addEventListener('change', (e) => {
            const selectedValue = e.target.value;
            if (analyzeSubCategoryBtn) {
                analyzeSubCategoryBtn.disabled = !selectedValue;
            }
            if (!selectedValue && subCategoryContentDisplay) {
                subCategoryContentDisplay.classList.add('hidden');
            }
        });

        // Analyze sub-category with AI
        analyzeSubCategoryBtn?.addEventListener('click', async () => {
            const selectedOption = subCategorySelect?.options[subCategorySelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                alert('Please select a sub-category first.');
                return;
            }

            const section = defaultSections.find(sec => sec.id === activeSectionId);
            if (!section) {
                alert('No section selected.');
                return;
            }

            const subcategoryId = selectedOption.value;
            const subcategoryTitle = selectedOption.dataset.subcategoryTitle || selectedOption.textContent;
            const bidId = getActiveBidId();

            // Show loading state
            if (analyzeSubCategoryBtn) {
                analyzeSubCategoryBtn.disabled = true;
            }
            if (subCategoryAnalyzing) {
                subCategoryAnalyzing.classList.remove('hidden');
            }

            try {
                const response = await fetch('/api/analyze-subcategory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section_id: section.id,
                        subcategory_id: subcategoryId,
                        subcategory_title: subcategoryTitle,
                        bid_id: bidId
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to analyze sub-category');
                }

                // Display the analyzed content
                if (subCategoryTitleDisplay) {
                    subCategoryTitleDisplay.textContent = subcategoryTitle;
                }
                if (subCategoryContentText) {
                    // Format the content - preserve line breaks
                    const formattedContent = data.content
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0)
                        .map(line => `<p>${escapeHtml(line)}</p>`)
                        .join('');
                    subCategoryContentText.innerHTML = formattedContent || '<p class="text-gray-500 italic">No content generated.</p>';
                }
                if (subCategoryContentDisplay) {
                    subCategoryContentDisplay.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error analyzing sub-category:', error);
                alert(`Error analyzing sub-category: ${error.message}`);
            } finally {
                // Hide loading state
                if (analyzeSubCategoryBtn) {
                    analyzeSubCategoryBtn.disabled = false;
                }
                if (subCategoryAnalyzing) {
                    subCategoryAnalyzing.classList.add('hidden');
                }
            }
        });

        if (rfpFolderInput) {
            rfpFolderInput.addEventListener('change', (event) => {
                const count = event.target.files.length;
                if (!count) {
                    selectedRfpLabel.textContent = 'No RFP attached';
                    rfpUploadLabel.textContent = 'Drop or browse PDFs';
                } else if (count === 1) {
                    selectedRfpLabel.textContent = event.target.files[0].name;
                    rfpUploadLabel.textContent = event.target.files[0].name;
                } else {
                    selectedRfpLabel.textContent = `${count} RFP documents attached`;
                    rfpUploadLabel.textContent = `${count} files ready`;
                }
            });
        }

        generateProposalBtn?.addEventListener('click', () => {
            // Check if any sections have generated content
            const sectionsPayload = collectSectionsPayload();
            if (sectionsPayload.length > 0) {
                // Save all sections to storage before compiling
                persistSectionsToStorage();
                compileProposalFromSections();
                return;
            }

            // Fallback to old RFP upload flow if no sections have content
            if (!uploadForm) return;
            if (!rfpFolderInput || rfpFolderInput.files.length === 0) {
                alert('Generate content for at least one section before creating a proposal, or attach an RFP PDF file.');
                return;
            }

            processingStatus.classList.remove('hidden');
            statusContent.innerHTML = `
                <div class="rounded-lg bg-cyan-100 px-4 py-2 flex items-center gap-3">
                    <i class="fas fa-file-import text-cyan-700"></i>
                    <span>Importing ${rfpFolderInput.files.length} RFP file(s) and mapping required sections...</span>
                </div>
                <div class="rounded-lg bg-cyan-100 px-4 py-2 flex items-center gap-3">
                    <i class="fas fa-robot text-cyan-700"></i>
                    <span>Generating draft narrative and compliance checklist.</span>
                </div>
            `;
            hiddenSubmit?.click();
        });

        function renderInitial() {
            renderSectionList();
            renderActiveSection();
            ensureSortable();

            // Auto-load RFP files from database if available
            if (rfpSectionEl && rfpSectionEl.dataset.bidId && rfpSectionEl.dataset.api) {
                // Load RFP preview automatically
                fetchRfpPages(1, RFP_PAGE_BATCH, false);
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.section-dropdown-btn') && !e.target.closest('[id^="dropdown-"]')) {
                    closeAllDropdowns();
                }
            });
        }

        hydrateSectionsFromStorage();
        renderInitial();
        updateEvaluateBtnState();

        let finalProposalSaveTimer = null;
        let finalProposalSaveInFlight = false;
        let lastSavedProposalHtml = '';

        function getFinalProposalHtmlForSave() {
            if (!finalProposalContent) return '';
            return finalProposalContent.innerHTML || '';
        }

        async function saveFinalProposalPreview(force) {
            if (!finalProposalContent || !finalProposalDownloadBtn) return false;
            const filename = finalProposalDownloadBtn.dataset.filename || '';
            if (!filename) return false;
            const sectionsPayload = collectSectionsPayload();
            const bidId = getActiveBidId();
            const html = getFinalProposalHtmlForSave();
            if (!force && html === lastSavedProposalHtml) return true;
            if (finalProposalSaveInFlight) return true;
            finalProposalSaveInFlight = true;
            try {
                const response = await fetch('/api/save-proposal-preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        filename,
                        html,
                        company: (companySelect && companySelect.value) ? companySelect.value : '',
                        bid_id: bidId,
                        sections: sectionsPayload
                    }),
                });
                const contentType = response.headers.get('content-type') || '';
                const data = contentType.includes('application/json') ? await response.json() : {};
                if (!response.ok) {
                    throw new Error(data.message || 'Unable to save the proposal preview.');
                }
                lastSavedProposalHtml = html;
                if (data.download_url && finalProposalDownloadBtn) {
                    finalProposalDownloadBtn.dataset.downloadHref = data.download_url;
                }
                setFinalProposalStatus('Preview saved. Ready to download.');
                return true;
            } catch (error) {
                console.error('Failed to save proposal preview:', error);
                setFinalProposalStatus('Unable to save preview. Please try again.');
                return false;
            } finally {
                finalProposalSaveInFlight = false;
            }
        }

        function scheduleFinalProposalAutosave() {
            if (!finalProposalContent || !finalProposalDownloadBtn?.dataset.filename) return;
            if (finalProposalSaveTimer) {
                clearTimeout(finalProposalSaveTimer);
            }
            finalProposalSaveTimer = setTimeout(() => {
                saveFinalProposalPreview(false);
            }, 1200);
        }

        finalProposalContent?.addEventListener('input', () => {
            setFinalProposalStatus('Saving preview...');
            scheduleFinalProposalAutosave();
        });

        finalProposalSaveBtn?.addEventListener('click', async () => {
            setFinalProposalStatus('Saving preview...');
            await saveFinalProposalPreview(true);
        });

        finalProposalDownloadBtn?.addEventListener('click', async () => {
            const href = finalProposalDownloadBtn.dataset.downloadHref;
            const missing = getMissingRequiredSections();
            if (!href) {
                alert('Generate the proposal first to enable downloads.');
                return;
            }
            if (missing.length > 0) {
                const list = missing.map(s => `• ${s.title}`).slice(0, 10).join('\n');
                alert(`Please complete and save all required sections before downloading:\n\n${list}${missing.length > 10 ? '\n…' : ''}`);
                return;
            }
            await saveFinalProposalPreview(true);
            window.open(finalProposalDownloadBtn.dataset.downloadHref || href, '_blank');
        });

        function ensureFinalProposalEditable() {
            if (!finalProposalContent) return;
            if (!finalProposalEditable && finalProposalEditBtn) {
                try { finalProposalEditBtn.click(); } catch (_) { }
                return;
            }
            if (!finalProposalContent.hasAttribute('contenteditable')) {
                finalProposalContent.setAttribute('contenteditable', 'true');
                finalProposalContent.classList.add('ring', 'ring-emerald-300');
            }
        }

        function execEditorCommand(cmd, value) {
            if (!finalProposalContent) return;
            ensureFinalProposalEditable();
            finalProposalContent.focus();
            document.execCommand(cmd, false, value);
            updateUndoBtnState();
            scheduleFinalProposalAutosave();
        }

        function applyEditorBlock(tag) {
            const safeTag = tag.startsWith('<') ? tag : `<${tag}>`;
            execEditorCommand('formatBlock', safeTag);
        }

        finalProposalFormat?.addEventListener('change', (event) => {
            const target = event.target;
            if (target && target.value) {
                applyEditorBlock(target.value);
            }
        });

        finalProposalFont?.addEventListener('change', (event) => {
            const target = event.target;
            if (target && target.value) {
                execEditorCommand('fontName', target.value);
            }
        });

        finalProposalFontSize?.addEventListener('change', (event) => {
            const target = event.target;
            if (target && target.value) {
                execEditorCommand('fontSize', target.value);
            }
        });

        document.querySelectorAll('[data-editor-cmd]').forEach((btn) => {
            btn.addEventListener('click', () => {
                const cmd = btn.getAttribute('data-editor-cmd');
                if (cmd) {
                    execEditorCommand(cmd);
                }
            });
        });

        document.querySelectorAll('[data-editor-block]').forEach((btn) => {
            btn.addEventListener('click', () => {
                const tag = btn.getAttribute('data-editor-block');
                if (tag) {
                    applyEditorBlock(tag);
                }
            });
        });

        finalProposalInsertTable?.addEventListener('click', () => {
            ensureFinalProposalEditable();
            const rows = parseInt(prompt('Rows?', '2') || '', 10);
            const cols = parseInt(prompt('Columns?', '2') || '', 10);
            if (!rows || !cols || rows < 1 || cols < 1) return;
            let html = '<table><tbody>';
            for (let r = 0; r < rows; r += 1) {
                html += '<tr>';
                for (let c = 0; c < cols; c += 1) {
                    html += '<td>&nbsp;</td>';
                }
                html += '</tr>';
            }
            html += '</tbody></table>';
            execEditorCommand('insertHTML', html);
        });

        finalProposalInsertImage?.addEventListener('click', () => {
            finalProposalImageInput?.click();
        });

        finalProposalInsertLink?.addEventListener('click', () => {
            ensureFinalProposalEditable();
            const url = prompt('Enter link URL');
            if (!url) return;
            const selection = window.getSelection();
            if (selection && selection.toString()) {
                execEditorCommand('createLink', url);
                return;
            }
            const text = prompt('Link text') || url;
            const html = `<a href="${url}" target="_blank" rel="noopener noreferrer">${text}</a>`;
            execEditorCommand('insertHTML', html);
        });

        finalProposalImageInput?.addEventListener('change', () => {
            const file = finalProposalImageInput.files && finalProposalImageInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                const dataUrl = reader.result;
                if (typeof dataUrl === 'string') {
                    execEditorCommand('insertImage', dataUrl);
                }
                finalProposalImageInput.value = '';
            };
            reader.readAsDataURL(file);
        });

        function setFinalProposalZoom(scale) {
            if (!finalProposalContent) return;
            const numeric = Number(scale) || 1;
            finalProposalContent.style.transform = `scale(${numeric})`;
        }

        finalProposalZoom?.addEventListener('change', (event) => {
            const target = event.target;
            if (target && target.value) {
                setFinalProposalZoom(target.value);
            }
        });

        finalProposalFullscreenBtn?.addEventListener('click', () => {
            const shell = finalProposalEditorShell || finalProposalFrame?.parentElement;
            if (!shell) return;
            shell.classList.toggle('proposal-fullscreen');
        });

        finalProposalClearBtn?.addEventListener('click', () => {
            if (!finalProposalContent) return;
            if (!confirm('Clear the entire proposal draft?')) return;
            finalProposalContent.innerHTML = '<p><br></p>';
            finalProposalPages = Array.from(finalProposalContent.querySelectorAll('.proposal-page'));
            if (finalProposalPages.length === 0) {
                finalProposalPages = [finalProposalContent.firstElementChild || finalProposalContent];
            }
            finalProposalTotalPages = Math.max(1, finalProposalPages.length);
            finalProposalCurrentPage = 0;
            updateFinalProposalPaginatorUI();
            scheduleFinalProposalAutosave();
        });

        finalProposalEditBtn?.addEventListener('click', () => {
            finalProposalEditable = !finalProposalEditable;
            if (finalProposalContent) {
                if (finalProposalEditable) {
                    finalProposalContent.setAttribute('contenteditable', 'true');
                    finalProposalContent.classList.add('ring', 'ring-emerald-300');
                } else {
                    finalProposalContent.removeAttribute('contenteditable');
                    finalProposalContent.classList.remove('ring', 'ring-emerald-300');
                }
            }
            if (finalProposalEditBtn) {
                finalProposalEditBtn.classList.toggle('btn-secondary', finalProposalEditable);
                const label = finalProposalEditBtn.querySelector('span');
                if (label) {
                    label.textContent = finalProposalEditable ? 'Lock Preview' : 'Edit Preview';
                }
            }
            // Make sure Undo button exists in the header
            ensureFinalProposalUndoBtn();
            updateUndoBtnState();
        });


        finalProposalPrevBtn?.addEventListener('click', () => {
            if (finalProposalPages.length > 0) {
                if (finalProposalCurrentPage <= 0) return;
                finalProposalPages[finalProposalCurrentPage].classList.add('hidden');
                finalProposalCurrentPage -= 1;
                finalProposalPages[finalProposalCurrentPage].classList.remove('hidden');
                updateFinalProposalPaginatorUI();
            } else if (finalProposalFrame) {
                if (finalProposalCurrentPage <= 0) return;
                finalProposalCurrentPage -= 1;
                finalProposalFrame.scrollTo({ top: finalProposalPageHeight * finalProposalCurrentPage, behavior: 'smooth' });
                updateFinalProposalPaginatorUI();
            }
        });

        finalProposalNextBtn?.addEventListener('click', () => {
            if (finalProposalPages.length > 0) {
                if (finalProposalCurrentPage >= (finalProposalTotalPages - 1)) return;
                finalProposalPages[finalProposalCurrentPage].classList.add('hidden');
                finalProposalCurrentPage += 1;
                finalProposalPages[finalProposalCurrentPage].classList.remove('hidden');
                updateFinalProposalPaginatorUI();
            } else if (finalProposalFrame) {
                if (finalProposalCurrentPage >= (finalProposalTotalPages - 1)) return;
                finalProposalCurrentPage += 1;
                finalProposalFrame.scrollTo({ top: finalProposalPageHeight * finalProposalCurrentPage, behavior: 'smooth' });
                updateFinalProposalPaginatorUI();
            }
        });

        // --- Drag selected text from preview into AI Agent input ---
        let selectionDragChip = null;

        function removeSelectionChip() {
            if (selectionDragChip && selectionDragChip.parentNode) {
                selectionDragChip.parentNode.removeChild(selectionDragChip);
            }
            selectionDragChip = null;
        }

        function ensureSelectionChip() {
            if (selectionDragChip) return selectionDragChip;
            const chip = document.createElement('div');
            chip.id = 'selectionDragChip';
            chip.draggable = true;
            chip.className = 'fixed z-50 select-none cursor-grab active:cursor-grabbing';
            chip.innerHTML = `
                <div class="rounded-full bg-emerald-600 text-white text-xs px-3 py-1 shadow-lg flex items-center gap-1">
                    <i class="fas fa-comments"></i>
                    <span>Ask AI</span>
                </div>
            `;
            document.body.appendChild(chip);
            selectionDragChip = chip;
            return chip;
        }

        function getSelectedTextWithin(el) {
            const sel = window.getSelection();
            if (!sel || sel.rangeCount === 0) return '';
            const range = sel.getRangeAt(0);
            if (!el.contains(range.commonAncestorContainer)) return '';
            return sel.toString() || '';
        }

        function insertTextIntoGeneralQueryInput(text) {
            if (!generalQueryInput) return;
            const snippet = (text || '').trim();
            if (!snippet) return;
            const prefix = generalQueryInput.value.trim() ? '\n\n' : '';
            const toInsert = `${prefix}"${snippet}"\n\nQuestion: `;
            generalQueryInput.value += toInsert;
            // Trigger auto-resize and keep UX consistent
            generalQueryInput.dispatchEvent(new Event('input'));
            generalQueryInput.focus();
            const len = generalQueryInput.value.length;
            try {
                generalQueryInput.setSelectionRange(len, len);
            } catch (_) { }
        }

        function positionChipNearSelection(chip) {
            const sel = window.getSelection();
            if (!sel || sel.rangeCount === 0) return;
            const rect = sel.getRangeAt(0).getBoundingClientRect();
            const top = Math.max(8, rect.top + window.scrollY - 36);
            const left = Math.min(window.innerWidth - 120, rect.right + window.scrollX + 8);
            chip.style.top = `${top}px`;
            chip.style.left = `${left}px`;
        }

        // Show chip when user selects text inside the final preview
        document.addEventListener('selectionchange', () => {
            if (!finalProposalContent) return;
            const selected = getSelectedTextWithin(finalProposalContent);
            if (selected && selected.length > 2) {
                const chip = ensureSelectionChip();
                positionChipNearSelection(chip);
                chip.ondragstart = (e) => {
                    e.dataTransfer?.setData('text/plain', selected);
                    // Provide a subtle drag image
                    try {
                        const img = document.createElement('canvas');
                        img.width = 1; img.height = 1;
                        e.dataTransfer.setDragImage(img, 0, 0);
                    } catch (_) { }
                };
                chip.onclick = () => insertTextIntoGeneralQueryInput(selected);
            } else {
                removeSelectionChip();
            }
        });

        // Accept drops on the AI input area
        if (generalQueryInput) {
            const dropTargets = [generalQueryInput, generalQueryForm];
            dropTargets.forEach((target) => {
                if (!target) return;
                target.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                target.addEventListener('drop', (e) => {
                    e.preventDefault();
                    let text = '';
                    if (e.dataTransfer) {
                        text = e.dataTransfer.getData('text/plain') || '';
                    }
                    if (!text) {
                        text = getSelectedTextWithin(finalProposalContent);
                    }
                    insertTextIntoGeneralQueryInput(text);
                    removeSelectionChip();
                });
            });
        }

        // Load saved requirements from localStorage on page load
        loadRequirementsFromStorage();

        renderGeneralQueryChat();

        generalQueryForm?.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!generalQueryInput) {
                return;
            }

            const message = generalQueryInput.value.trim();
            if (!message) {
                generalQueryInput.focus();
                return;
            }

            const previousHistory = generalQueryHistory.slice(-10).map((entry) => ({
                role: entry.role,
                content: entry.content,
            }));

            generalQueryHistory.push({ role: 'user', content: message });
            if (generalQueryHistory.length > 20) {
                generalQueryHistory = generalQueryHistory.slice(-20);
            }

            generalQueryInput.value = '';
            generalQueryInput.setAttribute('disabled', 'disabled');
            const submitBtn = generalQueryForm.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-70', 'cursor-not-allowed');
            }

            renderGeneralQueryChat(GENERAL_AGENT_STATUS_TEXT);

            try {
                const response = await fetch('/api/proposals-agent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message,
                        history: previousHistory,
                        context: proposalContext || {},
                    }),
                });

                let payload = null;
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    payload = await response.json();
                } else {
                    const text = await response.text();
                    payload = { error: text || 'Unexpected response format.' };
                }

                if (!response.ok || (payload && payload.error)) {
                    const errorMessage = payload?.message || payload?.error || 'Unable to get agent response.';
                    throw new Error(errorMessage);
                }

                const reply = (payload && payload.reply ? String(payload.reply) : '').trim();
                generalQueryHistory.push({
                    role: 'assistant',
                    content: reply || 'I was unable to craft a response. Please try asking again with more detail.',
                });
            } catch (error) {
                generalQueryHistory.push({
                    role: 'assistant',
                    content: `Unable to complete your request: ${error?.message || error}`,
                });
            } finally {
                if (generalQueryHistory.length > 20) {
                    generalQueryHistory = generalQueryHistory.slice(-20);
                }

                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
                generalQueryInput.removeAttribute('disabled');
                renderGeneralQueryChat();
                generalQueryInput.focus();
            }
        });

        // Auto-resize textarea
        if (generalQueryInput) {
            // Auto-resize on input
            generalQueryInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 128) + 'px'; // Max height ~32px * 4 rows
            });

            // Handle Enter key (submit on Enter, new line on Shift+Enter)
            generalQueryInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (generalQueryForm) {
                        generalQueryForm.dispatchEvent(new Event('submit'));
                    }
                }
            });
        }

        // Initialize chat on page load
        renderGeneralQueryChat();

        function refreshProposals() {
            fetch('{{ url_for("proposals_making") }}?refresh=1')
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('proposalsList');
                    if (!list) return;
                    if (data.proposals && data.proposals.length > 0) {
                        list.innerHTML = data.proposals.map(p => `
                            <article class="rounded-xl border border-gray-200 px-4 py-4 hover:border-emerald-200 hover:shadow-sm transition card-hover">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">${p.name || 'Proposal'}</h4>
                                        <div class="mt-2 flex flex-wrap gap-x-6 gap-y-1 text-sm text-gray-600">
                                            <span class="flex items-center gap-2"><i class="fas fa-file-pdf text-red-500"></i>${p.rfp_name || '—'}</span>
                                            <span class="flex items-center gap-2"><i class="fas fa-building text-gray-400"></i>${p.company || 'N/A'}</span>
                                            <span class="flex items-center gap-2"><i class="fas fa-clock text-gray-400"></i>${p.created_at || 'N/A'}</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <a href="${p.download_url || '#'}" class="btn-primary inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-white">
                                            <i class="fas fa-download"></i>
                                            Download
                                        </a>
                                    </div>
                                </div>
                            </article>
                        `).join('');
                    } else {
                        list.innerHTML = '<p class="text-center text-gray-500">No proposals generated yet.</p>';
                    }
                })
                .catch(err => {
                    console.error('Error refreshing proposals:', err);
                });
        }

        // Requirements and Attachments handlers
        const analyzeRequirementsBtn = document.getElementById('analyzeRequirementsBtn');
        const requirementsAnalyzing = document.getElementById('requirementsAnalyzing');
        const requirementsDisplay = document.getElementById('requirementsDisplay');
        const requirementsItemsList = document.getElementById('requirementsItemsList');
        let requirementsData = [];

        // Get localStorage key for requirements based on bid ID
        function getRequirementsStorageKey() {
            const bidId = getActiveBidId();
            return bidId ? `requirements_data_${bidId}` : 'requirements_data_default';
        }

        // Save requirements to localStorage
        function saveRequirementsToStorage() {
            try {
                const storageKey = getRequirementsStorageKey();
                // Create a serializable copy without File objects
                const serializableData = requirementsData.map(categoryData => ({
                    category: categoryData.category,
                    items: categoryData.items ? categoryData.items.map(item => ({
                        id: item.id,
                        text: item.text,
                        category: item.category,
                        attachments: item.attachments ? item.attachments.map(att => ({
                            name: att.name,
                            size: att.size,
                            validating: att.validating || false,
                            validated: att.validated,
                            validationError: att.validationError
                            // Note: File object is not stored, only metadata
                        })) : []
                    })) : []
                }));
                localStorage.setItem(storageKey, JSON.stringify(serializableData));
            } catch (error) {
                console.error('Error saving requirements to localStorage:', error);
            }
        }

        // Load requirements from localStorage
        function loadRequirementsFromStorage() {
            try {
                const storageKey = getRequirementsStorageKey();
                const savedData = localStorage.getItem(storageKey);
                if (savedData) {
                    requirementsData = JSON.parse(savedData);
                    renderRequirementsItems();
                    if (requirementsDisplay && requirementsData.length > 0) {
                        requirementsDisplay.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading requirements from localStorage:', error);
            }
        }

        // Clear requirements from localStorage
        function clearRequirementsStorage() {
            try {
                const storageKey = getRequirementsStorageKey();
                localStorage.removeItem(storageKey);
            } catch (error) {
                console.error('Error clearing requirements from localStorage:', error);
            }
        }

        analyzeRequirementsBtn?.addEventListener('click', async () => {
            const bidId = getActiveBidId();
            if (!bidId) {
                alert('Please select a bid/project first to analyze its RFP.');
                return;
            }

            // Clear existing requirements when starting new analysis
            clearRequirementsStorage();
            requirementsData = [];

            if (analyzeRequirementsBtn) {
                analyzeRequirementsBtn.disabled = true;
            }
            if (requirementsAnalyzing) {
                requirementsAnalyzing.classList.remove('hidden');
            }
            if (requirementsDisplay) {
                requirementsDisplay.classList.add('hidden');
            }

            try {
                const response = await fetch('/api/analyze-requirements-attachments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        bid_id: bidId,
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to analyze requirements and attachments.');
                }

                const outputText = (data.output || data.requirements || '').trim();

                // Parse requirements into individual items
                requirementsData = parseRequirements(outputText);

                // Save to localStorage
                saveRequirementsToStorage();

                // Render individual requirement items
                renderRequirementsItems();

                if (requirementsDisplay) {
                    requirementsDisplay.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error analyzing requirements:', error);
                alert(`Unable to analyze RFP requirements: ${error.message || error}`);
            } finally {
                if (requirementsAnalyzing) {
                    requirementsAnalyzing.classList.add('hidden');
                }
                if (analyzeRequirementsBtn) {
                    analyzeRequirementsBtn.disabled = false;
                }
            }
        });

        // Parse requirements text into individual items
        function parseRequirements(text) {
            if (!text) return [];

            const items = [];
            const lines = text.split('\n');
            let currentCategory = '';
            let currentItems = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Skip ending messages
                if (line.includes('These are the mandatory attachments') ||
                    line.includes('explicitly required for bid submission') ||
                    line.includes('No specific attachments or mandatory bid documents')) {
                    continue;
                }

                // Check if it's a category heading (starts with emoji or **)
                if (line.match(/^[📎📋✅🎯📝💼🔒💡🗓️📑]/) || line.match(/^\*\*[^*]+\*\*/)) {
                    // Save previous category items
                    if (currentCategory && currentItems.length > 0) {
                        items.push({
                            category: currentCategory,
                            items: [...currentItems]
                        });
                        currentItems = [];
                    }
                    // Extract category name (remove emoji and markdown)
                    currentCategory = line
                        .replace(/^[📎📋✅🎯📝💼🔒💡🗓️📑]\s*/, '')
                        .replace(/\*\*/g, '')
                        .trim();
                    // Default to "Mandatory Attachments & Documents" if it's the main heading
                    if (line.includes('Mandatory Attachments') || line.includes('Mandatory')) {
                        currentCategory = 'Mandatory Attachments & Documents';
                    }
                }
                // Check if it's a bullet point or list item
                else if (line.match(/^[-•*]\s+/) || line.match(/^\d+[.)]\s+/)) {
                    const itemText = line
                        .replace(/^[-•*]\s+/, '')
                        .replace(/^\d+[.)]\s+/, '')
                        .trim();
                    if (itemText) {
                        currentItems.push({
                            id: `req-${items.length}-${currentItems.length}`,
                            text: itemText,
                            category: currentCategory || 'Mandatory Attachments & Documents',
                            attachments: []
                        });
                    }
                }
                // Check if it's a regular text line (might be continuation or standalone requirement)
                else if (line.length > 20 && !line.match(/^[|]/)) {
                    // Treat as standalone requirement if it looks like one
                    if (line.match(/[A-Z][a-z]+/) || line.match(/certificate|license|form|document|attachment/i)) {
                        currentItems.push({
                            id: `req-${items.length}-${currentItems.length}`,
                            text: line,
                            category: currentCategory || 'Mandatory Attachments & Documents',
                            attachments: []
                        });
                    }
                }
            }

            // Save last category
            if (currentCategory && currentItems.length > 0) {
                items.push({
                    category: currentCategory,
                    items: [...currentItems]
                });
            }

            // If no categories found, treat each bullet as individual item
            if (items.length === 0) {
                const allItems = [];
                lines.forEach((line, idx) => {
                    const trimmed = line.trim();
                    if (trimmed && (trimmed.match(/^[-•*]\s+/) || trimmed.match(/^\d+[.)]\s+/) || trimmed.length > 20)) {
                        const itemText = trimmed
                            .replace(/^[-•*]\s+/, '')
                            .replace(/^\d+[.)]\s+/, '')
                            .trim();
                        if (itemText && itemText.length > 10) {
                            allItems.push({
                                id: `req-standalone-${idx}`,
                                text: itemText,
                                category: 'Mandatory Attachments & Documents',
                                attachments: []
                            });
                        }
                    }
                });
                if (allItems.length > 0) {
                    items.push({
                        category: 'Mandatory Attachments & Documents',
                        items: allItems
                    });
                }
            }

            return items;
        }

        // Render individual requirement items with attach buttons
        function renderRequirementsItems() {
            if (!requirementsItemsList) return;

            if (requirementsData.length === 0) {
                requirementsItemsList.innerHTML = '<p class="text-gray-500 italic text-sm">No requirements found in the RFP.</p>';
                return;
            }

            let html = '';
            requirementsData.forEach((categoryData) => {
                if (categoryData.items && categoryData.items.length > 0) {
                    // Category header
                    html += `
                        <div class="mb-4">
                            <h6 class="text-xs font-semibold uppercase tracking-wide text-gray-600 mb-2 flex items-center gap-2">
                                <i class="fas fa-paperclip text-gray-400"></i>
                                ${escapeHtml(categoryData.category)}
                            </h6>
                    `;

                    // Individual items
                    categoryData.items.forEach((item) => {
                        const attachments = item.attachments || [];
                        html += `
                            <div class="mb-3 rounded-lg border border-gray-200 bg-white p-3 shadow-sm">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm text-gray-700 leading-relaxed">${escapeHtml(item.text)}</p>
                                        ${attachments.length > 0 ? `
                                            <div class="mt-2 space-y-1">
                                                ${attachments.map((att, idx) => {
                            const sizeKB = (att.size / 1024).toFixed(1);
                            const isValid = att.validated === true;
                            const isValidating = att.validating === true;
                            const isInvalid = att.validated === false;
                            let statusClass = 'bg-gray-50';
                            let statusIcon = '<i class="fas fa-file text-gray-400"></i>';
                            let statusText = '';

                            if (isValidating) {
                                statusClass = 'bg-yellow-50 border border-yellow-200';
                                statusIcon = '<div class="h-3 w-3 border-2 border-yellow-400 border-t-yellow-600 rounded-full animate-spin"></div>';
                                statusText = '<span class="text-yellow-600 text-xs">Validating...</span>';
                            } else if (isValid) {
                                statusClass = 'bg-green-50 border border-green-200';
                                statusIcon = '<i class="fas fa-check-circle text-green-600"></i>';
                                statusText = '<span class="text-green-600 text-xs">Valid</span>';
                            } else if (isInvalid) {
                                statusClass = 'bg-red-50 border border-red-200';
                                statusIcon = '<i class="fas fa-times-circle text-red-600"></i>';
                                const errorMsg = att.validationError || 'Document does not match requirement';
                                statusText = `<span class="text-red-600 text-xs" title="${escapeHtml(errorMsg)}">Invalid: ${escapeHtml(errorMsg.length > 40 ? errorMsg.substring(0, 40) + '...' : errorMsg)}</span>`;
                            }

                            return `
                                                        <div class="flex items-center gap-2 text-xs text-gray-600 ${statusClass} px-2 py-1.5 rounded">
                                                            ${statusIcon}
                                                            <span class="truncate flex-1">${escapeHtml(att.name)}</span>
                                                            <span class="text-gray-400">(${sizeKB} KB)</span>
                                                            ${statusText}
                                                            <button onclick="removeRequirementAttachment('${item.id}', ${idx})" 
                                                                class="text-red-500 hover:text-red-700 ml-2" 
                                                                title="Remove">
                                                                <i class="fas fa-times text-xs"></i>
                                                            </button>
                                                        </div>
                                                    `;
                        }).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="flex-shrink-0 flex items-center gap-2">
                                        <input type="file" 
                                            id="file-input-${item.id}" 
                                            class="hidden" 
                                            multiple 
                                            accept=".pdf,.jpg,.jpeg"
                                            onchange="handleRequirementAttachment('${item.id}', this, '${escapeHtml(item.text)}')">
                                        <button onclick="document.getElementById('file-input-${item.id}').click()"
                                            class="btn-secondary inline-flex items-center gap-2 rounded-lg px-3 py-1.5 text-xs font-semibold text-white transition-all">
                                            <i class="fas fa-paperclip"></i>
                                            ${attachments.length > 0 ? 'Add More' : 'Attach'}
                                        </button>
                                        <button onclick="deleteRequirementItem('${item.id}')"
                                            class="inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs font-semibold text-red-600 hover:text-red-700 hover:bg-red-50 border border-red-200 hover:border-red-300 transition-all"
                                            title="Delete this requirement">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>Delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `</div>`;
                }
            });

            requirementsItemsList.innerHTML = html || '<p class="text-gray-500 italic text-sm">No requirements found.</p>';
        }

        // Handle attachment upload for a specific requirement
        window.handleRequirementAttachment = async function (requirementId, fileInput, requirementText) {
            const files = Array.from(fileInput.files || []);
            if (files.length === 0) return;

            // Find the requirement item
            let item = null;
            requirementsData.forEach((categoryData) => {
                if (categoryData.items) {
                    const found = categoryData.items.find(i => i.id === requirementId);
                    if (found) item = found;
                }
            });

            if (!item) return;

            // Validate and add files
            for (const file of files) {
                // Validate file type
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (!['pdf', 'jpg', 'jpeg'].includes(fileExtension)) {
                    alert(`File "${file.name}" is not a valid format. Only PDF and JPG files are allowed.`);
                    continue;
                }

                // Validate file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File "${file.name}" is too large. Maximum file size is 10MB.`);
                    continue;
                }

                if (!item.attachments) {
                    item.attachments = [];
                }

                // Add file with validating status
                const attachmentIndex = item.attachments.length;
                item.attachments.push({
                    name: file.name,
                    size: file.size,
                    file: file,
                    validating: true,
                    validated: null,
                    validationError: null
                });

                // Re-render to show validating state
                renderRequirementsItems();
                saveRequirementsToStorage();

                // Validate document content
                try {
                    const validationResult = await validateDocumentContent(file, requirementText);
                    item.attachments[attachmentIndex].validating = false;
                    item.attachments[attachmentIndex].validated = validationResult.is_valid;
                    if (!validationResult.is_valid) {
                        // Extract error message from validation result
                        const errorMsg = validationResult.validation_message || validationResult.message || 'Document does not match the required form type.';
                        // Remove "NO: " prefix if present
                        item.attachments[attachmentIndex].validationError = errorMsg.replace(/^NO:\s*/i, '').trim();
                    } else {
                        item.attachments[attachmentIndex].validationError = null;
                    }
                } catch (error) {
                    console.error('Validation error:', error);
                    item.attachments[attachmentIndex].validating = false;
                    item.attachments[attachmentIndex].validated = false;
                    item.attachments[attachmentIndex].validationError = error.message || 'Validation failed.';
                }

                // Re-render to show validation result
                renderRequirementsItems();
                saveRequirementsToStorage();
            }

            // Reset file input
            fileInput.value = '';
        };

        // Validate document content against requirement
        async function validateDocumentContent(file, requirementText) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('requirement_text', requirementText);

            try {
                const response = await fetch('/api/validate-requirement-attachment', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Validation failed');
                }

                return {
                    is_valid: data.is_valid === true,
                    validation_message: data.validation_message || '',
                    message: data.message || ''
                };
            } catch (error) {
                console.error('Validation API error:', error);
                throw error;
            }
        }

        // Remove attachment from a requirement
        window.removeRequirementAttachment = function (requirementId, attachmentIndex) {
            requirementsData.forEach((categoryData) => {
                if (categoryData.items) {
                    const item = categoryData.items.find(i => i.id === requirementId);
                    if (item && item.attachments) {
                        item.attachments.splice(attachmentIndex, 1);
                    }
                }
            });

            // Re-render and save
            renderRequirementsItems();
            saveRequirementsToStorage();
        };

        // Delete a requirement item completely
        window.deleteRequirementItem = function (requirementId) {
            if (!confirm('Are you sure you want to delete this requirement? This action cannot be undone.')) {
                return;
            }

            // Find and remove the item from requirementsData
            requirementsData.forEach((categoryData) => {
                if (categoryData.items) {
                    const itemIndex = categoryData.items.findIndex(i => i.id === requirementId);
                    if (itemIndex !== -1) {
                        categoryData.items.splice(itemIndex, 1);
                    }
                }
            });

            // Remove empty categories
            requirementsData = requirementsData.filter(categoryData => 
                categoryData.items && categoryData.items.length > 0
            );

            // Re-render and save
            renderRequirementsItems();
            saveRequirementsToStorage();
        };

        // ========== PDF.js Viewer and Editor ==========
        let pdfDoc = null;
        let pdfPageNum = 1;
        let pdfNumPages = 0;
        let pdfScale = 1.0;
        let pdfLibDoc = null;
        let pdfTextAnnotations = [];

        // Set up PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        const pdfCanvas = document.getElementById('pdfCanvas');
        const pdfViewerContainer = document.getElementById('pdfViewerContainer');
        const pdfLoadingIndicator = document.getElementById('pdfLoadingIndicator');
        const pdfErrorIndicator = document.getElementById('pdfErrorIndicator');
        const pdfEditorControls = document.getElementById('pdfEditorControls');
        const pdfPageInfo = document.getElementById('pdfPageInfo');
        const pdfPageInput = document.getElementById('pdfPageInput');
        const pdfZoomLevel = document.getElementById('pdfZoomLevel');
        const pdfPrevPage = document.getElementById('pdfPrevPage');
        const pdfNextPage = document.getElementById('pdfNextPage');
        const pdfGoToPage = document.getElementById('pdfGoToPage');
        const pdfZoomIn = document.getElementById('pdfZoomIn');
        const pdfZoomOut = document.getElementById('pdfZoomOut');
        const pdfAddText = document.getElementById('pdfAddText');
        const pdfExport = document.getElementById('pdfExport');

        async function loadPdfWithJs(url) {
            if (!pdfCanvas || !pdfViewerContainer) return;

            try {
                pdfLoadingIndicator.classList.remove('hidden');
                pdfErrorIndicator.classList.add('hidden');
                pdfEditorControls.classList.add('hidden');

                // Try to load PDF directly
                let loadingTask = pdfjsLib.getDocument(url);
                
                try {
                    pdfDoc = await loadingTask.promise;
                    pdfNumPages = pdfDoc.numPages;
                    pdfPageNum = 1;
                    pdfScale = 1.0;
                    
                    // Load with PDF-lib for editing
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    pdfLibDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                    
                    pdfTextAnnotations = [];
                    renderPdfPage();
                    pdfEditorControls.classList.remove('hidden');
                    pdfLoadingIndicator.classList.add('hidden');
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    // If PDF is encrypted, try to decrypt it via backend
                    if (error.message && (error.message.includes('encrypted') || error.message.includes('password'))) {
                        pdfErrorIndicator.classList.remove('hidden');
                        pdfLoadingIndicator.classList.add('hidden');
                        
                        // Attempt to decrypt via backend
                        const decryptUrl = `/api/rfp-file/decrypt?url=${encodeURIComponent(url)}`;
                        try {
                            const decryptResponse = await fetch(decryptUrl, { method: 'POST' });
                            if (decryptResponse.ok) {
                                const blob = await decryptResponse.blob();
                                const decryptedUrl = URL.createObjectURL(blob);
                                
                                loadingTask = pdfjsLib.getDocument(decryptedUrl);
                                pdfDoc = await loadingTask.promise;
                                pdfNumPages = pdfDoc.numPages;
                                pdfPageNum = 1;
                                
                                pdfLibDoc = await PDFLib.PDFDocument.load(await blob.arrayBuffer());
                                pdfTextAnnotations = [];
                                
                                renderPdfPage();
                                pdfEditorControls.classList.remove('hidden');
                                pdfErrorIndicator.classList.add('hidden');
                                pdfLoadingIndicator.classList.add('hidden');
                            } else {
                                throw new Error('Failed to decrypt PDF');
                            }
                        } catch (decryptError) {
                            console.error('Decryption failed:', decryptError);
                            pdfErrorIndicator.querySelector('p').textContent = 'PDF is encrypted and cannot be decrypted automatically.';
                        }
                    } else {
                        throw error;
                    }
                }
            } catch (error) {
                console.error('Failed to load PDF:', error);
                pdfLoadingIndicator.classList.add('hidden');
                pdfErrorIndicator.classList.remove('hidden');
                pdfErrorIndicator.querySelector('p').textContent = 'Failed to load PDF. Please try again.';
            }
        }

        async function renderPdfPage() {
            if (!pdfDoc || !pdfCanvas) return;

            try {
                const page = await pdfDoc.getPage(pdfPageNum);
                const viewport = page.getViewport({ scale: pdfScale });
                
                pdfCanvas.height = viewport.height;
                pdfCanvas.width = viewport.width;

                const renderContext = {
                    canvasContext: pdfCanvas.getContext('2d'),
                    viewport: viewport
                };

                await page.render(renderContext).promise;
                
                // Update UI
                if (pdfPageInfo) {
                    pdfPageInfo.textContent = `Page ${pdfPageNum} of ${pdfNumPages}`;
                }
                if (pdfPageInput) {
                    pdfPageInput.value = pdfPageNum;
                    pdfPageInput.max = pdfNumPages;
                }
                if (pdfZoomLevel) {
                    pdfZoomLevel.textContent = `${Math.round(pdfScale * 100)}%`;
                }
                
                // Re-render annotations
                renderAnnotations();
            } catch (error) {
                console.error('Error rendering PDF page:', error);
            }
        }

        // Event listeners for PDF controls
        pdfPrevPage?.addEventListener('click', () => {
            if (pdfPageNum <= 1) return;
            pdfPageNum--;
            renderPdfPage();
        });

        pdfNextPage?.addEventListener('click', () => {
            if (pdfPageNum >= pdfNumPages) return;
            pdfPageNum++;
            renderPdfPage();
        });

        pdfGoToPage?.addEventListener('click', () => {
            const pageNum = parseInt(pdfPageInput.value);
            if (pageNum >= 1 && pageNum <= pdfNumPages) {
                pdfPageNum = pageNum;
                renderPdfPage();
            }
        });

        pdfPageInput?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                pdfGoToPage.click();
            }
        });

        pdfZoomIn?.addEventListener('click', () => {
            pdfScale += 0.25;
            renderPdfPage();
        });

        pdfZoomOut?.addEventListener('click', () => {
            if (pdfScale > 0.25) {
                pdfScale -= 0.25;
                renderPdfPage();
            }
        });

        // --- Advanced Visual Editing Logic ---
        let pdfAnnotations = {}; // { pageNum: [ {text, x, y} ] }
        let isAddingText = false;
        const textOverlayLayer = document.getElementById('textOverlayLayer');

        pdfAddText?.addEventListener('click', () => {
            isAddingText = !isAddingText;
            if (isAddingText) {
                pdfAddText.classList.add('ring-2', 'ring-emerald-500');
                pdfCanvas.style.cursor = 'crosshair';
                if (textOverlayLayer) textOverlayLayer.style.pointerEvents = 'auto';
                alert('Click on the PDF to add a text box. You can drag and edit text boxes freely.');
            } else {
                pdfAddText.classList.remove('ring-2', 'ring-emerald-500');
                pdfCanvas.style.cursor = 'default';
                if (textOverlayLayer) textOverlayLayer.style.pointerEvents = 'none';
                renderAnnotations(); // Refresh to ensure correct pointer-events on children
            }
        });

        function getPdfCoordinates(clientX, clientY) {
            const rect = pdfCanvas.getBoundingClientRect();
            const canvasX = clientX - rect.left;
            const canvasY = clientY - rect.top;
            
            // PDF-lib (0,0 bottom-left)
            const pdfX = canvasX / pdfScale;
            const pdfY = (pdfCanvas.height - canvasY) / pdfScale;
            
            return { x: pdfX, y: pdfY };
        }

        function getCanvasCoordinates(pdfX, pdfY) {
            const canvasX = pdfX * pdfScale;
            const canvasY = pdfCanvas.height - (pdfY * pdfScale);
            return { x: canvasX, y: canvasY };
        }

        function renderAnnotations() {
            if (!textOverlayLayer) return;
            textOverlayLayer.innerHTML = '';
            
            // Allow clicking background only if adding text
            textOverlayLayer.style.pointerEvents = isAddingText ? 'auto' : 'none';

            const pageAnnos = pdfAnnotations[pdfPageNum - 1] || [];
            
            pageAnnos.forEach((anno, index) => {
                const coords = getCanvasCoordinates(anno.x, anno.y);
                
                const container = document.createElement('div');
                container.className = 'absolute flex items-center group';
                container.style.pointerEvents = 'auto'; // Always clickable
                
                // Position at bottom-left anchor
                container.style.left = coords.x + 'px';
                container.style.top = coords.y + 'px';
                container.style.transform = 'translateY(-100%)'; // Shift up so bottom aligns with Y
                
                const input = document.createElement('div');
                input.contentEditable = true;
                input.className = 'px-2 py-1 bg-white/90 border border-emerald-300 rounded hover:border-emerald-500 focus:border-emerald-600 focus:ring-1 focus:ring-emerald-500 outline-none text-black whitespace-nowrap shadow-sm min-w-[20px]';
                input.style.fontSize = (12 * pdfScale) + 'px';
                input.innerText = anno.text;
                input.title = "Click to edit text";
                
                // Input event
                input.addEventListener('input', (e) => {
                    anno.text = e.target.innerText;
                });
                
                // Prevent drag when editing text
                input.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });

                // Delete button
                const delBtn = document.createElement('button');
                delBtn.innerHTML = '<i class="fas fa-times"></i>';
                delBtn.className = 'absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-[10px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer shadow-sm z-10 hover:bg-red-600';
                delBtn.title = 'Remove text';
                delBtn.addEventListener('mousedown', (e) => {
                     e.stopPropagation(); // Prevent drag
                });
                delBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    pageAnnos.splice(index, 1);
                    renderAnnotations();
                });
                
                // Drag handle icon
                const dragHandle = document.createElement('div');
                dragHandle.className = 'absolute -left-4 top-1/2 -translate-y-1/2 text-gray-400 cursor-move opacity-0 group-hover:opacity-100 px-1 hover:text-emerald-600';
                dragHandle.innerHTML = '<i class="fas fa-grip-vertical text-sm"></i>';
                dragHandle.title = "Drag to move";
                dragHandle.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    startDrag(e, anno, container);
                });

                // Also allow dragging by holding the border area if not clicking input
                container.addEventListener('mousedown', (e) => {
                    if (e.target !== input && e.target !== delBtn) {
                        e.preventDefault();
                        startDrag(e, anno, container);
                    }
                });

                container.appendChild(dragHandle);
                container.appendChild(input);
                container.appendChild(delBtn);
                textOverlayLayer.appendChild(container);
            });
        }

        function startDrag(e, anno, el) {
            const startX = e.clientX;
            const startY = e.clientY;
            const startPdfX = anno.x;
            const startPdfY = anno.y;
            
            function onMouseMove(e) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                // Convert delta pixels to delta PDF units
                const dPdfX = dx / pdfScale;
                const dPdfY = -dy / pdfScale; // Y is inverted
                
                anno.x = startPdfX + dPdfX;
                anno.y = startPdfY + dPdfY;
                
                // Update UI immediately
                const newCoords = getCanvasCoordinates(anno.x, anno.y);
                el.style.left = newCoords.x + 'px';
                el.style.top = newCoords.y + 'px';
            }
            
            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        // Add text click handler (background)
        textOverlayLayer?.addEventListener('click', (e) => {
            if (!isAddingText) return;
            if (e.target !== textOverlayLayer) return; // Clicked on existing text
            
            const coords = getPdfCoordinates(e.clientX, e.clientY);
            
            if (!pdfAnnotations[pdfPageNum - 1]) {
                pdfAnnotations[pdfPageNum - 1] = [];
            }
            
            pdfAnnotations[pdfPageNum - 1].push({
                text: 'Double click to edit',
                x: coords.x,
                y: coords.y
            });
            
            renderAnnotations();
        });

        pdfExport?.addEventListener('click', async () => {
            if (!pdfLibDoc) {
                alert('No PDF loaded to export.');
                return;
            }

            const hasAnnotations = Object.keys(pdfAnnotations).some(k => pdfAnnotations[k].length > 0);
            if (!hasAnnotations && !confirm('No text changes detected. Export original PDF?')) return;
            if (hasAnnotations && !confirm('Burn text edits into PDF and export?')) return;

            try {
                // Clone the document so we don't burn into the view model (though we could)
                // Actually pdfLibDoc is the view model here.
                
                const pages = pdfLibDoc.getPages();
                
                for (const [pageNumStr, annos] of Object.entries(pdfAnnotations)) {
                    const pageIndex = parseInt(pageNumStr);
                    if (pageIndex >= pages.length) continue;
                    
                    const page = pages[pageIndex];
                    // const { height } = page.getSize(); // already used in coord calc
                    
                    for (const anno of annos) {
                        page.drawText(anno.text, {
                            x: anno.x,
                            y: anno.y, 
                            size: 12,
                            color: PDFLib.rgb(0, 0, 0),
                        });
                    }
                }

                const pdfBytes = await pdfLibDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                // Get the current bid ID for saving
                const rfpSectionEl = document.querySelector('[data-section="requirements"]');
                const gId = rfpSectionEl?.dataset.bidId;
                
                if (gId) {
                    // Save to server
                    const formData = new FormData();
                    formData.append('file', blob, 'edited_rfp.pdf');
                    
                    const saveResponse = await fetch(`/api/rfp-file/${gId}/save-edited`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (saveResponse.ok) {
                        const result = await saveResponse.json();
                        alert('PDF saved successfully!');
                        // Reload the PDF to show burnt-in changes and clear local annotations
                        pdfAnnotations = {};
                        renderAnnotations();
                        
                        if (rfpSectionEl.dataset.viewUrl) {
                            delete rfpSectionEl.dataset.pdfLoaded;
                            loadPdfWithJs(`${rfpSectionEl.dataset.viewUrl}?t=${Date.now()}`);
                        }
                    } else {
                        throw new Error('Failed to save PDF');
                    }
                } else {
                    // Download directly
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'edited_rfp.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('PDF exported successfully!');
                    
                    // Clear annotations as they are now in the PDF (if we reloaded, but we didn't)
                    // Users might want to keep editing.
                    // But if they export again, they will double burn.
                    // It's safer to clear or reload.
                    pdfAnnotations = {};
                    renderAnnotations();
                }
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Failed to export PDF. Please try again.');
            }
        });
    </script>
    <!-- Suggested Headers Modal -->
    <div id="headersModal" class="fixed inset-0 bg-black/50 hidden z-50">
        <div class="relative mx-auto mt-16 w-11/12 md:w-[32rem] bg-white rounded-lg shadow-xl">
            <div class="flex items-center justify-between border-b px-5 py-3">
                <h3 class="text-lg font-semibold text-gray-900">Suggested Headers</h3>
                <button id="headersModalClose" class="text-gray-500 hover:text-gray-700" title="Close">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div id="headersModalList" class="px-5 py-4 text-sm text-gray-800">
                <p class="text-gray-500">Analyzing RFP…</p>
            </div>
        </div>
    </div>

    <!-- Compact header at bottom -->
    <!-- <footer class="bg-white border-t border-gray-200 px-3 py-2">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 text-xs">
            <div class="flex flex-wrap items-center gap-1.5">
                <p class="text-[10px] uppercase tracking-wide text-emerald-600 font-semibold">Proposal workspace</p>
                <span class="text-gray-400">·</span>
                <h2 class="text-xs font-semibold text-gray-700">Cover Page and Offer or Information</h2>
                {% if bid_context %}
                <span class="text-gray-400">·</span>
                <div
                    class="inline-flex items-center gap-1 rounded-full border border-emerald-200 bg-emerald-50 px-1.5 py-0.5 text-[10px] text-emerald-700">
                    <i class="fas fa-diagram-project text-[9px]"></i>
                    <span>{{ bid_context.project_name }}</span>
                    {% if bid_context.bid_id %}
                    <span class="text-[9px] text-emerald-500 font-medium">ID {{ bid_context.bid_id }}</span>
                    {% endif %}
                </div>
                {% elif bid_id and bid_name %}
                <span class="text-gray-400">·</span>
                <div
                    class="inline-flex items-center gap-1 rounded-full border border-emerald-200 bg-emerald-50 px-1.5 py-0.5 text-[10px] text-emerald-700">
                    <i class="fas fa-info-circle text-[9px]"></i>
                    <span>{{ bid_name }}{% if bid_id %} · ID {{ bid_id }}{% endif %}</span>
                </div>
                {% endif %}
                {% if bid_context and bid_context.info_chips %}
                {% for chip in bid_context.info_chips %}
                <span class="text-gray-400">·</span>
                <div
                    class="inline-flex items-center gap-1 rounded-full border border-gray-200 bg-gray-50 px-1.5 py-0.5 text-[10px] text-gray-600">
                    <i class="fas fa-{{ chip.icon | default('circle-info') }} text-[9px] text-gray-400"></i>
                    <span class="font-medium text-gray-700">{{ chip.label }}:</span>
                    <span>{{ chip.value }}</span>
                </div>
                {% endfor %}
                {% endif %}
                {% if bid_context and bid_context.summary_excerpt %}
                <span class="text-gray-400">·</span>
                <p class="text-[10px] text-gray-500 max-w-md truncate">{{ bid_context.summary_excerpt }}</p>
                {% endif %}
                {% if contact_email %}
                <span class="text-gray-400">·</span>
                <p class="text-[10px] text-gray-400">Contact: {{ contact_email }}</p>
                {% endif %}
            </div>
            <div class="flex items-center gap-2">
                <div class="flex items-center gap-1 text-[10px] text-gray-500">
                    <i class="fas fa-file-pdf text-gray-400 text-[9px]"></i>
                    <span id="selectedRfpLabelBottom">
                        {% if bid_context and bid_context.rfp_label %}
                        {{ bid_context.rfp_label }}
                        {% else %}
                        No RFP attached
                        {% endif %}
                    </span>
                </div>
                <button id="generateProposalBtnBottom"
                    class="btn-primary inline-flex items-center gap-1 rounded px-2 py-1 text-[10px] text-white font-medium transition-all">
                    <i class="fas fa-wand-magic-sparkles text-[9px]"></i>
                    <span>Generate</span>
                </button>
            </div>
        </div>
    </footer> -->

</body>

</html>
