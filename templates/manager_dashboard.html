<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - ESCO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='light_theme_overrides.css') }}">
</head>
<body class="bg-gray-50 text-gray-800 with-fixed-sidebar">
    {% set topbar_title = 'Manager Dashboard' %}
    {% set topbar_subtitle = 'Open Bid Analyzer or review approvals' %}
    {% set topbar_right_html %}
        <div class="flex items-center gap-3">
            {% include '_bm_notification_bell.html' %}
            <div class="text-xs text-gray-500 whitespace-nowrap">
                <span class="px-2 py-1 bg-gray-100 rounded">Role: {{ (user_role or 'manager')|replace('_',' ')|title }}</span>
            </div>
        </div>
    {% endset %}
    <div class="flex h-screen">
        {% set sidebar_fixed = true %}
        {% include 'sidebar.html' %}

        <main class="ml-64 flex-1 p-8 overflow-y-auto">
            {% set overview_cards = overview_cards if overview_cards is defined else {} %}
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-7 gap-5">
                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-gray-500">Today's New Bids</div>
                            <div class="text-3xl font-semibold text-gray-900 mt-1">{{ overview_cards.get('new_bids_today', 0) }}</div>
                            <div class="text-xs text-gray-500 mt-1">Created today in Bid Incoming</div>
                        </div>
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-rose-100 text-rose-600">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-gray-500">Total Bid Incoming</div>
                            <div class="text-3xl font-semibold text-gray-900 mt-1">{{ overview_cards.get('total_bid_incoming', 0) }}</div>
                            <div class="text-xs text-gray-500 mt-1">All BIDs received</div>
                        </div>
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-emerald-100 text-emerald-600">
                            <i class="fas fa-inbox"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-gray-500">Pending Bids</div>
                            <div class="text-3xl font-semibold text-gray-900 mt-1">{{ overview_cards.get('pending_bids', 0) }}</div>
                            <div class="text-xs text-gray-500 mt-1">Awaiting action</div>
                        </div>
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-amber-100 text-amber-600">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-gray-500">Bids Submitted</div>
                            <div class="text-3xl font-semibold text-gray-900 mt-1">{{ overview_cards.get('bids_submitted', 0) }}</div>
                            <div class="text-xs text-gray-500 mt-1">Already submitted</div>
                        </div>
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-sky-100 text-sky-600">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-gray-500">Total Project</div>
                            <div class="text-3xl font-semibold text-gray-900 mt-1">{{ overview_cards.get('total_project', 0) }}</div>
                            <div class="text-xs text-gray-500 mt-1">All projects</div>
                        </div>
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-cyan-100 text-cyan-600">
                            <i class="fas fa-diagram-project"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-gray-500">Project In Progress</div>
                            <div class="text-3xl font-semibold text-gray-900 mt-1">{{ overview_cards.get('project_in_progress', 0) }}</div>
                            <div class="text-xs text-gray-500 mt-1">Ongoing</div>
                        </div>
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-violet-100 text-violet-600">
                            <i class="fas fa-spinner"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-gray-500">Project Completed</div>
                            <div class="text-3xl font-semibold text-gray-900 mt-1">{{ overview_cards.get('project_completed', 0) }}</div>
                            <div class="text-xs text-gray-500 mt-1">Finished</div>
                        </div>
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-emerald-100 text-emerald-600">
                            <i class="fas fa-circle-check"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 bg-white p-5 rounded-xl shadow-md border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="text-sm font-semibold text-gray-900">Bid Timeline</div>
                        <div class="text-xs text-gray-500">Working bids across all teams.</div>
                    </div>
                </div>
                <div class="space-y-4">
                    {% for item in bid_timeline_items %}
                    <div class="rounded-xl border border-gray-200 bg-white p-5 shadow-sm hover:shadow-md transition group border-l-4 border-l-emerald-300" data-bid-id="{{ item.g_id }}">
                        <div class="flex flex-wrap items-start justify-between gap-3">
                            <div>
                                <h4 class="text-base font-semibold text-gray-900">{{ item.b_name }}</h4>
                                <div class="text-xs text-gray-500 mt-1">{{ item.company or 'Company' }}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="px-3 py-1 text-xs font-semibold rounded-full border border-gray-200 bg-gray-50 text-gray-700">
                                    Due: {{ item.due_date or 'TBD' }}
                                </span>
                            </div>
                        </div>
                        <div class="mt-3 text-[11px] font-semibold text-gray-500 uppercase tracking-wide">Team Progress</div>
                        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                            {% for st in item.stages %}
                            {% if st.key not in ['analyzer','handover'] %}
                            <div class="rounded-lg border border-gray-200 bg-gray-50/60 p-3" data-stage-key="{{ st.key }}">
                                <div class="flex items-center justify-between text-[11px] font-semibold text-gray-700 mb-2">
                                    <span>{{ st.name }}</span>
                                    <span class="px-2 py-0.5 rounded-full bg-white border border-gray-200 text-gray-600" data-stage-pct>{{ st.progress }}%</span>
                                </div>
                                <div class="h-2 rounded-full bg-white border border-gray-200 overflow-hidden">
                                    <div class="h-full bg-emerald-500 transition-all" style="width: {{ st.progress }}%;" data-stage-bar></div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-2 opacity-50"></i>
                        <p>No active bids to display.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
        </main>
    </div>
    <script>
        (function () {
            const listEl = document.getElementById('managerNotifList');
            const markBtn = document.getElementById('managerNotifMarkAllBtn');
            const recentUrl = {{ url_for('api_notifications_recent')|tojson }};
            const markUrl = {{ url_for('api_notifications_mark_read')|tojson }};
            const csrfToken = {{ csrf_token()|tojson }};
            const categoryStyles = {
                approval: 'bg-rose-100 text-rose-700',
                error: 'bg-rose-100 text-rose-700',
                warning: 'bg-amber-100 text-amber-700',
                success: 'bg-emerald-100 text-emerald-700',
                info: 'bg-blue-100 text-blue-700',
            };

            function escapeHtml(value) {
                return String(value || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            function buildRowHtml(item) {
                const title = escapeHtml(item.title || 'Notification');
                const message = escapeHtml(item.message || '');
                const category = (item.category || 'info').toLowerCase();
                const badgeClass = categoryStyles[category] || categoryStyles.info;
                const ts = escapeHtml(item.created_at || '');
                const isRead = Boolean(item.is_read);
                const base = [
                    'block',
                    'rounded-2xl',
                    'border',
                    'px-4',
                    'py-3',
                    'transition',
                    'duration-150',
                    isRead ? 'bg-white border-gray-200' : 'bg-white border-blue-200 shadow-sm'
                ].join(' ');
                const badge = `<span class="px-2 py-0.5 text-[11px] font-semibold rounded-full ${badgeClass} uppercase tracking-wide">${escapeHtml(category)}</span>`;

                const messageHtml = message ? `<p class="text-xs text-gray-500 mt-2">${message}</p>` : '';
                const timestampHtml = ts ? `<p class="text-[11px] text-gray-400 mt-2">${ts}</p>` : '';
                const notifId = item.id ? escapeHtml(item.id) : '';
                const dataAttr = notifId ? ` data-notif-id="${notifId}"` : '';
                const link = item.link_url ? escapeHtml(item.link_url) : '';
                if (link) {
                    return `
                        <a class="${base}" href="${link}" target="_blank" rel="noreferrer noopener"${dataAttr}>
                            <div class="flex items-center justify-between gap-2">
                                <div class="${isRead ? 'text-gray-700' : 'text-gray-900'} text-sm font-semibold">${title}</div>
                                ${badge}
                            </div>
                            ${messageHtml}
                            ${timestampHtml}
                        </a>
                    `;
                }
                return `
                    <div class="${base}"${dataAttr}>
                        <div class="flex items-center justify-between gap-2">
                            <div class="${isRead ? 'text-gray-700' : 'text-gray-900'} text-sm font-semibold">${title}</div>
                            ${badge}
                        </div>
                        ${messageHtml}
                        ${timestampHtml}
                    </div>
                `;
            }

            function formatRecentUrl() {
                if (!recentUrl) {
                    return '';
                }
                const separator = recentUrl.includes('?') ? '&' : '?';
                return `${recentUrl}${separator}limit=6`;
            }

            async function loadNotifications() {
                if (!listEl) return;
                listEl.innerHTML = '<div class="text-sm text-gray-500 italic">Loading notifications...</div>';
                if (!recentUrl) {
                    listEl.innerHTML = '<div class="text-sm text-gray-500 italic">Notification service unavailable.</div>';
                    return;
                }
                try {
                    const res = await fetch(formatRecentUrl(), { cache: 'no-store' });
                    if (!res.ok) {
                        throw new Error('Failed to fetch notifications');
                    }
                    const data = await res.json();
                    const items = Array.isArray(data.items) ? data.items : [];
                    if (!items.length) {
                        listEl.innerHTML = '<div class="text-sm text-gray-500 italic">No notifications yet.</div>';
                        return;
                    }
                    listEl.innerHTML = items.map(buildRowHtml).join('');
                } catch (error) {
                    console.error('Manager notifications load error', error);
                    listEl.innerHTML = '<div class="text-sm text-red-500">Unable to load notifications.</div>';
                }
            }

            async function markAllRead() {
                if (!markUrl) return;
                try {
                    await fetch(markUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: [], _csrf_token: csrfToken })
                    });
                } catch (error) {
                    console.error('Manager notifications mark read failed', error);
                }
            }

            if (markBtn) {
                markBtn.addEventListener('click', async function (event) {
                    event.preventDefault();
                    markBtn.disabled = true;
                    await markAllRead();
                    await loadNotifications();
                    markBtn.disabled = false;
                });
            }

            loadNotifications();
            setInterval(loadNotifications, 45000);
        })();
        (function () {
            const cards = Array.from(document.querySelectorAll('[data-bid-id]'));
            if (!cards.length) return;
            const ids = cards.map(c => c.getAttribute('data-bid-id')).filter(Boolean);
            if (!ids.length) return;
            const url = `/api/bid-timeline/progress?ids=${encodeURIComponent(ids.join(','))}`;
            let pending = null;

            function refreshTimeline() {
                if (pending) return;
                pending = fetch(url, { cache: 'no-store' })
                    .then(res => res.json())
                    .then(data => {
                        const items = data && data.items ? data.items : {};
            cards.forEach(card => {
              const gid = card.getAttribute('data-bid-id');
              const map = items[gid] || items[String(gid)] || {};
              if (!map || !Object.keys(map).length) return;
              card.querySelectorAll('[data-stage-key]').forEach(row => {
                const key = row.getAttribute('data-stage-key');
                if (!key) return;
                                const pct = Math.max(0, Math.min(100, Number(map[key] || 0)));
                                const bar = row.querySelector('[data-stage-bar]');
                                const txt = row.querySelector('[data-stage-pct]');
                                if (bar) bar.style.width = `${pct}%`;
                                if (txt) txt.textContent = `${pct}%`;
                            });
                        });
                    })
                    .catch(() => {})
                    .finally(() => { pending = null; });
            }

            refreshTimeline();

            if (typeof io !== 'undefined') {
                const sock = io();
                sock.on('task_update', refreshTimeline);
                sock.on('task_activity', refreshTimeline);
                sock.on('master_update', refreshTimeline);
            }
        })();
    </script>
</body>
</html>
