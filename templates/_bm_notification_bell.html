{# Business Manager: bell dropdown (Flask user notifications) #}
<div class="relative">
  <button type="button" id="bmNotifDropdownBtn"
          class="w-10 h-10 rounded-lg border flex items-center justify-center relative"
          style="background: var(--bg-tertiary, #ffffff); border-color: var(--border-color, #e5e7eb);">
    <i class="fas fa-bell" style="color: var(--text-primary, #374151);"></i>
    <span id="bmNotifUnreadBadge"
          class="hidden absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-rose-600 text-white text-[10px] font-bold flex items-center justify-center"></span>
  </button>
  <div id="bmNotifDropdownPanel" class="hidden absolute right-0 mt-2 w-96 rounded-xl shadow-xl overflow-hidden z-50"
       style="background: var(--bg-tertiary, #ffffff); border: 1px solid var(--border-color, #e5e7eb);">
    <div class="px-3 py-2 flex items-center justify-between" style="border-bottom: 1px solid var(--border-color, #e5e7eb);">
      <div class="text-sm font-semibold" style="color: var(--text-primary, #111827);">Notifications</div>
      <button type="button" id="bmNotifMarkAllBtn" class="text-xs font-semibold text-indigo-600 hover:underline">Mark all</button>
    </div>
    <div id="bmNotifDropdownList" class="max-h-80 overflow-y-auto"></div>
  </div>
</div>

<script>
  window.ESCO_NOTIF = {
    mode: 'user',
    unreadUrl: {{ url_for('api_notifications_unread_count')|tojson }},
    recentUrl: {{ url_for('api_notifications_recent')|tojson }},
    markReadUrl: {{ url_for('api_notifications_mark_read')|tojson }},
    allUrl: {{ url_for('notifications_page')|tojson }},
    csrf: {{ csrf_token()|tojson }},
    badgeId: 'bmNotifUnreadBadge',
    dropdownBtnId: 'bmNotifDropdownBtn',
    dropdownPanelId: 'bmNotifDropdownPanel',
    dropdownListId: 'bmNotifDropdownList',
    pollMs: 12000,
    pollMsList: 18000
  };
</script>
<script src="{{ url_for('static', filename='notifications.js') }}"></script>
<script>
  (function () {
    const btn = document.getElementById('bmNotifMarkAllBtn');
    if (!btn) return;
    btn.addEventListener('click', async function () {
      try {
        btn.disabled = true;
        await fetch(window.ESCO_NOTIF.markReadUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: [], _csrf_token: window.ESCO_NOTIF.csrf })
        });
      } catch (e) {} finally {
        btn.disabled = false;
      }
    });
  })();
</script>
