<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overview - Site Engineer Manager - ESCO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0b1220;
            --bg-secondary: #111b2e;
            --bg-tertiary: #18233a;
            --border-color: #27344f;
            --text-primary: #e5e7eb;
            --text-secondary: #94a3b8;
            --accent-emerald: #10b981;
            --accent-cyan: #06b6d4;
            --accent-violet: #8b5cf6;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --company-primary: {% set _c = (active_company_name or '')|lower %}{% if 'ikio' in _c %}#10b981{% elif 'metco' in _c %}#8b5cf6{% elif 'sunsprint' in _c %}#f59e0b{% else %}#06b6d4{% endif %};
            --company-secondary: {% set _c2 = (active_company_name or '')|lower %}{% if 'ikio' in _c2 %}#14b8a6{% elif 'metco' in _c2 %}#a855f7{% elif 'sunsprint' in _c2 %}#fb923c{% else %}#22d3ee{% endif %};
            --company-glow: {% set _c3 = (active_company_name or '')|lower %}{% if 'ikio' in _c3 %}rgba(16, 185, 129, 0.25){% elif 'metco' in _c3 %}rgba(139, 92, 246, 0.25){% elif 'sunsprint' in _c3 %}rgba(245, 158, 11, 0.25){% else %}rgba(6, 182, 212, 0.25){% endif %};
        }
        body {
            background: radial-gradient(1200px 800px at 20% 10%, rgba(16,185,129,0.12), transparent 60%),
                        radial-gradient(1000px 700px at 80% 20%, rgba(139,92,246,0.10), transparent 55%),
                        linear-gradient(135deg, var(--bg-primary), #070b14);
            color: var(--text-primary);
        }
        .glass-card {
            background: rgba(17, 27, 46, 0.72);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(17, 27, 46, 0.85) 0%, rgba(24, 35, 58, 0.70) 100%);
            border: 1px solid var(--border-color);
            box-shadow: 0 0 0 1px rgba(255,255,255,0.02) inset;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            border-color: var(--company-primary);
            box-shadow: 0 0 30px var(--company-glow);
        }
        .progress-bar {
            background: linear-gradient(90deg, var(--company-primary), var(--company-secondary));
        }
        .scrollbar-custom::-webkit-scrollbar { width: 8px; }
        .scrollbar-custom::-webkit-scrollbar-track { background: rgba(255,255,255,0.04); }
        .scrollbar-custom::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.35); border-radius: 999px; }
    </style>
</head>
<body class="text-[var(--text-primary)]" data-theme="dark">
    <div class="flex h-screen">
        {% set team = 'engineer' %}
        {% set sidebar_mode = 'dept_minimal' %}
        {% include 'sidebar_team.html' %}

        <main class="flex-1 overflow-y-auto scrollbar-custom">
            <!-- Header -->
            <header class="sticky top-0 z-10 px-8 py-5 border-b border-[var(--border-color)] bg-[var(--bg-primary)]/90 backdrop-blur-sm">
                <div class="flex items-start justify-between gap-6">
                    <div>
                        <h2 class="text-3xl font-bold">Overview</h2>
                        <p class="text-sm text-[var(--text-secondary)]">Site Engineer â€¢ Site Engineer Manager</p>
                        <p class="mt-2 text-sm text-[var(--text-secondary)]">Company: <span class="font-semibold text-[var(--text-primary)]">{{ active_company_name or 'All' }}</span></p>
                    </div>
                    <div class="flex items-center gap-4">
                        <form method="POST" action="{{ url_for('switch_context') }}" class="flex items-center gap-2">
                            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="next" value="{{ request.full_path }}">
                            <label class="text-xs text-[var(--text-secondary)]">Company</label>
                            <select name="company_id" class="bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg px-3 py-2 text-sm text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--company-primary)]">
                                <option value="" {{ 'selected' if not active_company_id else '' }}>All</option>
                                {% for c in available_companies %}
                                <option value="{{ c.id }}" {{ 'selected' if (active_company_id|string) == (c.id|string) else '' }}>{{ c.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="px-3 py-2 rounded-lg text-sm font-semibold text-white" style="background: var(--company-primary)">
                                Switch
                            </button>
                        </form>
                        <div class="text-right">
                            <div class="text-xs text-[var(--text-secondary)]">Data source: go_bids, projects</div>
                            <div class="mt-1 text-xs">
                                <span class="px-3 py-1 rounded-full glass-card">Role: {{ user_role|replace('_',' ')|title }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="p-8">
                <!-- Overview KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-6 gap-5 mb-8">
                    <div class="stat-card rounded-xl p-5 cursor-pointer" role="button" tabindex="0" data-detail-key="total_bid_incoming">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-[var(--text-secondary)]">Total Bid Incoming</p>
                                <p class="text-3xl font-bold mt-1">{{ overview_cards.total_bid_incoming }}</p>
                                <p class="text-xs text-[var(--text-secondary)] mt-1">Engineer-stage BIDs</p>
                            </div>
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: color-mix(in srgb, var(--company-primary) 20%, transparent);">
                                <i class="fas fa-inbox" style="color: var(--company-primary)"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card rounded-xl p-5 cursor-pointer" role="button" tabindex="0" data-detail-key="pending_bids">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-[var(--text-secondary)]">Pending Bids</p>
                                <p class="text-3xl font-bold mt-1">{{ overview_cards.pending_bids }}</p>
                                <p class="text-xs text-[var(--text-secondary)] mt-1">Awaiting action</p>
                            </div>
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-amber-500/15">
                                <i class="fas fa-hourglass-half text-amber-300"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card rounded-xl p-5 cursor-pointer" role="button" tabindex="0" data-detail-key="bids_submitted">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-[var(--text-secondary)]">Bids Submitted</p>
                                <p class="text-3xl font-bold mt-1">{{ overview_cards.bids_submitted }}</p>
                                <p class="text-xs text-[var(--text-secondary)] mt-1">Already submitted</p>
                            </div>
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-emerald-500/15">
                                <i class="fas fa-paper-plane text-emerald-300"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card rounded-xl p-5 cursor-pointer" role="button" tabindex="0" data-detail-key="total_project">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-[var(--text-secondary)]">Total Project</p>
                                <p class="text-3xl font-bold mt-1">{{ overview_cards.total_project }}</p>
                                <p class="text-xs text-[var(--text-secondary)] mt-1">All projects</p>
                            </div>
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-cyan-500/15">
                                <i class="fas fa-diagram-project text-cyan-300"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card rounded-xl p-5 cursor-pointer" role="button" tabindex="0" data-detail-key="project_in_progress">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-[var(--text-secondary)]">Project In Progress</p>
                                <p class="text-3xl font-bold mt-1">{{ overview_cards.project_in_progress }}</p>
                                <p class="text-xs text-[var(--text-secondary)] mt-1">Ongoing</p>
                            </div>
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-violet-500/15">
                                <i class="fas fa-spinner text-violet-300"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card rounded-xl p-5 cursor-pointer" role="button" tabindex="0" data-detail-key="project_completed">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-[var(--text-secondary)]">Project Completed</p>
                                <p class="text-3xl font-bold mt-1">{{ overview_cards.project_completed }}</p>
                                <p class="text-xs text-[var(--text-secondary)] mt-1">Finished</p>
                            </div>
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-emerald-500/15">
                                <i class="fas fa-circle-check text-emerald-300"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status + Details -->
                <div class="grid grid-cols-1 sm:grid-cols-1 gap-6 mb-8">
                    <div class="glass-card rounded-xl p-6">
                        <h3 class="text-lg font-semibold mb-4">BIDs by status</h3>
                        {% set _rows = [
                            ('Incoming','incoming','bg-cyan-400'),
                            ('Pending','pending','bg-amber-400'),
                            ('Submitted','submitted','bg-emerald-400'),
                            ('Unknown','unknown','bg-slate-400')
                        ] %}
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-center">
                            <div class="rounded-xl border border-[var(--border-color)] bg-[var(--bg-tertiary)] p-4">
                                <div class="h-[220px]">
                                    <canvas id="bidsByStatusChart" aria-label="BIDs by status chart" role="img"></canvas>
                                </div>
                                <script type="application/json" id="bidsByStatusData">{{ bids_by_status|tojson }}</script>
                                <div class="mt-3 text-xs text-[var(--text-secondary)]">
                                    Based on <span class="font-semibold text-[var(--text-primary)]">GO bids</span> submission status (Engineer stage).
                                </div>
                            </div>

                            <div class="space-y-4">
                                {% for label, key, _color in _rows %}
                                <div class="flex items-center gap-4 cursor-pointer" role="button" tabindex="0" data-detail-key="status_{{ key }}">
                                    <div class="w-24 text-sm text-[var(--text-secondary)]">{{ label }}</div>
                                    <div class="flex-1 h-2.5 rounded-full bg-white/5 overflow-hidden border border-[var(--border-color)]">
                                        <div class="h-full progress-bar" data-pct="{{ bids_by_status_pct.get(key, 0) }}"></div>
                                    </div>
                                    <div class="w-10 text-right text-sm font-semibold">{{ bids_by_status.get(key, 0) }}</div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl p-6" id="deptDetailsPanel">
                        <div class="flex items-center justify-between gap-4 mb-4">
                            <h3 class="text-lg font-semibold" id="deptDetailsTitle">Details</h3>
                            <div class="text-xs text-[var(--text-secondary)]" id="deptDetailsMeta"></div>
                        </div>
                        <div id="deptDetailsBody" class="text-sm text-[var(--text-secondary)]">
                            Click any card above to load records.
                        </div>
                    </div>
                </div>

                <!-- BID Timeline -->
                <div class="glass-card rounded-xl p-6 mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-semibold">BID Timeline</h3>
                            <p class="text-sm text-[var(--text-secondary)]">{{ active_company_name or 'All Companies' }} - Top High Priority BIDs</p>
                        </div>
                        <a href="{{ url_for('bid_timeline') }}" class="text-sm font-semibold hover:opacity-90" style="color: var(--company-primary)">Open</a>
                    </div>
                    <div class="rounded-xl overflow-hidden border border-[var(--border-color)] bg-[var(--bg-tertiary)]">
                        <iframe
                            src="{{ url_for('bid_timeline') }}?embed=1&dark=1"
                            class="w-full h-[520px] border-0"
                            loading="lazy"
                        ></iframe>
                    </div>
                </div>

                <!-- Team Summary Cards -->
                <div class="glass-card rounded-xl p-6 mb-8">
                    <h3 class="text-lg font-semibold mb-4">Team Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                        {% for t in teams %}
                        <div class="stat-card rounded-xl p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-[var(--text-secondary)]">{{ t.display_name }}</p>
                                    <p class="text-2xl font-bold mt-1">{{ team_stats.get(t.key, {}).get('employees', 0) }}</p>
                                    <p class="text-xs text-[var(--text-secondary)]">Employees</p>
                                </div>
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-cyan-500/15">
                                    <i class="fas fa-users text-cyan-300"></i>
                                </div>
                            </div>
                            <div class="mt-4 grid grid-cols-2 gap-3 text-xs">
                                <div class="p-3 rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)]">
                                    <div class="text-[var(--text-secondary)]">Team Leads</div>
                                    <div class="font-semibold text-[var(--text-primary)]">{{ team_stats.get(t.key, {}).get('team_leads', 0) }}</div>
                                </div>
                                <div class="p-3 rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)]">
                                    <div class="text-[var(--text-secondary)]">Tasks</div>
                                    <div class="font-semibold text-[var(--text-primary)]">{{ team_stats.get(t.key, {}).get('tasks_total', 0) }}</div>
                                </div>
                            </div>
                            <div class="mt-4 flex flex-wrap gap-2">
                                <a class="text-xs px-3 py-2 rounded-lg font-semibold text-white" style="background: var(--company-primary)" href="{{ url_for('team_dashboard', team=t.key) }}">
                                    <i class="fas fa-chart-line mr-1"></i>Team Dashboard
                                </a>
                                <a class="text-xs px-3 py-2 rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] hover:bg-white/5" href="{{ url_for('team_employees', team=t.key) }}">
                                    <i class="fas fa-user-friends mr-1"></i>Employees
                                </a>
                                <a class="text-xs px-3 py-2 rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] hover:bg-white/5" href="{{ url_for('team_lead_overview', team=t.key) }}">
                                    <i class="fas fa-clipboard-list mr-1"></i>Lead Overview
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Assigned Bids (Grid/Board) -->
                <div class="glass-card rounded-xl mb-8">
                    <div class="p-6 border-b border-[var(--border-color)]">
                        <h3 class="text-lg font-semibold">Assigned Bids</h3>
                        <p class="text-sm text-[var(--text-secondary)]">Grid/Board view (Site Engineer)</p>
                    </div>
                    <div class="p-0">
                        <iframe src="{{ url_for('team_dashboard', team='engineer') }}?embed=1"
                                class="w-full h-[80vh] border-0 rounded-b-xl"
                                loading="lazy"></iframe>
                    </div>
                </div>

                <!-- Team Leads -->
                <div class="glass-card rounded-xl mb-8">
                    <div class="p-6 border-b border-[var(--border-color)]">
                        <h3 class="text-lg font-semibold">Team Leads</h3>
                        <p class="text-sm text-[var(--text-secondary)]">Team leads for Site Engineering</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-[var(--bg-tertiary)]">
                                <tr class="text-left text-xs font-semibold uppercase tracking-wide text-[var(--text-secondary)]">
                                    <th class="p-3">Team</th>
                                    <th class="p-3">Lead</th>
                                    <th class="p-3">Role</th>
                                    <th class="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in team_leads %}
                                <tr class="border-b border-[var(--border-color)]/70 hover:bg-white/5">
                                    <td class="p-3 font-medium">{{ team_names.get(row.team_key, row.team_key)|title }}</td>
                                    <td class="p-3">{{ row.email }}</td>
                                    <td class="p-3 text-sm text-[var(--text-secondary)]">{{ (row.role or '')|replace('_',' ')|title }}</td>
                                    <td class="p-3">
                                        <a class="inline-flex items-center px-3 py-2 text-xs rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] hover:bg-white/5" href="{{ url_for('team_employees', team=row.team_key) }}">
                                            <i class="fas fa-users-cog mr-1"></i>Team
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if team_leads|length == 0 %}
                                <tr>
                                    <td colspan="4" class="p-6 text-center text-[var(--text-secondary)]">No team leads found in `users` table for the configured roles.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Employees -->
                <div class="glass-card rounded-xl">
                    <div class="p-6 border-b border-[var(--border-color)]">
                        <h3 class="text-lg font-semibold">Employees</h3>
                        <p class="text-sm text-[var(--text-secondary)]">Quick access to employee details and employee dashboard</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-[var(--bg-tertiary)]">
                                <tr class="text-left text-xs font-semibold uppercase tracking-wide text-[var(--text-secondary)]">
                                    <th class="p-3">Team</th>
                                    <th class="p-3">Employee</th>
                                    <th class="p-3">Email</th>
                                    <th class="p-3">Tasks</th>
                                    <th class="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for emp in employees %}
                                <tr class="border-b border-[var(--border-color)]/70 hover:bg-white/5">
                                    <td class="p-3 font-medium">{{ team_names.get(emp.department, emp.department)|title }}</td>
                                    <td class="p-3">{{ emp.name }}</td>
                                    <td class="p-3 text-sm text-[var(--text-secondary)]">{{ emp.email or 'N/A' }}</td>
                                    <td class="p-3 text-sm">
                                        <span class="px-2 py-1 text-xs rounded bg-amber-500/15 text-amber-200 border border-[var(--border-color)]/70">P: {{ emp.pending_tasks or 0 }}</span>
                                        <span class="px-2 py-1 text-xs rounded bg-cyan-500/15 text-cyan-200 border border-[var(--border-color)]/70">IP: {{ emp.in_progress_tasks or 0 }}</span>
                                        <span class="px-2 py-1 text-xs rounded bg-emerald-500/15 text-emerald-200 border border-[var(--border-color)]/70">C: {{ emp.completed_tasks or 0 }}</span>
                                    </td>
                                    <td class="p-3">
                                        <a class="inline-flex items-center px-3 py-2 text-xs rounded-lg border border-[var(--border-color)] bg-[var(--bg-tertiary)] hover:bg-white/5" href="{{ url_for('employee_detail', employee_id=emp.id) }}">
                                            <i class="fas fa-id-card mr-1"></i>Detail
                                        </a>
                                        <a class="inline-flex items-center px-3 py-2 text-xs rounded-lg text-white ml-2" style="background: var(--company-primary)" href="{{ url_for('employee_dashboard', employee_id=emp.id) }}">
                                            <i class="fas fa-user mr-1"></i>Dashboard
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if employees|length == 0 %}
                                <tr>
                                    <td colspan="5" class="p-6 text-center text-[var(--text-secondary)]">No active employees found.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        (function () {
            const apiUrl = "{{ url_for('api_department_manager_overview_details', team='engineer') }}";
            const bodyEl = document.getElementById('deptDetailsBody');
            const titleEl = document.getElementById('deptDetailsTitle');
            const metaEl = document.getElementById('deptDetailsMeta');

            function escapeHtml(v) {
                const s = (v === null || v === undefined) ? '' : String(v);
                return s
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#039;');
            }

            function setLoading(label) {
                titleEl.textContent = label || 'Details';
                metaEl.textContent = 'Loading...';
                bodyEl.innerHTML = '<div class="text-sm text-[var(--text-secondary)]">Loading records...</div>';
            }

            function setError(label, msg) {
                titleEl.textContent = label || 'Details';
                metaEl.textContent = '';
                bodyEl.innerHTML = '<div class="text-sm text-rose-300">Failed to load: ' + escapeHtml(msg || 'Unknown error') + '</div>';
            }

            function setEmpty(label) {
                titleEl.textContent = label || 'Details';
                metaEl.textContent = '0 records';
                bodyEl.innerHTML = '<div class="text-sm text-[var(--text-secondary)]">No records.</div>';
            }

            function renderTable(label, columns, rows, shown, limit) {
                titleEl.textContent = label || 'Details';
                metaEl.textContent = `${shown} shown (limit ${limit})`;
                const thead = '<tr>' + columns.map(c =>
                    '<th class="px-3 py-2 text-left text-xs font-semibold uppercase tracking-wide text-[var(--text-secondary)] border-b border-[var(--border-color)] whitespace-nowrap">' + escapeHtml(c) + '</th>'
                ).join('') + '</tr>';

                const tbody = rows.map(r => {
                    return '<tr class="border-b border-[var(--border-color)]/70 hover:bg-white/5">' +
                        columns.map(c => {
                            const v = (r && Object.prototype.hasOwnProperty.call(r, c)) ? r[c] : '';
                            return '<td class="px-3 py-2 text-sm text-[var(--text-primary)] align-top whitespace-nowrap">' + escapeHtml(v) + '</td>';
                        }).join('') +
                        '</tr>';
                }).join('');

                bodyEl.innerHTML = `
                    <div class="rounded-xl overflow-hidden border border-[var(--border-color)] bg-[var(--bg-tertiary)]">
                        <div class="max-h-[330px] overflow-auto scrollbar-custom">
                            <table class="w-full text-left">
                                <thead class="sticky top-0 bg-[var(--bg-tertiary)]">${thead}</thead>
                                <tbody>${tbody}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            async function loadDetails(key) {
                if (!key) return;
                setLoading('Details');
                try {
                    const res = await fetch(apiUrl + '?key=' + encodeURIComponent(key), { credentials: 'same-origin' });
                    const data = await res.json();
                    if (!res.ok || !data || !data.ok) {
                        throw new Error((data && (data.message || data.error)) || ('HTTP ' + res.status));
                    }
                    const title = data.title || 'Details';
                    const columns = data.columns || [];
                    const rows = data.rows || [];
                    if (!rows.length) return setEmpty(title);
                    return renderTable(title, columns, rows, data.shown || rows.length, data.limit || rows.length);
                } catch (e) {
                    return setError('Details', e && e.message ? e.message : String(e));
                }
            }

            function setActive(el) {
                document.querySelectorAll('[data-detail-key]').forEach(x => {
                    x.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-transparent');
                    x.style.boxShadow = '';
                });
                if (el) {
                    el.classList.add('ring-2', 'ring-offset-2', 'ring-offset-transparent');
                    el.style.boxShadow = '0 0 0 2px var(--company-primary)';
                }
            }

            function wireClickable(el) {
                const key = el.getAttribute('data-detail-key');
                if (!key) return;
                el.addEventListener('click', () => {
                    setActive(el);
                    loadDetails(key);
                });
                el.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        setActive(el);
                        loadDetails(key);
                    }
                });
            }

            document.querySelectorAll('[data-detail-key]').forEach(wireClickable);

            document.querySelectorAll('.progress-bar[data-pct]').forEach((bar) => {
                const pct = parseInt(bar.getAttribute('data-pct') || '0', 10);
                bar.style.width = (Number.isFinite(pct) ? pct : 0) + '%';
            });

            window.__deptOverview = { loadDetails };
        })();
    </script>

    <script>
        (function () {
            const el = document.getElementById('bidsByStatusChart');
            if (!el || !window.Chart) return;

            const labels = ['Incoming', 'Pending', 'Submitted', 'Unknown'];
            let status = {};
            try {
                const dataEl = document.getElementById('bidsByStatusData');
                status = JSON.parse((dataEl && dataEl.textContent) ? dataEl.textContent : '{}') || {};
            } catch (e) {
                status = {};
            }
            const values = [
                Number(status.incoming || 0),
                Number(status.pending || 0),
                Number(status.submitted || 0),
                Number(status.unknown || 0),
            ];

            const css = getComputedStyle(document.documentElement);
            const colors = [
                css.getPropertyValue('--accent-cyan').trim() || '#06b6d4',
                css.getPropertyValue('--accent-amber').trim() || '#f59e0b',
                css.getPropertyValue('--accent-emerald').trim() || '#10b981',
                css.getPropertyValue('--text-secondary').trim() || '#94a3b8'
            ];

            // eslint-disable-next-line no-new
            new Chart(el, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderColor: 'rgba(0,0,0,0)',
                        hoverOffset: 6,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    onClick: function (_evt, elements) {
                        try {
                            const first = elements && elements[0];
                            if (!first) return;
                            const idx = first.index;
                            const map = ['status_incoming', 'status_pending', 'status_submitted', 'status_unknown'];
                            const key = map[idx];
                            if (!key) return;
                            if (window.__deptOverview && typeof window.__deptOverview.loadDetails === 'function') {
                                window.__deptOverview.loadDetails(key);
                            }
                        } catch (e) {
                            // no-op
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: css.getPropertyValue('--text-secondary').trim() || '#94a3b8',
                                boxWidth: 10,
                                boxHeight: 10,
                                padding: 14,
                                usePointStyle: true,
                                pointStyle: 'circle',
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (ctx) {
                                    const v = ctx.parsed || 0;
                                    const total = values.reduce((a, b) => a + b, 0) || 1;
                                    const pct = Math.round((v / total) * 100);
                                    return ` ${ctx.label}: ${v} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });
        })();
    </script>
</body>
</html>

