<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approvals - Team Lead - ESCO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='light_theme_overrides.css') }}">
</head>
<body class="bg-gray-50 text-gray-800 with-fixed-sidebar">
    <div class="flex h-screen">
        {% set _sidebar_q = (request.args.get('sidebar') or '')|lower %}
        {% set sidebar_fixed = true %}
        {% set topbar_title = 'Approvals' %}
        {% set topbar_subtitle = team_label ~ ' approvals for uploads and comments.' %}
        {% set topbar_right_html %}
            <div class="flex items-center gap-2">
                {% include '_bm_notification_bell.html' %}
            </div>
        {% endset %}
        {% if _sidebar_q == 'minimal' %}
            {% include 'sidebar.html' %}
        {% else %}
            {% set team = team_key or 'business' %}
            {% set hide_notifications = true %}
            {% set sidebar_mode = 'team_lead' %}
            {% include 'sidebar.html' %}
        {% endif %}

        <main class="ml-64 flex-1 p-8 overflow-y-auto">

            <div class="bg-white rounded-lg shadow-md mb-8">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold">Pending Approvals</h3>
                        <p class="text-sm text-gray-600">Comments and uploads awaiting approval</p>
                    </div>
                    <div class="text-xs text-gray-500">Total: {{ items|length }}</div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                            <tr>
                                <th class="text-left p-3">Source</th>
                                <th class="text-left p-3">Department</th>
                                <th class="text-left p-3">Task</th>
                                <th class="text-left p-3">Priority</th>
                                <th class="text-left p-3">Uploaded By</th>
                                <th class="text-left p-3">Approval For</th>
                                <th class="text-left p-3">File / Notes</th>
                                <th class="text-left p-3">Uploaded</th>
                                <th class="text-left p-3">Status</th>
                                <th class="text-left p-3">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for it in items %}
                            <tr class="hover:bg-gray-50">
                                <td class="p-3">
                                    <span class="px-2 py-1 text-xs rounded-full font-semibold {{ 'bg-blue-100 text-blue-800' if it.source=='employee' else 'bg-gray-100 text-gray-700' }}">
                                        {{ it.source|title }}
                                    </span>
                                </td>
                                <td class="p-3 text-gray-600">{{ (it.department or 'N/A')|replace('_',' ')|title }}</td>
                                <td class="p-3">
                                    <div class="font-semibold">{{ it.task_name or ('Task ' ~ it.task_id) }}</div>
                                    <div class="text-xs text-gray-500">{{ it.bid_name or 'N/A' }}</div>
                                </td>
                                <td class="p-3 whitespace-nowrap">
                                    {% set _prio = (it.priority or 'normal')|lower %}
                                    {% set _prio_label = _prio if _prio in ['low','medium','high','urgent','normal'] else 'normal' %}
                                    <span class="px-2 py-1 text-xs rounded-full font-semibold
                                        {{ 'bg-red-100 text-red-800' if _prio_label=='urgent' else ('bg-orange-100 text-orange-800' if _prio_label=='high' else ('bg-yellow-100 text-yellow-800' if _prio_label=='medium' else 'bg-gray-100 text-gray-700')) }}">
                                        {{ _prio_label|title }}
                                    </span>
                                </td>
                                <td class="p-3 text-gray-600">{{ it.uploader or 'N/A' }}</td>
                                <td class="p-3 text-gray-600">{{ (it.approval_target or 'admin')|replace('_',' ')|title }}</td>
                                <td class="p-3">
                                    {% if it.source_table == 'task_comments' %}
                                        <div class="text-gray-900 font-semibold">Approval Request</div>
                                        <div class="text-xs text-gray-600 mt-0.5 whitespace-pre-line">{{ it.comment or 'N/A' }}</div>
                                        
                                    {% else %}
                                        <a class="text-gray-900 font-semibold underline" href="{{ it.download_url }}" target="_blank">{{ it.original_filename or it.filename }}</a>
                                        {% if it.description %}
                                            <div class="text-xs text-gray-500 mt-0.5">{{ it.description }}</div>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="p-3 text-gray-600 whitespace-nowrap">{{ it.uploaded_at }}</td>
                                <td class="p-3 whitespace-nowrap">
                                    {% set st = (it.status or 'pending')|lower %}
                                    <span class="px-2 py-1 text-xs rounded-full font-semibold
                                        {{ 'bg-amber-100 text-amber-800' if st=='pending' else ('bg-emerald-100 text-emerald-800' if st=='approved' else 'bg-rose-100 text-rose-800') }}">
                                        {{ st|title }}
                                    </span>
                                    {% if it.decided_at and st != 'pending' %}
                                        <div class="text-xs text-gray-500 mt-0.5">Decided: {{ it.decided_at }}</div>
                                    {% endif %}
                                </td>
                                <td class="p-3">
                                    <div class="flex items-center gap-2">
                                        {% if st == 'pending' %}
                                        {% if check_action_access('approve_item') or is_admin %}
                                        <button type="button"
                                                class="px-3 py-2 text-xs bg-emerald-100 hover:bg-emerald-200 text-emerald-700 rounded-lg font-semibold"
                                                data-approve
                                                data-source-table="{{ it.source_table }}"
                                                data-source-id="{{ it.source_id }}">
                                            Approve
                                        </button>
                                        {% endif %}
                                        {% if check_action_access('reject_item') or is_admin %}
                                        <button type="button"
                                                class="px-3 py-2 text-xs bg-rose-100 hover:bg-rose-200 text-rose-700 rounded-lg font-semibold"
                                                data-reject
                                                data-source-table="{{ it.source_table }}"
                                                data-source-id="{{ it.source_id }}">
                                            Reject
                                        </button>
                                        {% endif %}
                                        <div class="flex items-center gap-2">
                                            <select class="border border-gray-300 rounded px-2 py-1 text-xs"
                                                    data-escalate-target>
                                                <option value="manager">Manager</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                            {% if check_action_access('escalate_item') or is_admin %}
                                            <button type="button"
                                                    class="px-2 py-1 text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg font-semibold"
                                                    data-escalate
                                                    data-source-table="{{ it.source_table }}"
                                                    data-source-id="{{ it.source_id }}">
                                                Request Approval
                                            </button>
                                            {% endif %}
                                        </div>
                                        {% else %}
                                            <span class="text-xs text-gray-500 italic">No action</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if (items|length) == 0 %}
                            <tr><td colspan="10" class="p-10 text-center text-gray-500 italic">No approvals found.</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        async function postAction(action, table, id) {
            const res = await fetch('/approvals/action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, source_table: table, source_id: id, _csrf_token: '{{ csrf_token() }}' })
            });
            const data = await res.json();
            if (!data || !data.success) throw new Error((data && (data.error || data.message)) || 'Failed');
        }

        async function postEscalate(table, id, target) {
            const res = await fetch('/approvals/escalate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source_table: table, source_id: id, approval_target: target, _csrf_token: '{{ csrf_token() }}' })
            });
            const data = await res.json();
            if (!data || !data.success) throw new Error((data && (data.error || data.message)) || 'Failed');
        }

        document.addEventListener('click', async (e) => {
            const btnApprove = e.target.closest ? e.target.closest('[data-approve]') : null;
            const btnReject = e.target.closest ? e.target.closest('[data-reject]') : null;
            const btnEscalate = e.target.closest ? e.target.closest('[data-escalate]') : null;
            if (btnEscalate) {
                const table = btnEscalate.getAttribute('data-source-table');
                const id = parseInt(btnEscalate.getAttribute('data-source-id') || '0', 10);
                const row = btnEscalate.closest('tr');
                const sel = row ? row.querySelector('[data-escalate-target]') : null;
                const target = sel && sel.value ? sel.value : 'manager';
                if (!table || !id) return;
                try {
                    btnEscalate.disabled = true;
                    await postEscalate(table, id, target);
                    location.reload();
                } catch (err) {
                    btnEscalate.disabled = false;
                    alert('Approval request failed: ' + (err && err.message ? err.message : 'Unknown error'));
                }
                return;
            }
            const btn = btnApprove || btnReject;
            if (!btn) return;
            const action = btnApprove ? 'approve' : 'reject';
            const table = btn.getAttribute('data-source-table');
            const id = parseInt(btn.getAttribute('data-source-id') || '0', 10);
            if (!table || !id) return;
            try {
                btn.disabled = true;
                await postAction(action, table, id);
                location.reload();
            } catch (err) {
                btn.disabled = false;
                alert('Approval action failed: ' + (err && err.message ? err.message : 'Unknown error'));
            }
        });
    </script>
</body>
</html>
